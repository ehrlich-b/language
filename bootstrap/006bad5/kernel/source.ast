(program
  (var LIMIT_STMTS_PER_BLOCK (type_base i64) (number 1024))
  (var LIMIT_CALL_ARGS (type_base i64) (number 16))
  (var LIMIT_FUNC_PARAMS (type_base i64) (number 16))
  (var LIMIT_TOP_DECLS (type_base i64) (number 1000))
  (var LIMIT_LOCALS (type_base i64) (number 1024))
  (var LIMIT_GLOBALS (type_base i64) (number 1000))
  (var LIMIT_STRINGS (type_base i64) (number 3000))
  (var LIMIT_STRUCTS (type_base i64) (number 100))
  (var LIMIT_ENUMS (type_base i64) (number 100))
  (var LIMIT_EFFECTS (type_base i64) (number 100))
  (var LIMIT_MACROS (type_base i64) (number 100))
  (var LIMIT_READERS (type_base i64) (number 100))
  (var LIMIT_FUNCS (type_base i64) (number 1000))
  (var LIMIT_LAMBDAS (type_base i64) (number 1000))
  (var LIMIT_CAPTURES (type_base i64) (number 64))
  (var LIMIT_LOOP_DEPTH (type_base i64) (number 32))
  (var LIMIT_INCLUDE_DEPTH (type_base i64) (number 32))
  (var SIZE_CODE_BUF (type_base i64) (number 4194304))
  (var SIZE_FUNC_BUF (type_base i64) (number 524288))
  (var SIZE_HEAP (type_base i64) (number 268435456))
  (var heap_pos (type_ptr (type_base u8)) (nil))
  (var heap_end (type_ptr (type_base u8)) (nil))
  (func alloc ((param size (type_base i64))) (type_ptr (type_base u8))
    (block
      (if (binop == (ident heap_pos) (nil))
        (block
          (assign (ident heap_pos) (call (ident syscall) (number 9) (number 0) (ident SIZE_HEAP) (number 3) (number 34) (binop - (number 0) (number 1)) (number 0)))
          (assign (ident heap_end) (binop + (ident heap_pos) (ident SIZE_HEAP)))))
      (var ptr (type_ptr (type_base u8)) (ident heap_pos))
      (assign (ident heap_pos) (binop + (ident heap_pos) (ident size)))
      (return (ident ptr))))
  (var free_list (type_ptr (type_base u8)) (nil))
  (func malloc ((param size (type_base i64))) (type_ptr (type_base u8))
    (block
      (if (binop < (ident size) (number 8))
        (block
          (assign (ident size) (number 8))))
      (var rem (type_base i64) (binop % (ident size) (number 8)))
      (if (binop != (ident rem) (number 0))
        (block
          (assign (ident size) (binop - (binop + (ident size) (number 8)) (ident rem)))))
      (var prev (type_ptr (type_base u8)) (nil))
      (var curr (type_ptr (type_base u8)) (ident free_list))
      (while (binop != (ident curr) (nil))
        (block
          (var block_size_ptr (type_ptr (type_base i64)) (ident curr))
          (var block_size (type_base i64) (unop * (ident block_size_ptr)))
          (if (binop >= (ident block_size) (ident size))
            (block
              (var next_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident curr) (number 8)))
              (var next (type_ptr (type_base u8)) (unop * (ident next_ptr)))
              (if (binop == (ident prev) (nil))
                (block
                  (assign (ident free_list) (ident next)))
                (block
                  (var prev_next_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident prev) (number 8)))
                  (assign (unop * (ident prev_next_ptr)) (ident next))))
              (return (binop + (ident curr) (number 8)))))
          (assign (ident prev) (ident curr))
          (var curr_next_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident curr) (number 8)))
          (assign (ident curr) (unop * (ident curr_next_ptr)))))
      (var total (type_base i64) (binop + (ident size) (number 8)))
      (var block (type_ptr (type_base u8)) (call (ident alloc) (ident total)))
      (var size_ptr (type_ptr (type_base i64)) (ident block))
      (assign (unop * (ident size_ptr)) (ident size))
      (return (binop + (ident block) (number 8)))))
  (func free ((param ptr (type_ptr (type_base u8)))) nil
    (block
      (if (binop == (ident ptr) (nil))
        (block
          (return)))
      (var block (type_ptr (type_base u8)) (binop - (ident ptr) (number 8)))
      (var next_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident block) (number 8)))
      (assign (unop * (ident next_ptr)) (ident free_list))
      (assign (ident free_list) (ident block))))
  (func vec_new ((param cap (type_base i64))) (type_ptr (type_base u8))
    (block
      (var v (type_ptr (type_base u8)) (call (ident malloc) (number 24)))
      (if (binop < (ident cap) (number 4))
        (block
          (assign (ident cap) (number 4))))
      (var cap_ptr (type_ptr (type_base i64)) (ident v))
      (assign (unop * (ident cap_ptr)) (ident cap))
      (var len_ptr (type_ptr (type_base i64)) (binop + (ident v) (number 8)))
      (assign (unop * (ident len_ptr)) (number 0))
      (var data_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident v) (number 16)))
      (assign (unop * (ident data_ptr)) (call (ident malloc) (binop * (ident cap) (number 8))))
      (return (ident v))))
  (func vec_len ((param v (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var len_ptr (type_ptr (type_base i64)) (binop + (ident v) (number 8)))
      (return (unop * (ident len_ptr)))))
  (func vec_get ((param v (type_ptr (type_base u8))) (param index (type_base i64))) (type_base i64)
    (block
      (var data_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident v) (number 16)))
      (var data (type_ptr (type_base u8)) (unop * (ident data_ptr)))
      (var elem_ptr (type_ptr (type_base i64)) (binop + (ident data) (binop * (ident index) (number 8))))
      (return (unop * (ident elem_ptr)))))
  (func vec_set ((param v (type_ptr (type_base u8))) (param index (type_base i64)) (param value (type_base i64))) nil
    (block
      (var data_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident v) (number 16)))
      (var data (type_ptr (type_base u8)) (unop * (ident data_ptr)))
      (var elem_ptr (type_ptr (type_base i64)) (binop + (ident data) (binop * (ident index) (number 8))))
      (assign (unop * (ident elem_ptr)) (ident value))))
  (func vec_push ((param v (type_ptr (type_base u8))) (param value (type_base i64))) nil
    (block
      (var cap_ptr (type_ptr (type_base i64)) (ident v))
      (var len_ptr (type_ptr (type_base i64)) (binop + (ident v) (number 8)))
      (var data_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident v) (number 16)))
      (var cap (type_base i64) (unop * (ident cap_ptr)))
      (var len (type_base i64) (unop * (ident len_ptr)))
      (var data (type_ptr (type_base u8)) (unop * (ident data_ptr)))
      (if (binop >= (ident len) (ident cap))
        (block
          (var new_cap (type_base i64) (binop * (ident cap) (number 2)))
          (var new_data (type_ptr (type_base u8)) (call (ident malloc) (binop * (ident new_cap) (number 8))))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident len))
            (block
              (var old_ptr (type_ptr (type_base i64)) (binop + (ident data) (binop * (ident i) (number 8))))
              (var new_ptr (type_ptr (type_base i64)) (binop + (ident new_data) (binop * (ident i) (number 8))))
              (assign (unop * (ident new_ptr)) (unop * (ident old_ptr)))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident free) (ident data)))
          (assign (unop * (ident cap_ptr)) (ident new_cap))
          (assign (unop * (ident data_ptr)) (ident new_data))
          (assign (ident data) (ident new_data))))
      (var elem_ptr (type_ptr (type_base i64)) (binop + (ident data) (binop * (ident len) (number 8))))
      (assign (unop * (ident elem_ptr)) (ident value))
      (assign (unop * (ident len_ptr)) (binop + (ident len) (number 1)))))
  (func vec_free ((param v (type_ptr (type_base u8)))) nil
    (block
      (var data_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident v) (number 16)))
      (var data (type_ptr (type_base u8)) (unop * (ident data_ptr)))
      (expr_stmt (call (ident free) (ident data)))
      (expr_stmt (call (ident free) (ident v)))))
  (func vec_pop ((param v (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var len_ptr (type_ptr (type_base i64)) (binop + (ident v) (number 8)))
      (var data_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident v) (number 16)))
      (var len (type_base i64) (unop * (ident len_ptr)))
      (if (binop == (ident len) (number 0))
        (block
          (return (number 0))))
      (assign (ident len) (binop - (ident len) (number 1)))
      (assign (unop * (ident len_ptr)) (ident len))
      (var data (type_ptr (type_base u8)) (unop * (ident data_ptr)))
      (var elem_ptr (type_ptr (type_base i64)) (binop + (ident data) (binop * (ident len) (number 8))))
      (return (unop * (ident elem_ptr)))))
  (func hash_str ((param s (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var h (type_base i64) (number 5381))
      (while (binop != (unop * (ident s)) (number 0))
        (block
          (assign (ident h) (binop + (binop * (ident h) (number 33)) (unop * (ident s))))
          (assign (ident s) (binop + (ident s) (number 1)))))
      (if (binop < (ident h) (number 0))
        (block
          (assign (ident h) (binop - (number 0) (ident h)))))
      (return (ident h))))
  (func map_new () (type_ptr (type_base u8))
    (block
      (var m (type_ptr (type_base u8)) (call (ident malloc) (number 32)))
      (var cap_ptr (type_ptr (type_base i64)) (ident m))
      (assign (unop * (ident cap_ptr)) (number 16))
      (var count_ptr (type_ptr (type_base i64)) (binop + (ident m) (number 8)))
      (assign (unop * (ident count_ptr)) (number 0))
      (var keys_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident m) (number 16)))
      (var keys (type_ptr (type_base u8)) (call (ident malloc) (number 128)))
      (assign (unop * (ident keys_ptr)) (ident keys))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (number 16))
        (block
          (var slot (type_ptr (type_ptr (type_base u8))) (binop + (ident keys) (binop * (ident i) (number 8))))
          (assign (unop * (ident slot)) (nil))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (var vals_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident m) (number 24)))
      (assign (unop * (ident vals_ptr)) (call (ident malloc) (number 128)))
      (return (ident m))))
  (func map_find_slot ((param m (type_ptr (type_base u8))) (param key (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var cap_ptr (type_ptr (type_base i64)) (ident m))
      (var cap (type_base i64) (unop * (ident cap_ptr)))
      (var keys_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident m) (number 16)))
      (var keys (type_ptr (type_base u8)) (unop * (ident keys_ptr)))
      (var h (type_base i64) (binop % (call (ident hash_str) (ident key)) (ident cap)))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cap))
        (block
          (var idx (type_base i64) (binop % (binop + (ident h) (ident i)) (ident cap)))
          (var slot (type_ptr (type_ptr (type_base u8))) (binop + (ident keys) (binop * (ident idx) (number 8))))
          (var slot_key (type_ptr (type_base u8)) (unop * (ident slot)))
          (if (binop == (ident slot_key) (nil))
            (block
              (return (ident idx))))
          (if (call (ident streq) (ident slot_key) (ident key))
            (block
              (return (ident idx))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (binop - (number 0) (number 1)))))
  (func map_grow ((param m (type_ptr (type_base u8)))) nil
    (block
      (var cap_ptr (type_ptr (type_base i64)) (ident m))
      (var count_ptr (type_ptr (type_base i64)) (binop + (ident m) (number 8)))
      (var keys_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident m) (number 16)))
      (var vals_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident m) (number 24)))
      (var old_cap (type_base i64) (unop * (ident cap_ptr)))
      (var old_keys (type_ptr (type_base u8)) (unop * (ident keys_ptr)))
      (var old_vals (type_ptr (type_base u8)) (unop * (ident vals_ptr)))
      (var new_cap (type_base i64) (binop * (ident old_cap) (number 2)))
      (assign (unop * (ident cap_ptr)) (ident new_cap))
      (assign (unop * (ident count_ptr)) (number 0))
      (var new_keys (type_ptr (type_base u8)) (call (ident malloc) (binop * (ident new_cap) (number 8))))
      (var new_vals (type_ptr (type_base u8)) (call (ident malloc) (binop * (ident new_cap) (number 8))))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident new_cap))
        (block
          (var slot (type_ptr (type_ptr (type_base u8))) (binop + (ident new_keys) (binop * (ident i) (number 8))))
          (assign (unop * (ident slot)) (nil))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (assign (unop * (ident keys_ptr)) (ident new_keys))
      (assign (unop * (ident vals_ptr)) (ident new_vals))
      (assign (ident i) (number 0))
      (while (binop < (ident i) (ident old_cap))
        (block
          (var old_slot (type_ptr (type_ptr (type_base u8))) (binop + (ident old_keys) (binop * (ident i) (number 8))))
          (var old_key (type_ptr (type_base u8)) (unop * (ident old_slot)))
          (if (binop != (ident old_key) (nil))
            (block
              (var old_val_ptr (type_ptr (type_base i64)) (binop + (ident old_vals) (binop * (ident i) (number 8))))
              (var old_val (type_base i64) (unop * (ident old_val_ptr)))
              (var idx (type_base i64) (call (ident map_find_slot) (ident m) (ident old_key)))
              (var new_slot (type_ptr (type_ptr (type_base u8))) (binop + (ident new_keys) (binop * (ident idx) (number 8))))
              (assign (unop * (ident new_slot)) (ident old_key))
              (var new_val_ptr (type_ptr (type_base i64)) (binop + (ident new_vals) (binop * (ident idx) (number 8))))
              (assign (unop * (ident new_val_ptr)) (ident old_val))
              (var count (type_base i64) (unop * (ident count_ptr)))
              (assign (unop * (ident count_ptr)) (binop + (ident count) (number 1)))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (expr_stmt (call (ident free) (ident old_keys)))
      (expr_stmt (call (ident free) (ident old_vals)))))
  (func map_set ((param m (type_ptr (type_base u8))) (param key (type_ptr (type_base u8))) (param value (type_base i64))) nil
    (block
      (var cap_ptr (type_ptr (type_base i64)) (ident m))
      (var count_ptr (type_ptr (type_base i64)) (binop + (ident m) (number 8)))
      (var keys_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident m) (number 16)))
      (var vals_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident m) (number 24)))
      (var cap (type_base i64) (unop * (ident cap_ptr)))
      (var count (type_base i64) (unop * (ident count_ptr)))
      (if (binop > (binop * (ident count) (number 4)) (binop * (ident cap) (number 3)))
        (block
          (expr_stmt (call (ident map_grow) (ident m)))))
      (var keys (type_ptr (type_base u8)) (unop * (ident keys_ptr)))
      (var vals (type_ptr (type_base u8)) (unop * (ident vals_ptr)))
      (var idx (type_base i64) (call (ident map_find_slot) (ident m) (ident key)))
      (var slot (type_ptr (type_ptr (type_base u8))) (binop + (ident keys) (binop * (ident idx) (number 8))))
      (var slot_key (type_ptr (type_base u8)) (unop * (ident slot)))
      (if (binop == (ident slot_key) (nil))
        (block
          (assign (unop * (ident slot)) (ident key))
          (assign (ident count) (unop * (ident count_ptr)))
          (assign (unop * (ident count_ptr)) (binop + (ident count) (number 1)))))
      (var val_ptr (type_ptr (type_base i64)) (binop + (ident vals) (binop * (ident idx) (number 8))))
      (assign (unop * (ident val_ptr)) (ident value))))
  (func map_get ((param m (type_ptr (type_base u8))) (param key (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var keys_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident m) (number 16)))
      (var vals_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident m) (number 24)))
      (var keys (type_ptr (type_base u8)) (unop * (ident keys_ptr)))
      (var vals (type_ptr (type_base u8)) (unop * (ident vals_ptr)))
      (var idx (type_base i64) (call (ident map_find_slot) (ident m) (ident key)))
      (var slot (type_ptr (type_ptr (type_base u8))) (binop + (ident keys) (binop * (ident idx) (number 8))))
      (var slot_key (type_ptr (type_base u8)) (unop * (ident slot)))
      (if (binop == (ident slot_key) (nil))
        (block
          (return (number 0))))
      (var val_ptr (type_ptr (type_base i64)) (binop + (ident vals) (binop * (ident idx) (number 8))))
      (return (unop * (ident val_ptr)))))
  (func map_has ((param m (type_ptr (type_base u8))) (param key (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var keys_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident m) (number 16)))
      (var keys (type_ptr (type_base u8)) (unop * (ident keys_ptr)))
      (var idx (type_base i64) (call (ident map_find_slot) (ident m) (ident key)))
      (var slot (type_ptr (type_ptr (type_base u8))) (binop + (ident keys) (binop * (ident idx) (number 8))))
      (var slot_key (type_ptr (type_base u8)) (unop * (ident slot)))
      (if (binop == (ident slot_key) (nil))
        (block
          (return (number 0))))
      (return (number 1))))
  (func map_free ((param m (type_ptr (type_base u8)))) nil
    (block
      (var keys_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident m) (number 16)))
      (var vals_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident m) (number 24)))
      (expr_stmt (call (ident free) (unop * (ident keys_ptr))))
      (expr_stmt (call (ident free) (unop * (ident vals_ptr))))
      (expr_stmt (call (ident free) (ident m)))))
  (func str_dup_n ((param s (type_ptr (type_base u8))) (param len (type_base i64))) (type_ptr (type_base u8))
    (block
      (var result (type_ptr (type_base u8)) (call (ident malloc) (binop + (ident len) (number 1))))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident len))
        (block
          (assign (unop * (binop + (ident result) (ident i))) (unop * (binop + (ident s) (ident i))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (assign (unop * (binop + (ident result) (ident len))) (number 0))
      (return (ident result))))
  (func map_set_n ((param m (type_ptr (type_base u8))) (param key (type_ptr (type_base u8))) (param key_len (type_base i64)) (param value (type_base i64))) (type_base void)
    (block
      (var key_copy (type_ptr (type_base u8)) (call (ident str_dup_n) (ident key) (ident key_len)))
      (expr_stmt (call (ident map_set) (ident m) (ident key_copy) (ident value)))))
  (func map_get_n ((param m (type_ptr (type_base u8))) (param key (type_ptr (type_base u8))) (param key_len (type_base i64))) (type_base i64)
    (block
      (var key_copy (type_ptr (type_base u8)) (call (ident str_dup_n) (ident key) (ident key_len)))
      (var result (type_base i64) (call (ident map_get) (ident m) (ident key_copy)))
      (expr_stmt (call (ident free) (ident key_copy)))
      (return (ident result))))
  (func file_open ((param path (type_ptr (type_base u8))) (param flags (type_base i64))) (type_base i64)
    (block
      (return (call (ident syscall) (number 2) (ident path) (ident flags) (number 420)))))
  (func file_read ((param fd (type_base i64)) (param buf (type_ptr (type_base u8))) (param n (type_base i64))) (type_base i64)
    (block
      (return (call (ident syscall) (number 0) (ident fd) (ident buf) (ident n)))))
  (func file_write ((param fd (type_base i64)) (param buf (type_ptr (type_base u8))) (param n (type_base i64))) (type_base i64)
    (block
      (return (call (ident syscall) (number 1) (ident fd) (ident buf) (ident n)))))
  (func file_close ((param fd (type_base i64))) nil
    (block
      (expr_stmt (call (ident syscall) (number 3) (ident fd)))))
  (func strlen ((param s (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var n (type_base i64) (number 0))
      (while (binop != (unop * (binop + (ident s) (ident n))) (number 0))
        (block
          (assign (ident n) (binop + (ident n) (number 1)))))
      (return (ident n))))
  (func streq ((param a (type_ptr (type_base u8))) (param b (type_ptr (type_base u8)))) (type_base i64)
    (block
      (while (binop && (binop != (unop * (ident a)) (number 0)) (binop != (unop * (ident b)) (number 0)))
        (block
          (if (binop != (unop * (ident a)) (unop * (ident b)))
            (block
              (return (number 0))))
          (assign (ident a) (binop + (ident a) (number 1)))
          (assign (ident b) (binop + (ident b) (number 1)))))
      (if (binop == (unop * (ident a)) (unop * (ident b)))
        (block
          (return (number 1))))
      (return (number 0))))
  (func str_eq_n ((param a (type_ptr (type_base u8))) (param a_len (type_base i64)) (param b (type_ptr (type_base u8))) (param b_len (type_base i64))) (type_base bool)
    (block
      (if (binop != (ident a_len) (ident b_len))
        (block
          (return (bool false))))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident a_len))
        (block
          (if (binop != (unop * (binop + (ident a) (ident i))) (unop * (binop + (ident b) (ident i))))
            (block
              (return (bool false))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (bool true))))
  (func str_concat ((param a (type_ptr (type_base u8))) (param b (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var len_a (type_base i64) (call (ident strlen) (ident a)))
      (var len_b (type_base i64) (call (ident strlen) (ident b)))
      (var result (type_ptr (type_base u8)) (call (ident malloc) (binop + (binop + (ident len_a) (ident len_b)) (number 1))))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident len_a))
        (block
          (assign (unop * (binop + (ident result) (ident i))) (unop * (binop + (ident a) (ident i))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (var j (type_base i64) (number 0))
      (while (binop < (ident j) (ident len_b))
        (block
          (assign (unop * (binop + (binop + (ident result) (ident len_a)) (ident j))) (unop * (binop + (ident b) (ident j))))
          (assign (ident j) (binop + (ident j) (number 1)))))
      (assign (unop * (binop + (binop + (ident result) (ident len_a)) (ident len_b))) (number 0))
      (return (ident result))))
  (func str_dup ((param s (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var len (type_base i64) (call (ident strlen) (ident s)))
      (var result (type_ptr (type_base u8)) (call (ident malloc) (binop + (ident len) (number 1))))
      (var i (type_base i64) (number 0))
      (while (binop <= (ident i) (ident len))
        (block
          (assign (unop * (binop + (ident result) (ident i))) (unop * (binop + (ident s) (ident i))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (ident result))))
  (func print ((param s (type_ptr (type_base u8)))) nil
    (block
      (expr_stmt (call (ident file_write) (number 1) (ident s) (call (ident strlen) (ident s))))))
  (func println ((param s (type_ptr (type_base u8)))) nil
    (block
      (expr_stmt (call (ident print) (ident s)))
      (expr_stmt (call (ident file_write) (number 1) (string "\n") (number 1)))))
  (func eprint ((param s (type_ptr (type_base u8)))) nil
    (block
      (expr_stmt (call (ident file_write) (number 2) (ident s) (call (ident strlen) (ident s))))))
  (func eprintln ((param s (type_ptr (type_base u8)))) nil
    (block
      (expr_stmt (call (ident eprint) (ident s)))
      (expr_stmt (call (ident file_write) (number 2) (string "\n") (number 1)))))
  (func eprint_buf ((param buf (type_ptr (type_base u8))) (param len (type_base i64))) nil
    (block
      (expr_stmt (call (ident file_write) (number 2) (ident buf) (ident len)))))
  (func eprint_i64 ((param n (type_base i64))) nil
    (block
      (if (binop < (ident n) (number 0))
        (block
          (expr_stmt (call (ident file_write) (number 2) (string "-") (number 1)))
          (assign (ident n) (binop - (number 0) (ident n)))))
      (if (binop == (ident n) (number 0))
        (block
          (expr_stmt (call (ident file_write) (number 2) (string "0") (number 1)))
          (return)))
      (var divisor (type_base i64) (number 1))
      (var temp (type_base i64) (ident n))
      (while (binop >= (ident temp) (number 10))
        (block
          (assign (ident temp) (binop / (ident temp) (number 10)))
          (assign (ident divisor) (binop * (ident divisor) (number 10)))))
      (while (binop > (ident divisor) (number 0))
        (block
          (var digit (type_base i64) (binop / (ident n) (ident divisor)))
          (var c (type_base u8) (binop + (number 48) (ident digit)))
          (expr_stmt (call (ident file_write) (number 2) (unop & (ident c)) (number 1)))
          (assign (ident n) (binop % (ident n) (ident divisor)))
          (assign (ident divisor) (binop / (ident divisor) (number 10)))))))
  (func exit ((param code (type_base i64))) nil
    (block
      (expr_stmt (call (ident syscall) (number 60) (ident code)))))
  (func print_digit ((param d (type_base i64))) nil
    (block
      (var c (type_base u8) (binop + (number 48) (ident d)))
      (expr_stmt (call (ident file_write) (number 1) (unop & (ident c)) (number 1)))))
  (func print_int ((param n (type_base i64))) nil
    (block
      (if (binop < (ident n) (number 0))
        (block
          (expr_stmt (call (ident file_write) (number 1) (string "-") (number 1)))
          (assign (ident n) (binop - (number 0) (ident n)))))
      (if (binop == (ident n) (number 0))
        (block
          (expr_stmt (call (ident file_write) (number 1) (string "0") (number 1)))
          (return)))
      (var divisor (type_base i64) (number 1))
      (var temp (type_base i64) (ident n))
      (while (binop >= (ident temp) (number 10))
        (block
          (assign (ident temp) (binop / (ident temp) (number 10)))
          (assign (ident divisor) (binop * (ident divisor) (number 10)))))
      (while (binop > (ident divisor) (number 0))
        (block
          (var digit (type_base i64) (binop / (ident n) (ident divisor)))
          (expr_stmt (call (ident print_digit) (ident digit)))
          (assign (ident n) (binop % (ident n) (ident divisor)))
          (assign (ident divisor) (binop / (ident divisor) (number 10)))))))
  (func itoa ((param n (type_base i64)) (param buf (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var pos (type_base i64) (number 0))
      (if (binop < (ident n) (number 0))
        (block
          (assign (unop * (binop + (ident buf) (ident pos))) (number 45))
          (assign (ident pos) (binop + (ident pos) (number 1)))
          (assign (ident n) (binop - (number 0) (ident n)))))
      (if (binop == (ident n) (number 0))
        (block
          (assign (unop * (binop + (ident buf) (ident pos))) (number 48))
          (return (binop + (ident pos) (number 1)))))
      (var divisor (type_base i64) (number 1))
      (var temp (type_base i64) (ident n))
      (while (binop >= (ident temp) (number 10))
        (block
          (assign (ident temp) (binop / (ident temp) (number 10)))
          (assign (ident divisor) (binop * (ident divisor) (number 10)))))
      (while (binop > (ident divisor) (number 0))
        (block
          (var digit (type_base i64) (binop / (ident n) (ident divisor)))
          (assign (unop * (binop + (ident buf) (ident pos))) (binop + (number 48) (ident digit)))
          (assign (ident pos) (binop + (ident pos) (number 1)))
          (assign (ident n) (binop % (ident n) (ident divisor)))
          (assign (ident divisor) (binop / (ident divisor) (number 10)))))
      (return (ident pos))))
  (var TOKEN_EOF (type_base i64) (number 0))
  (var TOKEN_ERROR (type_base i64) (number 1))
  (var TOKEN_IDENT (type_base i64) (number 2))
  (var TOKEN_NUMBER (type_base i64) (number 3))
  (var TOKEN_STRING (type_base i64) (number 4))
  (var TOKEN_FUNC (type_base i64) (number 5))
  (var TOKEN_VAR (type_base i64) (number 6))
  (var TOKEN_STRUCT (type_base i64) (number 7))
  (var TOKEN_IF (type_base i64) (number 8))
  (var TOKEN_ELSE (type_base i64) (number 9))
  (var TOKEN_WHILE (type_base i64) (number 10))
  (var TOKEN_RETURN (type_base i64) (number 11))
  (var TOKEN_TRUE (type_base i64) (number 12))
  (var TOKEN_FALSE (type_base i64) (number 13))
  (var TOKEN_NIL (type_base i64) (number 14))
  (var TOKEN_I8 (type_base i64) (number 15))
  (var TOKEN_I16 (type_base i64) (number 16))
  (var TOKEN_I32 (type_base i64) (number 17))
  (var TOKEN_I64 (type_base i64) (number 18))
  (var TOKEN_U8 (type_base i64) (number 19))
  (var TOKEN_U16 (type_base i64) (number 20))
  (var TOKEN_U32 (type_base i64) (number 21))
  (var TOKEN_U64 (type_base i64) (number 22))
  (var TOKEN_BOOL (type_base i64) (number 23))
  (var TOKEN_VOID (type_base i64) (number 24))
  (var TOKEN_PLUS (type_base i64) (number 25))
  (var TOKEN_MINUS (type_base i64) (number 26))
  (var TOKEN_STAR (type_base i64) (number 27))
  (var TOKEN_SLASH (type_base i64) (number 28))
  (var TOKEN_PERCENT (type_base i64) (number 29))
  (var TOKEN_AMP (type_base i64) (number 30))
  (var TOKEN_BANG (type_base i64) (number 31))
  (var TOKEN_EQ (type_base i64) (number 32))
  (var TOKEN_EQEQ (type_base i64) (number 33))
  (var TOKEN_BANGEQ (type_base i64) (number 34))
  (var TOKEN_LT (type_base i64) (number 35))
  (var TOKEN_GT (type_base i64) (number 36))
  (var TOKEN_LTEQ (type_base i64) (number 37))
  (var TOKEN_GTEQ (type_base i64) (number 38))
  (var TOKEN_AMPAMP (type_base i64) (number 39))
  (var TOKEN_PIPEPIPE (type_base i64) (number 40))
  (var TOKEN_LPAREN (type_base i64) (number 41))
  (var TOKEN_RPAREN (type_base i64) (number 42))
  (var TOKEN_LBRACE (type_base i64) (number 43))
  (var TOKEN_RBRACE (type_base i64) (number 44))
  (var TOKEN_LBRACKET (type_base i64) (number 45))
  (var TOKEN_RBRACKET (type_base i64) (number 46))
  (var TOKEN_COMMA (type_base i64) (number 47))
  (var TOKEN_SEMICOLON (type_base i64) (number 48))
  (var TOKEN_DOT (type_base i64) (number 49))
  (var TOKEN_COLON (type_base i64) (number 50))
  (var TOKEN_COLONEQ (type_base i64) (number 51))
  (var TOKEN_MACRO (type_base i64) (number 52))
  (var TOKEN_DOLLAR_LBRACE (type_base i64) (number 53))
  (var TOKEN_DOLLAR (type_base i64) (number 54))
  (var TOKEN_DOLLAR_AT (type_base i64) (number 55))
  (var TOKEN_IMPORT (type_base i64) (number 56))
  (var TOKEN_READER (type_base i64) (number 57))
  (var TOKEN_READER_MACRO (type_base i64) (number 58))
  (var TOKEN_INCLUDE (type_base i64) (number 59))
  (var TOKEN_PIPE (type_base i64) (number 60))
  (var TOKEN_CARET (type_base i64) (number 61))
  (var TOKEN_LTLT (type_base i64) (number 62))
  (var TOKEN_GTGT (type_base i64) (number 63))
  (var TOKEN_PLUSEQ (type_base i64) (number 64))
  (var TOKEN_MINUSEQ (type_base i64) (number 65))
  (var TOKEN_STAREQ (type_base i64) (number 66))
  (var TOKEN_SLASHEQ (type_base i64) (number 67))
  (var TOKEN_PERCENTEQ (type_base i64) (number 68))
  (var TOKEN_BREAK (type_base i64) (number 69))
  (var TOKEN_CONTINUE (type_base i64) (number 70))
  (var TOKEN_LET (type_base i64) (number 71))
  (var TOKEN_IN (type_base i64) (number 72))
  (var TOKEN_FN (type_base i64) (number 73))
  (var TOKEN_ENUM (type_base i64) (number 74))
  (var TOKEN_MATCH (type_base i64) (number 75))
  (var TOKEN_ARROW (type_base i64) (number 76))
  (var TOKEN_EFFECT (type_base i64) (number 77))
  (var TOKEN_PERFORM (type_base i64) (number 78))
  (var TOKEN_HANDLE (type_base i64) (number 79))
  (var TOKEN_WITH (type_base i64) (number 80))
  (var TOKEN_RESUME (type_base i64) (number 81))
  (var TOKEN_CLOSURE (type_base i64) (number 82))
  (struct Token ((field_decl type_tok (type_base i64)) (field_decl lexeme (type_ptr (type_base u8))) (field_decl lexeme_len (type_base i64)) (field_decl line (type_base i64)) (field_decl col (type_base i64)) (field_decl content (type_ptr (type_base u8))) (field_decl content_len (type_base i64))))
  (func tok_type ((param tok (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (return (field (ident t) type_tok))))
  (func tok_set_type ((param tok (type_ptr (type_base u8))) (param typ (type_base i64))) (type_base void)
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (assign (field (ident t) type_tok) (ident typ))))
  (func tok_lexeme ((param tok (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (return (field (ident t) lexeme))))
  (func tok_set_lexeme ((param tok (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (assign (field (ident t) lexeme) (ident ptr))))
  (func tok_lexeme_len ((param tok (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (return (field (ident t) lexeme_len))))
  (func tok_set_lexeme_len ((param tok (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (assign (field (ident t) lexeme_len) (ident len))))
  (func tok_line ((param tok (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (return (field (ident t) line))))
  (func tok_set_line ((param tok (type_ptr (type_base u8))) (param ln (type_base i64))) (type_base void)
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (assign (field (ident t) line) (ident ln))))
  (func tok_col ((param tok (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (return (field (ident t) col))))
  (func tok_set_col ((param tok (type_ptr (type_base u8))) (param c (type_base i64))) (type_base void)
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (assign (field (ident t) col) (ident c))))
  (func tok_content ((param tok (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (return (field (ident t) content))))
  (func tok_set_content ((param tok (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (assign (field (ident t) content) (ident ptr))))
  (func tok_content_len ((param tok (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (return (field (ident t) content_len))))
  (func tok_set_content_len ((param tok (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var t (type_ptr (type_base Token)) (ident tok))
      (assign (field (ident t) content_len) (ident len))))
  (func tok_alloc () (type_ptr (type_base u8))
    (block
      (return (call (ident alloc) (number 56)))))
  (var lex_source (type_ptr (type_base u8)) (nil))
  (var lex_source_len (type_base i64) (number 0))
  (var lex_start (type_base i64) (number 0))
  (var lex_current (type_base i64) (number 0))
  (var lex_line (type_base i64) (number 1))
  (var lex_col (type_base i64) (number 1))
  (var lex_start_col (type_base i64) (number 1))
  (func lexer_init ((param source (type_ptr (type_base u8)))) (type_base void)
    (block
      (assign (ident lex_source) (ident source))
      (assign (ident lex_source_len) (call (ident strlen) (ident source)))
      (assign (ident lex_start) (number 0))
      (assign (ident lex_current) (number 0))
      (assign (ident lex_line) (number 1))
      (assign (ident lex_col) (number 1))
      (assign (ident lex_start_col) (number 1))))
  (func is_alpha ((param c (type_base u8))) (type_base bool)
    (block
      (if (binop >= (ident c) (number 97))
        (block
          (if (binop <= (ident c) (number 122))
            (block
              (return (bool true))))))
      (if (binop >= (ident c) (number 65))
        (block
          (if (binop <= (ident c) (number 90))
            (block
              (return (bool true))))))
      (if (binop == (ident c) (number 95))
        (block
          (return (bool true))))
      (return (bool false))))
  (func is_digit ((param c (type_base u8))) (type_base bool)
    (block
      (if (binop >= (ident c) (number 48))
        (block
          (if (binop <= (ident c) (number 57))
            (block
              (return (bool true))))))
      (return (bool false))))
  (func is_alphanumeric ((param c (type_base u8))) (type_base bool)
    (block
      (return (binop || (call (ident is_alpha) (ident c)) (call (ident is_digit) (ident c))))))
  (func lex_is_at_end () (type_base bool)
    (block
      (return (binop >= (ident lex_current) (ident lex_source_len)))))
  (func lex_peek () (type_base u8)
    (block
      (if (call (ident lex_is_at_end))
        (block
          (return (number 0))))
      (return (unop * (binop + (ident lex_source) (ident lex_current))))))
  (func lex_peek_next () (type_base u8)
    (block
      (if (binop >= (binop + (ident lex_current) (number 1)) (ident lex_source_len))
        (block
          (return (number 0))))
      (return (unop * (binop + (binop + (ident lex_source) (ident lex_current)) (number 1))))))
  (func lex_advance () (type_base u8)
    (block
      (var c (type_base u8) (unop * (binop + (ident lex_source) (ident lex_current))))
      (assign (ident lex_current) (binop + (ident lex_current) (number 1)))
      (assign (ident lex_col) (binop + (ident lex_col) (number 1)))
      (return (ident c))))
  (func lex_match ((param expected (type_base u8))) (type_base bool)
    (block
      (if (call (ident lex_is_at_end))
        (block
          (return (bool false))))
      (if (binop != (unop * (binop + (ident lex_source) (ident lex_current))) (ident expected))
        (block
          (return (bool false))))
      (assign (ident lex_current) (binop + (ident lex_current) (number 1)))
      (assign (ident lex_col) (binop + (ident lex_col) (number 1)))
      (return (bool true))))
  (func make_token ((param tok_type (type_base i64))) (type_ptr (type_base u8))
    (block
      (var tok (type_ptr (type_base u8)) (call (ident tok_alloc)))
      (expr_stmt (call (ident tok_set_type) (ident tok) (ident tok_type)))
      (expr_stmt (call (ident tok_set_lexeme) (ident tok) (binop + (ident lex_source) (ident lex_start))))
      (expr_stmt (call (ident tok_set_lexeme_len) (ident tok) (binop - (ident lex_current) (ident lex_start))))
      (expr_stmt (call (ident tok_set_line) (ident tok) (ident lex_line)))
      (expr_stmt (call (ident tok_set_col) (ident tok) (ident lex_start_col)))
      (return (ident tok))))
  (func error_token ((param msg (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var tok (type_ptr (type_base u8)) (call (ident tok_alloc)))
      (expr_stmt (call (ident tok_set_type) (ident tok) (ident TOKEN_ERROR)))
      (expr_stmt (call (ident tok_set_lexeme) (ident tok) (ident msg)))
      (expr_stmt (call (ident tok_set_lexeme_len) (ident tok) (call (ident strlen) (ident msg))))
      (expr_stmt (call (ident tok_set_line) (ident tok) (ident lex_line)))
      (expr_stmt (call (ident tok_set_col) (ident tok) (ident lex_start_col)))
      (return (ident tok))))
  (func skip_block_comment () (type_base void)
    (block
      (expr_stmt (call (ident lex_advance)))
      (expr_stmt (call (ident lex_advance)))
      (var done (type_base i64) (number 0))
      (while (binop && (unop ! (call (ident lex_is_at_end))) (binop == (ident done) (number 0)))
        (block
          (if (binop && (binop == (call (ident lex_peek)) (number 42)) (binop == (call (ident lex_peek_next)) (number 47)))
            (block
              (expr_stmt (call (ident lex_advance)))
              (expr_stmt (call (ident lex_advance)))
              (assign (ident done) (number 1)))
            (block
              (if (binop == (call (ident lex_peek)) (number 10))
                (block
                  (assign (ident lex_line) (binop + (ident lex_line) (number 1)))
                  (assign (ident lex_col) (number 0))))
              (expr_stmt (call (ident lex_advance)))))))))
  (func skip_whitespace () (type_base void)
    (block
      (var done (type_base i64) (number 0))
      (while (binop == (ident done) (number 0))
        (block
          (if (call (ident lex_is_at_end))
            (block
              (assign (ident done) (number 1)))
            (block
              (var c (type_base u8) (call (ident lex_peek)))
              (if (binop || (binop || (binop == (ident c) (number 32)) (binop == (ident c) (number 9))) (binop == (ident c) (number 13)))
                (block
                  (expr_stmt (call (ident lex_advance))))
                (if (binop == (ident c) (number 10))
                  (block
                    (assign (ident lex_line) (binop + (ident lex_line) (number 1)))
                    (assign (ident lex_col) (number 0))
                    (expr_stmt (call (ident lex_advance))))
                  (if (binop == (ident c) (number 47))
                    (block
                      (if (binop == (call (ident lex_peek_next)) (number 47))
                        (block
                          (while (binop && (unop ! (call (ident lex_is_at_end))) (binop != (call (ident lex_peek)) (number 10)))
                            (block
                              (expr_stmt (call (ident lex_advance))))))
                        (if (binop == (call (ident lex_peek_next)) (number 42))
                          (block
                            (expr_stmt (call (ident skip_block_comment))))
                          (block
                            (assign (ident done) (number 1))))))
                    (block
                      (assign (ident done) (number 1))))))))))))
  (func lexeme_eq ((param kw (type_ptr (type_base u8)))) (type_base bool)
    (block
      (var kw_len (type_base i64) (call (ident strlen) (ident kw)))
      (var lex_len (type_base i64) (binop - (ident lex_current) (ident lex_start)))
      (if (binop != (ident kw_len) (ident lex_len))
        (block
          (return (bool false))))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident kw_len))
        (block
          (if (binop != (unop * (binop + (binop + (ident lex_source) (ident lex_start)) (ident i))) (unop * (binop + (ident kw) (ident i))))
            (block
              (return (bool false))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (bool true))))
  (func check_keyword () (type_base i64)
    (block
      (if (call (ident lexeme_eq) (string "func"))
        (block
          (return (ident TOKEN_FUNC))))
      (if (call (ident lexeme_eq) (string "var"))
        (block
          (return (ident TOKEN_VAR))))
      (if (call (ident lexeme_eq) (string "struct"))
        (block
          (return (ident TOKEN_STRUCT))))
      (if (call (ident lexeme_eq) (string "macro"))
        (block
          (return (ident TOKEN_MACRO))))
      (if (call (ident lexeme_eq) (string "reader"))
        (block
          (return (ident TOKEN_READER))))
      (if (call (ident lexeme_eq) (string "import"))
        (block
          (return (ident TOKEN_IMPORT))))
      (if (call (ident lexeme_eq) (string "include"))
        (block
          (return (ident TOKEN_INCLUDE))))
      (if (call (ident lexeme_eq) (string "if"))
        (block
          (return (ident TOKEN_IF))))
      (if (call (ident lexeme_eq) (string "else"))
        (block
          (return (ident TOKEN_ELSE))))
      (if (call (ident lexeme_eq) (string "while"))
        (block
          (return (ident TOKEN_WHILE))))
      (if (call (ident lexeme_eq) (string "return"))
        (block
          (return (ident TOKEN_RETURN))))
      (if (call (ident lexeme_eq) (string "break"))
        (block
          (return (ident TOKEN_BREAK))))
      (if (call (ident lexeme_eq) (string "continue"))
        (block
          (return (ident TOKEN_CONTINUE))))
      (if (call (ident lexeme_eq) (string "let"))
        (block
          (return (ident TOKEN_LET))))
      (if (call (ident lexeme_eq) (string "in"))
        (block
          (return (ident TOKEN_IN))))
      (if (call (ident lexeme_eq) (string "fn"))
        (block
          (return (ident TOKEN_FN))))
      (if (call (ident lexeme_eq) (string "enum"))
        (block
          (return (ident TOKEN_ENUM))))
      (if (call (ident lexeme_eq) (string "match"))
        (block
          (return (ident TOKEN_MATCH))))
      (if (call (ident lexeme_eq) (string "effect"))
        (block
          (return (ident TOKEN_EFFECT))))
      (if (call (ident lexeme_eq) (string "perform"))
        (block
          (return (ident TOKEN_PERFORM))))
      (if (call (ident lexeme_eq) (string "handle"))
        (block
          (return (ident TOKEN_HANDLE))))
      (if (call (ident lexeme_eq) (string "with"))
        (block
          (return (ident TOKEN_WITH))))
      (if (call (ident lexeme_eq) (string "resume"))
        (block
          (return (ident TOKEN_RESUME))))
      (if (call (ident lexeme_eq) (string "closure"))
        (block
          (return (ident TOKEN_CLOSURE))))
      (if (call (ident lexeme_eq) (string "true"))
        (block
          (return (ident TOKEN_TRUE))))
      (if (call (ident lexeme_eq) (string "false"))
        (block
          (return (ident TOKEN_FALSE))))
      (if (call (ident lexeme_eq) (string "nil"))
        (block
          (return (ident TOKEN_NIL))))
      (if (call (ident lexeme_eq) (string "i8"))
        (block
          (return (ident TOKEN_I8))))
      (if (call (ident lexeme_eq) (string "i16"))
        (block
          (return (ident TOKEN_I16))))
      (if (call (ident lexeme_eq) (string "i32"))
        (block
          (return (ident TOKEN_I32))))
      (if (call (ident lexeme_eq) (string "i64"))
        (block
          (return (ident TOKEN_I64))))
      (if (call (ident lexeme_eq) (string "u8"))
        (block
          (return (ident TOKEN_U8))))
      (if (call (ident lexeme_eq) (string "u16"))
        (block
          (return (ident TOKEN_U16))))
      (if (call (ident lexeme_eq) (string "u32"))
        (block
          (return (ident TOKEN_U32))))
      (if (call (ident lexeme_eq) (string "u64"))
        (block
          (return (ident TOKEN_U64))))
      (if (call (ident lexeme_eq) (string "bool"))
        (block
          (return (ident TOKEN_BOOL))))
      (if (call (ident lexeme_eq) (string "void"))
        (block
          (return (ident TOKEN_VOID))))
      (if (call (ident lexeme_eq) (string "syscall"))
        (block
          (return (ident TOKEN_IDENT))))
      (return (ident TOKEN_IDENT))))
  (func scan_identifier () (type_ptr (type_base u8))
    (block
      (while (call (ident is_alphanumeric) (call (ident lex_peek)))
        (block
          (expr_stmt (call (ident lex_advance)))))
      (return (call (ident make_token) (call (ident check_keyword))))))
  (func scan_number () (type_ptr (type_base u8))
    (block
      (while (call (ident is_digit) (call (ident lex_peek)))
        (block
          (expr_stmt (call (ident lex_advance)))))
      (return (call (ident make_token) (ident TOKEN_NUMBER)))))
  (func scan_string () (type_ptr (type_base u8))
    (block
      (while (binop && (unop ! (call (ident lex_is_at_end))) (binop != (call (ident lex_peek)) (number 34)))
        (block
          (if (binop == (call (ident lex_peek)) (number 10))
            (block
              (assign (ident lex_line) (binop + (ident lex_line) (number 1)))
              (assign (ident lex_col) (number 0))))
          (if (binop && (binop == (call (ident lex_peek)) (number 92)) (binop != (call (ident lex_peek_next)) (number 0)))
            (block
              (expr_stmt (call (ident lex_advance)))))
          (expr_stmt (call (ident lex_advance)))))
      (if (call (ident lex_is_at_end))
        (block
          (return (call (ident error_token) (string "unterminated string")))))
      (expr_stmt (call (ident lex_advance)))
      (return (call (ident make_token) (ident TOKEN_STRING)))))
  (func scan_char () (type_ptr (type_base u8))
    (block
      (if (call (ident lex_is_at_end))
        (block
          (return (call (ident error_token) (string "unterminated character literal")))))
      (var c (type_base u8) (call (ident lex_advance)))
      (var value (type_base i64) (number 0))
      (if (binop == (ident c) (number 92))
        (block
          (if (call (ident lex_is_at_end))
            (block
              (return (call (ident error_token) (string "unterminated escape in character literal")))))
          (var esc (type_base u8) (call (ident lex_advance)))
          (if (binop == (ident esc) (number 110))
            (block
              (assign (ident value) (number 10)))
            (if (binop == (ident esc) (number 116))
              (block
                (assign (ident value) (number 9)))
              (if (binop == (ident esc) (number 114))
                (block
                  (assign (ident value) (number 13)))
                (if (binop == (ident esc) (number 48))
                  (block
                    (assign (ident value) (number 0)))
                  (if (binop == (ident esc) (number 92))
                    (block
                      (assign (ident value) (number 92)))
                    (if (binop == (ident esc) (number 39))
                      (block
                        (assign (ident value) (number 39)))
                      (if (binop == (ident esc) (number 34))
                        (block
                          (assign (ident value) (number 34)))
                        (block
                          (return (call (ident error_token) (string "unknown escape sequence"))))))))))))
        (block
          (assign (ident value) (ident c))))
      (if (binop || (call (ident lex_is_at_end)) (binop != (call (ident lex_peek)) (number 39)))
        (block
          (return (call (ident error_token) (string "unterminated character literal")))))
      (expr_stmt (call (ident lex_advance)))
      (var buf (type_ptr (type_base u8)) (call (ident alloc) (number 16)))
      (var len (type_base i64) (call (ident itoa) (ident value) (ident buf)))
      (var tok (type_ptr (type_base u8)) (call (ident tok_alloc)))
      (expr_stmt (call (ident tok_set_type) (ident tok) (ident TOKEN_NUMBER)))
      (expr_stmt (call (ident tok_set_lexeme) (ident tok) (ident buf)))
      (expr_stmt (call (ident tok_set_lexeme_len) (ident tok) (ident len)))
      (expr_stmt (call (ident tok_set_line) (ident tok) (ident lex_line)))
      (expr_stmt (call (ident tok_set_col) (ident tok) (ident lex_start_col)))
      (return (ident tok))))
  (func scan_reader_macro () (type_ptr (type_base u8))
    (block
      (var name_start (type_base i64) (ident lex_current))
      (if (unop ! (call (ident is_alpha) (call (ident lex_peek))))
        (block
          (return (call (ident error_token) (string "expected identifier after '#'")))))
      (while (call (ident is_alphanumeric) (call (ident lex_peek)))
        (block
          (expr_stmt (call (ident lex_advance)))))
      (var name_end (type_base i64) (ident lex_current))
      (var name_len (type_base i64) (binop - (ident name_end) (ident name_start)))
      (if (binop != (call (ident lex_peek)) (number 123))
        (block
          (return (call (ident error_token) (string "expected '{' after reader macro name")))))
      (expr_stmt (call (ident lex_advance)))
      (var content_start (type_base i64) (ident lex_current))
      (var brace_depth (type_base i64) (number 1))
      (while (binop && (unop ! (call (ident lex_is_at_end))) (binop > (ident brace_depth) (number 0)))
        (block
          (var c (type_base u8) (call (ident lex_peek)))
          (if (binop == (ident c) (number 123))
            (block
              (assign (ident brace_depth) (binop + (ident brace_depth) (number 1)))
              (expr_stmt (call (ident lex_advance))))
            (if (binop == (ident c) (number 125))
              (block
                (assign (ident brace_depth) (binop - (ident brace_depth) (number 1)))
                (if (binop > (ident brace_depth) (number 0))
                  (block
                    (expr_stmt (call (ident lex_advance))))))
              (if (binop == (ident c) (number 34))
                (block
                  (expr_stmt (call (ident lex_advance)))
                  (while (binop && (unop ! (call (ident lex_is_at_end))) (binop != (call (ident lex_peek)) (number 34)))
                    (block
                      (if (binop && (binop == (call (ident lex_peek)) (number 92)) (binop != (call (ident lex_peek_next)) (number 0)))
                        (block
                          (expr_stmt (call (ident lex_advance)))))
                      (if (binop == (call (ident lex_peek)) (number 10))
                        (block
                          (assign (ident lex_line) (binop + (ident lex_line) (number 1)))
                          (assign (ident lex_col) (number 0))))
                      (expr_stmt (call (ident lex_advance)))))
                  (if (unop ! (call (ident lex_is_at_end)))
                    (block
                      (expr_stmt (call (ident lex_advance))))))
                (if (binop == (ident c) (number 10))
                  (block
                    (assign (ident lex_line) (binop + (ident lex_line) (number 1)))
                    (assign (ident lex_col) (number 0))
                    (expr_stmt (call (ident lex_advance))))
                  (block
                    (expr_stmt (call (ident lex_advance))))))))))
      (if (binop != (ident brace_depth) (number 0))
        (block
          (return (call (ident error_token) (string "unterminated reader macro content")))))
      (var content_end (type_base i64) (ident lex_current))
      (expr_stmt (call (ident lex_advance)))
      (var tok (type_ptr (type_base u8)) (call (ident tok_alloc)))
      (expr_stmt (call (ident tok_set_type) (ident tok) (ident TOKEN_READER_MACRO)))
      (expr_stmt (call (ident tok_set_lexeme) (ident tok) (binop + (ident lex_source) (ident name_start))))
      (expr_stmt (call (ident tok_set_lexeme_len) (ident tok) (ident name_len)))
      (expr_stmt (call (ident tok_set_line) (ident tok) (ident lex_line)))
      (expr_stmt (call (ident tok_set_col) (ident tok) (ident lex_start_col)))
      (expr_stmt (call (ident tok_set_content) (ident tok) (binop + (ident lex_source) (ident content_start))))
      (expr_stmt (call (ident tok_set_content_len) (ident tok) (binop - (ident content_end) (ident content_start))))
      (return (ident tok))))
  (func scan_token () (type_ptr (type_base u8))
    (block
      (expr_stmt (call (ident skip_whitespace)))
      (assign (ident lex_start) (ident lex_current))
      (assign (ident lex_start_col) (ident lex_col))
      (if (call (ident lex_is_at_end))
        (block
          (return (call (ident make_token) (ident TOKEN_EOF)))))
      (var c (type_base u8) (call (ident lex_advance)))
      (if (call (ident is_alpha) (ident c))
        (block
          (return (call (ident scan_identifier)))))
      (if (call (ident is_digit) (ident c))
        (block
          (return (call (ident scan_number)))))
      (if (binop == (ident c) (number 40))
        (block
          (return (call (ident make_token) (ident TOKEN_LPAREN)))))
      (if (binop == (ident c) (number 41))
        (block
          (return (call (ident make_token) (ident TOKEN_RPAREN)))))
      (if (binop == (ident c) (number 123))
        (block
          (return (call (ident make_token) (ident TOKEN_LBRACE)))))
      (if (binop == (ident c) (number 125))
        (block
          (return (call (ident make_token) (ident TOKEN_RBRACE)))))
      (if (binop == (ident c) (number 91))
        (block
          (return (call (ident make_token) (ident TOKEN_LBRACKET)))))
      (if (binop == (ident c) (number 93))
        (block
          (return (call (ident make_token) (ident TOKEN_RBRACKET)))))
      (if (binop == (ident c) (number 44))
        (block
          (return (call (ident make_token) (ident TOKEN_COMMA)))))
      (if (binop == (ident c) (number 59))
        (block
          (return (call (ident make_token) (ident TOKEN_SEMICOLON)))))
      (if (binop == (ident c) (number 46))
        (block
          (return (call (ident make_token) (ident TOKEN_DOT)))))
      (if (binop == (ident c) (number 43))
        (block
          (if (call (ident lex_match) (number 61))
            (block
              (return (call (ident make_token) (ident TOKEN_PLUSEQ)))))
          (return (call (ident make_token) (ident TOKEN_PLUS)))))
      (if (binop == (ident c) (number 45))
        (block
          (if (call (ident lex_match) (number 61))
            (block
              (return (call (ident make_token) (ident TOKEN_MINUSEQ)))))
          (return (call (ident make_token) (ident TOKEN_MINUS)))))
      (if (binop == (ident c) (number 42))
        (block
          (if (call (ident lex_match) (number 61))
            (block
              (return (call (ident make_token) (ident TOKEN_STAREQ)))))
          (return (call (ident make_token) (ident TOKEN_STAR)))))
      (if (binop == (ident c) (number 47))
        (block
          (if (call (ident lex_match) (number 61))
            (block
              (return (call (ident make_token) (ident TOKEN_SLASHEQ)))))
          (return (call (ident make_token) (ident TOKEN_SLASH)))))
      (if (binop == (ident c) (number 37))
        (block
          (if (call (ident lex_match) (number 61))
            (block
              (return (call (ident make_token) (ident TOKEN_PERCENTEQ)))))
          (return (call (ident make_token) (ident TOKEN_PERCENT)))))
      (if (binop == (ident c) (number 38))
        (block
          (if (call (ident lex_match) (number 38))
            (block
              (return (call (ident make_token) (ident TOKEN_AMPAMP)))))
          (return (call (ident make_token) (ident TOKEN_AMP)))))
      (if (binop == (ident c) (number 124))
        (block
          (if (call (ident lex_match) (number 124))
            (block
              (return (call (ident make_token) (ident TOKEN_PIPEPIPE)))))
          (return (call (ident make_token) (ident TOKEN_PIPE)))))
      (if (binop == (ident c) (number 94))
        (block
          (return (call (ident make_token) (ident TOKEN_CARET)))))
      (if (binop == (ident c) (number 33))
        (block
          (if (call (ident lex_match) (number 61))
            (block
              (return (call (ident make_token) (ident TOKEN_BANGEQ)))))
          (return (call (ident make_token) (ident TOKEN_BANG)))))
      (if (binop == (ident c) (number 61))
        (block
          (if (call (ident lex_match) (number 62))
            (block
              (return (call (ident make_token) (ident TOKEN_ARROW)))))
          (if (call (ident lex_match) (number 61))
            (block
              (return (call (ident make_token) (ident TOKEN_EQEQ)))))
          (return (call (ident make_token) (ident TOKEN_EQ)))))
      (if (binop == (ident c) (number 60))
        (block
          (if (call (ident lex_match) (number 60))
            (block
              (return (call (ident make_token) (ident TOKEN_LTLT)))))
          (if (call (ident lex_match) (number 61))
            (block
              (return (call (ident make_token) (ident TOKEN_LTEQ)))))
          (return (call (ident make_token) (ident TOKEN_LT)))))
      (if (binop == (ident c) (number 62))
        (block
          (if (call (ident lex_match) (number 62))
            (block
              (return (call (ident make_token) (ident TOKEN_GTGT)))))
          (if (call (ident lex_match) (number 61))
            (block
              (return (call (ident make_token) (ident TOKEN_GTEQ)))))
          (return (call (ident make_token) (ident TOKEN_GT)))))
      (if (binop == (ident c) (number 58))
        (block
          (if (call (ident lex_match) (number 61))
            (block
              (return (call (ident make_token) (ident TOKEN_COLONEQ)))))
          (return (call (ident make_token) (ident TOKEN_COLON)))))
      (if (binop == (ident c) (number 36))
        (block
          (if (call (ident lex_match) (number 123))
            (block
              (return (call (ident make_token) (ident TOKEN_DOLLAR_LBRACE)))))
          (if (call (ident lex_match) (number 64))
            (block
              (return (call (ident make_token) (ident TOKEN_DOLLAR_AT)))))
          (return (call (ident make_token) (ident TOKEN_DOLLAR)))))
      (if (binop == (ident c) (number 35))
        (block
          (return (call (ident scan_reader_macro)))))
      (if (binop == (ident c) (number 34))
        (block
          (return (call (ident scan_string)))))
      (if (binop == (ident c) (number 39))
        (block
          (return (call (ident scan_char)))))
      (return (call (ident error_token) (string "unexpected character")))))
  (func print_token_type ((param t (type_base i64))) (type_base void)
    (block
      (if (binop == (ident t) (ident TOKEN_EOF))
        (block
          (expr_stmt (call (ident print) (string "EOF")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_ERROR))
        (block
          (expr_stmt (call (ident print) (string "ERROR")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_IDENT))
        (block
          (expr_stmt (call (ident print) (string "IDENT")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_NUMBER))
        (block
          (expr_stmt (call (ident print) (string "NUMBER")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_STRING))
        (block
          (expr_stmt (call (ident print) (string "STRING")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_FUNC))
        (block
          (expr_stmt (call (ident print) (string "func")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_VAR))
        (block
          (expr_stmt (call (ident print) (string "var")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_STRUCT))
        (block
          (expr_stmt (call (ident print) (string "struct")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_IF))
        (block
          (expr_stmt (call (ident print) (string "if")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_ELSE))
        (block
          (expr_stmt (call (ident print) (string "else")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_WHILE))
        (block
          (expr_stmt (call (ident print) (string "while")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_RETURN))
        (block
          (expr_stmt (call (ident print) (string "return")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_TRUE))
        (block
          (expr_stmt (call (ident print) (string "true")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_FALSE))
        (block
          (expr_stmt (call (ident print) (string "false")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_NIL))
        (block
          (expr_stmt (call (ident print) (string "nil")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_I8))
        (block
          (expr_stmt (call (ident print) (string "i8")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_I16))
        (block
          (expr_stmt (call (ident print) (string "i16")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_I32))
        (block
          (expr_stmt (call (ident print) (string "i32")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_I64))
        (block
          (expr_stmt (call (ident print) (string "i64")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_U8))
        (block
          (expr_stmt (call (ident print) (string "u8")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_U16))
        (block
          (expr_stmt (call (ident print) (string "u16")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_U32))
        (block
          (expr_stmt (call (ident print) (string "u32")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_U64))
        (block
          (expr_stmt (call (ident print) (string "u64")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_BOOL))
        (block
          (expr_stmt (call (ident print) (string "bool")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_VOID))
        (block
          (expr_stmt (call (ident print) (string "void")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_PLUS))
        (block
          (expr_stmt (call (ident print) (string "+")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_MINUS))
        (block
          (expr_stmt (call (ident print) (string "-")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_STAR))
        (block
          (expr_stmt (call (ident print) (string "*")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_SLASH))
        (block
          (expr_stmt (call (ident print) (string "/")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_PERCENT))
        (block
          (expr_stmt (call (ident print) (string "%")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_AMP))
        (block
          (expr_stmt (call (ident print) (string "&")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_BANG))
        (block
          (expr_stmt (call (ident print) (string "!")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_EQ))
        (block
          (expr_stmt (call (ident print) (string "=")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_EQEQ))
        (block
          (expr_stmt (call (ident print) (string "==")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_BANGEQ))
        (block
          (expr_stmt (call (ident print) (string "!=")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_LT))
        (block
          (expr_stmt (call (ident print) (string "<")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_GT))
        (block
          (expr_stmt (call (ident print) (string ">")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_LTEQ))
        (block
          (expr_stmt (call (ident print) (string "<=")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_GTEQ))
        (block
          (expr_stmt (call (ident print) (string ">=")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_AMPAMP))
        (block
          (expr_stmt (call (ident print) (string "&&")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_PIPEPIPE))
        (block
          (expr_stmt (call (ident print) (string "||")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_LPAREN))
        (block
          (expr_stmt (call (ident print) (string "(")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_RPAREN))
        (block
          (expr_stmt (call (ident print) (string ")")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_LBRACE))
        (block
          (expr_stmt (call (ident print) (string "{")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_RBRACE))
        (block
          (expr_stmt (call (ident print) (string "}")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_LBRACKET))
        (block
          (expr_stmt (call (ident print) (string "[")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_RBRACKET))
        (block
          (expr_stmt (call (ident print) (string "]")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_COMMA))
        (block
          (expr_stmt (call (ident print) (string ",")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_SEMICOLON))
        (block
          (expr_stmt (call (ident print) (string ";")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_DOT))
        (block
          (expr_stmt (call (ident print) (string ".")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_COLON))
        (block
          (expr_stmt (call (ident print) (string ":")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_COLONEQ))
        (block
          (expr_stmt (call (ident print) (string ":=")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_MACRO))
        (block
          (expr_stmt (call (ident print) (string "macro")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_DOLLAR_LBRACE))
        (block
          (expr_stmt (call (ident print) (string "${")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_DOLLAR))
        (block
          (expr_stmt (call (ident print) (string "$")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_DOLLAR_AT))
        (block
          (expr_stmt (call (ident print) (string "$@")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_IMPORT))
        (block
          (expr_stmt (call (ident print) (string "import")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_READER))
        (block
          (expr_stmt (call (ident print) (string "reader")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_READER_MACRO))
        (block
          (expr_stmt (call (ident print) (string "READER_MACRO")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_INCLUDE))
        (block
          (expr_stmt (call (ident print) (string "include")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_PIPE))
        (block
          (expr_stmt (call (ident print) (string "|")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_CARET))
        (block
          (expr_stmt (call (ident print) (string "^")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_LTLT))
        (block
          (expr_stmt (call (ident print) (string "<<")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_GTGT))
        (block
          (expr_stmt (call (ident print) (string ">>")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_PLUSEQ))
        (block
          (expr_stmt (call (ident print) (string "+=")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_MINUSEQ))
        (block
          (expr_stmt (call (ident print) (string "-=")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_STAREQ))
        (block
          (expr_stmt (call (ident print) (string "*=")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_SLASHEQ))
        (block
          (expr_stmt (call (ident print) (string "/=")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_PERCENTEQ))
        (block
          (expr_stmt (call (ident print) (string "%=")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_BREAK))
        (block
          (expr_stmt (call (ident print) (string "break")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_CONTINUE))
        (block
          (expr_stmt (call (ident print) (string "continue")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_LET))
        (block
          (expr_stmt (call (ident print) (string "let")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_IN))
        (block
          (expr_stmt (call (ident print) (string "in")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_FN))
        (block
          (expr_stmt (call (ident print) (string "fn")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_ENUM))
        (block
          (expr_stmt (call (ident print) (string "enum")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_MATCH))
        (block
          (expr_stmt (call (ident print) (string "match")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_ARROW))
        (block
          (expr_stmt (call (ident print) (string "=>")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_EFFECT))
        (block
          (expr_stmt (call (ident print) (string "effect")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_PERFORM))
        (block
          (expr_stmt (call (ident print) (string "perform")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_HANDLE))
        (block
          (expr_stmt (call (ident print) (string "handle")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_WITH))
        (block
          (expr_stmt (call (ident print) (string "with")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_RESUME))
        (block
          (expr_stmt (call (ident print) (string "resume")))
          (return)))
      (if (binop == (ident t) (ident TOKEN_CLOSURE))
        (block
          (expr_stmt (call (ident print) (string "closure")))
          (return)))
      (expr_stmt (call (ident print) (string "UNKNOWN")))))
  (func print_n ((param s (type_ptr (type_base u8))) (param n (type_base i64))) (type_base void)
    (block
      (expr_stmt (call (ident file_write) (number 1) (ident s) (ident n)))))
  (func print_token ((param tok (type_ptr (type_base u8)))) (type_base void)
    (block
      (expr_stmt (call (ident print) (string "[")))
      (expr_stmt (call (ident print_int) (call (ident tok_line) (ident tok))))
      (expr_stmt (call (ident print) (string ":")))
      (expr_stmt (call (ident print_int) (call (ident tok_col) (ident tok))))
      (expr_stmt (call (ident print) (string "] ")))
      (expr_stmt (call (ident print_token_type) (call (ident tok_type) (ident tok))))
      (expr_stmt (call (ident print) (string " '")))
      (expr_stmt (call (ident print_n) (call (ident tok_lexeme) (ident tok)) (call (ident tok_lexeme_len) (ident tok))))
      (expr_stmt (call (ident println) (string "'")))))
  (var NODE_FUNC_DECL (type_base i64) (number 1))
  (var NODE_VAR_DECL (type_base i64) (number 2))
  (var NODE_STRUCT_DECL (type_base i64) (number 3))
  (var NODE_BLOCK_STMT (type_base i64) (number 4))
  (var NODE_IF_STMT (type_base i64) (number 5))
  (var NODE_WHILE_STMT (type_base i64) (number 6))
  (var NODE_RETURN_STMT (type_base i64) (number 7))
  (var NODE_EXPR_STMT (type_base i64) (number 8))
  (var NODE_BINARY_EXPR (type_base i64) (number 9))
  (var NODE_UNARY_EXPR (type_base i64) (number 10))
  (var NODE_CALL_EXPR (type_base i64) (number 11))
  (var NODE_INDEX_EXPR (type_base i64) (number 12))
  (var NODE_FIELD_EXPR (type_base i64) (number 13))
  (var NODE_IDENT_EXPR (type_base i64) (number 14))
  (var NODE_NUMBER_EXPR (type_base i64) (number 15))
  (var NODE_STRING_EXPR (type_base i64) (number 16))
  (var NODE_BOOL_EXPR (type_base i64) (number 17))
  (var NODE_NIL_EXPR (type_base i64) (number 18))
  (var NODE_GROUP_EXPR (type_base i64) (number 19))
  (var NODE_QUOTE_EXPR (type_base i64) (number 20))
  (var NODE_UNQUOTE_EXPR (type_base i64) (number 21))
  (var NODE_MACRO_DECL (type_base i64) (number 22))
  (var NODE_UNQUOTE_STRING_EXPR (type_base i64) (number 23))
  (var NODE_IMPORT (type_base i64) (number 24))
  (var NODE_READER_DECL (type_base i64) (number 25))
  (var NODE_READER_EXPR (type_base i64) (number 26))
  (var NODE_INCLUDE_DECL (type_base i64) (number 27))
  (var NODE_BREAK_STMT (type_base i64) (number 28))
  (var NODE_CONTINUE_STMT (type_base i64) (number 29))
  (var NODE_LET_EXPR (type_base i64) (number 30))
  (var NODE_ASSIGN_STMT (type_base i64) (number 31))
  (var NODE_LAMBDA_EXPR (type_base i64) (number 32))
  (var NODE_ENUM_DECL (type_base i64) (number 33))
  (var NODE_MATCH_EXPR (type_base i64) (number 34))
  (var NODE_PATTERN_VARIANT (type_base i64) (number 35))
  (var NODE_PATTERN_WILDCARD (type_base i64) (number 36))
  (var NODE_EFFECT_DECL (type_base i64) (number 37))
  (var NODE_PERFORM_EXPR (type_base i64) (number 38))
  (var NODE_HANDLE_EXPR (type_base i64) (number 39))
  (var NODE_RESUME_EXPR (type_base i64) (number 40))
  (var NODE_BLOCK_EXPR (type_base i64) (number 41))
  (var TYPE_BASE (type_base i64) (number 1))
  (var TYPE_PTR (type_base i64) (number 2))
  (var TYPE_ARRAY (type_base i64) (number 3))
  (var TYPE_FUNC (type_base i64) (number 4))
  (var TYPE_CLOSURE (type_base i64) (number 5))
  (func buf_eq_str ((param buf (type_ptr (type_base u8))) (param len (type_base i64)) (param str (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident len))
        (block
          (var c (type_base u8) (unop * (binop + (ident str) (ident i))))
          (if (binop == (ident c) (number 0))
            (block
              (return (number 0))))
          (if (binop != (unop * (binop + (ident buf) (ident i))) (ident c))
            (block
              (return (number 0))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (if (binop != (unop * (binop + (ident str) (ident i))) (number 0))
        (block
          (return (number 0))))
      (return (number 1))))
  (func node_kind ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (ident node))
      (return (unop * (ident p)))))
  (func node_set_kind ((param node (type_ptr (type_base u8))) (param k (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (ident node))
      (assign (unop * (ident p)) (ident k))))
  (func func_decl_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 56)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_FUNC_DECL)))
      (return (ident node))))
  (func func_decl_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func func_decl_set_name ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident ptr))))
  (func func_decl_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func func_decl_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func func_decl_params ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func func_decl_set_params ((param node (type_ptr (type_base u8))) (param params (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident params))))
  (func func_decl_param_count ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (return (unop * (ident p)))))
  (func func_decl_set_param_count ((param node (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (assign (unop * (ident p)) (ident count))))
  (func func_decl_ret_type ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 40)))
      (return (unop * (ident p)))))
  (func func_decl_set_ret_type ((param node (type_ptr (type_base u8))) (param t (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 40)))
      (assign (unop * (ident p)) (ident t))))
  (func func_decl_body ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 48)))
      (return (unop * (ident p)))))
  (func func_decl_set_body ((param node (type_ptr (type_base u8))) (param body (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 48)))
      (assign (unop * (ident p)) (ident body))))
  (func var_decl_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 40)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_VAR_DECL)))
      (return (ident node))))
  (func var_decl_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func var_decl_set_name ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident ptr))))
  (func var_decl_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func var_decl_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func var_decl_type ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func var_decl_set_type ((param node (type_ptr (type_base u8))) (param t (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident t))))
  (func var_decl_init ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 32)))
      (return (unop * (ident p)))))
  (func var_decl_set_init ((param node (type_ptr (type_base u8))) (param init (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 32)))
      (assign (unop * (ident p)) (ident init))))
  (func struct_decl_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 40)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_STRUCT_DECL)))
      (return (ident node))))
  (func struct_decl_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func struct_decl_set_name ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident ptr))))
  (func struct_decl_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func struct_decl_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func struct_decl_fields ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func struct_decl_set_fields ((param node (type_ptr (type_base u8))) (param fields (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident fields))))
  (func struct_decl_field_count ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (return (unop * (ident p)))))
  (func struct_decl_set_field_count ((param node (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (assign (unop * (ident p)) (ident count))))
  (func struct_field_name ((param field (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (ident field))
      (return (unop * (ident p)))))
  (func struct_field_set_name ((param field (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (ident field))
      (assign (unop * (ident p)) (ident ptr))))
  (func struct_field_name_len ((param field (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident field) (number 8)))
      (return (unop * (ident p)))))
  (func struct_field_set_name_len ((param field (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident field) (number 8)))
      (assign (unop * (ident p)) (ident len))))
  (func struct_field_type ((param field (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident field) (number 16)))
      (return (unop * (ident p)))))
  (func struct_field_set_type ((param field (type_ptr (type_base u8))) (param t (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident field) (number 16)))
      (assign (unop * (ident p)) (ident t))))
  (func get_struct_field ((param fields (type_ptr (type_base u8))) (param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (return (binop + (ident fields) (binop * (ident index) (number 24))))))
  (func enum_decl_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 40)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_ENUM_DECL)))
      (return (ident node))))
  (func enum_decl_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func enum_decl_set_name ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident ptr))))
  (func enum_decl_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func enum_decl_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func enum_decl_variants ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func enum_decl_set_variants ((param node (type_ptr (type_base u8))) (param variants (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident variants))))
  (func enum_decl_variant_count ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (return (unop * (ident p)))))
  (func enum_decl_set_variant_count ((param node (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (assign (unop * (ident p)) (ident count))))
  (func enum_variant_name ((param v (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (ident v))
      (return (unop * (ident p)))))
  (func enum_variant_set_name ((param v (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (ident v))
      (assign (unop * (ident p)) (ident ptr))))
  (func enum_variant_name_len ((param v (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident v) (number 8)))
      (return (unop * (ident p)))))
  (func enum_variant_set_name_len ((param v (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident v) (number 8)))
      (assign (unop * (ident p)) (ident len))))
  (func enum_variant_type ((param v (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident v) (number 16)))
      (return (unop * (ident p)))))
  (func enum_variant_set_type ((param v (type_ptr (type_base u8))) (param t (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident v) (number 16)))
      (assign (unop * (ident p)) (ident t))))
  (func enum_variant_tag ((param v (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident v) (number 24)))
      (return (unop * (ident p)))))
  (func enum_variant_set_tag ((param v (type_ptr (type_base u8))) (param tag (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident v) (number 24)))
      (assign (unop * (ident p)) (ident tag))))
  (func get_enum_variant ((param variants (type_ptr (type_base u8))) (param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (return (binop + (ident variants) (binop * (ident index) (number 32))))))
  (func match_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 32)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_MATCH_EXPR)))
      (return (ident node))))
  (func match_expr_scrutinee ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func match_expr_set_scrutinee ((param node (type_ptr (type_base u8))) (param expr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident expr))))
  (func match_expr_arms ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func match_expr_set_arms ((param node (type_ptr (type_base u8))) (param arms (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident arms))))
  (func match_expr_arm_count ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func match_expr_set_arm_count ((param node (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident count))))
  (func get_match_arm ((param arms (type_ptr (type_base u8))) (param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (return (binop + (ident arms) (binop * (ident index) (number 16))))))
  (func match_arm_pattern ((param arm (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (ident arm))
      (return (unop * (ident p)))))
  (func match_arm_set_pattern ((param arm (type_ptr (type_base u8))) (param pattern (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (ident arm))
      (assign (unop * (ident p)) (ident pattern))))
  (func match_arm_body ((param arm (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident arm) (number 8)))
      (return (unop * (ident p)))))
  (func match_arm_set_body ((param arm (type_ptr (type_base u8))) (param body (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident arm) (number 8)))
      (assign (unop * (ident p)) (ident body))))
  (func pattern_variant_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 56)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_PATTERN_VARIANT)))
      (return (ident node))))
  (func pattern_variant_enum_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func pattern_variant_set_enum_name ((param node (type_ptr (type_base u8))) (param name (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident name))))
  (func pattern_variant_enum_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func pattern_variant_set_enum_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func pattern_variant_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func pattern_variant_set_name ((param node (type_ptr (type_base u8))) (param name (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident name))))
  (func pattern_variant_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (return (unop * (ident p)))))
  (func pattern_variant_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (assign (unop * (ident p)) (ident len))))
  (func pattern_variant_binding ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 40)))
      (return (unop * (ident p)))))
  (func pattern_variant_set_binding ((param node (type_ptr (type_base u8))) (param name (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 40)))
      (assign (unop * (ident p)) (ident name))))
  (func pattern_variant_binding_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 48)))
      (return (unop * (ident p)))))
  (func pattern_variant_set_binding_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 48)))
      (assign (unop * (ident p)) (ident len))))
  (func pattern_wildcard_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 8)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_PATTERN_WILDCARD)))
      (return (ident node))))
  (func effect_decl_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 48)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_EFFECT_DECL)))
      (return (ident node))))
  (func effect_decl_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func effect_decl_set_name ((param node (type_ptr (type_base u8))) (param name (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident name))))
  (func effect_decl_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func effect_decl_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func effect_decl_param_types ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func effect_decl_set_param_types ((param node (type_ptr (type_base u8))) (param params (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident params))))
  (func effect_decl_param_type_count ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (return (unop * (ident p)))))
  (func effect_decl_set_param_type_count ((param node (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (assign (unop * (ident p)) (ident count))))
  (func effect_decl_return_type ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 40)))
      (return (unop * (ident p)))))
  (func effect_decl_set_return_type ((param node (type_ptr (type_base u8))) (param ret_type (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 40)))
      (assign (unop * (ident p)) (ident ret_type))))
  (func perform_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 40)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_PERFORM_EXPR)))
      (return (ident node))))
  (func perform_expr_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func perform_expr_set_name ((param node (type_ptr (type_base u8))) (param name (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident name))))
  (func perform_expr_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func perform_expr_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func perform_expr_args ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func perform_expr_set_args ((param node (type_ptr (type_base u8))) (param args (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident args))))
  (func perform_expr_arg_count ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (return (unop * (ident p)))))
  (func perform_expr_set_arg_count ((param node (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (assign (unop * (ident p)) (ident count))))
  (func handle_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 56)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_HANDLE_EXPR)))
      (return (ident node))))
  (func handle_expr_body ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func handle_expr_set_body ((param node (type_ptr (type_base u8))) (param body (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident body))))
  (func handle_expr_cases ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func handle_expr_set_cases ((param node (type_ptr (type_base u8))) (param cases (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident cases))))
  (func handle_expr_case_count ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func handle_expr_set_case_count ((param node (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident count))))
  (func handle_expr_ret_bind ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 32)))
      (return (unop * (ident p)))))
  (func handle_expr_set_ret_bind ((param node (type_ptr (type_base u8))) (param bind (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 32)))
      (assign (unop * (ident p)) (ident bind))))
  (func handle_expr_ret_bind_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 40)))
      (return (unop * (ident p)))))
  (func handle_expr_set_ret_bind_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 40)))
      (assign (unop * (ident p)) (ident len))))
  (func handle_expr_ret_body ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 48)))
      (return (unop * (ident p)))))
  (func handle_expr_set_ret_body ((param node (type_ptr (type_base u8))) (param body (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 48)))
      (assign (unop * (ident p)) (ident body))))
  (func effect_case_name ((param entry (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (ident entry))
      (return (unop * (ident p)))))
  (func effect_case_name_len ((param entry (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
      (return (unop * (ident p)))))
  (func effect_case_binding ((param entry (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
      (return (unop * (ident p)))))
  (func effect_case_binding_len ((param entry (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident entry) (number 24)))
      (return (unop * (ident p)))))
  (func effect_case_k ((param entry (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 32)))
      (return (unop * (ident p)))))
  (func effect_case_k_len ((param entry (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident entry) (number 40)))
      (return (unop * (ident p)))))
  (func effect_case_body ((param entry (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 48)))
      (return (unop * (ident p)))))
  (func resume_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_RESUME_EXPR)))
      (return (ident node))))
  (func resume_expr_k ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func resume_expr_set_k ((param node (type_ptr (type_base u8))) (param k (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident k))))
  (func resume_expr_value ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func resume_expr_set_value ((param node (type_ptr (type_base u8))) (param value (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident value))))
  (func block_stmt_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_BLOCK_STMT)))
      (return (ident node))))
  (func block_stmt_stmts ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func block_stmt_set_stmts ((param node (type_ptr (type_base u8))) (param stmts (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident stmts))))
  (func block_stmt_count ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func block_stmt_set_count ((param node (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident count))))
  (func block_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 32)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_BLOCK_EXPR)))
      (return (ident node))))
  (func block_expr_stmts ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func block_expr_set_stmts ((param node (type_ptr (type_base u8))) (param stmts (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident stmts))))
  (func block_expr_count ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func block_expr_set_count ((param node (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident count))))
  (func block_expr_tail ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func block_expr_set_tail ((param node (type_ptr (type_base u8))) (param tail (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident tail))))
  (func if_stmt_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 32)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_IF_STMT)))
      (return (ident node))))
  (func if_stmt_cond ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func if_stmt_set_cond ((param node (type_ptr (type_base u8))) (param cond (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident cond))))
  (func if_stmt_then ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func if_stmt_set_then ((param node (type_ptr (type_base u8))) (param then (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident then))))
  (func if_stmt_else ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func if_stmt_set_else ((param node (type_ptr (type_base u8))) (param els (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident els))))
  (func while_stmt_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 40)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_WHILE_STMT)))
      (return (ident node))))
  (func while_stmt_cond ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func while_stmt_set_cond ((param node (type_ptr (type_base u8))) (param cond (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident cond))))
  (func while_stmt_body ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func while_stmt_set_body ((param node (type_ptr (type_base u8))) (param body (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident body))))
  (func while_stmt_label ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func while_stmt_set_label ((param node (type_ptr (type_base u8))) (param label (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident label))))
  (func while_stmt_label_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (return (unop * (ident p)))))
  (func while_stmt_set_label_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (assign (unop * (ident p)) (ident len))))
  (func break_stmt_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_BREAK_STMT)))
      (return (ident node))))
  (func break_stmt_label ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func break_stmt_set_label ((param node (type_ptr (type_base u8))) (param label (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident label))))
  (func break_stmt_label_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func break_stmt_set_label_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func continue_stmt_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_CONTINUE_STMT)))
      (return (ident node))))
  (func continue_stmt_label ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func continue_stmt_set_label ((param node (type_ptr (type_base u8))) (param label (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident label))))
  (func continue_stmt_label_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func continue_stmt_set_label_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func return_stmt_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 16)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_RETURN_STMT)))
      (return (ident node))))
  (func return_stmt_value ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func return_stmt_set_value ((param node (type_ptr (type_base u8))) (param val (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident val))))
  (func expr_stmt_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 16)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_EXPR_STMT)))
      (return (ident node))))
  (func expr_stmt_expr ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func expr_stmt_set_expr ((param node (type_ptr (type_base u8))) (param expr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident expr))))
  (func assign_stmt_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_ASSIGN_STMT)))
      (return (ident node))))
  (func assign_stmt_target ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func assign_stmt_set_target ((param node (type_ptr (type_base u8))) (param target (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident target))))
  (func assign_stmt_value ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func assign_stmt_set_value ((param node (type_ptr (type_base u8))) (param value (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident value))))
  (func binary_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 32)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_BINARY_EXPR)))
      (return (ident node))))
  (func binary_expr_op ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func binary_expr_set_op ((param node (type_ptr (type_base u8))) (param op (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident op))))
  (func binary_expr_left ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func binary_expr_set_left ((param node (type_ptr (type_base u8))) (param left (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident left))))
  (func binary_expr_right ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func binary_expr_set_right ((param node (type_ptr (type_base u8))) (param right (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident right))))
  (func unary_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_UNARY_EXPR)))
      (return (ident node))))
  (func unary_expr_op ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func unary_expr_set_op ((param node (type_ptr (type_base u8))) (param op (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident op))))
  (func unary_expr_expr ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func unary_expr_set_expr ((param node (type_ptr (type_base u8))) (param expr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident expr))))
  (func call_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 32)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_CALL_EXPR)))
      (return (ident node))))
  (func call_expr_func ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func call_expr_set_func ((param node (type_ptr (type_base u8))) (param f (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident f))))
  (func call_expr_args ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func call_expr_set_args ((param node (type_ptr (type_base u8))) (param args (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident args))))
  (func call_expr_arg_count ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func call_expr_set_arg_count ((param node (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident count))))
  (func ident_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_IDENT_EXPR)))
      (return (ident node))))
  (func ident_expr_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func ident_expr_set_name ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident ptr))))
  (func ident_expr_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func ident_expr_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func field_expr_expr ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func field_expr_field ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func field_expr_field_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func number_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_NUMBER_EXPR)))
      (return (ident node))))
  (func number_expr_value ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func number_expr_set_value ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident ptr))))
  (func number_expr_value_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func number_expr_set_value_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func string_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_STRING_EXPR)))
      (return (ident node))))
  (func string_expr_value ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func string_expr_set_value ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident ptr))))
  (func string_expr_value_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func string_expr_set_value_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func bool_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 16)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_BOOL_EXPR)))
      (return (ident node))))
  (func bool_expr_value ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func bool_expr_set_value ((param node (type_ptr (type_base u8))) (param val (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident val))))
  (func nil_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 8)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_NIL_EXPR)))
      (return (ident node))))
  (func group_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 16)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_GROUP_EXPR)))
      (return (ident node))))
  (func group_expr_expr ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func group_expr_set_expr ((param node (type_ptr (type_base u8))) (param expr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident expr))))
  (func quote_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 16)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_QUOTE_EXPR)))
      (return (ident node))))
  (func quote_expr_expr ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func quote_expr_set_expr ((param node (type_ptr (type_base u8))) (param expr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident expr))))
  (func unquote_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_UNQUOTE_EXPR)))
      (return (ident node))))
  (func unquote_expr_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func unquote_expr_set_name ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident ptr))))
  (func unquote_expr_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func unquote_expr_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func unquote_string_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_UNQUOTE_STRING_EXPR)))
      (return (ident node))))
  (func unquote_string_expr_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func unquote_string_expr_set_name ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident ptr))))
  (func unquote_string_expr_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func unquote_string_expr_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func macro_decl_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 48)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_MACRO_DECL)))
      (return (ident node))))
  (func macro_decl_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func macro_decl_set_name ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident ptr))))
  (func macro_decl_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func macro_decl_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func macro_decl_params ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func macro_decl_set_params ((param node (type_ptr (type_base u8))) (param params (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident params))))
  (func macro_decl_param_count ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (return (unop * (ident p)))))
  (func macro_decl_set_param_count ((param node (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 32)))
      (assign (unop * (ident p)) (ident count))))
  (func macro_decl_body ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 40)))
      (return (unop * (ident p)))))
  (func macro_decl_set_body ((param node (type_ptr (type_base u8))) (param body (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 40)))
      (assign (unop * (ident p)) (ident body))))
  (func let_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 48)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_LET_EXPR)))
      (return (ident node))))
  (func let_expr_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func let_expr_set_name ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident ptr))))
  (func let_expr_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func let_expr_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func let_expr_type ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func let_expr_set_type ((param node (type_ptr (type_base u8))) (param typ (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident typ))))
  (func let_expr_init ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 32)))
      (return (unop * (ident p)))))
  (func let_expr_set_init ((param node (type_ptr (type_base u8))) (param init (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 32)))
      (assign (unop * (ident p)) (ident init))))
  (func let_expr_body ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 40)))
      (return (unop * (ident p)))))
  (func let_expr_set_body ((param node (type_ptr (type_base u8))) (param body (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 40)))
      (assign (unop * (ident p)) (ident body))))
  (func lambda_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 40)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_LAMBDA_EXPR)))
      (return (ident node))))
  (func lambda_expr_params ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (return (unop * (ident p)))))
  (func lambda_expr_set_params ((param node (type_ptr (type_base u8))) (param params (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
      (assign (unop * (ident p)) (ident params))))
  (func lambda_expr_param_count ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (return (unop * (ident p)))))
  (func lambda_expr_set_param_count ((param node (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident node) (number 16)))
      (assign (unop * (ident p)) (ident count))))
  (func lambda_expr_ret_type ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (return (unop * (ident p)))))
  (func lambda_expr_set_ret_type ((param node (type_ptr (type_base u8))) (param typ (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 24)))
      (assign (unop * (ident p)) (ident typ))))
  (func lambda_expr_body ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 32)))
      (return (unop * (ident p)))))
  (func lambda_expr_set_body ((param node (type_ptr (type_base u8))) (param body (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 32)))
      (assign (unop * (ident p)) (ident body))))
  (struct ImportDecl ((field_decl kind (type_base i64)) (field_decl path (type_ptr (type_base u8))) (field_decl path_len (type_base i64))))
  (func import_decl_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_IMPORT)))
      (return (ident node))))
  (func import_decl_path ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var n (type_ptr (type_base ImportDecl)) (ident node))
      (return (field (ident n) path))))
  (func import_decl_set_path ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var n (type_ptr (type_base ImportDecl)) (ident node))
      (assign (field (ident n) path) (ident ptr))))
  (func import_decl_path_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var n (type_ptr (type_base ImportDecl)) (ident node))
      (return (field (ident n) path_len))))
  (func import_decl_set_path_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var n (type_ptr (type_base ImportDecl)) (ident node))
      (assign (field (ident n) path_len) (ident len))))
  (struct ReaderDecl ((field_decl kind (type_base i64)) (field_decl name (type_ptr (type_base u8))) (field_decl name_len (type_base i64)) (field_decl param_name (type_ptr (type_base u8))) (field_decl param_len (type_base i64)) (field_decl body (type_ptr (type_base u8)))))
  (func reader_decl_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 48)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_READER_DECL)))
      (return (ident node))))
  (func reader_decl_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var n (type_ptr (type_base ReaderDecl)) (ident node))
      (return (field (ident n) name))))
  (func reader_decl_set_name ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var n (type_ptr (type_base ReaderDecl)) (ident node))
      (assign (field (ident n) name) (ident ptr))))
  (func reader_decl_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var n (type_ptr (type_base ReaderDecl)) (ident node))
      (return (field (ident n) name_len))))
  (func reader_decl_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var n (type_ptr (type_base ReaderDecl)) (ident node))
      (assign (field (ident n) name_len) (ident len))))
  (func reader_decl_param_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var n (type_ptr (type_base ReaderDecl)) (ident node))
      (return (field (ident n) param_name))))
  (func reader_decl_set_param_name ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var n (type_ptr (type_base ReaderDecl)) (ident node))
      (assign (field (ident n) param_name) (ident ptr))))
  (func reader_decl_param_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var n (type_ptr (type_base ReaderDecl)) (ident node))
      (return (field (ident n) param_len))))
  (func reader_decl_set_param_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var n (type_ptr (type_base ReaderDecl)) (ident node))
      (assign (field (ident n) param_len) (ident len))))
  (func reader_decl_body ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var n (type_ptr (type_base ReaderDecl)) (ident node))
      (return (field (ident n) body))))
  (func reader_decl_set_body ((param node (type_ptr (type_base u8))) (param body (type_ptr (type_base u8)))) (type_base void)
    (block
      (var n (type_ptr (type_base ReaderDecl)) (ident node))
      (assign (field (ident n) body) (ident body))))
  (struct ReaderExpr ((field_decl kind (type_base i64)) (field_decl name (type_ptr (type_base u8))) (field_decl name_len (type_base i64)) (field_decl content (type_ptr (type_base u8))) (field_decl content_len (type_base i64))))
  (func reader_expr_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 40)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_READER_EXPR)))
      (return (ident node))))
  (func reader_expr_name ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var n (type_ptr (type_base ReaderExpr)) (ident node))
      (return (field (ident n) name))))
  (func reader_expr_set_name ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var n (type_ptr (type_base ReaderExpr)) (ident node))
      (assign (field (ident n) name) (ident ptr))))
  (func reader_expr_name_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var n (type_ptr (type_base ReaderExpr)) (ident node))
      (return (field (ident n) name_len))))
  (func reader_expr_set_name_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var n (type_ptr (type_base ReaderExpr)) (ident node))
      (assign (field (ident n) name_len) (ident len))))
  (func reader_expr_content ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var n (type_ptr (type_base ReaderExpr)) (ident node))
      (return (field (ident n) content))))
  (func reader_expr_set_content ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var n (type_ptr (type_base ReaderExpr)) (ident node))
      (assign (field (ident n) content) (ident ptr))))
  (func reader_expr_content_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var n (type_ptr (type_base ReaderExpr)) (ident node))
      (return (field (ident n) content_len))))
  (func reader_expr_set_content_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var n (type_ptr (type_base ReaderExpr)) (ident node))
      (assign (field (ident n) content_len) (ident len))))
  (struct IncludeDecl ((field_decl kind (type_base i64)) (field_decl path (type_ptr (type_base u8))) (field_decl path_len (type_base i64))))
  (func include_decl_alloc () (type_ptr (type_base u8))
    (block
      (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_INCLUDE_DECL)))
      (return (ident node))))
  (func include_decl_path ((param node (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var n (type_ptr (type_base IncludeDecl)) (ident node))
      (return (field (ident n) path))))
  (func include_decl_set_path ((param node (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var n (type_ptr (type_base IncludeDecl)) (ident node))
      (assign (field (ident n) path) (ident ptr))))
  (func include_decl_path_len ((param node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var n (type_ptr (type_base IncludeDecl)) (ident node))
      (return (field (ident n) path_len))))
  (func include_decl_set_path_len ((param node (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var n (type_ptr (type_base IncludeDecl)) (ident node))
      (assign (field (ident n) path_len) (ident len))))
  (func type_kind ((param t (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (ident t))
      (return (unop * (ident p)))))
  (func type_set_kind ((param t (type_ptr (type_base u8))) (param k (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (ident t))
      (assign (unop * (ident p)) (ident k))))
  (func base_type_alloc () (type_ptr (type_base u8))
    (block
      (var t (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
      (expr_stmt (call (ident type_set_kind) (ident t) (ident TYPE_BASE)))
      (return (ident t))))
  (func base_type_name ((param t (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident t) (number 8)))
      (return (unop * (ident p)))))
  (func base_type_set_name ((param t (type_ptr (type_base u8))) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident t) (number 8)))
      (assign (unop * (ident p)) (ident ptr))))
  (func base_type_name_len ((param t (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident t) (number 16)))
      (return (unop * (ident p)))))
  (func base_type_set_name_len ((param t (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident t) (number 16)))
      (assign (unop * (ident p)) (ident len))))
  (func ptr_type_alloc () (type_ptr (type_base u8))
    (block
      (var t (type_ptr (type_base u8)) (call (ident alloc) (number 16)))
      (expr_stmt (call (ident type_set_kind) (ident t) (ident TYPE_PTR)))
      (return (ident t))))
  (func ptr_type_elem ((param t (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident t) (number 8)))
      (return (unop * (ident p)))))
  (func ptr_type_set_elem ((param t (type_ptr (type_base u8))) (param elem (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident t) (number 8)))
      (assign (unop * (ident p)) (ident elem))))
  (func func_type_alloc () (type_ptr (type_base u8))
    (block
      (var t (type_ptr (type_base u8)) (call (ident alloc) (number 32)))
      (expr_stmt (call (ident type_set_kind) (ident t) (ident TYPE_FUNC)))
      (return (ident t))))
  (func func_type_params ((param t (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident t) (number 8)))
      (return (unop * (ident p)))))
  (func func_type_set_params ((param t (type_ptr (type_base u8))) (param params (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident t) (number 8)))
      (assign (unop * (ident p)) (ident params))))
  (func func_type_param_count ((param t (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident t) (number 16)))
      (return (unop * (ident p)))))
  (func func_type_set_param_count ((param t (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident t) (number 16)))
      (assign (unop * (ident p)) (ident count))))
  (func func_type_ret ((param t (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident t) (number 24)))
      (return (unop * (ident p)))))
  (func func_type_set_ret ((param t (type_ptr (type_base u8))) (param ret (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident t) (number 24)))
      (assign (unop * (ident p)) (ident ret))))
  (func closure_type_alloc () (type_ptr (type_base u8))
    (block
      (var t (type_ptr (type_base u8)) (call (ident alloc) (number 32)))
      (expr_stmt (call (ident type_set_kind) (ident t) (ident TYPE_CLOSURE)))
      (return (ident t))))
  (func closure_type_params ((param t (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident t) (number 8)))
      (return (unop * (ident p)))))
  (func closure_type_set_params ((param t (type_ptr (type_base u8))) (param params (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident t) (number 8)))
      (assign (unop * (ident p)) (ident params))))
  (func closure_type_param_count ((param t (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident t) (number 16)))
      (return (unop * (ident p)))))
  (func closure_type_set_param_count ((param t (type_ptr (type_base u8))) (param count (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident t) (number 16)))
      (assign (unop * (ident p)) (ident count))))
  (func closure_type_ret ((param t (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident t) (number 24)))
      (return (unop * (ident p)))))
  (func closure_type_set_ret ((param t (type_ptr (type_base u8))) (param ret (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident t) (number 24)))
      (assign (unop * (ident p)) (ident ret))))
  (func param_name ((param p (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var ptr (type_ptr (type_ptr (type_base u8))) (ident p))
      (return (unop * (ident ptr)))))
  (func param_set_name ((param p (type_ptr (type_base u8))) (param name (type_ptr (type_base u8)))) (type_base void)
    (block
      (var ptr (type_ptr (type_ptr (type_base u8))) (ident p))
      (assign (unop * (ident ptr)) (ident name))))
  (func param_name_len ((param p (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var ptr (type_ptr (type_base i64)) (binop + (ident p) (number 8)))
      (return (unop * (ident ptr)))))
  (func param_set_name_len ((param p (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var ptr (type_ptr (type_base i64)) (binop + (ident p) (number 8)))
      (assign (unop * (ident ptr)) (ident len))))
  (func param_type ((param p (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident p) (number 16)))
      (return (unop * (ident ptr)))))
  (func param_set_type ((param p (type_ptr (type_base u8))) (param t (type_ptr (type_base u8)))) (type_base void)
    (block
      (var ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident p) (number 16)))
      (assign (unop * (ident ptr)) (ident t))))
  (var parse_tokens (type_ptr (type_base u8)) (nil))
  (var parse_current (type_base i64) (number 0))
  (var parse_error_count (type_base i64) (number 0))
  (var parse_max_errors (type_base i64) (number 10))
  (func get_token ((param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (var ptr_as_int (type_base i64) (call (ident vec_get) (ident parse_tokens) (ident index)))
      (var p (type_ptr (type_base i64)) (unop & (ident ptr_as_int)))
      (var pp (type_ptr (type_ptr (type_base u8))) (ident p))
      (return (unop * (ident pp)))))
  (func parser_token_count () (type_base i64)
    (block
      (return (call (ident vec_len) (ident parse_tokens)))))
  (func parser_init () (type_base void)
    (block
      (assign (ident parse_tokens) (call (ident vec_new) (number 8)))
      (assign (ident parse_current) (number 0))
      (assign (ident parse_error_count) (number 0))))
  (func parser_add_token ((param tok (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (unop & (ident tok)))
      (var pi (type_ptr (type_base i64)) (ident p))
      (expr_stmt (call (ident vec_push) (ident parse_tokens) (unop * (ident pi))))))
  (func parser_tokenize ((param source (type_ptr (type_base u8)))) (type_base void)
    (block
      (expr_stmt (call (ident parser_init)))
      (expr_stmt (call (ident lexer_init) (ident source)))
      (var done (type_base i64) (number 0))
      (while (binop == (ident done) (number 0))
        (block
          (var tok (type_ptr (type_base u8)) (call (ident scan_token)))
          (expr_stmt (call (ident parser_add_token) (ident tok)))
          (if (binop || (binop == (call (ident tok_type) (ident tok)) (ident TOKEN_EOF)) (binop == (call (ident tok_type) (ident tok)) (ident TOKEN_ERROR)))
            (block
              (assign (ident done) (number 1))))))))
  (func parse_is_at_end () (type_base bool)
    (block
      (return (binop == (call (ident tok_type) (call (ident parse_peek))) (ident TOKEN_EOF)))))
  (func parse_peek () (type_ptr (type_base u8))
    (block
      (return (call (ident get_token) (ident parse_current)))))
  (func parse_peek_next () (type_ptr (type_base u8))
    (block
      (if (binop >= (binop + (ident parse_current) (number 1)) (call (ident parser_token_count)))
        (block
          (return (nil))))
      (return (call (ident get_token) (binop + (ident parse_current) (number 1))))))
  (func parse_previous () (type_ptr (type_base u8))
    (block
      (return (call (ident get_token) (binop - (ident parse_current) (number 1))))))
  (func parse_advance () (type_ptr (type_base u8))
    (block
      (if (unop ! (call (ident parse_is_at_end)))
        (block
          (assign (ident parse_current) (binop + (ident parse_current) (number 1)))))
      (return (call (ident parse_previous)))))
  (func parse_check ((param t (type_base i64))) (type_base bool)
    (block
      (if (call (ident parse_is_at_end))
        (block
          (return (bool false))))
      (return (binop == (call (ident tok_type) (call (ident parse_peek))) (ident t)))))
  (func parse_match ((param t (type_base i64))) (type_base bool)
    (block
      (if (call (ident parse_check) (ident t))
        (block
          (expr_stmt (call (ident parse_advance)))
          (return (bool true))))
      (return (bool false))))
  (func parse_error ((param msg (type_ptr (type_base u8)))) (type_base void)
    (block
      (var tok (type_ptr (type_base u8)) (call (ident parse_peek)))
      (expr_stmt (call (ident eprint) (string "Error at ")))
      (expr_stmt (call (ident eprint_i64) (call (ident tok_line) (ident tok))))
      (expr_stmt (call (ident eprint) (string ":")))
      (expr_stmt (call (ident eprint_i64) (call (ident tok_col) (ident tok))))
      (expr_stmt (call (ident eprint) (string ": ")))
      (expr_stmt (call (ident eprintln) (ident msg)))
      (assign (ident parse_error_count) (binop + (ident parse_error_count) (number 1)))
      (if (binop >= (ident parse_error_count) (ident parse_max_errors))
        (block
          (expr_stmt (call (ident eprintln) (string "Too many errors, stopping.")))
          (expr_stmt (call (ident exit) (number 1)))))))
  (func parse_expect ((param t (type_base i64)) (param msg (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (if (call (ident parse_check) (ident t))
        (block
          (return (call (ident parse_advance)))))
      (expr_stmt (call (ident parse_error) (ident msg)))
      (return (nil))))
  (func parse_type () (type_ptr (type_base u8))
    (block
      (if (call (ident parse_match) (ident TOKEN_STAR))
        (block
          (var elem (type_ptr (type_base u8)) (call (ident parse_type)))
          (var t (type_ptr (type_base u8)) (call (ident ptr_type_alloc)))
          (expr_stmt (call (ident ptr_type_set_elem) (ident t) (ident elem)))
          (return (ident t))))
      (if (call (ident parse_match) (ident TOKEN_FN))
        (block
          (expr_stmt (call (ident parse_expect) (ident TOKEN_LPAREN) (string "expected '(' after 'fn'")))
          (var params (type_ptr (type_base u8)) (call (ident vec_new) (number 8)))
          (if (unop ! (call (ident parse_check) (ident TOKEN_RPAREN)))
            (block
              (var first (type_base i64) (number 1))
              (while (binop || (binop == (ident first) (number 1)) (call (ident parse_match) (ident TOKEN_COMMA)))
                (block
                  (assign (ident first) (number 0))
                  (var param_type (type_ptr (type_base u8)) (call (ident parse_type)))
                  (expr_stmt (call (ident vec_push) (ident params) (ident param_type)))))))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after parameter types")))
          (var ret (type_ptr (type_base u8)) (call (ident parse_type)))
          (var t (type_ptr (type_base u8)) (call (ident func_type_alloc)))
          (expr_stmt (call (ident func_type_set_params) (ident t) (ident params)))
          (expr_stmt (call (ident func_type_set_param_count) (ident t) (call (ident vec_len) (ident params))))
          (expr_stmt (call (ident func_type_set_ret) (ident t) (ident ret)))
          (return (ident t))))
      (if (call (ident parse_match) (ident TOKEN_CLOSURE))
        (block
          (expr_stmt (call (ident parse_expect) (ident TOKEN_LPAREN) (string "expected '(' after 'closure'")))
          (var params (type_ptr (type_base u8)) (call (ident vec_new) (number 8)))
          (if (unop ! (call (ident parse_check) (ident TOKEN_RPAREN)))
            (block
              (var first (type_base i64) (number 1))
              (while (binop || (binop == (ident first) (number 1)) (call (ident parse_match) (ident TOKEN_COMMA)))
                (block
                  (assign (ident first) (number 0))
                  (var param_type (type_ptr (type_base u8)) (call (ident parse_type)))
                  (expr_stmt (call (ident vec_push) (ident params) (ident param_type)))))))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after parameter types")))
          (var ret (type_ptr (type_base u8)) (call (ident parse_type)))
          (var t (type_ptr (type_base u8)) (call (ident closure_type_alloc)))
          (expr_stmt (call (ident closure_type_set_params) (ident t) (ident params)))
          (expr_stmt (call (ident closure_type_set_param_count) (ident t) (call (ident vec_len) (ident params))))
          (expr_stmt (call (ident closure_type_set_ret) (ident t) (ident ret)))
          (return (ident t))))
      (var tok (type_ptr (type_base u8)) (call (ident parse_advance)))
      (var tt (type_base i64) (call (ident tok_type) (ident tok)))
      (if (binop || (binop || (binop || (binop || (binop || (binop || (binop || (binop || (binop || (binop || (binop == (ident tt) (ident TOKEN_I8)) (binop == (ident tt) (ident TOKEN_I16))) (binop == (ident tt) (ident TOKEN_I32))) (binop == (ident tt) (ident TOKEN_I64))) (binop == (ident tt) (ident TOKEN_U8))) (binop == (ident tt) (ident TOKEN_U16))) (binop == (ident tt) (ident TOKEN_U32))) (binop == (ident tt) (ident TOKEN_U64))) (binop == (ident tt) (ident TOKEN_BOOL))) (binop == (ident tt) (ident TOKEN_VOID))) (binop == (ident tt) (ident TOKEN_IDENT)))
        (block
          (var t (type_ptr (type_base u8)) (call (ident base_type_alloc)))
          (expr_stmt (call (ident base_type_set_name) (ident t) (call (ident tok_lexeme) (ident tok))))
          (expr_stmt (call (ident base_type_set_name_len) (ident t) (call (ident tok_lexeme_len) (ident tok))))
          (return (ident t))))
      (expr_stmt (call (ident parse_error) (string "expected type")))
      (var t (type_ptr (type_base u8)) (call (ident base_type_alloc)))
      (expr_stmt (call (ident base_type_set_name) (ident t) (string "error")))
      (expr_stmt (call (ident base_type_set_name_len) (ident t) (number 5)))
      (return (ident t))))
  (func parse_expression () (type_ptr (type_base u8))
    (block
      (return (call (ident parse_assignment)))))
  (func parse_assignment () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_or)))
      (if (call (ident parse_match) (ident TOKEN_EQ))
        (block
          (var value (type_ptr (type_base u8)) (call (ident parse_assignment)))
          (var node (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident node) (ident TOKEN_EQ)))
          (expr_stmt (call (ident binary_expr_set_left) (ident node) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident node) (ident value)))
          (return (ident node))))
      (var compound_op (type_base i64) (number 0))
      (if (call (ident parse_match) (ident TOKEN_PLUSEQ))
        (block
          (assign (ident compound_op) (ident TOKEN_PLUS)))
        (if (call (ident parse_match) (ident TOKEN_MINUSEQ))
          (block
            (assign (ident compound_op) (ident TOKEN_MINUS)))
          (if (call (ident parse_match) (ident TOKEN_STAREQ))
            (block
              (assign (ident compound_op) (ident TOKEN_STAR)))
            (if (call (ident parse_match) (ident TOKEN_SLASHEQ))
              (block
                (assign (ident compound_op) (ident TOKEN_SLASH)))
              (if (call (ident parse_match) (ident TOKEN_PERCENTEQ))
                (block
                  (assign (ident compound_op) (ident TOKEN_PERCENT))))))))
      (if (binop != (ident compound_op) (number 0))
        (block
          (var value (type_ptr (type_base u8)) (call (ident parse_assignment)))
          (var binop (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident binop) (ident compound_op)))
          (expr_stmt (call (ident binary_expr_set_left) (ident binop) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident binop) (ident value)))
          (var assign (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident assign) (ident TOKEN_EQ)))
          (expr_stmt (call (ident binary_expr_set_left) (ident assign) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident assign) (ident binop)))
          (return (ident assign))))
      (return (ident expr))))
  (func parse_or () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_and)))
      (while (call (ident parse_match) (ident TOKEN_PIPEPIPE))
        (block
          (var right (type_ptr (type_base u8)) (call (ident parse_and)))
          (var node (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident node) (ident TOKEN_PIPEPIPE)))
          (expr_stmt (call (ident binary_expr_set_left) (ident node) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident node) (ident right)))
          (assign (ident expr) (ident node))))
      (return (ident expr))))
  (func parse_and () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_bitor)))
      (while (call (ident parse_match) (ident TOKEN_AMPAMP))
        (block
          (var right (type_ptr (type_base u8)) (call (ident parse_bitor)))
          (var node (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident node) (ident TOKEN_AMPAMP)))
          (expr_stmt (call (ident binary_expr_set_left) (ident node) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident node) (ident right)))
          (assign (ident expr) (ident node))))
      (return (ident expr))))
  (func parse_bitor () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_bitxor)))
      (while (call (ident parse_match) (ident TOKEN_PIPE))
        (block
          (var right (type_ptr (type_base u8)) (call (ident parse_bitxor)))
          (var node (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident node) (ident TOKEN_PIPE)))
          (expr_stmt (call (ident binary_expr_set_left) (ident node) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident node) (ident right)))
          (assign (ident expr) (ident node))))
      (return (ident expr))))
  (func parse_bitxor () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_bitand)))
      (while (call (ident parse_match) (ident TOKEN_CARET))
        (block
          (var right (type_ptr (type_base u8)) (call (ident parse_bitand)))
          (var node (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident node) (ident TOKEN_CARET)))
          (expr_stmt (call (ident binary_expr_set_left) (ident node) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident node) (ident right)))
          (assign (ident expr) (ident node))))
      (return (ident expr))))
  (func parse_bitand () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_equality)))
      (while (call (ident parse_match) (ident TOKEN_AMP))
        (block
          (var right (type_ptr (type_base u8)) (call (ident parse_equality)))
          (var node (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident node) (ident TOKEN_AMP)))
          (expr_stmt (call (ident binary_expr_set_left) (ident node) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident node) (ident right)))
          (assign (ident expr) (ident node))))
      (return (ident expr))))
  (func parse_equality () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_comparison)))
      (while (binop || (call (ident parse_check) (ident TOKEN_EQEQ)) (call (ident parse_check) (ident TOKEN_BANGEQ)))
        (block
          (var op (type_base i64) (call (ident tok_type) (call (ident parse_advance))))
          (var right (type_ptr (type_base u8)) (call (ident parse_comparison)))
          (var node (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident node) (ident op)))
          (expr_stmt (call (ident binary_expr_set_left) (ident node) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident node) (ident right)))
          (assign (ident expr) (ident node))))
      (return (ident expr))))
  (func parse_comparison () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_shift)))
      (while (binop || (binop || (binop || (call (ident parse_check) (ident TOKEN_LT)) (call (ident parse_check) (ident TOKEN_GT))) (call (ident parse_check) (ident TOKEN_LTEQ))) (call (ident parse_check) (ident TOKEN_GTEQ)))
        (block
          (var op (type_base i64) (call (ident tok_type) (call (ident parse_advance))))
          (var right (type_ptr (type_base u8)) (call (ident parse_shift)))
          (var node (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident node) (ident op)))
          (expr_stmt (call (ident binary_expr_set_left) (ident node) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident node) (ident right)))
          (assign (ident expr) (ident node))))
      (return (ident expr))))
  (func parse_shift () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_additive)))
      (while (binop || (call (ident parse_check) (ident TOKEN_LTLT)) (call (ident parse_check) (ident TOKEN_GTGT)))
        (block
          (var op (type_base i64) (call (ident tok_type) (call (ident parse_advance))))
          (var right (type_ptr (type_base u8)) (call (ident parse_additive)))
          (var node (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident node) (ident op)))
          (expr_stmt (call (ident binary_expr_set_left) (ident node) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident node) (ident right)))
          (assign (ident expr) (ident node))))
      (return (ident expr))))
  (func parse_additive () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_mult)))
      (while (binop || (call (ident parse_check) (ident TOKEN_PLUS)) (call (ident parse_check) (ident TOKEN_MINUS)))
        (block
          (var op (type_base i64) (call (ident tok_type) (call (ident parse_advance))))
          (var right (type_ptr (type_base u8)) (call (ident parse_mult)))
          (var node (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident node) (ident op)))
          (expr_stmt (call (ident binary_expr_set_left) (ident node) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident node) (ident right)))
          (assign (ident expr) (ident node))))
      (return (ident expr))))
  (func parse_mult () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_unary)))
      (while (binop || (binop || (call (ident parse_check) (ident TOKEN_STAR)) (call (ident parse_check) (ident TOKEN_SLASH))) (call (ident parse_check) (ident TOKEN_PERCENT)))
        (block
          (var op (type_base i64) (call (ident tok_type) (call (ident parse_advance))))
          (var right (type_ptr (type_base u8)) (call (ident parse_unary)))
          (var node (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident node) (ident op)))
          (expr_stmt (call (ident binary_expr_set_left) (ident node) (ident expr)))
          (expr_stmt (call (ident binary_expr_set_right) (ident node) (ident right)))
          (assign (ident expr) (ident node))))
      (return (ident expr))))
  (func parse_unary () (type_ptr (type_base u8))
    (block
      (if (binop || (binop || (binop || (call (ident parse_check) (ident TOKEN_MINUS)) (call (ident parse_check) (ident TOKEN_BANG))) (call (ident parse_check) (ident TOKEN_STAR))) (call (ident parse_check) (ident TOKEN_AMP)))
        (block
          (var op (type_base i64) (call (ident tok_type) (call (ident parse_advance))))
          (var expr (type_ptr (type_base u8)) (call (ident parse_unary)))
          (var node (type_ptr (type_base u8)) (call (ident unary_expr_alloc)))
          (expr_stmt (call (ident unary_expr_set_op) (ident node) (ident op)))
          (expr_stmt (call (ident unary_expr_set_expr) (ident node) (ident expr)))
          (return (ident node))))
      (return (call (ident parse_postfix)))))
  (func parse_postfix () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_primary)))
      (var done (type_base i64) (number 0))
      (while (binop == (ident done) (number 0))
        (block
          (if (call (ident parse_match) (ident TOKEN_LPAREN))
            (block
              (assign (ident expr) (call (ident parse_finish_call) (ident expr))))
            (if (call (ident parse_match) (ident TOKEN_LBRACKET))
              (block
                (var index (type_ptr (type_base u8)) (call (ident parse_expression)))
                (expr_stmt (call (ident parse_expect) (ident TOKEN_RBRACKET) (string "expected ']' after index")))
                (var node (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
                (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_INDEX_EXPR)))
                (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
                (assign (unop * (ident p)) (ident expr))
                (assign (ident p) (binop + (ident node) (number 16)))
                (assign (unop * (ident p)) (ident index))
                (assign (ident expr) (ident node)))
              (if (call (ident parse_match) (ident TOKEN_DOT))
                (block
                  (var name_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected field name")))
                  (var node (type_ptr (type_base u8)) (call (ident alloc) (number 32)))
                  (expr_stmt (call (ident node_set_kind) (ident node) (ident NODE_FIELD_EXPR)))
                  (var pe (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 8)))
                  (assign (unop * (ident pe)) (ident expr))
                  (var pn (type_ptr (type_ptr (type_base u8))) (binop + (ident node) (number 16)))
                  (assign (unop * (ident pn)) (call (ident tok_lexeme) (ident name_tok)))
                  (var pl (type_ptr (type_base i64)) (binop + (ident node) (number 24)))
                  (assign (unop * (ident pl)) (call (ident tok_lexeme_len) (ident name_tok)))
                  (assign (ident expr) (ident node)))
                (block
                  (assign (ident done) (number 1))))))))
      (return (ident expr))))
  (func parse_finish_call ((param callee (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var args (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident LIMIT_CALL_ARGS) (number 8))))
      (var arg_count (type_base i64) (number 0))
      (if (unop ! (call (ident parse_check) (ident TOKEN_RPAREN)))
        (block
          (var done (type_base i64) (number 0))
          (while (binop == (ident done) (number 0))
            (block
              (var arg (type_ptr (type_base u8)) (call (ident parse_expression)))
              (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident args) (binop * (ident arg_count) (number 8))))
              (assign (unop * (ident p)) (ident arg))
              (assign (ident arg_count) (binop + (ident arg_count) (number 1)))
              (if (unop ! (call (ident parse_match) (ident TOKEN_COMMA)))
                (block
                  (assign (ident done) (number 1))))))))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after arguments")))
      (var node (type_ptr (type_base u8)) (call (ident call_expr_alloc)))
      (expr_stmt (call (ident call_expr_set_func) (ident node) (ident callee)))
      (expr_stmt (call (ident call_expr_set_args) (ident node) (ident args)))
      (expr_stmt (call (ident call_expr_set_arg_count) (ident node) (ident arg_count)))
      (return (ident node))))
  (func parse_pattern () (type_ptr (type_base u8))
    (block
      (if (call (ident parse_check) (ident TOKEN_IDENT))
        (block
          (var tok (type_ptr (type_base u8)) (call (ident parse_peek)))
          (var name (type_ptr (type_base u8)) (call (ident tok_lexeme) (ident tok)))
          (var len (type_base i64) (call (ident tok_lexeme_len) (ident tok)))
          (if (binop && (binop == (ident len) (number 1)) (binop == (unop * (ident name)) (number 95)))
            (block
              (expr_stmt (call (ident parse_advance)))
              (return (call (ident pattern_wildcard_alloc)))))))
      (var enum_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected pattern")))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_DOT) (string "expected '.' after enum name in pattern")))
      (var variant_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected variant name after '.'")))
      (var node (type_ptr (type_base u8)) (call (ident pattern_variant_alloc)))
      (expr_stmt (call (ident pattern_variant_set_enum_name) (ident node) (call (ident tok_lexeme) (ident enum_tok))))
      (expr_stmt (call (ident pattern_variant_set_enum_len) (ident node) (call (ident tok_lexeme_len) (ident enum_tok))))
      (expr_stmt (call (ident pattern_variant_set_name) (ident node) (call (ident tok_lexeme) (ident variant_tok))))
      (expr_stmt (call (ident pattern_variant_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident variant_tok))))
      (if (call (ident parse_match) (ident TOKEN_LPAREN))
        (block
          (var binding_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected binding name")))
          (expr_stmt (call (ident pattern_variant_set_binding) (ident node) (call (ident tok_lexeme) (ident binding_tok))))
          (expr_stmt (call (ident pattern_variant_set_binding_len) (ident node) (call (ident tok_lexeme_len) (ident binding_tok))))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after binding"))))
        (block
          (expr_stmt (call (ident pattern_variant_set_binding) (ident node) (nil)))
          (expr_stmt (call (ident pattern_variant_set_binding_len) (ident node) (number 0)))))
      (return (ident node))))
  (func parse_primary () (type_ptr (type_base u8))
    (block
      (if (call (ident parse_match) (ident TOKEN_NUMBER))
        (block
          (var tok (type_ptr (type_base u8)) (call (ident parse_previous)))
          (var node (type_ptr (type_base u8)) (call (ident number_expr_alloc)))
          (expr_stmt (call (ident number_expr_set_value) (ident node) (call (ident tok_lexeme) (ident tok))))
          (expr_stmt (call (ident number_expr_set_value_len) (ident node) (call (ident tok_lexeme_len) (ident tok))))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_STRING))
        (block
          (var tok (type_ptr (type_base u8)) (call (ident parse_previous)))
          (var node (type_ptr (type_base u8)) (call (ident string_expr_alloc)))
          (expr_stmt (call (ident string_expr_set_value) (ident node) (call (ident tok_lexeme) (ident tok))))
          (expr_stmt (call (ident string_expr_set_value_len) (ident node) (call (ident tok_lexeme_len) (ident tok))))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_TRUE))
        (block
          (var node (type_ptr (type_base u8)) (call (ident bool_expr_alloc)))
          (expr_stmt (call (ident bool_expr_set_value) (ident node) (number 1)))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_FALSE))
        (block
          (var node (type_ptr (type_base u8)) (call (ident bool_expr_alloc)))
          (expr_stmt (call (ident bool_expr_set_value) (ident node) (number 0)))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_NIL))
        (block
          (return (call (ident nil_expr_alloc)))))
      (if (call (ident parse_match) (ident TOKEN_IDENT))
        (block
          (var tok (type_ptr (type_base u8)) (call (ident parse_previous)))
          (var node (type_ptr (type_base u8)) (call (ident ident_expr_alloc)))
          (expr_stmt (call (ident ident_expr_set_name) (ident node) (call (ident tok_lexeme) (ident tok))))
          (expr_stmt (call (ident ident_expr_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident tok))))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_LPAREN))
        (block
          (var expr (type_ptr (type_base u8)) (call (ident parse_expression)))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after expression")))
          (var node (type_ptr (type_base u8)) (call (ident group_expr_alloc)))
          (expr_stmt (call (ident group_expr_set_expr) (ident node) (ident expr)))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_DOLLAR_LBRACE))
        (block
          (var expr (type_ptr (type_base u8)) (call (ident parse_expression)))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_RBRACE) (string "expected '}' after quoted expression")))
          (var node (type_ptr (type_base u8)) (call (ident quote_expr_alloc)))
          (expr_stmt (call (ident quote_expr_set_expr) (ident node) (ident expr)))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_DOLLAR))
        (block
          (expr_stmt (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected identifier after '$'")))
          (var tok (type_ptr (type_base u8)) (call (ident parse_previous)))
          (var node (type_ptr (type_base u8)) (call (ident unquote_expr_alloc)))
          (expr_stmt (call (ident unquote_expr_set_name) (ident node) (call (ident tok_lexeme) (ident tok))))
          (expr_stmt (call (ident unquote_expr_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident tok))))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_DOLLAR_AT))
        (block
          (expr_stmt (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected identifier after '$@'")))
          (var tok (type_ptr (type_base u8)) (call (ident parse_previous)))
          (var node (type_ptr (type_base u8)) (call (ident unquote_string_expr_alloc)))
          (expr_stmt (call (ident unquote_string_expr_set_name) (ident node) (call (ident tok_lexeme) (ident tok))))
          (expr_stmt (call (ident unquote_string_expr_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident tok))))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_READER_MACRO))
        (block
          (var tok (type_ptr (type_base u8)) (call (ident parse_previous)))
          (var node (type_ptr (type_base u8)) (call (ident reader_expr_alloc)))
          (expr_stmt (call (ident reader_expr_set_name) (ident node) (call (ident tok_lexeme) (ident tok))))
          (expr_stmt (call (ident reader_expr_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident tok))))
          (expr_stmt (call (ident reader_expr_set_content) (ident node) (call (ident tok_content) (ident tok))))
          (expr_stmt (call (ident reader_expr_set_content_len) (ident node) (call (ident tok_content_len) (ident tok))))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_LET))
        (block
          (var name_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected identifier after 'let'")))
          (var typ (type_ptr (type_base u8)) (nil))
          (if (unop ! (call (ident parse_check) (ident TOKEN_EQ)))
            (block
              (assign (ident typ) (call (ident parse_type)))))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_EQ) (string "expected '=' in let expression")))
          (var init (type_ptr (type_base u8)) (call (ident parse_expression)))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_IN) (string "expected 'in' after let initializer")))
          (var body (type_ptr (type_base u8)) (call (ident parse_expression)))
          (var node (type_ptr (type_base u8)) (call (ident let_expr_alloc)))
          (expr_stmt (call (ident let_expr_set_name) (ident node) (call (ident tok_lexeme) (ident name_tok))))
          (expr_stmt (call (ident let_expr_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident name_tok))))
          (expr_stmt (call (ident let_expr_set_type) (ident node) (ident typ)))
          (expr_stmt (call (ident let_expr_set_init) (ident node) (ident init)))
          (expr_stmt (call (ident let_expr_set_body) (ident node) (ident body)))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_FN))
        (block
          (expr_stmt (call (ident parse_expect) (ident TOKEN_LPAREN) (string "expected '(' after 'fn' in lambda")))
          (var params (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident LIMIT_FUNC_PARAMS) (number 24))))
          (var param_count (type_base i64) (number 0))
          (if (unop ! (call (ident parse_check) (ident TOKEN_RPAREN)))
            (block
              (var done (type_base i64) (number 0))
              (while (binop == (ident done) (number 0))
                (block
                  (var pname_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected parameter name")))
                  (var ptype (type_ptr (type_base u8)) (call (ident parse_type)))
                  (var p (type_ptr (type_base u8)) (binop + (ident params) (binop * (ident param_count) (number 24))))
                  (expr_stmt (call (ident param_set_name) (ident p) (call (ident tok_lexeme) (ident pname_tok))))
                  (expr_stmt (call (ident param_set_name_len) (ident p) (call (ident tok_lexeme_len) (ident pname_tok))))
                  (expr_stmt (call (ident param_set_type) (ident p) (ident ptype)))
                  (assign (ident param_count) (binop + (ident param_count) (number 1)))
                  (if (unop ! (call (ident parse_match) (ident TOKEN_COMMA)))
                    (block
                      (assign (ident done) (number 1))))))))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after lambda parameters")))
          (var ret_type (type_ptr (type_base u8)) (nil))
          (if (unop ! (call (ident parse_check) (ident TOKEN_LBRACE)))
            (block
              (assign (ident ret_type) (call (ident parse_type)))))
          (var body (type_ptr (type_base u8)) (call (ident parse_block)))
          (var node (type_ptr (type_base u8)) (call (ident lambda_expr_alloc)))
          (expr_stmt (call (ident lambda_expr_set_params) (ident node) (ident params)))
          (expr_stmt (call (ident lambda_expr_set_param_count) (ident node) (ident param_count)))
          (expr_stmt (call (ident lambda_expr_set_ret_type) (ident node) (ident ret_type)))
          (expr_stmt (call (ident lambda_expr_set_body) (ident node) (ident body)))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_MATCH))
        (block
          (var scrutinee (type_ptr (type_base u8)) (call (ident parse_expression)))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_LBRACE) (string "expected '{' after match expression")))
          (var arms (type_ptr (type_base u8)) (call (ident alloc) (binop * (number 32) (number 16))))
          (var arm_count (type_base i64) (number 0))
          (while (binop && (unop ! (call (ident parse_check) (ident TOKEN_RBRACE))) (unop ! (call (ident parse_is_at_end))))
            (block
              (var pattern (type_ptr (type_base u8)) (call (ident parse_pattern)))
              (expr_stmt (call (ident parse_expect) (ident TOKEN_ARROW) (string "expected '=>' after pattern")))
              (var body (type_ptr (type_base u8)) (nil))
              (if (call (ident parse_check) (ident TOKEN_LBRACE))
                (block
                  (assign (ident body) (call (ident parse_block_expr))))
                (block
                  (assign (ident body) (call (ident parse_expression)))))
              (var arm (type_ptr (type_base u8)) (call (ident get_match_arm) (ident arms) (ident arm_count)))
              (expr_stmt (call (ident match_arm_set_pattern) (ident arm) (ident pattern)))
              (expr_stmt (call (ident match_arm_set_body) (ident arm) (ident body)))
              (assign (ident arm_count) (binop + (ident arm_count) (number 1)))
              (expr_stmt (call (ident parse_match) (ident TOKEN_COMMA)))))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_RBRACE) (string "expected '}' after match arms")))
          (var node (type_ptr (type_base u8)) (call (ident match_expr_alloc)))
          (expr_stmt (call (ident match_expr_set_scrutinee) (ident node) (ident scrutinee)))
          (expr_stmt (call (ident match_expr_set_arms) (ident node) (ident arms)))
          (expr_stmt (call (ident match_expr_set_arm_count) (ident node) (ident arm_count)))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_PERFORM))
        (block
          (var name_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected effect name after 'perform'")))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_LPAREN) (string "expected '(' after effect name")))
          (var args (type_ptr (type_base u8)) (call (ident alloc) (binop * (number 64) (number 8))))
          (var arg_count (type_base i64) (number 0))
          (if (unop ! (call (ident parse_check) (ident TOKEN_RPAREN)))
            (block
              (var first_arg (type_ptr (type_base u8)) (call (ident parse_expression)))
              (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident args) (binop * (ident arg_count) (number 8))))
              (assign (unop * (ident p)) (ident first_arg))
              (assign (ident arg_count) (binop + (ident arg_count) (number 1)))
              (while (call (ident parse_match) (ident TOKEN_COMMA))
                (block
                  (var arg (type_ptr (type_base u8)) (call (ident parse_expression)))
                  (var pp (type_ptr (type_ptr (type_base u8))) (binop + (ident args) (binop * (ident arg_count) (number 8))))
                  (assign (unop * (ident pp)) (ident arg))
                  (assign (ident arg_count) (binop + (ident arg_count) (number 1)))))))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after effect arguments")))
          (var node (type_ptr (type_base u8)) (call (ident perform_expr_alloc)))
          (expr_stmt (call (ident perform_expr_set_name) (ident node) (call (ident tok_lexeme) (ident name_tok))))
          (expr_stmt (call (ident perform_expr_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident name_tok))))
          (expr_stmt (call (ident perform_expr_set_args) (ident node) (ident args)))
          (expr_stmt (call (ident perform_expr_set_arg_count) (ident node) (ident arg_count)))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_RESUME))
        (block
          (var k_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected continuation name after 'resume'")))
          (var k_expr (type_ptr (type_base u8)) (call (ident ident_expr_alloc)))
          (expr_stmt (call (ident ident_expr_set_name) (ident k_expr) (call (ident tok_lexeme) (ident k_tok))))
          (expr_stmt (call (ident ident_expr_set_name_len) (ident k_expr) (call (ident tok_lexeme_len) (ident k_tok))))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_LPAREN) (string "expected '(' after continuation")))
          (var value (type_ptr (type_base u8)) (nil))
          (if (unop ! (call (ident parse_check) (ident TOKEN_RPAREN)))
            (block
              (assign (ident value) (call (ident parse_expression)))))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after resume value")))
          (var node (type_ptr (type_base u8)) (call (ident resume_expr_alloc)))
          (expr_stmt (call (ident resume_expr_set_k) (ident node) (ident k_expr)))
          (expr_stmt (call (ident resume_expr_set_value) (ident node) (ident value)))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_HANDLE))
        (block
          (expr_stmt (call (ident parse_expect) (ident TOKEN_LBRACE) (string "expected '{' after 'handle'")))
          (var stmts (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident LIMIT_STMTS_PER_BLOCK) (number 8))))
          (var stmt_count (type_base i64) (number 0))
          (while (binop && (unop ! (call (ident parse_check) (ident TOKEN_RBRACE))) (unop ! (call (ident parse_is_at_end))))
            (block
              (var stmt (type_ptr (type_base u8)) (call (ident parse_statement)))
              (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident stmts) (binop * (ident stmt_count) (number 8))))
              (assign (unop * (ident p)) (ident stmt))
              (assign (ident stmt_count) (binop + (ident stmt_count) (number 1)))))
          (var body (type_ptr (type_base u8)) (call (ident block_stmt_alloc)))
          (expr_stmt (call (ident block_stmt_set_stmts) (ident body) (ident stmts)))
          (expr_stmt (call (ident block_stmt_set_count) (ident body) (ident stmt_count)))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_RBRACE) (string "expected '}' after handle body")))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_WITH) (string "expected 'with' after handle body")))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_LBRACE) (string "expected '{' after 'with'")))
          (var ret_bind (type_ptr (type_base u8)) (nil))
          (var ret_bind_len (type_base i64) (number 0))
          (var ret_body (type_ptr (type_base u8)) (nil))
          (var cases (type_ptr (type_base u8)) (call (ident alloc) (binop * (number 32) (number 56))))
          (var case_count (type_base i64) (number 0))
          (while (binop && (unop ! (call (ident parse_check) (ident TOKEN_RBRACE))) (unop ! (call (ident parse_is_at_end))))
            (block
              (var case_name_tok (type_ptr (type_base u8)) (nil))
              (if (call (ident parse_match) (ident TOKEN_RETURN))
                (block
                  (assign (ident case_name_tok) (call (ident parse_previous))))
                (block
                  (assign (ident case_name_tok) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected effect name or 'return'")))))
              (expr_stmt (call (ident parse_expect) (ident TOKEN_LPAREN) (string "expected '(' after handler case name")))
              (var binding_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected binding name")))
              (var k_tok (type_ptr (type_base u8)) (nil))
              (if (call (ident parse_match) (ident TOKEN_COMMA))
                (block
                  (assign (ident k_tok) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected continuation name")))))
              (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after binding")))
              (expr_stmt (call (ident parse_expect) (ident TOKEN_ARROW) (string "expected '=>' after pattern")))
              (var case_body (type_ptr (type_base u8)) (nil))
              (if (call (ident parse_check) (ident TOKEN_LBRACE))
                (block
                  (assign (ident case_body) (call (ident parse_block))))
                (block
                  (assign (ident case_body) (call (ident parse_expression)))))
              (if (call (ident buf_eq_str) (call (ident tok_lexeme) (ident case_name_tok)) (call (ident tok_lexeme_len) (ident case_name_tok)) (string "return"))
                (block
                  (assign (ident ret_bind) (call (ident tok_lexeme) (ident binding_tok)))
                  (assign (ident ret_bind_len) (call (ident tok_lexeme_len) (ident binding_tok)))
                  (assign (ident ret_body) (ident case_body)))
                (block
                  (var entry (type_ptr (type_base u8)) (binop + (ident cases) (binop * (ident case_count) (number 56))))
                  (var p1 (type_ptr (type_ptr (type_base u8))) (ident entry))
                  (assign (unop * (ident p1)) (call (ident tok_lexeme) (ident case_name_tok)))
                  (var p2 (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
                  (assign (unop * (ident p2)) (call (ident tok_lexeme_len) (ident case_name_tok)))
                  (var p3 (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
                  (assign (unop * (ident p3)) (call (ident tok_lexeme) (ident binding_tok)))
                  (var p4 (type_ptr (type_base i64)) (binop + (ident entry) (number 24)))
                  (assign (unop * (ident p4)) (call (ident tok_lexeme_len) (ident binding_tok)))
                  (var p5 (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 32)))
                  (var p6 (type_ptr (type_base i64)) (binop + (ident entry) (number 40)))
                  (if (binop != (ident k_tok) (nil))
                    (block
                      (assign (unop * (ident p5)) (call (ident tok_lexeme) (ident k_tok)))
                      (assign (unop * (ident p6)) (call (ident tok_lexeme_len) (ident k_tok))))
                    (block
                      (assign (unop * (ident p5)) (nil))
                      (assign (unop * (ident p6)) (number 0))))
                  (var p7 (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 48)))
                  (assign (unop * (ident p7)) (ident case_body))
                  (assign (ident case_count) (binop + (ident case_count) (number 1)))))
              (expr_stmt (call (ident parse_match) (ident TOKEN_COMMA)))))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_RBRACE) (string "expected '}' after handler cases")))
          (var node (type_ptr (type_base u8)) (call (ident handle_expr_alloc)))
          (expr_stmt (call (ident handle_expr_set_body) (ident node) (ident body)))
          (expr_stmt (call (ident handle_expr_set_cases) (ident node) (ident cases)))
          (expr_stmt (call (ident handle_expr_set_case_count) (ident node) (ident case_count)))
          (expr_stmt (call (ident handle_expr_set_ret_bind) (ident node) (ident ret_bind)))
          (expr_stmt (call (ident handle_expr_set_ret_bind_len) (ident node) (ident ret_bind_len)))
          (expr_stmt (call (ident handle_expr_set_ret_body) (ident node) (ident ret_body)))
          (return (ident node))))
      (expr_stmt (call (ident parse_error) (string "expected expression")))
      (var node (type_ptr (type_base u8)) (call (ident number_expr_alloc)))
      (expr_stmt (call (ident number_expr_set_value) (ident node) (string "0")))
      (expr_stmt (call (ident number_expr_set_value_len) (ident node) (number 1)))
      (return (ident node))))
  (func parse_block () (type_ptr (type_base u8))
    (block
      (expr_stmt (call (ident parse_expect) (ident TOKEN_LBRACE) (string "expected '{'")))
      (var stmts (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident LIMIT_STMTS_PER_BLOCK) (number 8))))
      (var stmt_count (type_base i64) (number 0))
      (while (binop && (unop ! (call (ident parse_check) (ident TOKEN_RBRACE))) (unop ! (call (ident parse_is_at_end))))
        (block
          (var stmt (type_ptr (type_base u8)) (call (ident parse_statement)))
          (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident stmts) (binop * (ident stmt_count) (number 8))))
          (assign (unop * (ident p)) (ident stmt))
          (assign (ident stmt_count) (binop + (ident stmt_count) (number 1)))))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_RBRACE) (string "expected '}'")))
      (var node (type_ptr (type_base u8)) (call (ident block_stmt_alloc)))
      (expr_stmt (call (ident block_stmt_set_stmts) (ident node) (ident stmts)))
      (expr_stmt (call (ident block_stmt_set_count) (ident node) (ident stmt_count)))
      (return (ident node))))
  (func parse_block_expr () (type_ptr (type_base u8))
    (block
      (expr_stmt (call (ident parse_expect) (ident TOKEN_LBRACE) (string "expected '{'")))
      (var stmts (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident LIMIT_STMTS_PER_BLOCK) (number 8))))
      (var stmt_count (type_base i64) (number 0))
      (var tail_expr (type_ptr (type_base u8)) (nil))
      (while (binop && (unop ! (call (ident parse_check) (ident TOKEN_RBRACE))) (unop ! (call (ident parse_is_at_end))))
        (block
          (if (binop || (binop || (binop || (binop || (binop || (binop || (call (ident parse_check) (ident TOKEN_VAR)) (call (ident parse_check) (ident TOKEN_IF))) (call (ident parse_check) (ident TOKEN_WHILE))) (call (ident parse_check) (ident TOKEN_RETURN))) (call (ident parse_check) (ident TOKEN_BREAK))) (call (ident parse_check) (ident TOKEN_CONTINUE))) (call (ident parse_check) (ident TOKEN_LBRACE)))
            (block
              (var stmt (type_ptr (type_base u8)) (call (ident parse_statement)))
              (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident stmts) (binop * (ident stmt_count) (number 8))))
              (assign (unop * (ident p)) (ident stmt))
              (assign (ident stmt_count) (binop + (ident stmt_count) (number 1))))
            (block
              (var expr (type_ptr (type_base u8)) (call (ident parse_expression)))
              (if (call (ident parse_check) (ident TOKEN_SEMICOLON))
                (block
                  (expr_stmt (call (ident parse_advance)))
                  (var stmt (type_ptr (type_base u8)) (call (ident expr_stmt_alloc)))
                  (expr_stmt (call (ident expr_stmt_set_expr) (ident stmt) (ident expr)))
                  (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident stmts) (binop * (ident stmt_count) (number 8))))
                  (assign (unop * (ident p)) (ident stmt))
                  (assign (ident stmt_count) (binop + (ident stmt_count) (number 1))))
                (if (call (ident parse_check) (ident TOKEN_RBRACE))
                  (block
                    (assign (ident tail_expr) (ident expr)))
                  (block
                    (if (call (ident parse_check) (ident TOKEN_EQ))
                      (block
                        (expr_stmt (call (ident parse_advance)))
                        (var val (type_ptr (type_base u8)) (call (ident parse_expression)))
                        (expr_stmt (call (ident parse_expect) (ident TOKEN_SEMICOLON) (string "expected ';' after assignment")))
                        (var stmt (type_ptr (type_base u8)) (call (ident assign_stmt_alloc)))
                        (expr_stmt (call (ident assign_stmt_set_target) (ident stmt) (ident expr)))
                        (expr_stmt (call (ident assign_stmt_set_value) (ident stmt) (ident val)))
                        (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident stmts) (binop * (ident stmt_count) (number 8))))
                        (assign (unop * (ident p)) (ident stmt))
                        (assign (ident stmt_count) (binop + (ident stmt_count) (number 1))))
                      (block
                        (expr_stmt (call (ident parse_error) (string "expected ';' or '}' after expression in block"))))))))))))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_RBRACE) (string "expected '}'")))
      (var node (type_ptr (type_base u8)) (call (ident block_expr_alloc)))
      (expr_stmt (call (ident block_expr_set_stmts) (ident node) (ident stmts)))
      (expr_stmt (call (ident block_expr_set_count) (ident node) (ident stmt_count)))
      (expr_stmt (call (ident block_expr_set_tail) (ident node) (ident tail_expr)))
      (return (ident node))))
  (var parse_pending_label (type_ptr (type_base u8)) (nil))
  (var parse_pending_label_len (type_base i64) (number 0))
  (func parse_statement () (type_ptr (type_base u8))
    (block
      (if (call (ident parse_check) (ident TOKEN_IDENT))
        (block
          (var tok (type_ptr (type_base u8)) (call (ident parse_peek)))
          (var next (type_ptr (type_base u8)) (call (ident parse_peek_next)))
          (if (binop && (binop != (ident next) (nil)) (binop == (call (ident tok_type) (ident next)) (ident TOKEN_COLON)))
            (block
              (expr_stmt (call (ident parse_advance)))
              (expr_stmt (call (ident parse_advance)))
              (assign (ident parse_pending_label) (call (ident tok_lexeme) (ident tok)))
              (assign (ident parse_pending_label_len) (call (ident tok_lexeme_len) (ident tok)))
              (return (call (ident parse_statement)))))))
      (if (call (ident parse_match) (ident TOKEN_VAR))
        (block
          (return (call (ident parse_var_decl)))))
      (if (call (ident parse_match) (ident TOKEN_IF))
        (block
          (return (call (ident parse_if_stmt)))))
      (if (call (ident parse_match) (ident TOKEN_WHILE))
        (block
          (return (call (ident parse_while_stmt)))))
      (if (call (ident parse_match) (ident TOKEN_RETURN))
        (block
          (return (call (ident parse_return_stmt)))))
      (if (call (ident parse_match) (ident TOKEN_BREAK))
        (block
          (var node (type_ptr (type_base u8)) (call (ident break_stmt_alloc)))
          (if (call (ident parse_check) (ident TOKEN_IDENT))
            (block
              (var label_tok (type_ptr (type_base u8)) (call (ident parse_advance)))
              (expr_stmt (call (ident break_stmt_set_label) (ident node) (call (ident tok_lexeme) (ident label_tok))))
              (expr_stmt (call (ident break_stmt_set_label_len) (ident node) (call (ident tok_lexeme_len) (ident label_tok)))))
            (block
              (expr_stmt (call (ident break_stmt_set_label) (ident node) (nil)))
              (expr_stmt (call (ident break_stmt_set_label_len) (ident node) (number 0)))))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_SEMICOLON) (string "expected ';' after break")))
          (return (ident node))))
      (if (call (ident parse_match) (ident TOKEN_CONTINUE))
        (block
          (var node (type_ptr (type_base u8)) (call (ident continue_stmt_alloc)))
          (if (call (ident parse_check) (ident TOKEN_IDENT))
            (block
              (var label_tok (type_ptr (type_base u8)) (call (ident parse_advance)))
              (expr_stmt (call (ident continue_stmt_set_label) (ident node) (call (ident tok_lexeme) (ident label_tok))))
              (expr_stmt (call (ident continue_stmt_set_label_len) (ident node) (call (ident tok_lexeme_len) (ident label_tok)))))
            (block
              (expr_stmt (call (ident continue_stmt_set_label) (ident node) (nil)))
              (expr_stmt (call (ident continue_stmt_set_label_len) (ident node) (number 0)))))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_SEMICOLON) (string "expected ';' after continue")))
          (return (ident node))))
      (if (call (ident parse_check) (ident TOKEN_LBRACE))
        (block
          (return (call (ident parse_block)))))
      (return (call (ident parse_expr_stmt)))))
  (func parse_var_decl () (type_ptr (type_base u8))
    (block
      (var name_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected variable name")))
      (var typ (type_ptr (type_base u8)) (call (ident parse_type)))
      (var init (type_ptr (type_base u8)) (nil))
      (if (call (ident parse_match) (ident TOKEN_EQ))
        (block
          (assign (ident init) (call (ident parse_expression)))))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_SEMICOLON) (string "expected ';' after variable declaration")))
      (var node (type_ptr (type_base u8)) (call (ident var_decl_alloc)))
      (expr_stmt (call (ident var_decl_set_name) (ident node) (call (ident tok_lexeme) (ident name_tok))))
      (expr_stmt (call (ident var_decl_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident name_tok))))
      (expr_stmt (call (ident var_decl_set_type) (ident node) (ident typ)))
      (expr_stmt (call (ident var_decl_set_init) (ident node) (ident init)))
      (return (ident node))))
  (func parse_if_stmt () (type_ptr (type_base u8))
    (block
      (var cond (type_ptr (type_base u8)) (call (ident parse_expression)))
      (var then (type_ptr (type_base u8)) (call (ident parse_block)))
      (var els (type_ptr (type_base u8)) (nil))
      (if (call (ident parse_match) (ident TOKEN_ELSE))
        (block
          (if (call (ident parse_check) (ident TOKEN_IF))
            (block
              (expr_stmt (call (ident parse_advance)))
              (assign (ident els) (call (ident parse_if_stmt))))
            (block
              (assign (ident els) (call (ident parse_block)))))))
      (var node (type_ptr (type_base u8)) (call (ident if_stmt_alloc)))
      (expr_stmt (call (ident if_stmt_set_cond) (ident node) (ident cond)))
      (expr_stmt (call (ident if_stmt_set_then) (ident node) (ident then)))
      (expr_stmt (call (ident if_stmt_set_else) (ident node) (ident els)))
      (return (ident node))))
  (func parse_while_stmt () (type_ptr (type_base u8))
    (block
      (var label (type_ptr (type_base u8)) (ident parse_pending_label))
      (var label_len (type_base i64) (ident parse_pending_label_len))
      (assign (ident parse_pending_label) (nil))
      (assign (ident parse_pending_label_len) (number 0))
      (var cond (type_ptr (type_base u8)) (call (ident parse_expression)))
      (var body (type_ptr (type_base u8)) (call (ident parse_block)))
      (var node (type_ptr (type_base u8)) (call (ident while_stmt_alloc)))
      (expr_stmt (call (ident while_stmt_set_cond) (ident node) (ident cond)))
      (expr_stmt (call (ident while_stmt_set_body) (ident node) (ident body)))
      (expr_stmt (call (ident while_stmt_set_label) (ident node) (ident label)))
      (expr_stmt (call (ident while_stmt_set_label_len) (ident node) (ident label_len)))
      (return (ident node))))
  (func parse_return_stmt () (type_ptr (type_base u8))
    (block
      (var value (type_ptr (type_base u8)) (nil))
      (if (unop ! (call (ident parse_check) (ident TOKEN_SEMICOLON)))
        (block
          (assign (ident value) (call (ident parse_expression)))))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_SEMICOLON) (string "expected ';' after return")))
      (var node (type_ptr (type_base u8)) (call (ident return_stmt_alloc)))
      (expr_stmt (call (ident return_stmt_set_value) (ident node) (ident value)))
      (return (ident node))))
  (func parse_expr_stmt () (type_ptr (type_base u8))
    (block
      (var expr (type_ptr (type_base u8)) (call (ident parse_expression)))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_SEMICOLON) (string "expected ';' after expression")))
      (if (binop == (call (ident node_kind) (ident expr)) (ident NODE_BINARY_EXPR))
        (block
          (if (binop == (call (ident binary_expr_op) (ident expr)) (ident TOKEN_EQ))
            (block
              (var node (type_ptr (type_base u8)) (call (ident assign_stmt_alloc)))
              (expr_stmt (call (ident assign_stmt_set_target) (ident node) (call (ident binary_expr_left) (ident expr))))
              (expr_stmt (call (ident assign_stmt_set_value) (ident node) (call (ident binary_expr_right) (ident expr))))
              (return (ident node))))))
      (var node (type_ptr (type_base u8)) (call (ident expr_stmt_alloc)))
      (expr_stmt (call (ident expr_stmt_set_expr) (ident node) (ident expr)))
      (return (ident node))))
  (func parse_func_decl () (type_ptr (type_base u8))
    (block
      (var name_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected function name")))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_LPAREN) (string "expected '(' after function name")))
      (var params (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident LIMIT_FUNC_PARAMS) (number 24))))
      (var param_count (type_base i64) (number 0))
      (if (unop ! (call (ident parse_check) (ident TOKEN_RPAREN)))
        (block
          (var done (type_base i64) (number 0))
          (while (binop == (ident done) (number 0))
            (block
              (var pname_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected parameter name")))
              (var ptype (type_ptr (type_base u8)) (call (ident parse_type)))
              (var p (type_ptr (type_base u8)) (binop + (ident params) (binop * (ident param_count) (number 24))))
              (expr_stmt (call (ident param_set_name) (ident p) (call (ident tok_lexeme) (ident pname_tok))))
              (expr_stmt (call (ident param_set_name_len) (ident p) (call (ident tok_lexeme_len) (ident pname_tok))))
              (expr_stmt (call (ident param_set_type) (ident p) (ident ptype)))
              (assign (ident param_count) (binop + (ident param_count) (number 1)))
              (if (unop ! (call (ident parse_match) (ident TOKEN_COMMA)))
                (block
                  (assign (ident done) (number 1))))))))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after parameters")))
      (var ret_type (type_ptr (type_base u8)) (nil))
      (if (unop ! (call (ident parse_check) (ident TOKEN_LBRACE)))
        (block
          (assign (ident ret_type) (call (ident parse_type)))))
      (var body (type_ptr (type_base u8)) (call (ident parse_block)))
      (var node (type_ptr (type_base u8)) (call (ident func_decl_alloc)))
      (expr_stmt (call (ident func_decl_set_name) (ident node) (call (ident tok_lexeme) (ident name_tok))))
      (expr_stmt (call (ident func_decl_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident name_tok))))
      (expr_stmt (call (ident func_decl_set_params) (ident node) (ident params)))
      (expr_stmt (call (ident func_decl_set_param_count) (ident node) (ident param_count)))
      (expr_stmt (call (ident func_decl_set_ret_type) (ident node) (ident ret_type)))
      (expr_stmt (call (ident func_decl_set_body) (ident node) (ident body)))
      (return (ident node))))
  (func parse_struct_decl () (type_ptr (type_base u8))
    (block
      (var name_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected struct name")))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_LBRACE) (string "expected '{' after struct name")))
      (var fields (type_ptr (type_base u8)) (call (ident alloc) (binop * (number 64) (number 24))))
      (var field_count (type_base i64) (number 0))
      (while (binop && (unop ! (call (ident parse_check) (ident TOKEN_RBRACE))) (unop ! (call (ident parse_is_at_end))))
        (block
          (var field_name (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected field name")))
          (var field_type (type_ptr (type_base u8)) (call (ident parse_type)))
          (expr_stmt (call (ident parse_expect) (ident TOKEN_SEMICOLON) (string "expected ';' after field")))
          (var f (type_ptr (type_base u8)) (call (ident get_struct_field) (ident fields) (ident field_count)))
          (expr_stmt (call (ident struct_field_set_name) (ident f) (call (ident tok_lexeme) (ident field_name))))
          (expr_stmt (call (ident struct_field_set_name_len) (ident f) (call (ident tok_lexeme_len) (ident field_name))))
          (expr_stmt (call (ident struct_field_set_type) (ident f) (ident field_type)))
          (assign (ident field_count) (binop + (ident field_count) (number 1)))))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_RBRACE) (string "expected '}' after struct fields")))
      (var node (type_ptr (type_base u8)) (call (ident struct_decl_alloc)))
      (expr_stmt (call (ident struct_decl_set_name) (ident node) (call (ident tok_lexeme) (ident name_tok))))
      (expr_stmt (call (ident struct_decl_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident name_tok))))
      (expr_stmt (call (ident struct_decl_set_fields) (ident node) (ident fields)))
      (expr_stmt (call (ident struct_decl_set_field_count) (ident node) (ident field_count)))
      (return (ident node))))
  (func parse_enum_decl () (type_ptr (type_base u8))
    (block
      (var name_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected enum name")))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_LBRACE) (string "expected '{' after enum name")))
      (var variants (type_ptr (type_base u8)) (call (ident alloc) (binop * (number 64) (number 32))))
      (var variant_count (type_base i64) (number 0))
      (while (binop && (unop ! (call (ident parse_check) (ident TOKEN_RBRACE))) (unop ! (call (ident parse_is_at_end))))
        (block
          (var vname_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected variant name")))
          (var v (type_ptr (type_base u8)) (call (ident get_enum_variant) (ident variants) (ident variant_count)))
          (expr_stmt (call (ident enum_variant_set_name) (ident v) (call (ident tok_lexeme) (ident vname_tok))))
          (expr_stmt (call (ident enum_variant_set_name_len) (ident v) (call (ident tok_lexeme_len) (ident vname_tok))))
          (expr_stmt (call (ident enum_variant_set_tag) (ident v) (ident variant_count)))
          (if (call (ident parse_match) (ident TOKEN_LPAREN))
            (block
              (var vtype (type_ptr (type_base u8)) (call (ident parse_type)))
              (expr_stmt (call (ident enum_variant_set_type) (ident v) (ident vtype)))
              (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after variant type"))))
            (block
              (expr_stmt (call (ident enum_variant_set_type) (ident v) (nil)))))
          (assign (ident variant_count) (binop + (ident variant_count) (number 1)))
          (expr_stmt (call (ident parse_match) (ident TOKEN_COMMA)))))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_RBRACE) (string "expected '}' after enum variants")))
      (var node (type_ptr (type_base u8)) (call (ident enum_decl_alloc)))
      (expr_stmt (call (ident enum_decl_set_name) (ident node) (call (ident tok_lexeme) (ident name_tok))))
      (expr_stmt (call (ident enum_decl_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident name_tok))))
      (expr_stmt (call (ident enum_decl_set_variants) (ident node) (ident variants)))
      (expr_stmt (call (ident enum_decl_set_variant_count) (ident node) (ident variant_count)))
      (return (ident node))))
  (func parse_effect_decl () (type_ptr (type_base u8))
    (block
      (var name_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected effect name")))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_LPAREN) (string "expected '(' after effect name")))
      (var param_types (type_ptr (type_base u8)) (call (ident alloc) (binop * (number 64) (number 8))))
      (var param_type_count (type_base i64) (number 0))
      (if (unop ! (call (ident parse_check) (ident TOKEN_RPAREN)))
        (block
          (var first_type (type_ptr (type_base u8)) (call (ident parse_type)))
          (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident param_types) (binop * (ident param_type_count) (number 8))))
          (assign (unop * (ident p)) (ident first_type))
          (assign (ident param_type_count) (binop + (ident param_type_count) (number 1)))
          (while (call (ident parse_match) (ident TOKEN_COMMA))
            (block
              (var ptype (type_ptr (type_base u8)) (call (ident parse_type)))
              (var pp (type_ptr (type_ptr (type_base u8))) (binop + (ident param_types) (binop * (ident param_type_count) (number 8))))
              (assign (unop * (ident pp)) (ident ptype))
              (assign (ident param_type_count) (binop + (ident param_type_count) (number 1)))))))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after effect parameters")))
      (var ret_type (type_ptr (type_base u8)) (call (ident parse_type)))
      (var node (type_ptr (type_base u8)) (call (ident effect_decl_alloc)))
      (expr_stmt (call (ident effect_decl_set_name) (ident node) (call (ident tok_lexeme) (ident name_tok))))
      (expr_stmt (call (ident effect_decl_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident name_tok))))
      (expr_stmt (call (ident effect_decl_set_param_types) (ident node) (ident param_types)))
      (expr_stmt (call (ident effect_decl_set_param_type_count) (ident node) (ident param_type_count)))
      (expr_stmt (call (ident effect_decl_set_return_type) (ident node) (ident ret_type)))
      (return (ident node))))
  (func parse_macro_decl () (type_ptr (type_base u8))
    (block
      (var name_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected macro name")))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_LPAREN) (string "expected '(' after macro name")))
      (var params (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident LIMIT_FUNC_PARAMS) (number 24))))
      (var param_count (type_base i64) (number 0))
      (if (unop ! (call (ident parse_check) (ident TOKEN_RPAREN)))
        (block
          (var done (type_base i64) (number 0))
          (while (binop == (ident done) (number 0))
            (block
              (var pname_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected parameter name")))
              (var p (type_ptr (type_base u8)) (binop + (ident params) (binop * (ident param_count) (number 24))))
              (expr_stmt (call (ident param_set_name) (ident p) (call (ident tok_lexeme) (ident pname_tok))))
              (expr_stmt (call (ident param_set_name_len) (ident p) (call (ident tok_lexeme_len) (ident pname_tok))))
              (expr_stmt (call (ident param_set_type) (ident p) (nil)))
              (assign (ident param_count) (binop + (ident param_count) (number 1)))
              (if (unop ! (call (ident parse_match) (ident TOKEN_COMMA)))
                (block
                  (assign (ident done) (number 1))))))))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after macro parameters")))
      (var body (type_ptr (type_base u8)) (call (ident parse_block)))
      (var node (type_ptr (type_base u8)) (call (ident macro_decl_alloc)))
      (expr_stmt (call (ident macro_decl_set_name) (ident node) (call (ident tok_lexeme) (ident name_tok))))
      (expr_stmt (call (ident macro_decl_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident name_tok))))
      (expr_stmt (call (ident macro_decl_set_params) (ident node) (ident params)))
      (expr_stmt (call (ident macro_decl_set_param_count) (ident node) (ident param_count)))
      (expr_stmt (call (ident macro_decl_set_body) (ident node) (ident body)))
      (return (ident node))))
  (func parse_import () (type_ptr (type_base u8))
    (block
      (var path_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_STRING) (string "expected string after 'import'")))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_SEMICOLON) (string "expected ';' after import path")))
      (var node (type_ptr (type_base u8)) (call (ident import_decl_alloc)))
      (expr_stmt (call (ident import_decl_set_path) (ident node) (binop + (call (ident tok_lexeme) (ident path_tok)) (number 1))))
      (expr_stmt (call (ident import_decl_set_path_len) (ident node) (binop - (call (ident tok_lexeme_len) (ident path_tok)) (number 2))))
      (return (ident node))))
  (func parse_reader_decl () (type_ptr (type_base u8))
    (block
      (var name_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected reader name")))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_LPAREN) (string "expected '(' after reader name")))
      (var param_tok (type_ptr (type_base u8)) (call (ident parse_expect) (ident TOKEN_IDENT) (string "expected parameter name")))
      (expr_stmt (call (ident parse_type)))
      (expr_stmt (call (ident parse_expect) (ident TOKEN_RPAREN) (string "expected ')' after reader parameter")))
      (expr_stmt (call (ident parse_type)))
      (var body (type_ptr (type_base u8)) (call (ident parse_block)))
      (var node (type_ptr (type_base u8)) (call (ident reader_decl_alloc)))
      (expr_stmt (call (ident reader_decl_set_name) (ident node) (call (ident tok_lexeme) (ident name_tok))))
      (expr_stmt (call (ident reader_decl_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident name_tok))))
      (expr_stmt (call (ident reader_decl_set_param_name) (ident node) (call (ident tok_lexeme) (ident param_tok))))
      (expr_stmt (call (ident reader_decl_set_param_len) (ident node) (call (ident tok_lexeme_len) (ident param_tok))))
      (expr_stmt (call (ident reader_decl_set_body) (ident node) (ident body)))
      (return (ident node))))
  (func parse_include () (type_ptr (type_base u8))
    (block
      (if (unop ! (call (ident parse_match) (ident TOKEN_STRING)))
        (block
          (expr_stmt (call (ident parse_error) (string "expected string path after include")))
          (return (nil))))
      (var path_tok (type_ptr (type_base u8)) (call (ident parse_previous)))
      (var path (type_ptr (type_base u8)) (call (ident tok_lexeme) (ident path_tok)))
      (var path_len (type_base i64) (call (ident tok_lexeme_len) (ident path_tok)))
      (assign (ident path) (binop + (ident path) (number 1)))
      (assign (ident path_len) (binop - (ident path_len) (number 2)))
      (var node (type_ptr (type_base u8)) (call (ident include_decl_alloc)))
      (expr_stmt (call (ident include_decl_set_path) (ident node) (ident path)))
      (expr_stmt (call (ident include_decl_set_path_len) (ident node) (ident path_len)))
      (return (ident node))))
  (func parse_declaration () (type_ptr (type_base u8))
    (block
      (if (call (ident parse_match) (ident TOKEN_FUNC))
        (block
          (return (call (ident parse_func_decl)))))
      (if (call (ident parse_match) (ident TOKEN_VAR))
        (block
          (return (call (ident parse_var_decl)))))
      (if (call (ident parse_match) (ident TOKEN_STRUCT))
        (block
          (return (call (ident parse_struct_decl)))))
      (if (call (ident parse_match) (ident TOKEN_ENUM))
        (block
          (return (call (ident parse_enum_decl)))))
      (if (call (ident parse_match) (ident TOKEN_EFFECT))
        (block
          (return (call (ident parse_effect_decl)))))
      (if (call (ident parse_match) (ident TOKEN_MACRO))
        (block
          (return (call (ident parse_macro_decl)))))
      (if (call (ident parse_match) (ident TOKEN_IMPORT))
        (block
          (return (call (ident parse_import)))))
      (if (call (ident parse_match) (ident TOKEN_READER))
        (block
          (return (call (ident parse_reader_decl)))))
      (if (call (ident parse_match) (ident TOKEN_INCLUDE))
        (block
          (return (call (ident parse_include)))))
      (if (call (ident parse_match) (ident TOKEN_READER_MACRO))
        (block
          (var tok (type_ptr (type_base u8)) (call (ident parse_previous)))
          (var node (type_ptr (type_base u8)) (call (ident reader_expr_alloc)))
          (expr_stmt (call (ident reader_expr_set_name) (ident node) (call (ident tok_lexeme) (ident tok))))
          (expr_stmt (call (ident reader_expr_set_name_len) (ident node) (call (ident tok_lexeme_len) (ident tok))))
          (expr_stmt (call (ident reader_expr_set_content) (ident node) (call (ident tok_content) (ident tok))))
          (expr_stmt (call (ident reader_expr_set_content_len) (ident node) (call (ident tok_content_len) (ident tok))))
          (return (ident node))))
      (if (call (ident parse_check) (ident TOKEN_SEMICOLON))
        (block
          (expr_stmt (call (ident parse_error) (string "unexpected ';' - lang doesn't use semicolons after include/import")))
          (expr_stmt (call (ident parse_advance)))
          (return (nil))))
      (expr_stmt (call (ident parse_error) (string "expected declaration")))
      (expr_stmt (call (ident parse_advance)))
      (return (nil))))
  (func parse_program () (type_ptr (type_base u8))
    (block
      (var decls (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident LIMIT_TOP_DECLS) (number 8))))
      (var decl_count (type_base i64) (number 0))
      (while (unop ! (call (ident parse_is_at_end)))
        (block
          (var decl (type_ptr (type_base u8)) (call (ident parse_declaration)))
          (if (binop != (ident decl) (nil))
            (block
              (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident decls) (binop * (ident decl_count) (number 8))))
              (assign (unop * (ident p)) (ident decl))
              (assign (ident decl_count) (binop + (ident decl_count) (number 1)))))))
      (var prog (type_ptr (type_base u8)) (call (ident alloc) (number 16)))
      (var pd (type_ptr (type_ptr (type_base u8))) (ident prog))
      (assign (unop * (ident pd)) (ident decls))
      (var pc (type_ptr (type_base i64)) (binop + (ident prog) (number 8)))
      (assign (unop * (ident pc)) (ident decl_count))
      (return (ident prog))))
  (func program_decls ((param prog (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (ident prog))
      (return (unop * (ident p)))))
  (func program_decl_count ((param prog (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident prog) (number 8)))
      (return (unop * (ident p)))))
  (func get_decl ((param decls (type_ptr (type_base u8))) (param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident decls) (binop * (ident index) (number 8))))
      (return (unop * (ident p)))))
  (func parse_expression_from_string ((param source (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var saved_tokens (type_ptr (type_base u8)) (ident parse_tokens))
      (var saved_current (type_base i64) (ident parse_current))
      (var saved_errors (type_base i64) (ident parse_error_count))
      (assign (ident parse_tokens) (call (ident vec_new) (number 8)))
      (assign (ident parse_current) (number 0))
      (assign (ident parse_error_count) (number 0))
      (expr_stmt (call (ident parser_tokenize) (ident source)))
      (var expr (type_ptr (type_base u8)) (nil))
      (if (binop > (call (ident parser_token_count)) (number 0))
        (block
          (assign (ident expr) (call (ident parse_expression)))))
      (expr_stmt (call (ident vec_free) (ident parse_tokens)))
      (assign (ident parse_tokens) (ident saved_tokens))
      (assign (ident parse_current) (ident saved_current))
      (assign (ident parse_error_count) (ident saved_errors))
      (return (ident expr))))
  (func parse_program_from_string ((param source (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var saved_tokens (type_ptr (type_base u8)) (ident parse_tokens))
      (var saved_current (type_base i64) (ident parse_current))
      (var saved_errors (type_base i64) (ident parse_error_count))
      (assign (ident parse_tokens) (call (ident vec_new) (number 8)))
      (assign (ident parse_current) (number 0))
      (assign (ident parse_error_count) (number 0))
      (expr_stmt (call (ident parser_tokenize) (ident source)))
      (var prog (type_ptr (type_base u8)) (nil))
      (if (binop > (call (ident parser_token_count)) (number 0))
        (block
          (assign (ident prog) (call (ident parse_program)))))
      (expr_stmt (call (ident vec_free) (ident parse_tokens)))
      (assign (ident parse_tokens) (ident saved_tokens))
      (assign (ident parse_current) (ident saved_current))
      (assign (ident parse_error_count) (ident saved_errors))
      (return (ident prog))))
  (var cg_out_fd (type_base i64) (number 0))
  (var cg_label_num (type_base i64) (number 0))
  (var cg_locals (type_ptr (type_base u8)) (nil))
  (var cg_local_count (type_base i64) (number 0))
  (var cg_stack_size (type_base i64) (number 0))
  (var cg_globals (type_ptr (type_base u8)) (nil))
  (var cg_global_count (type_base i64) (number 0))
  (var cg_strings (type_ptr (type_base u8)) (nil))
  (var cg_string_count (type_base i64) (number 0))
  (var cg_code_buf (type_ptr (type_base u8)) (nil))
  (var cg_code_len (type_base i64) (number 0))
  (var cg_code_cap (type_base i64) (number 0))
  (var cg_func_buf (type_ptr (type_base u8)) (nil))
  (var cg_func_len (type_base i64) (number 0))
  (var cg_func_cap (type_base i64) (number 0))
  (var cg_in_func_body (type_base i64) (number 0))
  (var cg_structs (type_ptr (type_base u8)) (nil))
  (var cg_struct_count (type_base i64) (number 0))
  (var cg_enums (type_ptr (type_base u8)) (nil))
  (var cg_enum_count (type_base i64) (number 0))
  (var cg_macros (type_ptr (type_base u8)) (nil))
  (var cg_macro_count (type_base i64) (number 0))
  (var cg_readers (type_ptr (type_base u8)) (nil))
  (var cg_reader_count (type_base i64) (number 0))
  (var cg_funcs (type_ptr (type_base u8)) (nil))
  (var cg_func_count (type_base i64) (number 0))
  (var cg_lambdas (type_ptr (type_base u8)) (nil))
  (var cg_lambda_count (type_base i64) (number 0))
  (var cg_current_captures (type_ptr (type_base u8)) (nil))
  (var cg_current_capture_count (type_base i64) (number 0))
  (var cg_lambda_scope_start (type_base i64) (number 0))
  (var cg_parent_captures (type_ptr (type_base u8)) (nil))
  (var cg_parent_capture_count (type_base i64) (number 0))
  (var cg_in_closure (type_base i64) (number 0))
  (var cg_closure_ptr_offset (type_base i64) (number 0))
  (var cg_closure_captures (type_ptr (type_base u8)) (nil))
  (var cg_closure_capture_count (type_base i64) (number 0))
  (var cg_effects (type_ptr (type_base u8)) (nil))
  (var cg_effect_count (type_base i64) (number 0))
  (var cg_handler_depth (type_base i64) (number 0))
  (var cg_include_stack (type_ptr (type_base u8)) (nil))
  (var cg_include_count (type_base i64) (number 0))
  (var cg_included_files (type_ptr (type_base u8)) (nil))
  (var cg_expand_macros (type_base i64) (number 0))
  (var cg_loop_stack (type_ptr (type_base u8)) (nil))
  (var cg_loop_depth (type_base i64) (number 0))
  (func loop_stack_push ((param name (type_ptr (type_base u8))) (param name_len (type_base i64)) (param break_label (type_base i64)) (param continue_label (type_base i64))) (type_base void)
    (block
      (if (binop == (ident cg_loop_stack) (nil))
        (block
          (assign (ident cg_loop_stack) (call (ident alloc) (binop * (ident LIMIT_LOOP_DEPTH) (number 32))))))
      (var entry (type_ptr (type_base u8)) (binop + (ident cg_loop_stack) (binop * (ident cg_loop_depth) (number 32))))
      (var p_name (type_ptr (type_ptr (type_base u8))) (ident entry))
      (assign (unop * (ident p_name)) (ident name))
      (var p_len (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
      (assign (unop * (ident p_len)) (ident name_len))
      (var p_break (type_ptr (type_base i64)) (binop + (ident entry) (number 16)))
      (assign (unop * (ident p_break)) (ident break_label))
      (var p_cont (type_ptr (type_base i64)) (binop + (ident entry) (number 24)))
      (assign (unop * (ident p_cont)) (ident continue_label))
      (assign (ident cg_loop_depth) (binop + (ident cg_loop_depth) (number 1)))))
  (func loop_stack_pop () (type_base void)
    (block
      (if (binop > (ident cg_loop_depth) (number 0))
        (block
          (assign (ident cg_loop_depth) (binop - (ident cg_loop_depth) (number 1)))))))
  (func loop_stack_find ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_ptr (type_base u8))
    (block
      (var i (type_base i64) (binop - (ident cg_loop_depth) (number 1)))
      (while (binop >= (ident i) (number 0))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident cg_loop_stack) (binop * (ident i) (number 32))))
          (var p_name (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var entry_name (type_ptr (type_base u8)) (unop * (ident p_name)))
          (var p_len (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (var entry_len (type_base i64) (unop * (ident p_len)))
          (if (binop == (ident name) (nil))
            (block
              (return (ident entry))))
          (if (binop && (binop != (ident entry_name) (nil)) (binop == (ident entry_len) (ident name_len)))
            (block
              (var is_match (type_base i64) (number 1))
              (var j (type_base i64) (number 0))
              (while (binop < (ident j) (ident name_len))
                (block
                  (if (binop != (unop * (binop + (ident name) (ident j))) (unop * (binop + (ident entry_name) (ident j))))
                    (block
                      (assign (ident is_match) (number 0))))
                  (assign (ident j) (binop + (ident j) (number 1)))))
              (if (binop == (ident is_match) (number 1))
                (block
                  (return (ident entry))))))
          (assign (ident i) (binop - (ident i) (number 1)))))
      (return (nil))))
  (func loop_entry_break_label ((param entry (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident entry) (number 16)))
      (return (unop * (ident p)))))
  (func loop_entry_continue_label ((param entry (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (ident entry) (number 24)))
      (return (unop * (ident p)))))
  (var cg_decls (type_ptr (type_base u8)) (nil))
  (var cg_decl_count (type_base i64) (number 0))
  (var cg_temp_struct_decl (type_ptr (type_base u8)) (nil))
  (var cg_current_file_decls (type_ptr (type_base u8)) (nil))
  (var cg_current_file_decl_count (type_base i64) (number 0))
  (var cg_in_scoped_context (type_base i64) (number 0))
  (func codegen_init () (type_base void)
    (block
      (assign (ident cg_locals) (call (ident alloc) (binop * (ident LIMIT_LOCALS) (number 32))))
      (assign (ident cg_local_count) (number 0))
      (assign (ident cg_stack_size) (number 0))
      (assign (ident cg_globals) (call (ident alloc) (binop * (ident LIMIT_GLOBALS) (number 32))))
      (assign (ident cg_global_count) (number 0))
      (assign (ident cg_strings) (call (ident alloc) (binop * (ident LIMIT_STRINGS) (number 16))))
      (assign (ident cg_string_count) (number 0))
      (assign (ident cg_code_buf) (call (ident alloc) (ident SIZE_CODE_BUF)))
      (assign (ident cg_code_len) (number 0))
      (assign (ident cg_code_cap) (ident SIZE_CODE_BUF))
      (assign (ident cg_func_buf) (call (ident alloc) (ident SIZE_FUNC_BUF)))
      (assign (ident cg_func_len) (number 0))
      (assign (ident cg_func_cap) (ident SIZE_FUNC_BUF))
      (assign (ident cg_in_func_body) (number 0))
      (assign (ident cg_label_num) (number 0))
      (assign (ident cg_structs) (call (ident alloc) (binop * (ident LIMIT_STRUCTS) (number 24))))
      (assign (ident cg_struct_count) (number 0))
      (assign (ident cg_enums) (call (ident alloc) (binop * (ident LIMIT_ENUMS) (number 24))))
      (assign (ident cg_enum_count) (number 0))
      (assign (ident cg_effects) (call (ident alloc) (binop * (ident LIMIT_EFFECTS) (number 24))))
      (assign (ident cg_effect_count) (number 0))
      (assign (ident cg_macros) (call (ident alloc) (binop * (ident LIMIT_MACROS) (number 24))))
      (assign (ident cg_macro_count) (number 0))
      (assign (ident cg_readers) (call (ident alloc) (binop * (ident LIMIT_READERS) (number 24))))
      (assign (ident cg_reader_count) (number 0))
      (assign (ident cg_funcs) (call (ident alloc) (binop * (ident LIMIT_FUNCS) (number 24))))
      (assign (ident cg_func_count) (number 0))
      (assign (ident cg_include_stack) (call (ident alloc) (binop * (ident LIMIT_INCLUDE_DEPTH) (number 16))))
      (assign (ident cg_include_count) (number 0))
      (assign (ident cg_included_files) (call (ident map_new)))))
  (func local_get_name ((param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident cg_locals) (binop * (ident index) (number 32))))
      (return (unop * (ident p)))))
  (func local_set_name ((param index (type_base i64)) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident cg_locals) (binop * (ident index) (number 32))))
      (assign (unop * (ident p)) (ident ptr))))
  (func local_get_name_len ((param index (type_base i64))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (binop + (ident cg_locals) (binop * (ident index) (number 32))) (number 8)))
      (return (unop * (ident p)))))
  (func local_set_name_len ((param index (type_base i64)) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (binop + (ident cg_locals) (binop * (ident index) (number 32))) (number 8)))
      (assign (unop * (ident p)) (ident len))))
  (func local_get_offset ((param index (type_base i64))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (binop + (ident cg_locals) (binop * (ident index) (number 32))) (number 16)))
      (return (unop * (ident p)))))
  (func local_set_offset ((param index (type_base i64)) (param off (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (binop + (ident cg_locals) (binop * (ident index) (number 32))) (number 16)))
      (assign (unop * (ident p)) (ident off))))
  (func local_get_type ((param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (binop + (ident cg_locals) (binop * (ident index) (number 32))) (number 24)))
      (return (unop * (ident p)))))
  (func local_set_type ((param index (type_base i64)) (param t (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (binop + (ident cg_locals) (binop * (ident index) (number 32))) (number 24)))
      (assign (unop * (ident p)) (ident t))))
  (func find_local ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_base i64)
    (block
      (var i (type_base i64) (binop - (ident cg_local_count) (number 1)))
      (while (binop >= (ident i) (number 0))
        (block
          (if (binop == (call (ident local_get_name_len) (ident i)) (ident name_len))
            (block
              (if (call (ident memcmp) (call (ident local_get_name) (ident i)) (ident name) (ident name_len))
                (block
                  (return (ident i))))))
          (assign (ident i) (binop - (ident i) (number 1)))))
      (return (binop - (number 0) (number 1)))))
  (func add_local ((param name (type_ptr (type_base u8))) (param name_len (type_base i64)) (param offset (type_base i64)) (param t (type_ptr (type_base u8)))) (type_base void)
    (block
      (expr_stmt (call (ident local_set_name) (ident cg_local_count) (ident name)))
      (expr_stmt (call (ident local_set_name_len) (ident cg_local_count) (ident name_len)))
      (expr_stmt (call (ident local_set_offset) (ident cg_local_count) (ident offset)))
      (expr_stmt (call (ident local_set_type) (ident cg_local_count) (ident t)))
      (assign (ident cg_local_count) (binop + (ident cg_local_count) (number 1)))))
  (func capture_get_name ((param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident cg_current_captures) (binop * (ident index) (number 32))))
      (return (unop * (ident p)))))
  (func capture_set_name ((param index (type_base i64)) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident cg_current_captures) (binop * (ident index) (number 32))))
      (assign (unop * (ident p)) (ident ptr))))
  (func capture_get_name_len ((param index (type_base i64))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (binop + (ident cg_current_captures) (binop * (ident index) (number 32))) (number 8)))
      (return (unop * (ident p)))))
  (func capture_set_name_len ((param index (type_base i64)) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (binop + (ident cg_current_captures) (binop * (ident index) (number 32))) (number 8)))
      (assign (unop * (ident p)) (ident len))))
  (func capture_get_outer_offset ((param index (type_base i64))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (binop + (ident cg_current_captures) (binop * (ident index) (number 32))) (number 16)))
      (return (unop * (ident p)))))
  (func capture_set_outer_offset ((param index (type_base i64)) (param off (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (binop + (ident cg_current_captures) (binop * (ident index) (number 32))) (number 16)))
      (assign (unop * (ident p)) (ident off))))
  (func capture_get_type ((param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (binop + (ident cg_current_captures) (binop * (ident index) (number 32))) (number 24)))
      (return (unop * (ident p)))))
  (func capture_set_type ((param index (type_base i64)) (param t (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (binop + (ident cg_current_captures) (binop * (ident index) (number 32))) (number 24)))
      (assign (unop * (ident p)) (ident t))))
  (func find_capture ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_base i64)
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_current_capture_count))
        (block
          (if (binop == (call (ident capture_get_name_len) (ident i)) (ident name_len))
            (block
              (if (call (ident memcmp) (call (ident capture_get_name) (ident i)) (ident name) (ident name_len))
                (block
                  (return (ident i))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (binop - (number 0) (number 1)))))
  (func add_capture ((param name (type_ptr (type_base u8))) (param name_len (type_base i64)) (param outer_offset (type_base i64)) (param t (type_ptr (type_base u8)))) (type_base void)
    (block
      (if (binop >= (call (ident find_capture) (ident name) (ident name_len)) (number 0))
        (block
          (return)))
      (expr_stmt (call (ident capture_set_name) (ident cg_current_capture_count) (ident name)))
      (expr_stmt (call (ident capture_set_name_len) (ident cg_current_capture_count) (ident name_len)))
      (expr_stmt (call (ident capture_set_outer_offset) (ident cg_current_capture_count) (ident outer_offset)))
      (expr_stmt (call (ident capture_set_type) (ident cg_current_capture_count) (ident t)))
      (assign (ident cg_current_capture_count) (binop + (ident cg_current_capture_count) (number 1)))))
  (func init_capture_tracking () (type_base void)
    (block
      (if (binop == (ident cg_current_captures) (nil))
        (block
          (assign (ident cg_current_captures) (call (ident alloc) (binop * (ident LIMIT_CAPTURES) (number 32))))))
      (assign (ident cg_current_capture_count) (number 0))))
  (func find_in_parent_captures ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_base i64)
    (block
      (if (binop == (ident cg_parent_captures) (nil))
        (block
          (return (binop - (number 0) (number 1)))))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_parent_capture_count))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident cg_parent_captures) (binop * (ident i) (number 32))))
          (var cap_name_p (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var cap_name (type_ptr (type_base u8)) (unop * (ident cap_name_p)))
          (var cap_len_p (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (var cap_len (type_base i64) (unop * (ident cap_len_p)))
          (if (binop == (ident cap_len) (ident name_len))
            (block
              (if (call (ident memcmp) (ident cap_name) (ident name) (ident name_len))
                (block
                  (return (ident i))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (binop - (number 0) (number 1)))))
  (func get_parent_capture_type ((param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (var entry (type_ptr (type_base u8)) (binop + (binop + (ident cg_parent_captures) (binop * (ident index) (number 32))) (number 24)))
      (var type_p (type_ptr (type_ptr (type_base u8))) (ident entry))
      (return (unop * (ident type_p)))))
  (func analyze_captures_block ((param block (type_ptr (type_base u8)))) (type_base void)
    (block
      (var stmts (type_ptr (type_base u8)) (call (ident block_stmt_stmts) (ident block)))
      (var count (type_base i64) (call (ident block_stmt_count) (ident block)))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident count))
        (block
          (var stmt_p (type_ptr (type_ptr (type_base u8))) (binop + (ident stmts) (binop * (ident i) (number 8))))
          (expr_stmt (call (ident analyze_captures_stmt) (unop * (ident stmt_p))))
          (assign (ident i) (binop + (ident i) (number 1)))))))
  (func analyze_captures_stmt ((param stmt (type_ptr (type_base u8)))) (type_base void)
    (block
      (if (binop == (ident stmt) (nil))
        (block
          (return)))
      (var k (type_base i64) (call (ident node_kind) (ident stmt)))
      (if (binop == (ident k) (ident NODE_BLOCK_STMT))
        (block
          (expr_stmt (call (ident analyze_captures_block) (ident stmt))))
        (if (binop == (ident k) (ident NODE_IF_STMT))
          (block
            (expr_stmt (call (ident analyze_captures_expr) (call (ident if_stmt_cond) (ident stmt))))
            (expr_stmt (call (ident analyze_captures_stmt) (call (ident if_stmt_then) (ident stmt))))
            (var else_part (type_ptr (type_base u8)) (call (ident if_stmt_else) (ident stmt)))
            (if (binop != (ident else_part) (nil))
              (block
                (expr_stmt (call (ident analyze_captures_stmt) (ident else_part))))))
          (if (binop == (ident k) (ident NODE_WHILE_STMT))
            (block
              (expr_stmt (call (ident analyze_captures_expr) (call (ident while_stmt_cond) (ident stmt))))
              (expr_stmt (call (ident analyze_captures_stmt) (call (ident while_stmt_body) (ident stmt)))))
            (if (binop == (ident k) (ident NODE_RETURN_STMT))
              (block
                (var ret_val (type_ptr (type_base u8)) (call (ident return_stmt_value) (ident stmt)))
                (if (binop != (ident ret_val) (nil))
                  (block
                    (expr_stmt (call (ident analyze_captures_expr) (ident ret_val))))))
              (if (binop == (ident k) (ident NODE_EXPR_STMT))
                (block
                  (expr_stmt (call (ident analyze_captures_expr) (call (ident expr_stmt_expr) (ident stmt)))))
                (if (binop == (ident k) (ident NODE_VAR_DECL))
                  (block
                    (var init (type_ptr (type_base u8)) (call (ident var_decl_init) (ident stmt)))
                    (if (binop != (ident init) (nil))
                      (block
                        (expr_stmt (call (ident analyze_captures_expr) (ident init))))))
                  (if (binop == (ident k) (ident NODE_ASSIGN_STMT))
                    (block
                      (expr_stmt (call (ident analyze_captures_expr) (call (ident assign_stmt_target) (ident stmt))))
                      (expr_stmt (call (ident analyze_captures_expr) (call (ident assign_stmt_value) (ident stmt))))))))))))))
  (func analyze_captures_expr ((param expr (type_ptr (type_base u8)))) (type_base void)
    (block
      (if (binop == (ident expr) (nil))
        (block
          (return)))
      (var k (type_base i64) (call (ident node_kind) (ident expr)))
      (if (binop == (ident k) (ident NODE_IDENT_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident expr)))
          (var local_idx (type_base i64) (call (ident find_local) (ident name) (ident name_len)))
          (if (binop && (binop >= (ident local_idx) (number 0)) (binop < (ident local_idx) (ident cg_lambda_scope_start)))
            (block
              (var outer_offset (type_base i64) (call (ident local_get_offset) (ident local_idx)))
              (var local_type (type_ptr (type_base u8)) (call (ident local_get_type) (ident local_idx)))
              (expr_stmt (call (ident add_capture) (ident name) (ident name_len) (ident outer_offset) (ident local_type))))
            (if (binop < (ident local_idx) (number 0))
              (block
                (var parent_idx (type_base i64) (call (ident find_in_parent_captures) (ident name) (ident name_len)))
                (if (binop >= (ident parent_idx) (number 0))
                  (block
                    (var parent_type (type_ptr (type_base u8)) (call (ident get_parent_capture_type) (ident parent_idx)))
                    (expr_stmt (call (ident add_capture) (ident name) (ident name_len) (binop - (number 0) (number 1)) (ident parent_type)))))))))
        (if (binop == (ident k) (ident NODE_BINARY_EXPR))
          (block
            (expr_stmt (call (ident analyze_captures_expr) (call (ident binary_expr_left) (ident expr))))
            (expr_stmt (call (ident analyze_captures_expr) (call (ident binary_expr_right) (ident expr)))))
          (if (binop == (ident k) (ident NODE_UNARY_EXPR))
            (block
              (expr_stmt (call (ident analyze_captures_expr) (call (ident unary_expr_expr) (ident expr)))))
            (if (binop == (ident k) (ident NODE_CALL_EXPR))
              (block
                (expr_stmt (call (ident analyze_captures_expr) (call (ident call_expr_func) (ident expr))))
                (var args (type_ptr (type_base u8)) (call (ident call_expr_args) (ident expr)))
                (var arg_count (type_base i64) (call (ident call_expr_arg_count) (ident expr)))
                (var i (type_base i64) (number 0))
                (while (binop < (ident i) (ident arg_count))
                  (block
                    (var arg_p (type_ptr (type_ptr (type_base u8))) (binop + (ident args) (binop * (ident i) (number 8))))
                    (expr_stmt (call (ident analyze_captures_expr) (unop * (ident arg_p))))
                    (assign (ident i) (binop + (ident i) (number 1))))))
              (if (binop == (ident k) (ident NODE_FIELD_EXPR))
                (block
                  (expr_stmt (call (ident analyze_captures_expr) (call (ident field_expr_expr) (ident expr)))))
                (if (binop == (ident k) (ident NODE_INDEX_EXPR))
                  (block
                    (var idx_expr_p (type_ptr (type_ptr (type_base u8))) (binop + (ident expr) (number 8)))
                    (var idx_index_p (type_ptr (type_ptr (type_base u8))) (binop + (ident expr) (number 16)))
                    (expr_stmt (call (ident analyze_captures_expr) (unop * (ident idx_expr_p))))
                    (expr_stmt (call (ident analyze_captures_expr) (unop * (ident idx_index_p)))))
                  (if (binop == (ident k) (ident NODE_GROUP_EXPR))
                    (block
                      (expr_stmt (call (ident analyze_captures_expr) (call (ident group_expr_expr) (ident expr)))))
                    (if (binop == (ident k) (ident NODE_LET_EXPR))
                      (block
                        (expr_stmt (call (ident analyze_captures_expr) (call (ident let_expr_init) (ident expr))))
                        (expr_stmt (call (ident analyze_captures_expr) (call (ident let_expr_body) (ident expr)))))
                      (if (binop == (ident k) (ident NODE_LAMBDA_EXPR))
                        (block
                          (expr_stmt (call (ident analyze_captures_block) (call (ident lambda_expr_body) (ident expr)))))
                        (if (binop == (ident k) (ident NODE_MATCH_EXPR))
                          (block
                            (expr_stmt (call (ident analyze_captures_expr) (call (ident match_expr_scrutinee) (ident expr))))
                            (var arms (type_ptr (type_base u8)) (call (ident match_expr_arms) (ident expr)))
                            (var arm_count (type_base i64) (call (ident match_expr_arm_count) (ident expr)))
                            (var i (type_base i64) (number 0))
                            (while (binop < (ident i) (ident arm_count))
                              (block
                                (var arm (type_ptr (type_base u8)) (call (ident get_match_arm) (ident arms) (ident i)))
                                (expr_stmt (call (ident analyze_captures_expr) (call (ident match_arm_body) (ident arm))))
                                (assign (ident i) (binop + (ident i) (number 1))))))))))))))))))
  (func analyze_lambda_captures ((param lambda_node (type_ptr (type_base u8))) (param param_count (type_base i64))) (type_base i64)
    (block
      (expr_stmt (call (ident init_capture_tracking)))
      (assign (ident cg_lambda_scope_start) (ident cg_local_count))
      (expr_stmt (call (ident analyze_captures_block) (call (ident lambda_expr_body) (ident lambda_node))))
      (return (ident cg_current_capture_count))))
  (func find_closure_capture ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_base i64)
    (block
      (if (binop == (ident cg_in_closure) (number 0))
        (block
          (return (binop - (number 0) (number 1)))))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_closure_capture_count))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident cg_closure_captures) (binop * (ident i) (number 32))))
          (var cap_name (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var cap_len (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (if (binop == (unop * (ident cap_len)) (ident name_len))
            (block
              (if (call (ident memcmp) (unop * (ident cap_name)) (ident name) (ident name_len))
                (block
                  (return (ident i))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (binop - (number 0) (number 1)))))
  (func closure_capture_type ((param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (var entry (type_ptr (type_base u8)) (binop + (ident cg_closure_captures) (binop * (ident index) (number 32))))
      (var type_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 24)))
      (return (unop * (ident type_ptr)))))
  (func lambda_has_captures ((param lambda_node (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var saved_captures (type_ptr (type_base u8)) (ident cg_current_captures))
      (var saved_count (type_base i64) (ident cg_current_capture_count))
      (var saved_scope_start (type_base i64) (ident cg_lambda_scope_start))
      (var saved_parent_captures (type_ptr (type_base u8)) (ident cg_parent_captures))
      (var saved_parent_count (type_base i64) (ident cg_parent_capture_count))
      (if (binop == (ident cg_in_closure) (number 1))
        (block
          (assign (ident cg_parent_captures) (ident cg_closure_captures))
          (assign (ident cg_parent_capture_count) (ident cg_closure_capture_count))))
      (var param_count (type_base i64) (call (ident lambda_expr_param_count) (ident lambda_node)))
      (var capture_count (type_base i64) (call (ident analyze_lambda_captures) (ident lambda_node) (ident param_count)))
      (assign (ident cg_current_captures) (ident saved_captures))
      (assign (ident cg_current_capture_count) (ident saved_count))
      (assign (ident cg_lambda_scope_start) (ident saved_scope_start))
      (assign (ident cg_parent_captures) (ident saved_parent_captures))
      (assign (ident cg_parent_capture_count) (ident saved_parent_count))
      (if (binop > (ident capture_count) (number 0))
        (block
          (return (number 1))))
      (return (number 0))))
  (func global_get_name ((param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident cg_globals) (binop * (ident index) (number 32))))
      (return (unop * (ident p)))))
  (func global_set_name ((param index (type_base i64)) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident cg_globals) (binop * (ident index) (number 32))))
      (assign (unop * (ident p)) (ident ptr))))
  (func global_get_name_len ((param index (type_base i64))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (binop + (ident cg_globals) (binop * (ident index) (number 32))) (number 8)))
      (return (unop * (ident p)))))
  (func global_set_name_len ((param index (type_base i64)) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (binop + (ident cg_globals) (binop * (ident index) (number 32))) (number 8)))
      (assign (unop * (ident p)) (ident len))))
  (func global_get_type ((param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (binop + (ident cg_globals) (binop * (ident index) (number 32))) (number 16)))
      (return (unop * (ident p)))))
  (func global_set_type ((param index (type_base i64)) (param t (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (binop + (ident cg_globals) (binop * (ident index) (number 32))) (number 16)))
      (assign (unop * (ident p)) (ident t))))
  (func global_get_init ((param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (binop + (ident cg_globals) (binop * (ident index) (number 32))) (number 24)))
      (return (unop * (ident p)))))
  (func global_set_init ((param index (type_base i64)) (param init (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (binop + (ident cg_globals) (binop * (ident index) (number 32))) (number 24)))
      (assign (unop * (ident p)) (ident init))))
  (func find_global ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_base i64)
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_global_count))
        (block
          (if (binop == (call (ident global_get_name_len) (ident i)) (ident name_len))
            (block
              (if (call (ident memcmp) (call (ident global_get_name) (ident i)) (ident name) (ident name_len))
                (block
                  (return (ident i))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (binop - (number 0) (number 1)))))
  (func add_global ((param name (type_ptr (type_base u8))) (param name_len (type_base i64)) (param t (type_ptr (type_base u8))) (param init (type_ptr (type_base u8)))) (type_base void)
    (block
      (expr_stmt (call (ident global_set_name) (ident cg_global_count) (ident name)))
      (expr_stmt (call (ident global_set_name_len) (ident cg_global_count) (ident name_len)))
      (expr_stmt (call (ident global_set_type) (ident cg_global_count) (ident t)))
      (expr_stmt (call (ident global_set_init) (ident cg_global_count) (ident init)))
      (assign (ident cg_global_count) (binop + (ident cg_global_count) (number 1)))))
  (func add_struct ((param decl (type_ptr (type_base u8)))) (type_base void)
    (block
      (var name (type_ptr (type_base u8)) (call (ident struct_decl_name) (ident decl)))
      (var name_len (type_base i64) (call (ident struct_decl_name_len) (ident decl)))
      (var entry (type_ptr (type_base u8)) (binop + (ident cg_structs) (binop * (ident cg_struct_count) (number 24))))
      (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
      (assign (unop * (ident np)) (ident name))
      (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
      (assign (unop * (ident nl)) (ident name_len))
      (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
      (assign (unop * (ident dp)) (ident decl))
      (assign (ident cg_struct_count) (binop + (ident cg_struct_count) (number 1)))))
  (func find_struct ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_ptr (type_base u8))
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_struct_count))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident cg_structs) (binop * (ident i) (number 24))))
          (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var sname (type_ptr (type_base u8)) (unop * (ident np)))
          (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (var slen (type_base i64) (unop * (ident nl)))
          (if (binop == (ident slen) (ident name_len))
            (block
              (if (call (ident memcmp) (ident sname) (ident name) (ident name_len))
                (block
                  (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
                  (return (unop * (ident dp)))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (nil))))
  (func add_enum ((param decl (type_ptr (type_base u8)))) (type_base void)
    (block
      (var name (type_ptr (type_base u8)) (call (ident enum_decl_name) (ident decl)))
      (var name_len (type_base i64) (call (ident enum_decl_name_len) (ident decl)))
      (var entry (type_ptr (type_base u8)) (binop + (ident cg_enums) (binop * (ident cg_enum_count) (number 24))))
      (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
      (assign (unop * (ident np)) (ident name))
      (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
      (assign (unop * (ident nl)) (ident name_len))
      (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
      (assign (unop * (ident dp)) (ident decl))
      (assign (ident cg_enum_count) (binop + (ident cg_enum_count) (number 1)))))
  (func find_enum ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_ptr (type_base u8))
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_enum_count))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident cg_enums) (binop * (ident i) (number 24))))
          (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var ename (type_ptr (type_base u8)) (unop * (ident np)))
          (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (var elen (type_base i64) (unop * (ident nl)))
          (if (binop == (ident elen) (ident name_len))
            (block
              (if (call (ident memcmp) (ident ename) (ident name) (ident name_len))
                (block
                  (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
                  (return (unop * (ident dp)))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (nil))))
  (func find_variant ((param enum_decl (type_ptr (type_base u8))) (param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_ptr (type_base u8))
    (block
      (var variants (type_ptr (type_base u8)) (call (ident enum_decl_variants) (ident enum_decl)))
      (var count (type_base i64) (call (ident enum_decl_variant_count) (ident enum_decl)))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident count))
        (block
          (var v (type_ptr (type_base u8)) (call (ident get_enum_variant) (ident variants) (ident i)))
          (var vname (type_ptr (type_base u8)) (call (ident enum_variant_name) (ident v)))
          (var vlen (type_base i64) (call (ident enum_variant_name_len) (ident v)))
          (if (binop == (ident vlen) (ident name_len))
            (block
              (if (call (ident memcmp) (ident vname) (ident name) (ident name_len))
                (block
                  (return (ident v))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (nil))))
  (func add_effect ((param decl (type_ptr (type_base u8)))) (type_base void)
    (block
      (var name (type_ptr (type_base u8)) (call (ident effect_decl_name) (ident decl)))
      (var name_len (type_base i64) (call (ident effect_decl_name_len) (ident decl)))
      (var entry (type_ptr (type_base u8)) (binop + (ident cg_effects) (binop * (ident cg_effect_count) (number 24))))
      (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
      (assign (unop * (ident np)) (ident name))
      (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
      (assign (unop * (ident nl)) (ident name_len))
      (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
      (assign (unop * (ident dp)) (ident decl))
      (assign (ident cg_effect_count) (binop + (ident cg_effect_count) (number 1)))))
  (func find_effect ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_ptr (type_base u8))
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_effect_count))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident cg_effects) (binop * (ident i) (number 24))))
          (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var ename (type_ptr (type_base u8)) (unop * (ident np)))
          (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (var elen (type_base i64) (unop * (ident nl)))
          (if (binop == (ident elen) (ident name_len))
            (block
              (if (call (ident memcmp) (ident ename) (ident name) (ident name_len))
                (block
                  (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
                  (return (unop * (ident dp)))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (nil))))
  (func add_macro ((param decl (type_ptr (type_base u8)))) (type_base void)
    (block
      (var name (type_ptr (type_base u8)) (call (ident macro_decl_name) (ident decl)))
      (var name_len (type_base i64) (call (ident macro_decl_name_len) (ident decl)))
      (var entry (type_ptr (type_base u8)) (binop + (ident cg_macros) (binop * (ident cg_macro_count) (number 24))))
      (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
      (assign (unop * (ident np)) (ident name))
      (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
      (assign (unop * (ident nl)) (ident name_len))
      (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
      (assign (unop * (ident dp)) (ident decl))
      (assign (ident cg_macro_count) (binop + (ident cg_macro_count) (number 1)))))
  (func find_macro ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_ptr (type_base u8))
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_macro_count))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident cg_macros) (binop * (ident i) (number 24))))
          (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var mname (type_ptr (type_base u8)) (unop * (ident np)))
          (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (var mlen (type_base i64) (unop * (ident nl)))
          (if (binop == (ident mlen) (ident name_len))
            (block
              (if (call (ident memcmp) (ident mname) (ident name) (ident name_len))
                (block
                  (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
                  (return (unop * (ident dp)))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (nil))))
  (func exec_run ((param program (type_ptr (type_base u8))) (param arg1 (type_ptr (type_base u8))) (param arg2 (type_ptr (type_base u8))) (param arg3 (type_ptr (type_base u8))) (param arg4 (type_ptr (type_base u8))) (param arg5 (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var argv (type_ptr (type_base u8)) (call (ident alloc) (number 56)))
      (var a0 (type_ptr (type_ptr (type_base u8))) (ident argv))
      (assign (unop * (ident a0)) (ident program))
      (var a1 (type_ptr (type_ptr (type_base u8))) (binop + (ident argv) (number 8)))
      (assign (unop * (ident a1)) (ident arg1))
      (var a2 (type_ptr (type_ptr (type_base u8))) (binop + (ident argv) (number 16)))
      (assign (unop * (ident a2)) (ident arg2))
      (var a3 (type_ptr (type_ptr (type_base u8))) (binop + (ident argv) (number 24)))
      (assign (unop * (ident a3)) (ident arg3))
      (var a4 (type_ptr (type_ptr (type_base u8))) (binop + (ident argv) (number 32)))
      (assign (unop * (ident a4)) (ident arg4))
      (var a5 (type_ptr (type_ptr (type_base u8))) (binop + (ident argv) (number 40)))
      (assign (unop * (ident a5)) (ident arg5))
      (var a6 (type_ptr (type_ptr (type_base u8))) (binop + (ident argv) (number 48)))
      (assign (unop * (ident a6)) (nil))
      (var envp (type_ptr (type_base u8)) (call (ident alloc) (number 8)))
      (var e0 (type_ptr (type_ptr (type_base u8))) (ident envp))
      (assign (unop * (ident e0)) (nil))
      (var pid (type_base i64) (call (ident syscall) (number 57)))
      (if (binop == (ident pid) (number 0))
        (block
          (expr_stmt (call (ident syscall) (number 59) (ident program) (ident argv) (ident envp)))
          (expr_stmt (call (ident syscall) (number 60) (number 127)))))
      (var status (type_ptr (type_base i64)) (call (ident alloc) (number 8)))
      (expr_stmt (call (ident syscall) (number 61) (ident pid) (ident status) (number 0) (number 0)))
      (return (binop % (binop / (unop * (ident status)) (number 256)) (number 256)))))
  (func build_reader_cache_path ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_ptr (type_base u8))
    (block
      (var path (type_ptr (type_base u8)) (call (ident alloc) (number 256)))
      (var i (type_base i64) (number 0))
      (var prefix (type_ptr (type_base u8)) (string ".lang-cache/readers/"))
      (while (binop != (unop * (ident prefix)) (number 0))
        (block
          (assign (unop * (binop + (ident path) (ident i))) (unop * (ident prefix)))
          (assign (ident i) (binop + (ident i) (number 1)))
          (assign (ident prefix) (binop + (ident prefix) (number 1)))))
      (var j (type_base i64) (number 0))
      (while (binop < (ident j) (ident name_len))
        (block
          (assign (unop * (binop + (ident path) (ident i))) (unop * (binop + (ident name) (ident j))))
          (assign (ident i) (binop + (ident i) (number 1)))
          (assign (ident j) (binop + (ident j) (number 1)))))
      (assign (unop * (binop + (ident path) (ident i))) (number 0))
      (return (ident path))))
  (func cg_file_mtime ((param path (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var statbuf (type_ptr (type_base u8)) (call (ident alloc) (number 144)))
      (var result (type_base i64) (call (ident syscall) (number 4) (ident path) (ident statbuf)))
      (if (binop < (ident result) (number 0))
        (block
          (return (number 0))))
      (var mtime_ptr (type_ptr (type_base i64)) (binop + (ident statbuf) (number 88)))
      (return (unop * (ident mtime_ptr)))))
  (func should_recompile_reader ((param cached_exe (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var exe_mtime (type_base i64) (call (ident cg_file_mtime) (ident cached_exe)))
      (if (binop == (ident exe_mtime) (number 0))
        (block
          (return (number 1))))
      (if (binop > (call (ident cg_file_mtime) (string "./out/lang")) (ident exe_mtime))
        (block
          (return (number 1))))
      (if (binop > (call (ident cg_file_mtime) (string "./out/lang_next")) (ident exe_mtime))
        (block
          (return (number 1))))
      (if (binop > (call (ident cg_file_mtime) (string "std/core.lang")) (ident exe_mtime))
        (block
          (return (number 1))))
      (return (number 0))))
  (func compile_reader_to_executable ((param decl (type_ptr (type_base u8)))) (type_base void)
    (block
      (var name (type_ptr (type_base u8)) (call (ident reader_decl_name) (ident decl)))
      (var name_len (type_base i64) (call (ident reader_decl_name_len) (ident decl)))
      (var param_name (type_ptr (type_base u8)) (call (ident reader_decl_param_name) (ident decl)))
      (var param_len (type_base i64) (call (ident reader_decl_param_len) (ident decl)))
      (var body (type_ptr (type_base u8)) (call (ident reader_decl_body) (ident decl)))
      (var base_path (type_ptr (type_base u8)) (call (ident build_reader_cache_path) (ident name) (ident name_len)))
      (var exe_path (type_ptr (type_base u8)) (call (ident str_dup) (ident base_path)))
      (if (binop == (call (ident should_recompile_reader) (ident exe_path)) (number 0))
        (block
          (return)))
      (expr_stmt (call (ident syscall) (number 83) (string ".lang-cache") (number 493)))
      (expr_stmt (call (ident syscall) (number 83) (string ".lang-cache/readers") (number 493)))
      (var src_path (type_ptr (type_base u8)) (call (ident str_concat) (ident base_path) (string ".lang")))
      (var asm_path (type_ptr (type_base u8)) (call (ident str_concat) (ident base_path) (string ".s")))
      (var obj_path (type_ptr (type_base u8)) (call (ident str_concat) (ident base_path) (string ".o")))
      (var i (type_base i64) (number 0))
      (var j (type_base i64) (number 0))
      (var wrapper (type_ptr (type_base u8)) (call (ident alloc) (number 262144)))
      (var wp (type_ptr (type_base u8)) (ident wrapper))
      (expr_stmt (call (ident ast_str_init)))
      (expr_stmt (call (ident ast_str_append_cstr) (string "include \"std/core.lang\"\n")))
      (var reader_pos (type_base i64) (unop - (number 1)))
      (assign (ident i) (number 0))
      (while (binop < (ident i) (ident cg_current_file_decl_count))
        (block
          (var sibling (type_ptr (type_base u8)) (call (ident get_decl) (ident cg_current_file_decls) (ident i)))
          (if (binop == (ident sibling) (ident decl))
            (block
              (assign (ident reader_pos) (ident i))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (if (binop > (ident reader_pos) (number 0))
        (block
          (assign (ident i) (number 0))
          (while (binop < (ident i) (ident reader_pos))
            (block
              (var sibling (type_ptr (type_base u8)) (call (ident get_decl) (ident cg_current_file_decls) (ident i)))
              (var k (type_base i64) (call (ident node_kind) (ident sibling)))
              (if (binop == (ident k) (ident NODE_INCLUDE_DECL))
                (block
                  (expr_stmt (call (ident ast_to_string_include_decl) (ident sibling)))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (assign (ident i) (number 0))
          (while (binop < (ident i) (ident reader_pos))
            (block
              (var sibling (type_ptr (type_base u8)) (call (ident get_decl) (ident cg_current_file_decls) (ident i)))
              (var k (type_base i64) (call (ident node_kind) (ident sibling)))
              (if (binop == (ident k) (ident NODE_READER_EXPR))
                (block
                  (var rname (type_ptr (type_base u8)) (call (ident reader_expr_name) (ident sibling)))
                  (var rname_len (type_base i64) (call (ident reader_expr_name_len) (ident sibling)))
                  (var rcontent (type_ptr (type_base u8)) (call (ident reader_expr_content) (ident sibling)))
                  (var rcontent_len (type_base i64) (call (ident reader_expr_content_len) (ident sibling)))
                  (var rexe_path (type_ptr (type_base u8)) (call (ident build_reader_cache_path) (ident rname) (ident rname_len)))
                  (var rout (type_ptr (type_base u8)) (call (ident alloc) (number 131072)))
                  (var rn (type_base i64) (call (ident exec_capture) (ident rexe_path) (ident rcontent) (ident rcontent_len) (ident rout) (number 131072)))
                  (if (binop > (ident rn) (number 0))
                    (block
                      (expr_stmt (call (ident ast_str_append) (ident rout) (ident rn)))
                      (expr_stmt (call (ident ast_str_append_char) (number 10)))))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (assign (ident i) (number 0))
          (while (binop < (ident i) (ident reader_pos))
            (block
              (var sibling (type_ptr (type_base u8)) (call (ident get_decl) (ident cg_current_file_decls) (ident i)))
              (var k (type_base i64) (call (ident node_kind) (ident sibling)))
              (if (binop == (ident k) (ident NODE_STRUCT_DECL))
                (block
                  (expr_stmt (call (ident ast_to_string_struct_decl) (ident sibling)))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (assign (ident i) (number 0))
          (while (binop < (ident i) (ident reader_pos))
            (block
              (var sibling (type_ptr (type_base u8)) (call (ident get_decl) (ident cg_current_file_decls) (ident i)))
              (var k (type_base i64) (call (ident node_kind) (ident sibling)))
              (if (binop == (ident k) (ident NODE_FUNC_DECL))
                (block
                  (var fname (type_ptr (type_base u8)) (call (ident func_decl_name) (ident sibling)))
                  (var flen (type_base i64) (call (ident func_decl_name_len) (ident sibling)))
                  (if (binop || (binop != (ident flen) (number 4)) (unop ! (call (ident memcmp) (ident fname) (string "main") (number 4))))
                    (block
                      (expr_stmt (call (ident ast_to_string_func_decl) (ident sibling)))))))
              (assign (ident i) (binop + (ident i) (number 1)))))))
      (var siblings_src (type_ptr (type_base u8)) (call (ident ast_str_finish)))
      (var siblings_copy (type_ptr (type_base u8)) (ident siblings_src))
      (while (binop != (unop * (ident siblings_copy)) (number 0))
        (block
          (assign (unop * (ident wp)) (unop * (ident siblings_copy)))
          (assign (ident wp) (binop + (ident wp) (number 1)))
          (assign (ident siblings_copy) (binop + (ident siblings_copy) (number 1)))))
      (var body_src (type_ptr (type_base u8)) (call (ident ast_to_string_block) (ident body)))
      (var fn_kw (type_ptr (type_base u8)) (string "func "))
      (while (binop != (unop * (ident fn_kw)) (number 0))
        (block
          (assign (unop * (ident wp)) (unop * (ident fn_kw)))
          (assign (ident wp) (binop + (ident wp) (number 1)))
          (assign (ident fn_kw) (binop + (ident fn_kw) (number 1)))))
      (assign (ident j) (number 0))
      (while (binop < (ident j) (ident name_len))
        (block
          (assign (unop * (ident wp)) (unop * (binop + (ident name) (ident j))))
          (assign (ident wp) (binop + (ident wp) (number 1)))
          (assign (ident j) (binop + (ident j) (number 1)))))
      (assign (unop * (ident wp)) (number 40))
      (assign (ident wp) (binop + (ident wp) (number 1)))
      (assign (ident j) (number 0))
      (while (binop < (ident j) (ident param_len))
        (block
          (assign (unop * (ident wp)) (unop * (binop + (ident param_name) (ident j))))
          (assign (ident wp) (binop + (ident wp) (number 1)))
          (assign (ident j) (binop + (ident j) (number 1)))))
      (var sig (type_ptr (type_base u8)) (string " *u8) *u8 "))
      (while (binop != (unop * (ident sig)) (number 0))
        (block
          (assign (unop * (ident wp)) (unop * (ident sig)))
          (assign (ident wp) (binop + (ident wp) (number 1)))
          (assign (ident sig) (binop + (ident sig) (number 1)))))
      (while (binop != (unop * (ident body_src)) (number 0))
        (block
          (assign (unop * (ident wp)) (unop * (ident body_src)))
          (assign (ident wp) (binop + (ident wp) (number 1)))
          (assign (ident body_src) (binop + (ident body_src) (number 1)))))
      (assign (unop * (ident wp)) (number 10))
      (assign (ident wp) (binop + (ident wp) (number 1)))
      (var main_src (type_ptr (type_base u8)) (string "func main() i64 {\n    var buf *u8 = alloc(65536);\n    var n i64 = file_read(0, buf, 65536);\n    *(buf + n) = 0;\n    var result *u8 = "))
      (while (binop != (unop * (ident main_src)) (number 0))
        (block
          (assign (unop * (ident wp)) (unop * (ident main_src)))
          (assign (ident wp) (binop + (ident wp) (number 1)))
          (assign (ident main_src) (binop + (ident main_src) (number 1)))))
      (assign (ident j) (number 0))
      (while (binop < (ident j) (ident name_len))
        (block
          (assign (unop * (ident wp)) (unop * (binop + (ident name) (ident j))))
          (assign (ident wp) (binop + (ident wp) (number 1)))
          (assign (ident j) (binop + (ident j) (number 1)))))
      (var main_end (type_ptr (type_base u8)) (string "(buf);\n    print(result);\n    return 0;\n}\n"))
      (while (binop != (unop * (ident main_end)) (number 0))
        (block
          (assign (unop * (ident wp)) (unop * (ident main_end)))
          (assign (ident wp) (binop + (ident wp) (number 1)))
          (assign (ident main_end) (binop + (ident main_end) (number 1)))))
      (assign (unop * (ident wp)) (number 0))
      (var fd (type_base i64) (call (ident syscall) (number 2) (ident src_path) (number 577) (number 420)))
      (var wlen (type_base i64) (number 0))
      (var ws (type_ptr (type_base u8)) (ident wrapper))
      (while (binop != (unop * (ident ws)) (number 0))
        (block
          (assign (ident wlen) (binop + (ident wlen) (number 1)))
          (assign (ident ws) (binop + (ident ws) (number 1)))))
      (expr_stmt (call (ident syscall) (number 1) (ident fd) (ident wrapper) (ident wlen)))
      (expr_stmt (call (ident syscall) (number 3) (ident fd)))
      (expr_stmt (call (ident exec_run) (string "./out/lang") (ident src_path) (string "-o") (ident asm_path) (nil) (nil)))
      (expr_stmt (call (ident exec_run) (string "/usr/bin/as") (ident asm_path) (string "-o") (ident obj_path) (nil) (nil)))
      (expr_stmt (call (ident exec_run) (string "/usr/bin/ld") (ident obj_path) (string "-o") (ident exe_path) (nil) (nil)))))
  (func add_reader ((param decl (type_ptr (type_base u8)))) (type_base void)
    (block
      (var name (type_ptr (type_base u8)) (call (ident reader_decl_name) (ident decl)))
      (var name_len (type_base i64) (call (ident reader_decl_name_len) (ident decl)))
      (var entry (type_ptr (type_base u8)) (binop + (ident cg_readers) (binop * (ident cg_reader_count) (number 24))))
      (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
      (assign (unop * (ident np)) (ident name))
      (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
      (assign (unop * (ident nl)) (ident name_len))
      (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
      (assign (unop * (ident dp)) (ident decl))
      (assign (ident cg_reader_count) (binop + (ident cg_reader_count) (number 1)))
      (expr_stmt (call (ident compile_reader_to_executable) (ident decl)))))
  (func find_reader ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_ptr (type_base u8))
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_reader_count))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident cg_readers) (binop * (ident i) (number 24))))
          (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var rname (type_ptr (type_base u8)) (unop * (ident np)))
          (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (var rlen (type_base i64) (unop * (ident nl)))
          (if (binop == (ident rlen) (ident name_len))
            (block
              (if (call (ident memcmp) (ident rname) (ident name) (ident name_len))
                (block
                  (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
                  (return (unop * (ident dp)))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (var exe_path (type_ptr (type_base u8)) (call (ident build_reader_cache_path) (ident name) (ident name_len)))
      (var fd (type_base i64) (call (ident file_open) (ident exe_path) (number 0)))
      (if (binop >= (ident fd) (number 0))
        (block
          (expr_stmt (call (ident file_close) (ident fd)))
          (return (ident exe_path))))
      (return (nil))))
  (func add_func ((param decl (type_ptr (type_base u8)))) (type_base void)
    (block
      (var name (type_ptr (type_base u8)) (call (ident func_decl_name) (ident decl)))
      (var name_len (type_base i64) (call (ident func_decl_name_len) (ident decl)))
      (var entry (type_ptr (type_base u8)) (binop + (ident cg_funcs) (binop * (ident cg_func_count) (number 24))))
      (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
      (assign (unop * (ident np)) (ident name))
      (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
      (assign (unop * (ident nl)) (ident name_len))
      (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
      (assign (unop * (ident dp)) (ident decl))
      (assign (ident cg_func_count) (binop + (ident cg_func_count) (number 1)))))
  (func find_func ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_ptr (type_base u8))
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_func_count))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident cg_funcs) (binop * (ident i) (number 24))))
          (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var fname (type_ptr (type_base u8)) (unop * (ident np)))
          (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (var flen (type_base i64) (unop * (ident nl)))
          (if (binop && (binop == (ident flen) (ident name_len)) (call (ident memcmp) (ident fname) (ident name) (ident name_len)))
            (block
              (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
              (return (unop * (ident dp)))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (nil))))
  (func include_stack_push ((param path (type_ptr (type_base u8))) (param path_len (type_base i64))) (type_base void)
    (block
      (var entry (type_ptr (type_base u8)) (binop + (ident cg_include_stack) (binop * (ident cg_include_count) (number 16))))
      (var pp (type_ptr (type_ptr (type_base u8))) (ident entry))
      (assign (unop * (ident pp)) (ident path))
      (var pl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
      (assign (unop * (ident pl)) (ident path_len))
      (assign (ident cg_include_count) (binop + (ident cg_include_count) (number 1)))))
  (func include_stack_pop () (type_base void)
    (block
      (if (binop > (ident cg_include_count) (number 0))
        (block
          (assign (ident cg_include_count) (binop - (ident cg_include_count) (number 1)))))))
  (func include_stack_contains ((param path (type_ptr (type_base u8))) (param path_len (type_base i64))) (type_base bool)
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_include_count))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident cg_include_stack) (binop * (ident i) (number 16))))
          (var pp (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var stack_path (type_ptr (type_base u8)) (unop * (ident pp)))
          (var pl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (var stack_len (type_base i64) (unop * (ident pl)))
          (if (binop && (binop == (ident stack_len) (ident path_len)) (call (ident memcmp) (ident stack_path) (ident path) (ident path_len)))
            (block
              (return (bool true))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (bool false))))
  (func read_file_contents ((param path (type_ptr (type_base u8))) (param path_len (type_base i64)) (param buf (type_ptr (type_base u8))) (param buf_cap (type_base i64))) (type_base i64)
    (block
      (var path_z (type_ptr (type_base u8)) (call (ident alloc) (binop + (ident path_len) (number 1))))
      (var j (type_base i64) (number 0))
      (while (binop < (ident j) (ident path_len))
        (block
          (assign (unop * (binop + (ident path_z) (ident j))) (unop * (binop + (ident path) (ident j))))
          (assign (ident j) (binop + (ident j) (number 1)))))
      (assign (unop * (binop + (ident path_z) (ident path_len))) (number 0))
      (var fd (type_base i64) (call (ident syscall) (number 2) (ident path_z) (number 0) (number 0)))
      (if (binop < (ident fd) (number 0))
        (block
          (return (unop - (number 1)))))
      (var n (type_base i64) (call (ident syscall) (number 0) (ident fd) (ident buf) (ident buf_cap)))
      (expr_stmt (call (ident syscall) (number 3) (ident fd)))
      (if (binop >= (ident n) (number 0))
        (block
          (assign (unop * (binop + (ident buf) (ident n))) (number 0))))
      (return (ident n))))
  (func process_decl_first_pass ((param decl (type_ptr (type_base u8)))) (type_base void)
    (block
      (var k (type_base i64) (call (ident node_kind) (ident decl)))
      (if (binop == (ident k) (ident NODE_STRUCT_DECL))
        (block
          (expr_stmt (call (ident add_struct) (ident decl)))
          (return)))
      (if (binop == (ident k) (ident NODE_ENUM_DECL))
        (block
          (expr_stmt (call (ident add_enum) (ident decl)))
          (return)))
      (if (binop == (ident k) (ident NODE_EFFECT_DECL))
        (block
          (expr_stmt (call (ident add_effect) (ident decl)))
          (return)))
      (if (binop == (ident k) (ident NODE_MACRO_DECL))
        (block
          (expr_stmt (call (ident add_macro) (ident decl)))
          (return)))
      (if (binop == (ident k) (ident NODE_READER_DECL))
        (block
          (expr_stmt (call (ident add_reader) (ident decl)))
          (return)))
      (if (binop == (ident k) (ident NODE_FUNC_DECL))
        (block
          (expr_stmt (call (ident add_func) (ident decl)))
          (return)))
      (if (binop == (ident k) (ident NODE_READER_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident reader_expr_name) (ident decl)))
          (var name_len (type_base i64) (call (ident reader_expr_name_len) (ident decl)))
          (var content (type_ptr (type_base u8)) (call (ident reader_expr_content) (ident decl)))
          (var content_len (type_base i64) (call (ident reader_expr_content_len) (ident decl)))
          (var reader_decl (type_ptr (type_base u8)) (call (ident find_reader) (ident name) (ident name_len)))
          (if (binop == (ident reader_decl) (nil))
            (block
              (expr_stmt (call (ident eprint) (string "error: reader macro '")))
              (expr_stmt (call (ident eprint_buf) (ident name) (ident name_len)))
              (expr_stmt (call (ident eprintln) (string "' not found")))
              (assign (ident cg_had_error) (number 1))
              (return)))
          (var exe_path (type_ptr (type_base u8)) (call (ident build_reader_cache_path) (ident name) (ident name_len)))
          (var output (type_ptr (type_base u8)) (call (ident alloc) (number 131072)))
          (var n (type_base i64) (call (ident exec_capture) (ident exe_path) (ident content) (ident content_len) (ident output) (number 131072)))
          (if (binop <= (ident n) (number 0))
            (block
              (expr_stmt (call (ident eprint) (string "error: reader '")))
              (expr_stmt (call (ident eprint_buf) (ident name) (ident name_len)))
              (expr_stmt (call (ident eprintln) (string "' returned no output")))
              (assign (ident cg_had_error) (number 1))
              (return)))
          (var prog (type_ptr (type_base u8)) (call (ident parse_ast_from_string) (ident output)))
          (if (binop == (ident prog) (nil))
            (block
              (expr_stmt (call (ident eprint) (string "error: reader '")))
              (expr_stmt (call (ident eprint_buf) (ident name) (ident name_len)))
              (expr_stmt (call (ident eprintln) (string "' did not return valid AST")))
              (assign (ident cg_had_error) (number 1))
              (return)))
          (var gen_decls (type_ptr (type_base u8)) (call (ident program_decls) (ident prog)))
          (var gen_count (type_base i64) (call (ident program_decl_count) (ident prog)))
          (var gi (type_base i64) (number 0))
          (while (binop < (ident gi) (ident gen_count))
            (block
              (expr_stmt (call (ident process_decl_first_pass) (call (ident get_decl) (ident gen_decls) (ident gi))))
              (assign (ident gi) (binop + (ident gi) (number 1)))))
          (return)))
      (if (binop == (ident k) (ident NODE_VAR_DECL))
        (block
          (expr_stmt (call (ident add_global) (call (ident var_decl_name) (ident decl)) (call (ident var_decl_name_len) (ident decl)) (call (ident var_decl_type) (ident decl)) (call (ident var_decl_init) (ident decl))))
          (return)))
      (if (binop == (ident k) (ident NODE_INCLUDE_DECL))
        (block
          (var path (type_ptr (type_base u8)) (call (ident include_decl_path) (ident decl)))
          (var path_len (type_base i64) (call (ident include_decl_path_len) (ident decl)))
          (if (call (ident map_has) (ident cg_included_files) (call (ident str_dup_n) (ident path) (ident path_len)))
            (block
              (return)))
          (expr_stmt (call (ident map_set) (ident cg_included_files) (call (ident str_dup_n) (ident path) (ident path_len)) (number 1)))
          (if (call (ident include_stack_contains) (ident path) (ident path_len))
            (block
              (expr_stmt (call (ident eprint) (string "error: circular include detected: ")))
              (expr_stmt (call (ident eprint_buf) (ident path) (ident path_len)))
              (expr_stmt (call (ident eprintln) (string "")))
              (return)))
          (expr_stmt (call (ident include_stack_push) (ident path) (ident path_len)))
          (var buf (type_ptr (type_base u8)) (call (ident alloc) (number 1048576)))
          (var n (type_base i64) (call (ident read_file_contents) (ident path) (ident path_len) (ident buf) (number 1048576)))
          (if (binop < (ident n) (number 0))
            (block
              (expr_stmt (call (ident eprint) (string "error: cannot open include file: ")))
              (expr_stmt (call (ident eprint_buf) (ident path) (ident path_len)))
              (expr_stmt (call (ident eprintln) (string "")))
              (expr_stmt (call (ident include_stack_pop)))
              (return)))
          (var prog (type_ptr (type_base u8)) (call (ident parse_program_from_string) (ident buf)))
          (if (binop == (ident prog) (nil))
            (block
              (expr_stmt (call (ident eprint) (string "error: failed to parse include file: ")))
              (expr_stmt (call (ident eprint_buf) (ident path) (ident path_len)))
              (expr_stmt (call (ident eprintln) (string "")))
              (expr_stmt (call (ident include_stack_pop)))
              (return)))
          (var inc_decls (type_ptr (type_base u8)) (call (ident program_decls) (ident prog)))
          (var inc_count (type_base i64) (call (ident program_decl_count) (ident prog)))
          (var saved_file_decls (type_ptr (type_base u8)) (ident cg_current_file_decls))
          (var saved_file_count (type_base i64) (ident cg_current_file_decl_count))
          (var saved_scoped (type_base i64) (ident cg_in_scoped_context))
          (assign (ident cg_current_file_decls) (ident inc_decls))
          (assign (ident cg_current_file_decl_count) (ident inc_count))
          (assign (ident cg_in_scoped_context) (number 1))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident inc_count))
            (block
              (expr_stmt (call (ident process_decl_first_pass) (call (ident get_decl) (ident inc_decls) (ident i))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (assign (ident cg_current_file_decls) (ident saved_file_decls))
          (assign (ident cg_current_file_decl_count) (ident saved_file_count))
          (assign (ident cg_in_scoped_context) (ident saved_scoped))
          (expr_stmt (call (ident include_stack_pop)))
          (return)))))
  (func string_get_ptr ((param index (type_base i64))) (type_ptr (type_base u8))
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident cg_strings) (binop * (ident index) (number 16))))
      (return (unop * (ident p)))))
  (func string_set_ptr ((param index (type_base i64)) (param ptr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident cg_strings) (binop * (ident index) (number 16))))
      (assign (unop * (ident p)) (ident ptr))))
  (func string_get_len ((param index (type_base i64))) (type_base i64)
    (block
      (var p (type_ptr (type_base i64)) (binop + (binop + (ident cg_strings) (binop * (ident index) (number 16))) (number 8)))
      (return (unop * (ident p)))))
  (func string_set_len ((param index (type_base i64)) (param len (type_base i64))) (type_base void)
    (block
      (var p (type_ptr (type_base i64)) (binop + (binop + (ident cg_strings) (binop * (ident index) (number 16))) (number 8)))
      (assign (unop * (ident p)) (ident len))))
  (func add_string ((param ptr (type_ptr (type_base u8))) (param len (type_base i64))) (type_base i64)
    (block
      (var idx (type_base i64) (ident cg_string_count))
      (expr_stmt (call (ident string_set_ptr) (ident idx) (ident ptr)))
      (expr_stmt (call (ident string_set_len) (ident idx) (ident len)))
      (assign (ident cg_string_count) (binop + (ident cg_string_count) (number 1)))
      (return (ident idx))))
  (func memcmp ((param a (type_ptr (type_base u8))) (param b (type_ptr (type_base u8))) (param len (type_base i64))) (type_base bool)
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident len))
        (block
          (if (binop != (unop * (binop + (ident a) (ident i))) (unop * (binop + (ident b) (ident i))))
            (block
              (return (bool false))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (bool true))))
  (func emit_char ((param c (type_base u8))) (type_base void)
    (block
      (if (binop != (ident cg_in_func_body) (number 0))
        (block
          (if (binop >= (ident cg_func_len) (ident cg_func_cap))
            (block
              (expr_stmt (call (ident eprintln) (string "FATAL: cg_func_buf overflow!")))
              (expr_stmt (call (ident exit) (number 1)))))
          (assign (unop * (binop + (ident cg_func_buf) (ident cg_func_len))) (ident c))
          (assign (ident cg_func_len) (binop + (ident cg_func_len) (number 1))))
        (block
          (if (binop >= (ident cg_code_len) (ident cg_code_cap))
            (block
              (expr_stmt (call (ident eprintln) (string "FATAL: cg_code_buf overflow!")))
              (expr_stmt (call (ident exit) (number 1)))))
          (assign (unop * (binop + (ident cg_code_buf) (ident cg_code_len))) (ident c))
          (assign (ident cg_code_len) (binop + (ident cg_code_len) (number 1)))))))
  (func emit_str ((param s (type_ptr (type_base u8)))) (type_base void)
    (block
      (var i (type_base i64) (number 0))
      (while (binop != (unop * (binop + (ident s) (ident i))) (number 0))
        (block
          (expr_stmt (call (ident emit_char) (unop * (binop + (ident s) (ident i)))))
          (assign (ident i) (binop + (ident i) (number 1)))))))
  (func emit_n ((param s (type_ptr (type_base u8))) (param n (type_base i64))) (type_base void)
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident n))
        (block
          (expr_stmt (call (ident emit_char) (unop * (binop + (ident s) (ident i)))))
          (assign (ident i) (binop + (ident i) (number 1)))))))
  (func emit_int ((param n (type_base i64))) (type_base void)
    (block
      (if (binop < (ident n) (number 0))
        (block
          (expr_stmt (call (ident emit_char) (number 45)))
          (assign (ident n) (binop - (number 0) (ident n)))))
      (if (binop == (ident n) (number 0))
        (block
          (expr_stmt (call (ident emit_char) (number 48)))
          (return)))
      (var divisor (type_base i64) (number 1))
      (var temp (type_base i64) (ident n))
      (while (binop >= (ident temp) (number 10))
        (block
          (assign (ident temp) (binop / (ident temp) (number 10)))
          (assign (ident divisor) (binop * (ident divisor) (number 10)))))
      (while (binop > (ident divisor) (number 0))
        (block
          (var digit (type_base i64) (binop / (ident n) (ident divisor)))
          (expr_stmt (call (ident emit_char) (binop + (number 48) (ident digit))))
          (assign (ident n) (binop % (ident n) (ident divisor)))
          (assign (ident divisor) (binop / (ident divisor) (number 10)))))))
  (func emit_line ((param s (type_ptr (type_base u8)))) (type_base void)
    (block
      (expr_stmt (call (ident emit_str) (ident s)))
      (expr_stmt (call (ident emit_char) (number 10)))))
  (func emit_label ((param label (type_base i64))) (type_base void)
    (block
      (expr_stmt (call (ident emit_str) (string ".L")))
      (expr_stmt (call (ident emit_int) (ident label)))))
  (func new_label () (type_base i64)
    (block
      (assign (ident cg_label_num) (binop + (ident cg_label_num) (number 1)))
      (return (ident cg_label_num))))
  (func flush_func_body () (type_base void)
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_func_len))
        (block
          (assign (unop * (binop + (ident cg_code_buf) (ident cg_code_len))) (unop * (binop + (ident cg_func_buf) (ident i))))
          (assign (ident cg_code_len) (binop + (ident cg_code_len) (number 1)))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (assign (ident cg_func_len) (number 0))))
  (func out_char ((param c (type_base u8))) (type_base void)
    (block
      (expr_stmt (call (ident file_write) (ident cg_out_fd) (unop & (ident c)) (number 1)))))
  (func out_str ((param s (type_ptr (type_base u8)))) (type_base void)
    (block
      (expr_stmt (call (ident file_write) (ident cg_out_fd) (ident s) (call (ident strlen) (ident s))))))
  (func out_n ((param s (type_ptr (type_base u8))) (param n (type_base i64))) (type_base void)
    (block
      (expr_stmt (call (ident file_write) (ident cg_out_fd) (ident s) (ident n)))))
  (func out_int ((param n (type_base i64))) (type_base void)
    (block
      (if (binop < (ident n) (number 0))
        (block
          (expr_stmt (call (ident out_char) (number 45)))
          (assign (ident n) (binop - (number 0) (ident n)))))
      (if (binop == (ident n) (number 0))
        (block
          (expr_stmt (call (ident out_char) (number 48)))
          (return)))
      (var divisor (type_base i64) (number 1))
      (var temp (type_base i64) (ident n))
      (while (binop >= (ident temp) (number 10))
        (block
          (assign (ident temp) (binop / (ident temp) (number 10)))
          (assign (ident divisor) (binop * (ident divisor) (number 10)))))
      (while (binop > (ident divisor) (number 0))
        (block
          (var digit (type_base i64) (binop / (ident n) (ident divisor)))
          (expr_stmt (call (ident out_char) (binop + (number 48) (ident digit))))
          (assign (ident n) (binop % (ident n) (ident divisor)))
          (assign (ident divisor) (binop / (ident divisor) (number 10)))))))
  (func out_line ((param s (type_ptr (type_base u8)))) (type_base void)
    (block
      (expr_stmt (call (ident out_str) (ident s)))
      (expr_stmt (call (ident out_char) (number 10)))))
  (func get_field_offset ((param struct_decl (type_ptr (type_base u8))) (param field_name (type_ptr (type_base u8))) (param field_len (type_base i64))) (type_base i64)
    (block
      (if (binop == (ident struct_decl) (nil))
        (block
          (return (binop - (number 0) (number 1)))))
      (var fields (type_ptr (type_base u8)) (call (ident struct_decl_fields) (ident struct_decl)))
      (var count (type_base i64) (call (ident struct_decl_field_count) (ident struct_decl)))
      (var offset (type_base i64) (number 0))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident count))
        (block
          (var f (type_ptr (type_base u8)) (call (ident get_struct_field) (ident fields) (ident i)))
          (var fname (type_ptr (type_base u8)) (call (ident struct_field_name) (ident f)))
          (var fname_len (type_base i64) (call (ident struct_field_name_len) (ident f)))
          (if (binop == (ident fname_len) (ident field_len))
            (block
              (if (call (ident memcmp) (ident fname) (ident field_name) (ident field_len))
                (block
                  (return (ident offset))))))
          (var field_type (type_ptr (type_base u8)) (call (ident struct_field_type) (ident f)))
          (var field_size (type_base i64) (call (ident get_type_size) (ident field_type)))
          (if (binop < (ident field_size) (number 8))
            (block
              (assign (ident field_size) (number 8))))
          (assign (ident offset) (binop + (ident offset) (ident field_size)))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (binop - (number 0) (number 1)))))
  (func get_field_type ((param struct_decl (type_ptr (type_base u8))) (param field_name (type_ptr (type_base u8))) (param field_len (type_base i64))) (type_ptr (type_base u8))
    (block
      (if (binop == (ident struct_decl) (nil))
        (block
          (return (nil))))
      (var fields (type_ptr (type_base u8)) (call (ident struct_decl_fields) (ident struct_decl)))
      (var count (type_base i64) (call (ident struct_decl_field_count) (ident struct_decl)))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident count))
        (block
          (var f (type_ptr (type_base u8)) (call (ident get_struct_field) (ident fields) (ident i)))
          (var fname (type_ptr (type_base u8)) (call (ident struct_field_name) (ident f)))
          (var fname_len (type_base i64) (call (ident struct_field_name_len) (ident f)))
          (if (binop == (ident fname_len) (ident field_len))
            (block
              (if (call (ident memcmp) (ident fname) (ident field_name) (ident field_len))
                (block
                  (return (call (ident struct_field_type) (ident f)))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (nil))))
  (var cg_nested_field_base_local (type_base i64) (number 0))
  (func compute_nested_field_offset ((param expr (type_ptr (type_base u8)))) (type_base i64)
    (block
      (if (binop == (ident expr) (nil))
        (block
          (return (binop - (number 0) (number 1)))))
      (var k (type_base i64) (call (ident node_kind) (ident expr)))
      (if (binop == (ident k) (ident NODE_IDENT_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident expr)))
          (var local_idx (type_base i64) (call (ident find_local) (ident name) (ident name_len)))
          (if (binop < (ident local_idx) (number 0))
            (block
              (return (binop - (number 0) (number 1)))))
          (assign (ident cg_nested_field_base_local) (ident local_idx))
          (return (number 0))))
      (if (binop == (ident k) (ident NODE_FIELD_EXPR))
        (block
          (var base_expr (type_ptr (type_base u8)) (call (ident field_expr_expr) (ident expr)))
          (var field_name (type_ptr (type_base u8)) (call (ident field_expr_field) (ident expr)))
          (var field_len (type_base i64) (call (ident field_expr_field_len) (ident expr)))
          (var base_offset (type_base i64) (call (ident compute_nested_field_offset) (ident base_expr)))
          (if (binop < (ident base_offset) (number 0))
            (block
              (return (binop - (number 0) (number 1)))))
          (var base_type (type_ptr (type_base u8)) (call (ident get_expr_type) (ident base_expr)))
          (if (binop == (ident base_type) (nil))
            (block
              (return (binop - (number 0) (number 1)))))
          (var struct_name (type_ptr (type_base u8)) (nil))
          (var struct_name_len (type_base i64) (number 0))
          (if (binop == (call (ident type_kind) (ident base_type)) (ident TYPE_BASE))
            (block
              (assign (ident struct_name) (call (ident base_type_name) (ident base_type)))
              (assign (ident struct_name_len) (call (ident base_type_name_len) (ident base_type)))))
          (if (binop == (ident struct_name) (nil))
            (block
              (return (binop - (number 0) (number 1)))))
          (var struct_decl (type_ptr (type_base u8)) (call (ident find_struct) (ident struct_name) (ident struct_name_len)))
          (if (binop == (ident struct_decl) (nil))
            (block
              (return (binop - (number 0) (number 1)))))
          (var field_offset (type_base i64) (call (ident get_field_offset) (ident struct_decl) (ident field_name) (ident field_len)))
          (if (binop < (ident field_offset) (number 0))
            (block
              (return (binop - (number 0) (number 1)))))
          (return (binop + (ident base_offset) (ident field_offset)))))
      (return (binop - (number 0) (number 1)))))
  (func get_struct_size ((param decl (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var fields (type_ptr (type_base u8)) (call (ident struct_decl_fields) (ident decl)))
      (var count (type_base i64) (call (ident struct_decl_field_count) (ident decl)))
      (var size (type_base i64) (number 0))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident count))
        (block
          (var f (type_ptr (type_base u8)) (call (ident get_struct_field) (ident fields) (ident i)))
          (var field_type (type_ptr (type_base u8)) (call (ident struct_field_type) (ident f)))
          (var field_size (type_base i64) (call (ident get_type_size) (ident field_type)))
          (if (binop > (ident field_size) (number 1))
            (block
              (var rem (type_base i64) (binop % (ident size) (number 8)))
              (if (binop != (ident rem) (number 0))
                (block
                  (assign (ident size) (binop - (binop + (ident size) (number 8)) (ident rem)))))))
          (assign (ident size) (binop + (ident size) (ident field_size)))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (var rem (type_base i64) (binop % (ident size) (number 8)))
      (if (binop != (ident rem) (number 0))
        (block
          (assign (ident size) (binop - (binop + (ident size) (number 8)) (ident rem)))))
      (return (ident size))))
  (func get_type_size ((param t (type_ptr (type_base u8)))) (type_base i64)
    (block
      (if (binop == (ident t) (nil))
        (block
          (return (number 8))))
      (var k (type_base i64) (call (ident type_kind) (ident t)))
      (if (binop == (ident k) (ident TYPE_PTR))
        (block
          (return (number 8))))
      (if (binop == (ident k) (ident TYPE_FUNC))
        (block
          (return (number 8))))
      (if (binop == (ident k) (ident TYPE_CLOSURE))
        (block
          (return (number 8))))
      (if (binop == (ident k) (ident TYPE_BASE))
        (block
          (var name (type_ptr (type_base u8)) (call (ident base_type_name) (ident t)))
          (var len (type_base i64) (call (ident base_type_name_len) (ident t)))
          (if (binop == (ident len) (number 2))
            (block
              (if (binop || (call (ident memcmp) (ident name) (string "u8") (number 2)) (call (ident memcmp) (ident name) (string "i8") (number 2)))
                (block
                  (return (number 1))))))
          (if (binop == (ident len) (number 3))
            (block
              (if (binop || (call (ident memcmp) (ident name) (string "u16") (number 3)) (call (ident memcmp) (ident name) (string "i16") (number 3)))
                (block
                  (return (number 2))))
              (if (binop || (call (ident memcmp) (ident name) (string "u32") (number 3)) (call (ident memcmp) (ident name) (string "i32") (number 3)))
                (block
                  (return (number 4))))
              (if (binop || (call (ident memcmp) (ident name) (string "u64") (number 3)) (call (ident memcmp) (ident name) (string "i64") (number 3)))
                (block
                  (return (number 8))))))
          (if (binop == (ident len) (number 4))
            (block
              (if (call (ident memcmp) (ident name) (string "bool") (number 4))
                (block
                  (return (number 1))))
              (if (call (ident memcmp) (ident name) (string "void") (number 4))
                (block
                  (return (number 0))))))
          (var struct_decl (type_ptr (type_base u8)) (call (ident find_struct) (ident name) (ident len)))
          (if (binop != (ident struct_decl) (nil))
            (block
              (return (call (ident get_struct_size) (ident struct_decl)))))
          (var enum_decl (type_ptr (type_base u8)) (call (ident find_enum) (ident name) (ident len)))
          (if (binop != (ident enum_decl) (nil))
            (block
              (return (call (ident get_enum_size) (ident enum_decl)))))))
      (return (number 8))))
  (func get_enum_max_payload ((param decl (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var variants (type_ptr (type_base u8)) (call (ident enum_decl_variants) (ident decl)))
      (var count (type_base i64) (call (ident enum_decl_variant_count) (ident decl)))
      (var max_payload (type_base i64) (number 0))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident count))
        (block
          (var v (type_ptr (type_base u8)) (call (ident get_enum_variant) (ident variants) (ident i)))
          (var vtype (type_ptr (type_base u8)) (call (ident enum_variant_type) (ident v)))
          (if (binop != (ident vtype) (nil))
            (block
              (var size (type_base i64) (call (ident get_type_size) (ident vtype)))
              (if (binop > (ident size) (ident max_payload))
                (block
                  (assign (ident max_payload) (ident size))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (return (ident max_payload))))
  (func get_enum_size ((param decl (type_ptr (type_base u8)))) (type_base i64)
    (block
      (var max_payload (type_base i64) (call (ident get_enum_max_payload) (ident decl)))
      (if (binop < (ident max_payload) (number 8))
        (block
          (assign (ident max_payload) (number 8))))
      (return (binop + (number 8) (ident max_payload)))))
  (func get_pointed_type ((param t (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (if (binop == (ident t) (nil))
        (block
          (return (nil))))
      (if (binop == (call (ident type_kind) (ident t)) (ident TYPE_PTR))
        (block
          (return (call (ident ptr_type_elem) (ident t)))))
      (return (nil))))
  (func is_void_type ((param t (type_ptr (type_base u8)))) (type_base bool)
    (block
      (if (binop == (ident t) (nil))
        (block
          (return (bool true))))
      (if (binop == (call (ident type_kind) (ident t)) (ident TYPE_BASE))
        (block
          (var name (type_ptr (type_base u8)) (call (ident base_type_name) (ident t)))
          (var len (type_base i64) (call (ident base_type_name_len) (ident t)))
          (if (binop == (ident len) (number 4))
            (block
              (return (call (ident memcmp) (ident name) (string "void") (number 4)))))))
      (return (bool false))))
  (func is_auto_closure_type ((param t (type_ptr (type_base u8)))) (type_base i64)
    (block
      (if (binop == (ident t) (nil))
        (block
          (return (number 0))))
      (if (binop == (call (ident type_kind) (ident t)) (ident TYPE_CLOSURE))
        (block
          (return (number 1))))
      (return (number 0))))
  (func get_expr_type ((param expr (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (if (binop == (ident expr) (nil))
        (block
          (return (nil))))
      (var k (type_base i64) (call (ident node_kind) (ident expr)))
      (if (binop == (ident k) (ident NODE_IDENT_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident expr)))
          (if (binop == (ident cg_in_closure) (number 1))
            (block
              (var cap_idx (type_base i64) (call (ident find_closure_capture) (ident name) (ident name_len)))
              (if (binop >= (ident cap_idx) (number 0))
                (block
                  (return (call (ident closure_capture_type) (ident cap_idx)))))))
          (var local_idx (type_base i64) (call (ident find_local) (ident name) (ident name_len)))
          (if (binop >= (ident local_idx) (number 0))
            (block
              (return (call (ident local_get_type) (ident local_idx)))))
          (var global_idx (type_base i64) (call (ident find_global) (ident name) (ident name_len)))
          (if (binop >= (ident global_idx) (number 0))
            (block
              (return (call (ident global_get_type) (ident global_idx)))))
          (return (nil))))
      (if (binop == (ident k) (ident NODE_UNARY_EXPR))
        (block
          (var op (type_base i64) (call (ident unary_expr_op) (ident expr)))
          (if (binop == (ident op) (ident TOKEN_STAR))
            (block
              (var inner_type (type_ptr (type_base u8)) (call (ident get_expr_type) (call (ident unary_expr_expr) (ident expr))))
              (return (call (ident get_pointed_type) (ident inner_type)))))
          (if (binop == (ident op) (ident TOKEN_AMP))
            (block
              (return (nil))))
          (return (call (ident get_expr_type) (call (ident unary_expr_expr) (ident expr))))))
      (if (binop == (ident k) (ident NODE_BINARY_EXPR))
        (block
          (return (call (ident get_expr_type) (call (ident binary_expr_left) (ident expr))))))
      (if (binop == (ident k) (ident NODE_GROUP_EXPR))
        (block
          (return (call (ident get_expr_type) (call (ident group_expr_expr) (ident expr))))))
      (if (binop == (ident k) (ident NODE_FIELD_EXPR))
        (block
          (var base_expr (type_ptr (type_base u8)) (call (ident field_expr_expr) (ident expr)))
          (var field_name (type_ptr (type_base u8)) (call (ident field_expr_field) (ident expr)))
          (var field_len (type_base i64) (call (ident field_expr_field_len) (ident expr)))
          (var base_type (type_ptr (type_base u8)) (call (ident get_expr_type) (ident base_expr)))
          (if (binop == (ident base_type) (nil))
            (block
              (return (nil))))
          (var struct_name (type_ptr (type_base u8)) (nil))
          (var struct_name_len (type_base i64) (number 0))
          (if (binop == (call (ident type_kind) (ident base_type)) (ident TYPE_BASE))
            (block
              (assign (ident struct_name) (call (ident base_type_name) (ident base_type)))
              (assign (ident struct_name_len) (call (ident base_type_name_len) (ident base_type))))
            (if (binop == (call (ident type_kind) (ident base_type)) (ident TYPE_PTR))
              (block
                (var pointed_type (type_ptr (type_base u8)) (call (ident ptr_type_elem) (ident base_type)))
                (if (binop && (binop != (ident pointed_type) (nil)) (binop == (call (ident type_kind) (ident pointed_type)) (ident TYPE_BASE)))
                  (block
                    (assign (ident struct_name) (call (ident base_type_name) (ident pointed_type)))
                    (assign (ident struct_name_len) (call (ident base_type_name_len) (ident pointed_type))))))))
          (if (binop == (ident struct_name) (nil))
            (block
              (return (nil))))
          (var struct_decl (type_ptr (type_base u8)) (call (ident find_struct) (ident struct_name) (ident struct_name_len)))
          (if (binop == (ident struct_decl) (nil))
            (block
              (return (nil))))
          (return (call (ident get_field_type) (ident struct_decl) (ident field_name) (ident field_len)))))
      (if (binop == (ident k) (ident NODE_LET_EXPR))
        (block
          (return (call (ident get_expr_type) (call (ident let_expr_body) (ident expr))))))
      (if (binop == (ident k) (ident NODE_LAMBDA_EXPR))
        (block
          (var t (type_ptr (type_base u8)) (call (ident func_type_alloc)))
          (expr_stmt (call (ident func_type_set_params) (ident t) (call (ident lambda_expr_params) (ident expr))))
          (expr_stmt (call (ident func_type_set_param_count) (ident t) (call (ident lambda_expr_param_count) (ident expr))))
          (expr_stmt (call (ident func_type_set_ret) (ident t) (call (ident lambda_expr_ret_type) (ident expr))))
          (return (ident t))))
      (return (nil))))
  (func eval_constant ((param expr (type_ptr (type_base u8)))) (type_base i64)
    (block
      (if (binop == (ident expr) (nil))
        (block
          (return (number 0))))
      (var k (type_base i64) (call (ident node_kind) (ident expr)))
      (if (binop == (ident k) (ident NODE_NUMBER_EXPR))
        (block
          (var ptr (type_ptr (type_base u8)) (call (ident number_expr_value) (ident expr)))
          (var len (type_base i64) (call (ident number_expr_value_len) (ident expr)))
          (var val (type_base i64) (number 0))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident len))
            (block
              (assign (ident val) (binop + (binop * (ident val) (number 10)) (binop - (unop * (binop + (ident ptr) (ident i))) (number 48))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (return (ident val))))
      (if (binop == (ident k) (ident NODE_BOOL_EXPR))
        (block
          (return (call (ident bool_expr_value) (ident expr)))))
      (if (binop == (ident k) (ident NODE_NIL_EXPR))
        (block
          (return (number 0))))
      (if (binop == (ident k) (ident NODE_IDENT_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident expr)))
          (if (binop == (ident name_len) (number 3))
            (block
              (if (call (ident memcmp) (ident name) (string "nil") (number 3))
                (block
                  (return (number 0))))))
          (var idx (type_base i64) (call (ident find_global) (ident name) (ident name_len)))
          (if (binop >= (ident idx) (number 0))
            (block
              (var init (type_ptr (type_base u8)) (call (ident global_get_init) (ident idx)))
              (if (binop != (ident init) (nil))
                (block
                  (return (call (ident eval_constant) (ident init)))))))
          (return (number 0))))
      (if (binop == (ident k) (ident NODE_UNARY_EXPR))
        (block
          (var val (type_base i64) (call (ident eval_constant) (call (ident unary_expr_expr) (ident expr))))
          (var op (type_base i64) (call (ident unary_expr_op) (ident expr)))
          (if (binop == (ident op) (ident TOKEN_MINUS))
            (block
              (return (binop - (number 0) (ident val)))))
          (if (binop == (ident op) (ident TOKEN_BANG))
            (block
              (if (binop == (ident val) (number 0))
                (block
                  (return (number 1))))
              (return (number 0))))
          (return (ident val))))
      (if (binop == (ident k) (ident NODE_BINARY_EXPR))
        (block
          (var left (type_base i64) (call (ident eval_constant) (call (ident binary_expr_left) (ident expr))))
          (var right (type_base i64) (call (ident eval_constant) (call (ident binary_expr_right) (ident expr))))
          (var op (type_base i64) (call (ident binary_expr_op) (ident expr)))
          (if (binop == (ident op) (ident TOKEN_PLUS))
            (block
              (return (binop + (ident left) (ident right)))))
          (if (binop == (ident op) (ident TOKEN_MINUS))
            (block
              (return (binop - (ident left) (ident right)))))
          (if (binop == (ident op) (ident TOKEN_STAR))
            (block
              (return (binop * (ident left) (ident right)))))
          (if (binop == (ident op) (ident TOKEN_SLASH))
            (block
              (if (binop != (ident right) (number 0))
                (block
                  (return (binop / (ident left) (ident right)))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_PERCENT))
            (block
              (if (binop != (ident right) (number 0))
                (block
                  (return (binop % (ident left) (ident right)))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_EQEQ))
            (block
              (if (binop == (ident left) (ident right))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_BANGEQ))
            (block
              (if (binop != (ident left) (ident right))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_LT))
            (block
              (if (binop < (ident left) (ident right))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_GT))
            (block
              (if (binop > (ident left) (ident right))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_LTEQ))
            (block
              (if (binop <= (ident left) (ident right))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_GTEQ))
            (block
              (if (binop >= (ident left) (ident right))
                (block
                  (return (number 1))))
              (return (number 0))))
          (return (number 0))))
      (if (binop == (ident k) (ident NODE_GROUP_EXPR))
        (block
          (return (call (ident eval_constant) (call (ident group_expr_expr) (ident expr))))))
      (return (number 0))))
  (func emit_ascii_string ((param ptr (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var start (type_ptr (type_base u8)) (binop + (ident ptr) (number 1)))
      (var end (type_base i64) (binop - (ident len) (number 2)))
      (expr_stmt (call (ident emit_char) (number 34)))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident end))
        (block
          (var c (type_base u8) (unop * (binop + (ident start) (ident i))))
          (if (binop && (binop == (ident c) (number 92)) (binop < (binop + (ident i) (number 1)) (ident end)))
            (block
              (assign (ident i) (binop + (ident i) (number 1)))
              (var next (type_base u8) (unop * (binop + (ident start) (ident i))))
              (if (binop == (ident next) (number 110))
                (block
                  (expr_stmt (call (ident emit_str) (string "\\012"))))
                (if (binop == (ident next) (number 116))
                  (block
                    (expr_stmt (call (ident emit_str) (string "\\011"))))
                  (if (binop == (ident next) (number 114))
                    (block
                      (expr_stmt (call (ident emit_str) (string "\\015"))))
                    (if (binop == (ident next) (number 92))
                      (block
                        (expr_stmt (call (ident emit_str) (string "\\\\"))))
                      (if (binop == (ident next) (number 34))
                        (block
                          (expr_stmt (call (ident emit_str) (string "\\\""))))
                        (if (binop == (ident next) (number 48))
                          (block
                            (expr_stmt (call (ident emit_str) (string "\\000"))))
                          (block
                            (expr_stmt (call (ident emit_char) (ident next)))))))))))
            (if (binop && (binop && (binop && (binop >= (ident c) (number 32)) (binop < (ident c) (number 127))) (binop != (ident c) (number 34))) (binop != (ident c) (number 92)))
              (block
                (expr_stmt (call (ident emit_char) (ident c))))
              (block
                (expr_stmt (call (ident emit_char) (number 92)))
                (expr_stmt (call (ident emit_char) (binop + (number 48) (binop / (ident c) (number 64)))))
                (expr_stmt (call (ident emit_char) (binop + (number 48) (binop % (binop / (ident c) (number 8)) (number 8)))))
                (expr_stmt (call (ident emit_char) (binop + (number 48) (binop % (ident c) (number 8))))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (expr_stmt (call (ident emit_str) (string "\\000")))
      (expr_stmt (call (ident emit_char) (number 34)))))
  (func gen_expr ((param expr (type_ptr (type_base u8)))) (type_base void)
    (block
      (if (binop == (ident expr) (nil))
        (block
          (return)))
      (var k (type_base i64) (call (ident node_kind) (ident expr)))
      (if (binop == (ident k) (ident NODE_NUMBER_EXPR))
        (block
          (expr_stmt (call (ident emit_str) (string "    mov $")))
          (expr_stmt (call (ident emit_n) (call (ident number_expr_value) (ident expr)) (call (ident number_expr_value_len) (ident expr))))
          (expr_stmt (call (ident emit_line) (string ", %rax")))
          (return)))
      (if (binop == (ident k) (ident NODE_STRING_EXPR))
        (block
          (var idx (type_base i64) (call (ident add_string) (call (ident string_expr_value) (ident expr)) (call (ident string_expr_value_len) (ident expr))))
          (expr_stmt (call (ident emit_str) (string "    lea .str")))
          (expr_stmt (call (ident emit_int) (ident idx)))
          (expr_stmt (call (ident emit_line) (string "(%rip), %rax")))
          (return)))
      (if (binop == (ident k) (ident NODE_BOOL_EXPR))
        (block
          (if (binop != (call (ident bool_expr_value) (ident expr)) (number 0))
            (block
              (expr_stmt (call (ident emit_line) (string "    mov $1, %rax"))))
            (block
              (expr_stmt (call (ident emit_line) (string "    xor %rax, %rax")))))
          (return)))
      (if (binop == (ident k) (ident NODE_NIL_EXPR))
        (block
          (expr_stmt (call (ident emit_line) (string "    xor %rax, %rax")))
          (return)))
      (if (binop == (ident k) (ident NODE_IDENT_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident expr)))
          (if (binop == (ident cg_in_closure) (number 1))
            (block
              (var cap_idx (type_base i64) (call (ident find_closure_capture) (ident name) (ident name_len)))
              (if (binop >= (ident cap_idx) (number 0))
                (block
                  (var capture_offset (type_base i64) (binop + (number 16) (binop * (ident cap_idx) (number 8))))
                  (expr_stmt (call (ident emit_str) (string "    mov ")))
                  (expr_stmt (call (ident emit_int) (ident cg_closure_ptr_offset)))
                  (expr_stmt (call (ident emit_line) (string "(%rbp), %rax")))
                  (expr_stmt (call (ident emit_str) (string "    mov ")))
                  (expr_stmt (call (ident emit_int) (ident capture_offset)))
                  (expr_stmt (call (ident emit_line) (string "(%rax), %rax")))
                  (return)))))
          (var local_idx (type_base i64) (call (ident find_local) (ident name) (ident name_len)))
          (if (binop >= (ident local_idx) (number 0))
            (block
              (var local_type (type_ptr (type_base u8)) (call (ident local_get_type) (ident local_idx)))
              (if (binop && (binop != (ident local_type) (nil)) (binop == (call (ident type_kind) (ident local_type)) (ident TYPE_BASE)))
                (block
                  (var type_name (type_ptr (type_base u8)) (call (ident base_type_name) (ident local_type)))
                  (var type_name_len (type_base i64) (call (ident base_type_name_len) (ident local_type)))
                  (if (binop != (call (ident find_struct) (ident type_name) (ident type_name_len)) (nil))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    lea ")))
                      (expr_stmt (call (ident emit_int) (call (ident local_get_offset) (ident local_idx))))
                      (expr_stmt (call (ident emit_line) (string "(%rbp), %rax")))
                      (return)))
                  (if (binop != (call (ident find_enum) (ident type_name) (ident type_name_len)) (nil))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    lea ")))
                      (expr_stmt (call (ident emit_int) (call (ident local_get_offset) (ident local_idx))))
                      (expr_stmt (call (ident emit_line) (string "(%rbp), %rax")))
                      (return)))))
              (expr_stmt (call (ident emit_str) (string "    mov ")))
              (expr_stmt (call (ident emit_int) (call (ident local_get_offset) (ident local_idx))))
              (expr_stmt (call (ident emit_line) (string "(%rbp), %rax")))
              (return)))
          (var global_idx (type_base i64) (call (ident find_global) (ident name) (ident name_len)))
          (if (binop >= (ident global_idx) (number 0))
            (block
              (expr_stmt (call (ident emit_str) (string "    mov ")))
              (expr_stmt (call (ident emit_n) (ident name) (ident name_len)))
              (expr_stmt (call (ident emit_line) (string "(%rip), %rax")))
              (return)))
          (expr_stmt (call (ident emit_str) (string "    lea ")))
          (expr_stmt (call (ident emit_n) (ident name) (ident name_len)))
          (expr_stmt (call (ident emit_line) (string "(%rip), %rax")))
          (return)))
      (if (binop == (ident k) (ident NODE_GROUP_EXPR))
        (block
          (expr_stmt (call (ident gen_expr) (call (ident group_expr_expr) (ident expr))))
          (return)))
      (if (binop == (ident k) (ident NODE_UNARY_EXPR))
        (block
          (var op (type_base i64) (call (ident unary_expr_op) (ident expr)))
          (if (binop == (ident op) (ident TOKEN_AMP))
            (block
              (var inner (type_ptr (type_base u8)) (call (ident unary_expr_expr) (ident expr)))
              (if (binop == (call (ident node_kind) (ident inner)) (ident NODE_IDENT_EXPR))
                (block
                  (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident inner)))
                  (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident inner)))
                  (var local_idx (type_base i64) (call (ident find_local) (ident name) (ident name_len)))
                  (if (binop >= (ident local_idx) (number 0))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    lea ")))
                      (expr_stmt (call (ident emit_int) (call (ident local_get_offset) (ident local_idx))))
                      (expr_stmt (call (ident emit_line) (string "(%rbp), %rax")))
                      (return)))
                  (var global_idx (type_base i64) (call (ident find_global) (ident name) (ident name_len)))
                  (if (binop >= (ident global_idx) (number 0))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    lea ")))
                      (expr_stmt (call (ident emit_n) (ident name) (ident name_len)))
                      (expr_stmt (call (ident emit_line) (string "(%rip), %rax")))
                      (return)))
                  (var func_decl (type_ptr (type_base u8)) (call (ident find_func) (ident name) (ident name_len)))
                  (if (binop != (ident func_decl) (nil))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    lea ")))
                      (expr_stmt (call (ident emit_n) (ident name) (ident name_len)))
                      (expr_stmt (call (ident emit_line) (string "(%rip), %rax")))
                      (return)))
                  (expr_stmt (call (ident eprint) (string "error: cannot take address of undefined identifier '")))
                  (expr_stmt (call (ident eprint_buf) (ident name) (ident name_len)))
                  (expr_stmt (call (ident eprintln) (string "'")))
                  (assign (ident cg_had_error) (number 1))))
              (if (binop == (call (ident node_kind) (ident inner)) (ident NODE_FIELD_EXPR))
                (block
                  (var base_expr (type_ptr (type_base u8)) (call (ident field_expr_expr) (ident inner)))
                  (var field_name (type_ptr (type_base u8)) (call (ident field_expr_field) (ident inner)))
                  (var field_len (type_base i64) (call (ident field_expr_field_len) (ident inner)))
                  (var base_type (type_ptr (type_base u8)) (call (ident get_expr_type) (ident base_expr)))
                  (var struct_name (type_ptr (type_base u8)) (nil))
                  (var struct_name_len (type_base i64) (number 0))
                  (var base_is_pointer (type_base i64) (number 0))
                  (if (binop != (ident base_type) (nil))
                    (block
                      (if (binop == (call (ident type_kind) (ident base_type)) (ident TYPE_BASE))
                        (block
                          (assign (ident struct_name) (call (ident base_type_name) (ident base_type)))
                          (assign (ident struct_name_len) (call (ident base_type_name_len) (ident base_type))))
                        (if (binop == (call (ident type_kind) (ident base_type)) (ident TYPE_PTR))
                          (block
                            (var pointed_type (type_ptr (type_base u8)) (call (ident ptr_type_elem) (ident base_type)))
                            (if (binop && (binop != (ident pointed_type) (nil)) (binop == (call (ident type_kind) (ident pointed_type)) (ident TYPE_BASE)))
                              (block
                                (assign (ident struct_name) (call (ident base_type_name) (ident pointed_type)))
                                (assign (ident struct_name_len) (call (ident base_type_name_len) (ident pointed_type)))
                                (assign (ident base_is_pointer) (number 1)))))))))
                  (if (binop != (ident struct_name) (nil))
                    (block
                      (var struct_decl (type_ptr (type_base u8)) (call (ident find_struct) (ident struct_name) (ident struct_name_len)))
                      (if (binop != (ident struct_decl) (nil))
                        (block
                          (var field_offset (type_base i64) (call (ident get_field_offset) (ident struct_decl) (ident field_name) (ident field_len)))
                          (if (binop >= (ident field_offset) (number 0))
                            (block
                              (if (binop != (ident base_is_pointer) (number 0))
                                (block
                                  (expr_stmt (call (ident gen_expr) (ident base_expr)))
                                  (if (binop != (ident field_offset) (number 0))
                                    (block
                                      (expr_stmt (call (ident emit_str) (string "    add $")))
                                      (expr_stmt (call (ident emit_int) (ident field_offset)))
                                      (expr_stmt (call (ident emit_line) (string ", %rax")))))
                                  (return)))
                              (if (binop == (call (ident node_kind) (ident base_expr)) (ident NODE_IDENT_EXPR))
                                (block
                                  (var bname (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident base_expr)))
                                  (var bname_len (type_base i64) (call (ident ident_expr_name_len) (ident base_expr)))
                                  (var local_idx (type_base i64) (call (ident find_local) (ident bname) (ident bname_len)))
                                  (if (binop >= (ident local_idx) (number 0))
                                    (block
                                      (var base_offset (type_base i64) (call (ident local_get_offset) (ident local_idx)))
                                      (expr_stmt (call (ident emit_str) (string "    lea ")))
                                      (expr_stmt (call (ident emit_int) (binop + (ident base_offset) (ident field_offset))))
                                      (expr_stmt (call (ident emit_line) (string "(%rbp), %rax")))
                                      (return)))))))))))))
              (return)))
          (expr_stmt (call (ident gen_expr) (call (ident unary_expr_expr) (ident expr))))
          (if (binop == (ident op) (ident TOKEN_MINUS))
            (block
              (expr_stmt (call (ident emit_line) (string "    neg %rax")))
              (return)))
          (if (binop == (ident op) (ident TOKEN_BANG))
            (block
              (expr_stmt (call (ident emit_line) (string "    test %rax, %rax")))
              (expr_stmt (call (ident emit_line) (string "    setz %al")))
              (expr_stmt (call (ident emit_line) (string "    movzx %al, %rax")))
              (return)))
          (if (binop == (ident op) (ident TOKEN_STAR))
            (block
              (var ptr_type (type_ptr (type_base u8)) (call (ident get_expr_type) (call (ident unary_expr_expr) (ident expr))))
              (var elem_type (type_ptr (type_base u8)) (call (ident get_pointed_type) (ident ptr_type)))
              (var size (type_base i64) (number 8))
              (if (binop != (ident elem_type) (nil))
                (block
                  (assign (ident size) (call (ident get_type_size) (ident elem_type)))))
              (if (binop == (ident size) (number 1))
                (block
                  (expr_stmt (call (ident emit_line) (string "    movzbl (%rax), %eax"))))
                (if (binop == (ident size) (number 2))
                  (block
                    (expr_stmt (call (ident emit_line) (string "    movzwl (%rax), %eax"))))
                  (if (binop == (ident size) (number 4))
                    (block
                      (expr_stmt (call (ident emit_line) (string "    mov (%rax), %eax"))))
                    (block
                      (expr_stmt (call (ident emit_line) (string "    mov (%rax), %rax")))))))
              (return)))
          (return)))
      (if (binop == (ident k) (ident NODE_BINARY_EXPR))
        (block
          (var op (type_base i64) (call (ident binary_expr_op) (ident expr)))
          (if (binop == (ident op) (ident TOKEN_EQ))
            (block
              (expr_stmt (call (ident gen_expr) (call (ident binary_expr_right) (ident expr))))
              (expr_stmt (call (ident gen_lvalue_store) (call (ident binary_expr_left) (ident expr))))
              (return)))
          (if (binop == (ident op) (ident TOKEN_AMPAMP))
            (block
              (var end_label (type_base i64) (call (ident new_label)))
              (expr_stmt (call (ident gen_expr) (call (ident binary_expr_left) (ident expr))))
              (expr_stmt (call (ident emit_line) (string "    test %rax, %rax")))
              (expr_stmt (call (ident emit_str) (string "    jz ")))
              (expr_stmt (call (ident emit_label) (ident end_label)))
              (expr_stmt (call (ident emit_char) (number 10)))
              (expr_stmt (call (ident gen_expr) (call (ident binary_expr_right) (ident expr))))
              (expr_stmt (call (ident emit_label) (ident end_label)))
              (expr_stmt (call (ident emit_line) (string ":")))
              (return)))
          (if (binop == (ident op) (ident TOKEN_PIPEPIPE))
            (block
              (var end_label (type_base i64) (call (ident new_label)))
              (expr_stmt (call (ident gen_expr) (call (ident binary_expr_left) (ident expr))))
              (expr_stmt (call (ident emit_line) (string "    test %rax, %rax")))
              (expr_stmt (call (ident emit_str) (string "    jnz ")))
              (expr_stmt (call (ident emit_label) (ident end_label)))
              (expr_stmt (call (ident emit_char) (number 10)))
              (expr_stmt (call (ident gen_expr) (call (ident binary_expr_right) (ident expr))))
              (expr_stmt (call (ident emit_label) (ident end_label)))
              (expr_stmt (call (ident emit_line) (string ":")))
              (return)))
          (expr_stmt (call (ident gen_expr) (call (ident binary_expr_left) (ident expr))))
          (expr_stmt (call (ident emit_line) (string "    push %rax")))
          (expr_stmt (call (ident gen_expr) (call (ident binary_expr_right) (ident expr))))
          (expr_stmt (call (ident emit_line) (string "    mov %rax, %rcx")))
          (expr_stmt (call (ident emit_line) (string "    pop %rax")))
          (if (binop == (ident op) (ident TOKEN_PLUS))
            (block
              (var left_type (type_ptr (type_base u8)) (call (ident get_expr_type) (call (ident binary_expr_left) (ident expr))))
              (if (binop && (binop != (ident left_type) (nil)) (binop == (call (ident type_kind) (ident left_type)) (ident TYPE_PTR)))
                (block
                  (var elem_type (type_ptr (type_base u8)) (call (ident ptr_type_elem) (ident left_type)))
                  (var elem_size (type_base i64) (call (ident get_type_size) (ident elem_type)))
                  (if (binop > (ident elem_size) (number 1))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    imul $")))
                      (expr_stmt (call (ident emit_int) (ident elem_size)))
                      (expr_stmt (call (ident emit_line) (string ", %rcx")))))))
              (expr_stmt (call (ident emit_line) (string "    add %rcx, %rax"))))
            (if (binop == (ident op) (ident TOKEN_MINUS))
              (block
                (var left_type (type_ptr (type_base u8)) (call (ident get_expr_type) (call (ident binary_expr_left) (ident expr))))
                (if (binop && (binop != (ident left_type) (nil)) (binop == (call (ident type_kind) (ident left_type)) (ident TYPE_PTR)))
                  (block
                    (var elem_type (type_ptr (type_base u8)) (call (ident ptr_type_elem) (ident left_type)))
                    (var elem_size (type_base i64) (call (ident get_type_size) (ident elem_type)))
                    (if (binop > (ident elem_size) (number 1))
                      (block
                        (expr_stmt (call (ident emit_str) (string "    imul $")))
                        (expr_stmt (call (ident emit_int) (ident elem_size)))
                        (expr_stmt (call (ident emit_line) (string ", %rcx")))))))
                (expr_stmt (call (ident emit_line) (string "    sub %rcx, %rax"))))
              (if (binop == (ident op) (ident TOKEN_STAR))
                (block
                  (expr_stmt (call (ident emit_line) (string "    imul %rcx, %rax"))))
                (if (binop == (ident op) (ident TOKEN_SLASH))
                  (block
                    (expr_stmt (call (ident emit_line) (string "    cqo")))
                    (expr_stmt (call (ident emit_line) (string "    idiv %rcx"))))
                  (if (binop == (ident op) (ident TOKEN_PERCENT))
                    (block
                      (expr_stmt (call (ident emit_line) (string "    cqo")))
                      (expr_stmt (call (ident emit_line) (string "    idiv %rcx")))
                      (expr_stmt (call (ident emit_line) (string "    mov %rdx, %rax"))))
                    (if (binop == (ident op) (ident TOKEN_EQEQ))
                      (block
                        (expr_stmt (call (ident emit_line) (string "    cmp %rcx, %rax")))
                        (expr_stmt (call (ident emit_line) (string "    sete %al")))
                        (expr_stmt (call (ident emit_line) (string "    movzx %al, %rax"))))
                      (if (binop == (ident op) (ident TOKEN_BANGEQ))
                        (block
                          (expr_stmt (call (ident emit_line) (string "    cmp %rcx, %rax")))
                          (expr_stmt (call (ident emit_line) (string "    setne %al")))
                          (expr_stmt (call (ident emit_line) (string "    movzx %al, %rax"))))
                        (if (binop == (ident op) (ident TOKEN_LT))
                          (block
                            (expr_stmt (call (ident emit_line) (string "    cmp %rcx, %rax")))
                            (expr_stmt (call (ident emit_line) (string "    setl %al")))
                            (expr_stmt (call (ident emit_line) (string "    movzx %al, %rax"))))
                          (if (binop == (ident op) (ident TOKEN_GT))
                            (block
                              (expr_stmt (call (ident emit_line) (string "    cmp %rcx, %rax")))
                              (expr_stmt (call (ident emit_line) (string "    setg %al")))
                              (expr_stmt (call (ident emit_line) (string "    movzx %al, %rax"))))
                            (if (binop == (ident op) (ident TOKEN_LTEQ))
                              (block
                                (expr_stmt (call (ident emit_line) (string "    cmp %rcx, %rax")))
                                (expr_stmt (call (ident emit_line) (string "    setle %al")))
                                (expr_stmt (call (ident emit_line) (string "    movzx %al, %rax"))))
                              (if (binop == (ident op) (ident TOKEN_GTEQ))
                                (block
                                  (expr_stmt (call (ident emit_line) (string "    cmp %rcx, %rax")))
                                  (expr_stmt (call (ident emit_line) (string "    setge %al")))
                                  (expr_stmt (call (ident emit_line) (string "    movzx %al, %rax"))))
                                (if (binop == (ident op) (ident TOKEN_AMP))
                                  (block
                                    (expr_stmt (call (ident emit_line) (string "    and %rcx, %rax"))))
                                  (if (binop == (ident op) (ident TOKEN_PIPE))
                                    (block
                                      (expr_stmt (call (ident emit_line) (string "    or %rcx, %rax"))))
                                    (if (binop == (ident op) (ident TOKEN_CARET))
                                      (block
                                        (expr_stmt (call (ident emit_line) (string "    xor %rcx, %rax"))))
                                      (if (binop == (ident op) (ident TOKEN_LTLT))
                                        (block
                                          (expr_stmt (call (ident emit_line) (string "    shl %cl, %rax"))))
                                        (if (binop == (ident op) (ident TOKEN_GTGT))
                                          (block
                                            (expr_stmt (call (ident emit_line) (string "    sar %cl, %rax"))))))))))))))))))))
          (return)))
      (if (binop == (ident k) (ident NODE_CALL_EXPR))
        (block
          (var func_expr (type_ptr (type_base u8)) (call (ident call_expr_func) (ident expr)))
          (var args (type_ptr (type_base u8)) (call (ident call_expr_args) (ident expr)))
          (var arg_count (type_base i64) (call (ident call_expr_arg_count) (ident expr)))
          (if (binop == (call (ident node_kind) (ident func_expr)) (ident NODE_FIELD_EXPR))
            (block
              (var field_base (type_ptr (type_base u8)) (call (ident field_expr_expr) (ident func_expr)))
              (var field_name (type_ptr (type_base u8)) (call (ident field_expr_field) (ident func_expr)))
              (var field_len (type_base i64) (call (ident field_expr_field_len) (ident func_expr)))
              (if (binop == (call (ident node_kind) (ident field_base)) (ident NODE_IDENT_EXPR))
                (block
                  (var enum_name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident field_base)))
                  (var enum_name_len (type_base i64) (call (ident ident_expr_name_len) (ident field_base)))
                  (var enum_decl (type_ptr (type_base u8)) (call (ident find_enum) (ident enum_name) (ident enum_name_len)))
                  (if (binop != (ident enum_decl) (nil))
                    (block
                      (var variant (type_ptr (type_base u8)) (call (ident find_variant) (ident enum_decl) (ident field_name) (ident field_len)))
                      (if (binop == (ident variant) (nil))
                        (block
                          (expr_stmt (call (ident eprint) (string "error: enum '")))
                          (expr_stmt (call (ident eprint_buf) (ident enum_name) (ident enum_name_len)))
                          (expr_stmt (call (ident eprint) (string "' has no variant '")))
                          (expr_stmt (call (ident eprint_buf) (ident field_name) (ident field_len)))
                          (expr_stmt (call (ident eprintln) (string "'")))
                          (assign (ident cg_had_error) (number 1))
                          (return)))
                      (var enum_size (type_base i64) (call (ident get_enum_size) (ident enum_decl)))
                      (assign (ident cg_stack_size) (binop + (ident cg_stack_size) (ident enum_size)))
                      (var enum_offset (type_base i64) (binop - (number 0) (ident cg_stack_size)))
                      (var tag (type_base i64) (call (ident enum_variant_tag) (ident variant)))
                      (expr_stmt (call (ident emit_str) (string "    movq $")))
                      (expr_stmt (call (ident emit_int) (ident tag)))
                      (expr_stmt (call (ident emit_str) (string ", ")))
                      (expr_stmt (call (ident emit_int) (ident enum_offset)))
                      (expr_stmt (call (ident emit_line) (string "(%rbp)")))
                      (if (binop > (ident arg_count) (number 0))
                        (block
                          (var p (type_ptr (type_ptr (type_base u8))) (ident args))
                          (expr_stmt (call (ident gen_expr) (unop * (ident p))))
                          (var payload_type (type_ptr (type_base u8)) (call (ident enum_variant_type) (ident variant)))
                          (var payload_size (type_base i64) (number 8))
                          (if (binop != (ident payload_type) (nil))
                            (block
                              (assign (ident payload_size) (call (ident get_type_size) (ident payload_type)))))
                          (if (binop <= (ident payload_size) (number 8))
                            (block
                              (expr_stmt (call (ident emit_str) (string "    movq %rax, ")))
                              (expr_stmt (call (ident emit_int) (binop + (ident enum_offset) (number 8))))
                              (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
                            (block
                              (expr_stmt (call (ident emit_line) (string "    mov %rax, %rsi")))
                              (var i (type_base i64) (number 0))
                              (while (binop < (ident i) (ident payload_size))
                                (block
                                  (expr_stmt (call (ident emit_str) (string "    mov ")))
                                  (expr_stmt (call (ident emit_int) (ident i)))
                                  (expr_stmt (call (ident emit_line) (string "(%rsi), %rcx")))
                                  (expr_stmt (call (ident emit_str) (string "    mov %rcx, ")))
                                  (expr_stmt (call (ident emit_int) (binop + (binop + (ident enum_offset) (number 8)) (ident i))))
                                  (expr_stmt (call (ident emit_line) (string "(%rbp)")))
                                  (assign (ident i) (binop + (ident i) (number 8)))))))))
                      (expr_stmt (call (ident emit_str) (string "    lea ")))
                      (expr_stmt (call (ident emit_int) (ident enum_offset)))
                      (expr_stmt (call (ident emit_line) (string "(%rbp), %rax")))
                      (return)))))))
          (if (binop == (call (ident node_kind) (ident func_expr)) (ident NODE_IDENT_EXPR))
            (block
              (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident func_expr)))
              (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident func_expr)))
              (if (binop == (ident name_len) (number 7))
                (block
                  (if (call (ident memcmp) (ident name) (string "syscall") (number 7))
                    (block
                      (expr_stmt (call (ident gen_syscall) (ident args) (ident arg_count)))
                      (return)))))
              (var func_decl (type_ptr (type_base u8)) (call (ident find_func) (ident name) (ident name_len)))
              (if (binop != (ident func_decl) (nil))
                (block
                  (var is_main (type_base i64) (number 0))
                  (if (binop == (ident name_len) (number 4))
                    (block
                      (if (call (ident memcmp) (ident name) (string "main") (number 4))
                        (block
                          (assign (ident is_main) (number 1))))))
                  (var param_count (type_base i64) (call (ident func_decl_param_count) (ident func_decl)))
                  (if (binop && (binop != (ident arg_count) (ident param_count)) (binop == (ident is_main) (number 0)))
                    (block
                      (expr_stmt (call (ident eprint) (string "Error: function '")))
                      (expr_stmt (call (ident eprint_buf) (ident name) (ident name_len)))
                      (expr_stmt (call (ident eprint) (string "' expects ")))
                      (expr_stmt (call (ident eprint_i64) (ident param_count)))
                      (expr_stmt (call (ident eprint) (string " argument(s), got ")))
                      (expr_stmt (call (ident eprint_i64) (ident arg_count)))
                      (expr_stmt (call (ident eprintln) (string "")))
                      (expr_stmt (call (ident exit) (number 1)))))))
              (var macro_def (type_ptr (type_base u8)) (call (ident find_macro) (ident name) (ident name_len)))
              (if (binop != (ident macro_def) (nil))
                (block
                  (var expanded (type_ptr (type_base u8)) (call (ident interp_call_macro) (ident macro_def) (ident args) (ident arg_count)))
                  (if (binop && (binop != (ident cg_expand_macros) (number 0)) (binop != (ident expanded) (nil)))
                    (block
                      (expr_stmt (call (ident eprint) (string "[macro ")))
                      (expr_stmt (call (ident eprint_buf) (ident name) (ident name_len)))
                      (expr_stmt (call (ident eprint) (string "] => ")))
                      (expr_stmt (call (ident print_expr_ast) (ident expanded)))
                      (expr_stmt (call (ident eprintln) (string "")))))
                  (if (binop != (ident expanded) (nil))
                    (block
                      (expr_stmt (call (ident gen_expr) (ident expanded)))))
                  (return)))))
          (var i (type_base i64) (binop - (ident arg_count) (number 1)))
          (while (binop >= (ident i) (number 0))
            (block
              (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident args) (binop * (ident i) (number 8))))
              (expr_stmt (call (ident gen_expr) (unop * (ident p))))
              (expr_stmt (call (ident emit_line) (string "    push %rax")))
              (assign (ident i) (binop - (ident i) (number 1)))))
          (assign (ident i) (number 0))
          (while (binop && (binop < (ident i) (ident arg_count)) (binop < (ident i) (number 6)))
            (block
              (if (binop == (ident i) (number 0))
                (block
                  (expr_stmt (call (ident emit_line) (string "    pop %rdi"))))
                (if (binop == (ident i) (number 1))
                  (block
                    (expr_stmt (call (ident emit_line) (string "    pop %rsi"))))
                  (if (binop == (ident i) (number 2))
                    (block
                      (expr_stmt (call (ident emit_line) (string "    pop %rdx"))))
                    (if (binop == (ident i) (number 3))
                      (block
                        (expr_stmt (call (ident emit_line) (string "    pop %rcx"))))
                      (if (binop == (ident i) (number 4))
                        (block
                          (expr_stmt (call (ident emit_line) (string "    pop %r8"))))
                        (if (binop == (ident i) (number 5))
                          (block
                            (expr_stmt (call (ident emit_line) (string "    pop %r9"))))))))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (if (binop == (call (ident node_kind) (ident func_expr)) (ident NODE_IDENT_EXPR))
            (block
              (var fn_name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident func_expr)))
              (var fn_name_len (type_base i64) (call (ident ident_expr_name_len) (ident func_expr)))
              (var local_idx (type_base i64) (call (ident find_local) (ident fn_name) (ident fn_name_len)))
              (if (binop >= (ident local_idx) (number 0))
                (block
                  (var var_type (type_ptr (type_base u8)) (call (ident local_get_type) (ident local_idx)))
                  (if (binop == (call (ident is_auto_closure_type) (ident var_type)) (number 1))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    mov ")))
                      (expr_stmt (call (ident emit_int) (call (ident local_get_offset) (ident local_idx))))
                      (expr_stmt (call (ident emit_line) (string "(%rbp), %r10")))
                      (expr_stmt (call (ident emit_line) (string "    mov (%r10), %r11")))
                      (expr_stmt (call (ident emit_line) (string "    test %r11, %r11")))
                      (var plain_label (type_base i64) (call (ident new_label)))
                      (var end_label (type_base i64) (call (ident new_label)))
                      (expr_stmt (call (ident emit_str) (string "    jz ")))
                      (expr_stmt (call (ident emit_label) (ident plain_label)))
                      (expr_stmt (call (ident emit_char) (number 10)))
                      (if (binop >= (ident arg_count) (number 5))
                        (block
                          (expr_stmt (call (ident emit_line) (string "    mov %r9, %rax")))
                          (expr_stmt (call (ident emit_line) (string "    push %rax")))))
                      (if (binop >= (ident arg_count) (number 5))
                        (block
                          (expr_stmt (call (ident emit_line) (string "    mov %r8, %r9")))))
                      (if (binop >= (ident arg_count) (number 4))
                        (block
                          (expr_stmt (call (ident emit_line) (string "    mov %rcx, %r8")))))
                      (if (binop >= (ident arg_count) (number 3))
                        (block
                          (expr_stmt (call (ident emit_line) (string "    mov %rdx, %rcx")))))
                      (if (binop >= (ident arg_count) (number 2))
                        (block
                          (expr_stmt (call (ident emit_line) (string "    mov %rsi, %rdx")))))
                      (if (binop >= (ident arg_count) (number 1))
                        (block
                          (expr_stmt (call (ident emit_line) (string "    mov %rdi, %rsi")))))
                      (expr_stmt (call (ident emit_line) (string "    mov %r10, %rdi")))
                      (expr_stmt (call (ident emit_line) (string "    mov 8(%r10), %rax")))
                      (expr_stmt (call (ident emit_line) (string "    call *%rax")))
                      (expr_stmt (call (ident emit_str) (string "    jmp ")))
                      (expr_stmt (call (ident emit_label) (ident end_label)))
                      (expr_stmt (call (ident emit_char) (number 10)))
                      (expr_stmt (call (ident emit_label) (ident plain_label)))
                      (expr_stmt (call (ident emit_line) (string ":")))
                      (expr_stmt (call (ident emit_line) (string "    mov 8(%r10), %rax")))
                      (expr_stmt (call (ident emit_line) (string "    call *%rax")))
                      (expr_stmt (call (ident emit_label) (ident end_label)))
                      (expr_stmt (call (ident emit_line) (string ":"))))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    mov ")))
                      (expr_stmt (call (ident emit_int) (call (ident local_get_offset) (ident local_idx))))
                      (expr_stmt (call (ident emit_line) (string "(%rbp), %rax")))
                      (expr_stmt (call (ident emit_line) (string "    call *%rax"))))))
                (block
                  (var global_idx (type_base i64) (call (ident find_global) (ident fn_name) (ident fn_name_len)))
                  (if (binop >= (ident global_idx) (number 0))
                    (block
                      (var var_type (type_ptr (type_base u8)) (call (ident global_get_type) (ident global_idx)))
                      (if (binop == (call (ident is_auto_closure_type) (ident var_type)) (number 1))
                        (block
                          (expr_stmt (call (ident emit_str) (string "    mov ")))
                          (expr_stmt (call (ident emit_n) (ident fn_name) (ident fn_name_len)))
                          (expr_stmt (call (ident emit_line) (string "(%rip), %r10")))
                          (expr_stmt (call (ident emit_line) (string "    mov (%r10), %r11")))
                          (expr_stmt (call (ident emit_line) (string "    test %r11, %r11")))
                          (var plain_label (type_base i64) (call (ident new_label)))
                          (var end_label (type_base i64) (call (ident new_label)))
                          (expr_stmt (call (ident emit_str) (string "    jz ")))
                          (expr_stmt (call (ident emit_label) (ident plain_label)))
                          (expr_stmt (call (ident emit_char) (number 10)))
                          (if (binop >= (ident arg_count) (number 5))
                            (block
                              (expr_stmt (call (ident emit_line) (string "    mov %r9, %rax")))
                              (expr_stmt (call (ident emit_line) (string "    push %rax")))))
                          (if (binop >= (ident arg_count) (number 5))
                            (block
                              (expr_stmt (call (ident emit_line) (string "    mov %r8, %r9")))))
                          (if (binop >= (ident arg_count) (number 4))
                            (block
                              (expr_stmt (call (ident emit_line) (string "    mov %rcx, %r8")))))
                          (if (binop >= (ident arg_count) (number 3))
                            (block
                              (expr_stmt (call (ident emit_line) (string "    mov %rdx, %rcx")))))
                          (if (binop >= (ident arg_count) (number 2))
                            (block
                              (expr_stmt (call (ident emit_line) (string "    mov %rsi, %rdx")))))
                          (if (binop >= (ident arg_count) (number 1))
                            (block
                              (expr_stmt (call (ident emit_line) (string "    mov %rdi, %rsi")))))
                          (expr_stmt (call (ident emit_line) (string "    mov %r10, %rdi")))
                          (expr_stmt (call (ident emit_line) (string "    mov 8(%r10), %rax")))
                          (expr_stmt (call (ident emit_line) (string "    call *%rax")))
                          (expr_stmt (call (ident emit_str) (string "    jmp ")))
                          (expr_stmt (call (ident emit_label) (ident end_label)))
                          (expr_stmt (call (ident emit_char) (number 10)))
                          (expr_stmt (call (ident emit_label) (ident plain_label)))
                          (expr_stmt (call (ident emit_line) (string ":")))
                          (expr_stmt (call (ident emit_line) (string "    mov 8(%r10), %rax")))
                          (expr_stmt (call (ident emit_line) (string "    call *%rax")))
                          (expr_stmt (call (ident emit_label) (ident end_label)))
                          (expr_stmt (call (ident emit_line) (string ":"))))
                        (block
                          (expr_stmt (call (ident emit_str) (string "    mov ")))
                          (expr_stmt (call (ident emit_n) (ident fn_name) (ident fn_name_len)))
                          (expr_stmt (call (ident emit_line) (string "(%rip), %rax")))
                          (expr_stmt (call (ident emit_line) (string "    call *%rax"))))))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    call ")))
                      (expr_stmt (call (ident emit_n) (ident fn_name) (ident fn_name_len)))
                      (expr_stmt (call (ident emit_char) (number 10))))))))
            (block
              (expr_stmt (call (ident gen_expr) (ident func_expr)))
              (expr_stmt (call (ident emit_line) (string "    call *%rax")))))
          (if (binop > (ident arg_count) (number 6))
            (block
              (var extra_args (type_base i64) (binop - (ident arg_count) (number 6)))
              (var cleanup_bytes (type_base i64) (binop * (ident extra_args) (number 8)))
              (expr_stmt (call (ident emit_str) (string "    add $")))
              (expr_stmt (call (ident emit_int) (ident cleanup_bytes)))
              (expr_stmt (call (ident emit_line) (string ", %rsp")))))
          (return)))
      (if (binop == (ident k) (ident NODE_INDEX_EXPR))
        (block
          (return)))
      (if (binop == (ident k) (ident NODE_FIELD_EXPR))
        (block
          (var base_expr (type_ptr (type_base u8)) (call (ident field_expr_expr) (ident expr)))
          (var field_name (type_ptr (type_base u8)) (call (ident field_expr_field) (ident expr)))
          (var field_len (type_base i64) (call (ident field_expr_field_len) (ident expr)))
          (if (binop == (call (ident node_kind) (ident base_expr)) (ident NODE_IDENT_EXPR))
            (block
              (var enum_name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident base_expr)))
              (var enum_name_len (type_base i64) (call (ident ident_expr_name_len) (ident base_expr)))
              (var enum_decl (type_ptr (type_base u8)) (call (ident find_enum) (ident enum_name) (ident enum_name_len)))
              (if (binop != (ident enum_decl) (nil))
                (block
                  (var variant (type_ptr (type_base u8)) (call (ident find_variant) (ident enum_decl) (ident field_name) (ident field_len)))
                  (if (binop == (ident variant) (nil))
                    (block
                      (expr_stmt (call (ident eprint) (string "error: enum '")))
                      (expr_stmt (call (ident eprint_buf) (ident enum_name) (ident enum_name_len)))
                      (expr_stmt (call (ident eprint) (string "' has no variant '")))
                      (expr_stmt (call (ident eprint_buf) (ident field_name) (ident field_len)))
                      (expr_stmt (call (ident eprintln) (string "'")))
                      (assign (ident cg_had_error) (number 1))
                      (return)))
                  (var enum_size (type_base i64) (call (ident get_enum_size) (ident enum_decl)))
                  (assign (ident cg_stack_size) (binop + (ident cg_stack_size) (ident enum_size)))
                  (var enum_offset (type_base i64) (binop - (number 0) (ident cg_stack_size)))
                  (var tag (type_base i64) (call (ident enum_variant_tag) (ident variant)))
                  (expr_stmt (call (ident emit_str) (string "    movq $")))
                  (expr_stmt (call (ident emit_int) (ident tag)))
                  (expr_stmt (call (ident emit_str) (string ", ")))
                  (expr_stmt (call (ident emit_int) (ident enum_offset)))
                  (expr_stmt (call (ident emit_line) (string "(%rbp)")))
                  (expr_stmt (call (ident emit_str) (string "    movq $0, ")))
                  (expr_stmt (call (ident emit_int) (binop + (ident enum_offset) (number 8))))
                  (expr_stmt (call (ident emit_line) (string "(%rbp)")))
                  (expr_stmt (call (ident emit_str) (string "    lea ")))
                  (expr_stmt (call (ident emit_int) (ident enum_offset)))
                  (expr_stmt (call (ident emit_line) (string "(%rbp), %rax")))
                  (return)))))
          (var base_type (type_ptr (type_base u8)) (call (ident get_expr_type) (ident base_expr)))
          (if (binop == (ident base_type) (nil))
            (block
              (return)))
          (var struct_name (type_ptr (type_base u8)) (nil))
          (var struct_name_len (type_base i64) (number 0))
          (var is_pointer (type_base i64) (number 0))
          (if (binop == (call (ident type_kind) (ident base_type)) (ident TYPE_BASE))
            (block
              (assign (ident struct_name) (call (ident base_type_name) (ident base_type)))
              (assign (ident struct_name_len) (call (ident base_type_name_len) (ident base_type))))
            (if (binop == (call (ident type_kind) (ident base_type)) (ident TYPE_PTR))
              (block
                (var pointed_type (type_ptr (type_base u8)) (call (ident ptr_type_elem) (ident base_type)))
                (if (binop && (binop != (ident pointed_type) (nil)) (binop == (call (ident type_kind) (ident pointed_type)) (ident TYPE_BASE)))
                  (block
                    (assign (ident struct_name) (call (ident base_type_name) (ident pointed_type)))
                    (assign (ident struct_name_len) (call (ident base_type_name_len) (ident pointed_type)))
                    (assign (ident is_pointer) (number 1)))))))
          (if (binop == (ident struct_name) (nil))
            (block
              (return)))
          (assign (ident cg_temp_struct_decl) (call (ident find_struct) (ident struct_name) (ident struct_name_len)))
          (if (binop == (ident cg_temp_struct_decl) (nil))
            (block
              (return)))
          (var field_offset (type_base i64) (call (ident get_field_offset) (ident cg_temp_struct_decl) (ident field_name) (ident field_len)))
          (if (binop < (ident field_offset) (number 0))
            (block
              (return)))
          (var field_type (type_ptr (type_base u8)) (call (ident get_field_type) (ident cg_temp_struct_decl) (ident field_name) (ident field_len)))
          (var field_is_struct (type_base i64) (number 0))
          (if (binop && (binop != (ident field_type) (nil)) (binop == (call (ident type_kind) (ident field_type)) (ident TYPE_BASE)))
            (block
              (var ft_name (type_ptr (type_base u8)) (call (ident base_type_name) (ident field_type)))
              (var ft_name_len (type_base i64) (call (ident base_type_name_len) (ident field_type)))
              (if (binop != (call (ident find_struct) (ident ft_name) (ident ft_name_len)) (nil))
                (block
                  (assign (ident field_is_struct) (number 1))))))
          (if (binop != (ident is_pointer) (number 0))
            (block
              (expr_stmt (call (ident gen_expr) (ident base_expr)))
              (if (binop != (ident field_is_struct) (number 0))
                (block
                  (if (binop == (ident field_offset) (number 0))
                    (block)
                    (block
                      (expr_stmt (call (ident emit_str) (string "    add $")))
                      (expr_stmt (call (ident emit_int) (ident field_offset)))
                      (expr_stmt (call (ident emit_line) (string ", %rax"))))))
                (block
                  (if (binop == (ident field_offset) (number 0))
                    (block
                      (expr_stmt (call (ident emit_line) (string "    mov (%rax), %rax"))))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    mov ")))
                      (expr_stmt (call (ident emit_int) (ident field_offset)))
                      (expr_stmt (call (ident emit_line) (string "(%rax), %rax")))))))
              (return)))
          (if (binop == (call (ident node_kind) (ident base_expr)) (ident NODE_IDENT_EXPR))
            (block
              (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident base_expr)))
              (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident base_expr)))
              (var local_idx (type_base i64) (call (ident find_local) (ident name) (ident name_len)))
              (if (binop >= (ident local_idx) (number 0))
                (block
                  (var base_offset (type_base i64) (call (ident local_get_offset) (ident local_idx)))
                  (if (binop != (ident field_is_struct) (number 0))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    lea ")))
                      (expr_stmt (call (ident emit_int) (binop + (ident base_offset) (ident field_offset))))
                      (expr_stmt (call (ident emit_line) (string "(%rbp), %rax"))))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    mov ")))
                      (expr_stmt (call (ident emit_int) (binop + (ident base_offset) (ident field_offset))))
                      (expr_stmt (call (ident emit_line) (string "(%rbp), %rax")))))
                  (return)))))
          (if (binop == (call (ident node_kind) (ident base_expr)) (ident NODE_FIELD_EXPR))
            (block
              (expr_stmt (call (ident gen_expr) (ident base_expr)))
              (if (binop != (ident field_is_struct) (number 0))
                (block
                  (if (binop != (ident field_offset) (number 0))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    add $")))
                      (expr_stmt (call (ident emit_int) (ident field_offset)))
                      (expr_stmt (call (ident emit_line) (string ", %rax"))))))
                (block
                  (if (binop == (ident field_offset) (number 0))
                    (block
                      (expr_stmt (call (ident emit_line) (string "    mov (%rax), %rax"))))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    mov ")))
                      (expr_stmt (call (ident emit_int) (ident field_offset)))
                      (expr_stmt (call (ident emit_line) (string "(%rax), %rax")))))))
              (return)))
          (var total_offset (type_base i64) (call (ident compute_nested_field_offset) (ident expr)))
          (if (binop >= (ident total_offset) (number 0))
            (block
              (var base_offset (type_base i64) (call (ident local_get_offset) (ident cg_nested_field_base_local)))
              (expr_stmt (call (ident emit_str) (string "    mov ")))
              (expr_stmt (call (ident emit_int) (binop + (ident base_offset) (ident total_offset))))
              (expr_stmt (call (ident emit_line) (string "(%rbp), %rax")))
              (return)))
          (return)))
      (if (binop == (ident k) (ident NODE_READER_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident reader_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident reader_expr_name_len) (ident expr)))
          (var content (type_ptr (type_base u8)) (call (ident reader_expr_content) (ident expr)))
          (var content_len (type_base i64) (call (ident reader_expr_content_len) (ident expr)))
          (var reader_decl (type_ptr (type_base u8)) (call (ident find_reader) (ident name) (ident name_len)))
          (if (binop == (ident reader_decl) (nil))
            (block
              (expr_stmt (call (ident eprint) (string "error: reader macro '")))
              (expr_stmt (call (ident eprint_buf) (ident name) (ident name_len)))
              (expr_stmt (call (ident eprintln) (string "' not found")))
              (assign (ident cg_had_error) (number 1))
              (return)))
          (var exe_path (type_ptr (type_base u8)) (call (ident build_reader_cache_path) (ident name) (ident name_len)))
          (var output (type_ptr (type_base u8)) (call (ident alloc) (number 65536)))
          (var n (type_base i64) (call (ident exec_capture) (ident exe_path) (ident content) (ident content_len) (ident output) (number 65536)))
          (if (binop <= (ident n) (number 0))
            (block
              (expr_stmt (call (ident eprint) (string "error: reader '")))
              (expr_stmt (call (ident eprint_buf) (ident name) (ident name_len)))
              (expr_stmt (call (ident eprintln) (string "' returned no output")))
              (assign (ident cg_had_error) (number 1))
              (return)))
          (var expanded (type_ptr (type_base u8)) (call (ident parse_ast_expression_from_string) (ident output)))
          (if (binop != (ident expanded) (nil))
            (block
              (expr_stmt (call (ident gen_expr) (ident expanded)))))
          (return)))
      (if (binop == (ident k) (ident NODE_LET_EXPR))
        (block
          (var saved_local_count (type_base i64) (ident cg_local_count))
          (var var_type (type_ptr (type_base u8)) (call (ident let_expr_type) (ident expr)))
          (if (binop == (ident var_type) (nil))
            (block
              (assign (ident var_type) (call (ident get_expr_type) (call (ident let_expr_init) (ident expr))))
              (if (binop == (ident var_type) (nil))
                (block
                  (assign (ident var_type) (call (ident alloc) (number 24)))
                  (expr_stmt (call (ident node_set_kind) (ident var_type) (ident TYPE_BASE)))
                  (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident var_type) (number 8)))
                  (assign (unop * (ident p)) (string "i64"))
                  (var pl (type_ptr (type_base i64)) (binop + (ident var_type) (number 16)))
                  (assign (unop * (ident pl)) (number 3))))))
          (var var_size (type_base i64) (call (ident get_type_size) (ident var_type)))
          (if (binop < (ident var_size) (number 8))
            (block
              (assign (ident var_size) (number 8))))
          (assign (ident cg_stack_size) (binop + (ident cg_stack_size) (ident var_size)))
          (var offset (type_base i64) (binop - (number 0) (ident cg_stack_size)))
          (expr_stmt (call (ident add_local) (call (ident let_expr_name) (ident expr)) (call (ident let_expr_name_len) (ident expr)) (ident offset) (ident var_type)))
          (expr_stmt (call (ident gen_expr) (call (ident let_expr_init) (ident expr))))
          (expr_stmt (call (ident emit_str) (string "    mov %rax, ")))
          (expr_stmt (call (ident emit_int) (ident offset)))
          (expr_stmt (call (ident emit_line) (string "(%rbp)")))
          (expr_stmt (call (ident gen_expr) (call (ident let_expr_body) (ident expr))))
          (assign (ident cg_local_count) (ident saved_local_count))
          (return)))
      (if (binop == (ident k) (ident NODE_LAMBDA_EXPR))
        (block
          (var saved_parent_captures (type_ptr (type_base u8)) (ident cg_parent_captures))
          (var saved_parent_count (type_base i64) (ident cg_parent_capture_count))
          (if (binop == (ident cg_in_closure) (number 1))
            (block
              (assign (ident cg_parent_captures) (ident cg_closure_captures))
              (assign (ident cg_parent_capture_count) (ident cg_closure_capture_count))))
          (var param_count (type_base i64) (call (ident lambda_expr_param_count) (ident expr)))
          (var capture_count (type_base i64) (call (ident analyze_lambda_captures) (ident expr) (ident param_count)))
          (assign (ident cg_parent_captures) (ident saved_parent_captures))
          (assign (ident cg_parent_capture_count) (ident saved_parent_count))
          (if (binop == (ident cg_lambdas) (nil))
            (block
              (assign (ident cg_lambdas) (call (ident alloc) (binop * (ident LIMIT_LAMBDAS) (number 32))))))
          (var lambda_id (type_base i64) (ident cg_lambda_count))
          (var entry (type_ptr (type_base u8)) (binop + (ident cg_lambdas) (binop * (ident cg_lambda_count) (number 32))))
          (var p_node (type_ptr (type_ptr (type_base u8))) (ident entry))
          (assign (unop * (ident p_node)) (ident expr))
          (var p_id (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (assign (unop * (ident p_id)) (ident lambda_id))
          (var captures_copy (type_ptr (type_base u8)) (nil))
          (if (binop > (ident capture_count) (number 0))
            (block
              (assign (ident captures_copy) (call (ident alloc) (binop * (ident capture_count) (number 32))))
              (var i (type_base i64) (number 0))
              (while (binop < (ident i) (ident capture_count))
                (block
                  (var src (type_ptr (type_base u8)) (binop + (ident cg_current_captures) (binop * (ident i) (number 32))))
                  (var dst (type_ptr (type_base u8)) (binop + (ident captures_copy) (binop * (ident i) (number 32))))
                  (var j (type_base i64) (number 0))
                  (while (binop < (ident j) (number 32))
                    (block
                      (assign (unop * (binop + (ident dst) (ident j))) (unop * (binop + (ident src) (ident j))))
                      (assign (ident j) (binop + (ident j) (number 1)))))
                  (assign (ident i) (binop + (ident i) (number 1)))))))
          (var p_captures (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
          (assign (unop * (ident p_captures)) (ident captures_copy))
          (var p_cap_count (type_ptr (type_base i64)) (binop + (ident entry) (number 24)))
          (assign (unop * (ident p_cap_count)) (ident capture_count))
          (assign (ident cg_lambda_count) (binop + (ident cg_lambda_count) (number 1)))
          (if (binop == (ident capture_count) (number 0))
            (block
              (expr_stmt (call (ident emit_str) (string "    lea __lambda_")))
              (expr_stmt (call (ident emit_int) (ident lambda_id)))
              (expr_stmt (call (ident emit_line) (string "(%rip), %rax"))))
            (block
              (var closure_size (type_base i64) (binop + (number 16) (binop * (ident capture_count) (number 8))))
              (expr_stmt (call (ident emit_str) (string "    mov $")))
              (expr_stmt (call (ident emit_int) (ident closure_size)))
              (expr_stmt (call (ident emit_line) (string ", %rdi")))
              (expr_stmt (call (ident emit_line) (string "    call alloc")))
              (expr_stmt (call (ident emit_line) (string "    push %rax")))
              (expr_stmt (call (ident emit_line) (string "    movq $1, (%rax)")))
              (expr_stmt (call (ident emit_str) (string "    lea __lambda_")))
              (expr_stmt (call (ident emit_int) (ident lambda_id)))
              (expr_stmt (call (ident emit_line) (string "(%rip), %rbx")))
              (expr_stmt (call (ident emit_line) (string "    mov %rbx, 8(%rax)")))
              (var i (type_base i64) (number 0))
              (while (binop < (ident i) (ident capture_count))
                (block
                  (var outer_offset (type_base i64) (call (ident capture_get_outer_offset) (ident i)))
                  (var closure_offset (type_base i64) (binop + (number 16) (binop * (ident i) (number 8))))
                  (if (binop == (ident outer_offset) (binop - (number 0) (number 1)))
                    (block
                      (var cap_name (type_ptr (type_base u8)) (call (ident capture_get_name) (ident i)))
                      (var cap_name_len (type_base i64) (call (ident capture_get_name_len) (ident i)))
                      (var parent_cap_idx (type_base i64) (call (ident find_closure_capture) (ident cap_name) (ident cap_name_len)))
                      (if (binop >= (ident parent_cap_idx) (number 0))
                        (block
                          (var parent_offset (type_base i64) (binop + (number 16) (binop * (ident parent_cap_idx) (number 8))))
                          (expr_stmt (call (ident emit_str) (string "    mov ")))
                          (expr_stmt (call (ident emit_int) (ident cg_closure_ptr_offset)))
                          (expr_stmt (call (ident emit_line) (string "(%rbp), %rcx")))
                          (expr_stmt (call (ident emit_str) (string "    mov ")))
                          (expr_stmt (call (ident emit_int) (ident parent_offset)))
                          (expr_stmt (call (ident emit_line) (string "(%rcx), %rbx"))))))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    mov ")))
                      (expr_stmt (call (ident emit_int) (ident outer_offset)))
                      (expr_stmt (call (ident emit_line) (string "(%rbp), %rbx")))))
                  (expr_stmt (call (ident emit_line) (string "    pop %rax")))
                  (expr_stmt (call (ident emit_line) (string "    push %rax")))
                  (expr_stmt (call (ident emit_str) (string "    mov %rbx, ")))
                  (expr_stmt (call (ident emit_int) (ident closure_offset)))
                  (expr_stmt (call (ident emit_line) (string "(%rax)")))
                  (assign (ident i) (binop + (ident i) (number 1)))))
              (expr_stmt (call (ident emit_line) (string "    pop %rax")))))
          (return)))
      (if (binop == (ident k) (ident NODE_MATCH_EXPR))
        (block
          (var scrutinee (type_ptr (type_base u8)) (call (ident match_expr_scrutinee) (ident expr)))
          (var arms (type_ptr (type_base u8)) (call (ident match_expr_arms) (ident expr)))
          (var arm_count (type_base i64) (call (ident match_expr_arm_count) (ident expr)))
          (assign (ident cg_stack_size) (binop + (ident cg_stack_size) (number 8)))
          (var scrutinee_offset (type_base i64) (binop - (number 0) (ident cg_stack_size)))
          (expr_stmt (call (ident gen_expr) (ident scrutinee)))
          (expr_stmt (call (ident emit_str) (string "    mov %rax, ")))
          (expr_stmt (call (ident emit_int) (ident scrutinee_offset)))
          (expr_stmt (call (ident emit_line) (string "(%rbp)")))
          (expr_stmt (call (ident emit_line) (string "    mov (%rax), %rbx")))
          (var end_label (type_base i64) (call (ident new_label)))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident arm_count))
            (block
              (var arm (type_ptr (type_base u8)) (call (ident get_match_arm) (ident arms) (ident i)))
              (var pattern (type_ptr (type_base u8)) (call (ident match_arm_pattern) (ident arm)))
              (var body (type_ptr (type_base u8)) (call (ident match_arm_body) (ident arm)))
              (var pk (type_base i64) (call (ident node_kind) (ident pattern)))
              (if (binop == (ident pk) (ident NODE_PATTERN_WILDCARD))
                (block
                  (expr_stmt (call (ident gen_expr) (ident body)))
                  (expr_stmt (call (ident emit_str) (string "    jmp ")))
                  (expr_stmt (call (ident emit_label) (ident end_label)))
                  (expr_stmt (call (ident emit_char) (number 10))))
                (if (binop == (ident pk) (ident NODE_PATTERN_VARIANT))
                  (block
                    (var enum_name (type_ptr (type_base u8)) (call (ident pattern_variant_enum_name) (ident pattern)))
                    (var enum_len (type_base i64) (call (ident pattern_variant_enum_len) (ident pattern)))
                    (var var_name (type_ptr (type_base u8)) (call (ident pattern_variant_name) (ident pattern)))
                    (var var_len (type_base i64) (call (ident pattern_variant_name_len) (ident pattern)))
                    (var binding (type_ptr (type_base u8)) (call (ident pattern_variant_binding) (ident pattern)))
                    (var binding_len (type_base i64) (call (ident pattern_variant_binding_len) (ident pattern)))
                    (var enum_decl (type_ptr (type_base u8)) (call (ident find_enum) (ident enum_name) (ident enum_len)))
                    (if (binop == (ident enum_decl) (nil))
                      (block
                        (expr_stmt (call (ident eprint) (string "error: unknown enum '")))
                        (expr_stmt (call (ident eprint_buf) (ident enum_name) (ident enum_len)))
                        (expr_stmt (call (ident eprintln) (string "' in match pattern")))
                        (assign (ident cg_had_error) (number 1))
                        (return)))
                    (var variant (type_ptr (type_base u8)) (call (ident find_variant) (ident enum_decl) (ident var_name) (ident var_len)))
                    (if (binop == (ident variant) (nil))
                      (block
                        (expr_stmt (call (ident eprint) (string "error: unknown variant '")))
                        (expr_stmt (call (ident eprint_buf) (ident var_name) (ident var_len)))
                        (expr_stmt (call (ident eprintln) (string "' in match pattern")))
                        (assign (ident cg_had_error) (number 1))
                        (return)))
                    (var expected_tag (type_base i64) (call (ident enum_variant_tag) (ident variant)))
                    (var next_label (type_base i64) (call (ident new_label)))
                    (expr_stmt (call (ident emit_str) (string "    cmp $")))
                    (expr_stmt (call (ident emit_int) (ident expected_tag)))
                    (expr_stmt (call (ident emit_line) (string ", %rbx")))
                    (expr_stmt (call (ident emit_str) (string "    jne ")))
                    (expr_stmt (call (ident emit_label) (ident next_label)))
                    (expr_stmt (call (ident emit_char) (number 10)))
                    (if (binop != (ident binding) (nil))
                      (block
                        (var saved_local_count (type_base i64) (ident cg_local_count))
                        (var payload_type (type_ptr (type_base u8)) (call (ident enum_variant_type) (ident variant)))
                        (var payload_size (type_base i64) (number 8))
                        (if (binop != (ident payload_type) (nil))
                          (block
                            (assign (ident payload_size) (call (ident get_type_size) (ident payload_type)))))
                        (assign (ident cg_stack_size) (binop + (ident cg_stack_size) (ident payload_size)))
                        (var bind_offset (type_base i64) (binop - (number 0) (ident cg_stack_size)))
                        (expr_stmt (call (ident add_local) (ident binding) (ident binding_len) (ident bind_offset) (ident payload_type)))
                        (expr_stmt (call (ident emit_str) (string "    mov ")))
                        (expr_stmt (call (ident emit_int) (ident scrutinee_offset)))
                        (expr_stmt (call (ident emit_line) (string "(%rbp), %rsi")))
                        (var copy_idx (type_base i64) (number 0))
                        (while (binop < (ident copy_idx) (ident payload_size))
                          (block
                            (expr_stmt (call (ident emit_str) (string "    mov ")))
                            (expr_stmt (call (ident emit_int) (binop + (number 8) (ident copy_idx))))
                            (expr_stmt (call (ident emit_line) (string "(%rsi), %rcx")))
                            (expr_stmt (call (ident emit_str) (string "    mov %rcx, ")))
                            (expr_stmt (call (ident emit_int) (binop + (ident bind_offset) (ident copy_idx))))
                            (expr_stmt (call (ident emit_line) (string "(%rbp)")))
                            (assign (ident copy_idx) (binop + (ident copy_idx) (number 8)))))
                        (expr_stmt (call (ident gen_expr) (ident body)))
                        (assign (ident cg_local_count) (ident saved_local_count)))
                      (block
                        (expr_stmt (call (ident gen_expr) (ident body)))))
                    (expr_stmt (call (ident emit_str) (string "    jmp ")))
                    (expr_stmt (call (ident emit_label) (ident end_label)))
                    (expr_stmt (call (ident emit_char) (number 10)))
                    (expr_stmt (call (ident emit_label) (ident next_label)))
                    (expr_stmt (call (ident emit_line) (string ":"))))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident emit_label) (ident end_label)))
          (expr_stmt (call (ident emit_line) (string ":")))
          (return)))
      (if (binop == (ident k) (ident NODE_IF_STMT))
        (block
          (var if_else_label (type_base i64) (call (ident new_label)))
          (var if_end_label (type_base i64) (call (ident new_label)))
          (var if_then (type_ptr (type_base u8)) (call (ident if_stmt_then) (ident expr)))
          (var if_else (type_ptr (type_base u8)) (call (ident if_stmt_else) (ident expr)))
          (expr_stmt (call (ident gen_expr) (call (ident if_stmt_cond) (ident expr))))
          (expr_stmt (call (ident emit_line) (string "    test %rax, %rax")))
          (if (binop != (ident if_else) (nil))
            (block
              (expr_stmt (call (ident emit_str) (string "    jz ")))
              (expr_stmt (call (ident emit_label) (ident if_else_label)))
              (expr_stmt (call (ident emit_char) (number 10)))
              (if (binop == (call (ident node_kind) (ident if_then)) (ident NODE_BLOCK_STMT))
                (block
                  (expr_stmt (call (ident gen_stmt) (ident if_then))))
                (block
                  (expr_stmt (call (ident gen_expr) (ident if_then)))))
              (expr_stmt (call (ident emit_str) (string "    jmp ")))
              (expr_stmt (call (ident emit_label) (ident if_end_label)))
              (expr_stmt (call (ident emit_char) (number 10)))
              (expr_stmt (call (ident emit_label) (ident if_else_label)))
              (expr_stmt (call (ident emit_line) (string ":")))
              (if (binop == (call (ident node_kind) (ident if_else)) (ident NODE_BLOCK_STMT))
                (block
                  (expr_stmt (call (ident gen_stmt) (ident if_else))))
                (block
                  (expr_stmt (call (ident gen_expr) (ident if_else))))))
            (block
              (expr_stmt (call (ident emit_str) (string "    jz ")))
              (expr_stmt (call (ident emit_label) (ident if_end_label)))
              (expr_stmt (call (ident emit_char) (number 10)))
              (if (binop == (call (ident node_kind) (ident if_then)) (ident NODE_BLOCK_STMT))
                (block
                  (expr_stmt (call (ident gen_stmt) (ident if_then))))
                (block
                  (expr_stmt (call (ident gen_expr) (ident if_then)))))))
          (expr_stmt (call (ident emit_label) (ident if_end_label)))
          (expr_stmt (call (ident emit_line) (string ":")))
          (return)))
      (if (binop == (ident k) (ident NODE_BLOCK_EXPR))
        (block
          (var stmts (type_ptr (type_base u8)) (call (ident block_expr_stmts) (ident expr)))
          (var count (type_base i64) (call (ident block_expr_count) (ident expr)))
          (var tail (type_ptr (type_base u8)) (call (ident block_expr_tail) (ident expr)))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident count))
            (block
              (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident stmts) (binop * (ident i) (number 8))))
              (expr_stmt (call (ident gen_stmt) (unop * (ident p))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (if (binop != (ident tail) (nil))
            (block
              (expr_stmt (call (ident gen_expr) (ident tail)))))
          (return)))
      (if (binop == (ident k) (ident NODE_HANDLE_EXPR))
        (block
          (var body (type_ptr (type_base u8)) (call (ident handle_expr_body) (ident expr)))
          (var cases (type_ptr (type_base u8)) (call (ident handle_expr_cases) (ident expr)))
          (var case_count (type_base i64) (call (ident handle_expr_case_count) (ident expr)))
          (var ret_bind (type_ptr (type_base u8)) (call (ident handle_expr_ret_bind) (ident expr)))
          (var ret_bind_len (type_base i64) (call (ident handle_expr_ret_bind_len) (ident expr)))
          (var ret_body (type_ptr (type_base u8)) (call (ident handle_expr_ret_body) (ident expr)))
          (var handler_label (type_base i64) (call (ident new_label)))
          (var done_label (type_base i64) (call (ident new_label)))
          (expr_stmt (call (ident emit_line) (string "    movq %rbp, __handler_rbp(%rip)")))
          (expr_stmt (call (ident emit_line) (string "    movq %rsp, __handler_rsp(%rip)")))
          (expr_stmt (call (ident emit_str) (string "    leaq ")))
          (expr_stmt (call (ident emit_label) (ident handler_label)))
          (expr_stmt (call (ident emit_line) (string "(%rip), %rax")))
          (expr_stmt (call (ident emit_line) (string "    movq %rax, __handler_addr(%rip)")))
          (expr_stmt (call (ident emit_line) (string "    movq $1, __handler_set(%rip)")))
          (if (binop == (call (ident node_kind) (ident body)) (ident NODE_BLOCK_STMT))
            (block
              (expr_stmt (call (ident gen_stmt) (ident body))))
            (block
              (expr_stmt (call (ident gen_expr) (ident body)))))
          (expr_stmt (call (ident emit_str) (string "    jmp ")))
          (expr_stmt (call (ident emit_label) (ident done_label)))
          (expr_stmt (call (ident emit_char) (number 10)))
          (expr_stmt (call (ident emit_label) (ident handler_label)))
          (expr_stmt (call (ident emit_line) (string ":")))
          (var case_i (type_base i64) (number 0))
          (while (binop < (ident case_i) (ident case_count))
            (block
              (var entry (type_ptr (type_base u8)) (binop + (ident cases) (binop * (ident case_i) (number 56))))
              (var eff_name (type_ptr (type_base u8)) (call (ident effect_case_name) (ident entry)))
              (var eff_name_len (type_base i64) (call (ident effect_case_name_len) (ident entry)))
              (var bind_ptr (type_ptr (type_base u8)) (call (ident effect_case_binding) (ident entry)))
              (var bind_len (type_base i64) (call (ident effect_case_binding_len) (ident entry)))
              (var k_ptr (type_ptr (type_base u8)) (call (ident effect_case_k) (ident entry)))
              (var k_len (type_base i64) (call (ident effect_case_k_len) (ident entry)))
              (var case_body (type_ptr (type_base u8)) (call (ident effect_case_body) (ident entry)))
              (var eff_decl (type_ptr (type_base u8)) (call (ident find_effect) (ident eff_name) (ident eff_name_len)))
              (var eff_param_count (type_base i64) (number 0))
              (if (binop != (ident eff_decl) (nil))
                (block
                  (assign (ident eff_param_count) (call (ident effect_decl_param_type_count) (ident eff_decl)))))
              (if (binop && (binop && (binop == (ident eff_param_count) (number 0)) (binop == (ident k_len) (number 0))) (binop > (ident bind_len) (number 0)))
                (block
                  (assign (ident k_ptr) (ident bind_ptr))
                  (assign (ident k_len) (ident bind_len))
                  (assign (ident bind_ptr) (nil))
                  (assign (ident bind_len) (number 0))))
              (var case_label (type_base i64) (call (ident new_label)))
              (var next_case_label (type_base i64) (call (ident new_label)))
              (expr_stmt (call (ident emit_line) (string "    movq __effect_name_len(%rip), %rax")))
              (expr_stmt (call (ident emit_str) (string "    cmpq $")))
              (expr_stmt (call (ident emit_int) (ident eff_name_len)))
              (expr_stmt (call (ident emit_line) (string ", %rax")))
              (expr_stmt (call (ident emit_str) (string "    jne ")))
              (expr_stmt (call (ident emit_label) (ident next_case_label)))
              (expr_stmt (call (ident emit_char) (number 10)))
              (var eff_str_idx (type_base i64) (call (ident add_string) (ident eff_name) (ident eff_name_len)))
              (expr_stmt (call (ident emit_line) (string "    movq __effect_name_ptr(%rip), %rsi")))
              (expr_stmt (call (ident emit_str) (string "    leaq .str")))
              (expr_stmt (call (ident emit_int) (ident eff_str_idx)))
              (expr_stmt (call (ident emit_line) (string "(%rip), %rdi")))
              (expr_stmt (call (ident emit_str) (string "    movq $")))
              (expr_stmt (call (ident emit_int) (ident eff_name_len)))
              (expr_stmt (call (ident emit_line) (string ", %rcx")))
              (expr_stmt (call (ident emit_line) (string "    repe cmpsb")))
              (expr_stmt (call (ident emit_str) (string "    je ")))
              (expr_stmt (call (ident emit_label) (ident case_label)))
              (expr_stmt (call (ident emit_char) (number 10)))
              (expr_stmt (call (ident emit_label) (ident case_label)))
              (expr_stmt (call (ident emit_line) (string ":")))
              (var saved_local_count (type_base i64) (ident cg_local_count))
              (var bind_offset (type_base i64) (number 0))
              (if (binop > (ident bind_len) (number 0))
                (block
                  (assign (ident cg_stack_size) (binop + (ident cg_stack_size) (number 8)))
                  (assign (ident bind_offset) (binop - (number 0) (ident cg_stack_size)))
                  (expr_stmt (call (ident add_local) (ident bind_ptr) (ident bind_len) (ident bind_offset) (nil)))
                  (expr_stmt (call (ident emit_line) (string "    movq __effect_value(%rip), %rax")))
                  (expr_stmt (call (ident emit_str) (string "    movq %rax, ")))
                  (expr_stmt (call (ident emit_int) (ident bind_offset)))
                  (expr_stmt (call (ident emit_line) (string "(%rbp)")))))
              (if (binop > (ident k_len) (number 0))
                (block
                  (assign (ident cg_stack_size) (binop + (ident cg_stack_size) (number 8)))
                  (var k_offset (type_base i64) (binop - (number 0) (ident cg_stack_size)))
                  (expr_stmt (call (ident add_local) (ident k_ptr) (ident k_len) (ident k_offset) (nil)))
                  (expr_stmt (call (ident emit_line) (string "    movq __continuation_ptr(%rip), %rax")))
                  (expr_stmt (call (ident emit_str) (string "    movq %rax, ")))
                  (expr_stmt (call (ident emit_int) (ident k_offset)))
                  (expr_stmt (call (ident emit_line) (string "(%rbp)")))))
              (if (binop == (call (ident node_kind) (ident case_body)) (ident NODE_BLOCK_STMT))
                (block
                  (expr_stmt (call (ident gen_stmt) (ident case_body))))
                (block
                  (expr_stmt (call (ident gen_expr) (ident case_body)))))
              (assign (ident cg_local_count) (ident saved_local_count))
              (expr_stmt (call (ident emit_str) (string "    jmp ")))
              (expr_stmt (call (ident emit_label) (ident done_label)))
              (expr_stmt (call (ident emit_char) (number 10)))
              (expr_stmt (call (ident emit_label) (ident next_case_label)))
              (expr_stmt (call (ident emit_line) (string ":")))
              (assign (ident case_i) (binop + (ident case_i) (number 1)))))
          (expr_stmt (call (ident emit_label) (ident done_label)))
          (expr_stmt (call (ident emit_line) (string ":")))
          (expr_stmt (call (ident emit_line) (string "    movq $0, __handler_set(%rip)")))
          (return)))
      (if (binop == (ident k) (ident NODE_PERFORM_EXPR))
        (block
          (var args (type_ptr (type_base u8)) (call (ident perform_expr_args) (ident expr)))
          (var arg_count (type_base i64) (call (ident perform_expr_arg_count) (ident expr)))
          (var resume_label (type_base i64) (call (ident new_label)))
          (expr_stmt (call (ident emit_line) (string "    mov $24, %rdi")))
          (expr_stmt (call (ident emit_line) (string "    call alloc")))
          (expr_stmt (call (ident emit_line) (string "    push %rax")))
          (expr_stmt (call (ident emit_line) (string "    movq %rbp, (%rax)")))
          (expr_stmt (call (ident emit_line) (string "    leaq 8(%rsp), %rbx")))
          (expr_stmt (call (ident emit_line) (string "    movq %rbx, 8(%rax)")))
          (expr_stmt (call (ident emit_str) (string "    leaq ")))
          (expr_stmt (call (ident emit_label) (ident resume_label)))
          (expr_stmt (call (ident emit_line) (string "(%rip), %rbx")))
          (expr_stmt (call (ident emit_line) (string "    movq %rbx, 16(%rax)")))
          (expr_stmt (call (ident emit_line) (string "    movq %rax, __continuation_ptr(%rip)")))
          (var eff_name (type_ptr (type_base u8)) (call (ident perform_expr_name) (ident expr)))
          (var eff_name_len (type_base i64) (call (ident perform_expr_name_len) (ident expr)))
          (var eff_str_idx (type_base i64) (call (ident add_string) (ident eff_name) (ident eff_name_len)))
          (expr_stmt (call (ident emit_str) (string "    leaq .str")))
          (expr_stmt (call (ident emit_int) (ident eff_str_idx)))
          (expr_stmt (call (ident emit_line) (string "(%rip), %rax")))
          (expr_stmt (call (ident emit_line) (string "    movq %rax, __effect_name_ptr(%rip)")))
          (expr_stmt (call (ident emit_str) (string "    movq $")))
          (expr_stmt (call (ident emit_int) (ident eff_name_len)))
          (expr_stmt (call (ident emit_line) (string ", %rax")))
          (expr_stmt (call (ident emit_line) (string "    movq %rax, __effect_name_len(%rip)")))
          (if (binop > (ident arg_count) (number 0))
            (block
              (var first_arg_ptr (type_ptr (type_ptr (type_base u8))) (ident args))
              (expr_stmt (call (ident gen_expr) (unop * (ident first_arg_ptr))))
              (expr_stmt (call (ident emit_line) (string "    movq %rax, __effect_value(%rip)")))))
          (expr_stmt (call (ident emit_line) (string "    addq $8, %rsp")))
          (expr_stmt (call (ident emit_line) (string "    movq __handler_rbp(%rip), %rbp")))
          (expr_stmt (call (ident emit_line) (string "    jmpq *__handler_addr(%rip)")))
          (expr_stmt (call (ident emit_label) (ident resume_label)))
          (expr_stmt (call (ident emit_line) (string ":")))
          (return)))
      (if (binop == (ident k) (ident NODE_RESUME_EXPR))
        (block
          (var k_expr (type_ptr (type_base u8)) (call (ident resume_expr_k) (ident expr)))
          (var value (type_ptr (type_base u8)) (call (ident resume_expr_value) (ident expr)))
          (expr_stmt (call (ident gen_expr) (ident k_expr)))
          (expr_stmt (call (ident emit_line) (string "    mov %rax, %rbx")))
          (expr_stmt (call (ident emit_line) (string "    movq (%rbx), %r12")))
          (expr_stmt (call (ident emit_line) (string "    movq 8(%rbx), %r13")))
          (expr_stmt (call (ident emit_line) (string "    movq 16(%rbx), %r14")))
          (if (binop != (ident value) (nil))
            (block
              (expr_stmt (call (ident gen_expr) (ident value))))
            (block
              (expr_stmt (call (ident emit_line) (string "    xor %eax, %eax")))))
          (expr_stmt (call (ident emit_line) (string "    mov %r12, %rbp")))
          (expr_stmt (call (ident emit_line) (string "    mov %r13, %rsp")))
          (expr_stmt (call (ident emit_line) (string "    jmpq *%r14")))
          (return)))))
  (func gen_syscall ((param args (type_ptr (type_base u8))) (param arg_count (type_base i64))) (type_base void)
    (block
      (if (binop == (ident arg_count) (number 0))
        (block
          (return)))
      (var i (type_base i64) (binop - (ident arg_count) (number 1)))
      (while (binop >= (ident i) (number 0))
        (block
          (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident args) (binop * (ident i) (number 8))))
          (expr_stmt (call (ident gen_expr) (unop * (ident p))))
          (expr_stmt (call (ident emit_line) (string "    push %rax")))
          (assign (ident i) (binop - (ident i) (number 1)))))
      (expr_stmt (call (ident emit_line) (string "    pop %rax")))
      (assign (ident i) (number 1))
      (while (binop && (binop < (ident i) (ident arg_count)) (binop <= (ident i) (number 6)))
        (block
          (if (binop == (ident i) (number 1))
            (block
              (expr_stmt (call (ident emit_line) (string "    pop %rdi"))))
            (if (binop == (ident i) (number 2))
              (block
                (expr_stmt (call (ident emit_line) (string "    pop %rsi"))))
              (if (binop == (ident i) (number 3))
                (block
                  (expr_stmt (call (ident emit_line) (string "    pop %rdx"))))
                (if (binop == (ident i) (number 4))
                  (block
                    (expr_stmt (call (ident emit_line) (string "    pop %r10"))))
                  (if (binop == (ident i) (number 5))
                    (block
                      (expr_stmt (call (ident emit_line) (string "    pop %r8"))))
                    (if (binop == (ident i) (number 6))
                      (block
                        (expr_stmt (call (ident emit_line) (string "    pop %r9"))))))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (expr_stmt (call (ident emit_line) (string "    syscall")))))
  (func gen_lvalue_store ((param expr (type_ptr (type_base u8)))) (type_base void)
    (block
      (var k (type_base i64) (call (ident node_kind) (ident expr)))
      (if (binop == (ident k) (ident NODE_IDENT_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident expr)))
          (var local_idx (type_base i64) (call (ident find_local) (ident name) (ident name_len)))
          (if (binop >= (ident local_idx) (number 0))
            (block
              (var offset (type_base i64) (call (ident local_get_offset) (ident local_idx)))
              (var var_type (type_ptr (type_base u8)) (call (ident local_get_type) (ident local_idx)))
              (if (binop && (binop != (ident var_type) (nil)) (binop == (call (ident type_kind) (ident var_type)) (ident TYPE_BASE)))
                (block
                  (var type_name (type_ptr (type_base u8)) (call (ident base_type_name) (ident var_type)))
                  (var type_name_len (type_base i64) (call (ident base_type_name_len) (ident var_type)))
                  (var enum_decl (type_ptr (type_base u8)) (call (ident find_enum) (ident type_name) (ident type_name_len)))
                  (if (binop != (ident enum_decl) (nil))
                    (block
                      (var enum_size (type_base i64) (call (ident get_enum_size) (ident enum_decl)))
                      (expr_stmt (call (ident emit_line) (string "    mov %rax, %rsi")))
                      (var copy_i (type_base i64) (number 0))
                      (while (binop < (ident copy_i) (ident enum_size))
                        (block
                          (expr_stmt (call (ident emit_str) (string "    mov ")))
                          (expr_stmt (call (ident emit_int) (ident copy_i)))
                          (expr_stmt (call (ident emit_line) (string "(%rsi), %rcx")))
                          (expr_stmt (call (ident emit_str) (string "    mov %rcx, ")))
                          (expr_stmt (call (ident emit_int) (binop + (ident offset) (ident copy_i))))
                          (expr_stmt (call (ident emit_line) (string "(%rbp)")))
                          (assign (ident copy_i) (binop + (ident copy_i) (number 8)))))
                      (return)))))
              (expr_stmt (call (ident emit_str) (string "    mov %rax, ")))
              (expr_stmt (call (ident emit_int) (ident offset)))
              (expr_stmt (call (ident emit_line) (string "(%rbp)")))
              (return)))
          (var global_idx (type_base i64) (call (ident find_global) (ident name) (ident name_len)))
          (if (binop >= (ident global_idx) (number 0))
            (block
              (expr_stmt (call (ident emit_str) (string "    mov %rax, ")))
              (expr_stmt (call (ident emit_n) (ident name) (ident name_len)))
              (expr_stmt (call (ident emit_line) (string "(%rip)")))
              (return)))
          (return)))
      (if (binop == (ident k) (ident NODE_UNARY_EXPR))
        (block
          (var op (type_base i64) (call (ident unary_expr_op) (ident expr)))
          (if (binop == (ident op) (ident TOKEN_STAR))
            (block
              (expr_stmt (call (ident emit_line) (string "    push %rax")))
              (expr_stmt (call (ident gen_expr) (call (ident unary_expr_expr) (ident expr))))
              (expr_stmt (call (ident emit_line) (string "    mov %rax, %rcx")))
              (expr_stmt (call (ident emit_line) (string "    pop %rax")))
              (expr_stmt (call (ident emit_line) (string "    mov %rax, (%rcx)")))
              (return)))))
      (if (binop == (ident k) (ident NODE_FIELD_EXPR))
        (block
          (var base_expr (type_ptr (type_base u8)) (call (ident field_expr_expr) (ident expr)))
          (var field_name (type_ptr (type_base u8)) (call (ident field_expr_field) (ident expr)))
          (var field_len (type_base i64) (call (ident field_expr_field_len) (ident expr)))
          (var base_type (type_ptr (type_base u8)) (call (ident get_expr_type) (ident base_expr)))
          (if (binop == (ident base_type) (nil))
            (block
              (return)))
          (var struct_name (type_ptr (type_base u8)) (nil))
          (var struct_name_len (type_base i64) (number 0))
          (var is_pointer (type_base i64) (number 0))
          (if (binop == (call (ident type_kind) (ident base_type)) (ident TYPE_BASE))
            (block
              (assign (ident struct_name) (call (ident base_type_name) (ident base_type)))
              (assign (ident struct_name_len) (call (ident base_type_name_len) (ident base_type))))
            (if (binop == (call (ident type_kind) (ident base_type)) (ident TYPE_PTR))
              (block
                (var pointed_type (type_ptr (type_base u8)) (call (ident ptr_type_elem) (ident base_type)))
                (if (binop && (binop != (ident pointed_type) (nil)) (binop == (call (ident type_kind) (ident pointed_type)) (ident TYPE_BASE)))
                  (block
                    (assign (ident struct_name) (call (ident base_type_name) (ident pointed_type)))
                    (assign (ident struct_name_len) (call (ident base_type_name_len) (ident pointed_type)))
                    (assign (ident is_pointer) (number 1)))))))
          (if (binop == (ident struct_name) (nil))
            (block
              (return)))
          (assign (ident cg_temp_struct_decl) (call (ident find_struct) (ident struct_name) (ident struct_name_len)))
          (if (binop == (ident cg_temp_struct_decl) (nil))
            (block
              (return)))
          (var field_offset (type_base i64) (call (ident get_field_offset) (ident cg_temp_struct_decl) (ident field_name) (ident field_len)))
          (if (binop < (ident field_offset) (number 0))
            (block
              (return)))
          (var field_type (type_ptr (type_base u8)) (call (ident get_field_type) (ident cg_temp_struct_decl) (ident field_name) (ident field_len)))
          (var is_enum_field (type_base i64) (number 0))
          (if (binop && (binop != (ident field_type) (nil)) (binop == (call (ident type_kind) (ident field_type)) (ident TYPE_BASE)))
            (block
              (var ft_name (type_ptr (type_base u8)) (call (ident base_type_name) (ident field_type)))
              (var ft_name_len (type_base i64) (call (ident base_type_name_len) (ident field_type)))
              (if (binop != (call (ident find_enum) (ident ft_name) (ident ft_name_len)) (nil))
                (block
                  (assign (ident is_enum_field) (number 1))))))
          (if (binop != (ident is_pointer) (number 0))
            (block
              (expr_stmt (call (ident emit_line) (string "    push %rax")))
              (expr_stmt (call (ident gen_expr) (ident base_expr)))
              (expr_stmt (call (ident emit_line) (string "    mov %rax, %rcx")))
              (expr_stmt (call (ident emit_line) (string "    pop %rax")))
              (if (binop != (ident is_enum_field) (number 0))
                (block
                  (expr_stmt (call (ident emit_line) (string "    mov (%rax), %rbx")))
                  (if (binop == (ident field_offset) (number 0))
                    (block
                      (expr_stmt (call (ident emit_line) (string "    mov %rbx, (%rcx)"))))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    mov %rbx, ")))
                      (expr_stmt (call (ident emit_int) (ident field_offset)))
                      (expr_stmt (call (ident emit_line) (string "(%rcx)")))))
                  (expr_stmt (call (ident emit_line) (string "    mov 8(%rax), %rbx")))
                  (expr_stmt (call (ident emit_str) (string "    mov %rbx, ")))
                  (expr_stmt (call (ident emit_int) (binop + (ident field_offset) (number 8))))
                  (expr_stmt (call (ident emit_line) (string "(%rcx)"))))
                (block
                  (if (binop == (ident field_offset) (number 0))
                    (block
                      (expr_stmt (call (ident emit_line) (string "    mov %rax, (%rcx)"))))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    mov %rax, ")))
                      (expr_stmt (call (ident emit_int) (ident field_offset)))
                      (expr_stmt (call (ident emit_line) (string "(%rcx)")))))))
              (return)))
          (if (binop == (call (ident node_kind) (ident base_expr)) (ident NODE_IDENT_EXPR))
            (block
              (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident base_expr)))
              (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident base_expr)))
              (var local_idx (type_base i64) (call (ident find_local) (ident name) (ident name_len)))
              (if (binop >= (ident local_idx) (number 0))
                (block
                  (var base_offset (type_base i64) (call (ident local_get_offset) (ident local_idx)))
                  (if (binop != (ident is_enum_field) (number 0))
                    (block
                      (expr_stmt (call (ident emit_line) (string "    mov (%rax), %rcx")))
                      (expr_stmt (call (ident emit_str) (string "    mov %rcx, ")))
                      (expr_stmt (call (ident emit_int) (binop + (ident base_offset) (ident field_offset))))
                      (expr_stmt (call (ident emit_line) (string "(%rbp)")))
                      (expr_stmt (call (ident emit_line) (string "    mov 8(%rax), %rcx")))
                      (expr_stmt (call (ident emit_str) (string "    mov %rcx, ")))
                      (expr_stmt (call (ident emit_int) (binop + (binop + (ident base_offset) (ident field_offset)) (number 8))))
                      (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    mov %rax, ")))
                      (expr_stmt (call (ident emit_int) (binop + (ident base_offset) (ident field_offset))))
                      (expr_stmt (call (ident emit_line) (string "(%rbp)")))))
                  (return)))))
          (var total_offset (type_base i64) (call (ident compute_nested_field_offset) (ident expr)))
          (if (binop >= (ident total_offset) (number 0))
            (block
              (var base_offset (type_base i64) (call (ident local_get_offset) (ident cg_nested_field_base_local)))
              (if (binop != (ident is_enum_field) (number 0))
                (block
                  (expr_stmt (call (ident emit_line) (string "    mov (%rax), %rcx")))
                  (expr_stmt (call (ident emit_str) (string "    mov %rcx, ")))
                  (expr_stmt (call (ident emit_int) (binop + (ident base_offset) (ident total_offset))))
                  (expr_stmt (call (ident emit_line) (string "(%rbp)")))
                  (expr_stmt (call (ident emit_line) (string "    mov 8(%rax), %rcx")))
                  (expr_stmt (call (ident emit_str) (string "    mov %rcx, ")))
                  (expr_stmt (call (ident emit_int) (binop + (binop + (ident base_offset) (ident total_offset)) (number 8))))
                  (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
                (block
                  (expr_stmt (call (ident emit_str) (string "    mov %rax, ")))
                  (expr_stmt (call (ident emit_int) (binop + (ident base_offset) (ident total_offset))))
                  (expr_stmt (call (ident emit_line) (string "(%rbp)")))))
              (return)))
          (return)))))
  (func gen_stmt ((param stmt (type_ptr (type_base u8)))) (type_base void)
    (block
      (if (binop == (ident stmt) (nil))
        (block
          (return)))
      (var k (type_base i64) (call (ident node_kind) (ident stmt)))
      (if (binop == (ident k) (ident NODE_VAR_DECL))
        (block
          (var var_type (type_ptr (type_base u8)) (call (ident var_decl_type) (ident stmt)))
          (var var_size (type_base i64) (call (ident get_type_size) (ident var_type)))
          (if (binop < (ident var_size) (number 8))
            (block
              (assign (ident var_size) (number 8))))
          (assign (ident cg_stack_size) (binop + (ident cg_stack_size) (ident var_size)))
          (var offset (type_base i64) (binop - (number 0) (ident cg_stack_size)))
          (expr_stmt (call (ident add_local) (call (ident var_decl_name) (ident stmt)) (call (ident var_decl_name_len) (ident stmt)) (ident offset) (call (ident var_decl_type) (ident stmt))))
          (var init (type_ptr (type_base u8)) (call (ident var_decl_init) (ident stmt)))
          (if (binop != (ident init) (nil))
            (block
              (if (binop && (binop != (ident var_type) (nil)) (binop == (call (ident type_kind) (ident var_type)) (ident TYPE_FUNC)))
                (block
                  (if (binop == (call (ident node_kind) (ident init)) (ident NODE_LAMBDA_EXPR))
                    (block
                      (if (binop == (call (ident lambda_has_captures) (ident init)) (number 1))
                        (block
                          (expr_stmt (call (ident eprint) (string "error: cannot assign capturing lambda to 'fn' type variable '")))
                          (expr_stmt (call (ident eprint_buf) (call (ident var_decl_name) (ident stmt)) (call (ident var_decl_name_len) (ident stmt))))
                          (expr_stmt (call (ident eprintln) (string "'")))
                          (expr_stmt (call (ident eprintln) (string "  hint: use 'closure(T) R' type for capturing lambdas")))
                          (expr_stmt (call (ident eprintln) (string "  hint: fn(T) R only accepts non-capturing lambdas and &func")))
                          (assign (ident cg_had_error) (number 1))
                          (return)))))))
              (expr_stmt (call (ident gen_expr) (ident init)))
              (if (binop && (binop != (ident var_type) (nil)) (binop == (call (ident type_kind) (ident var_type)) (ident TYPE_CLOSURE)))
                (block
                  (if (binop == (call (ident node_kind) (ident init)) (ident NODE_LAMBDA_EXPR))
                    (block
                      (if (binop == (call (ident lambda_has_captures) (ident init)) (number 0))
                        (block
                          (expr_stmt (call (ident emit_line) (string "    push %rax")))
                          (expr_stmt (call (ident emit_line) (string "    mov $16, %rdi")))
                          (expr_stmt (call (ident emit_line) (string "    call alloc")))
                          (expr_stmt (call (ident emit_line) (string "    movq $0, (%rax)")))
                          (expr_stmt (call (ident emit_line) (string "    pop %rbx")))
                          (expr_stmt (call (ident emit_line) (string "    mov %rbx, 8(%rax)")))))))))
              (if (binop == (call (ident type_kind) (ident var_type)) (ident TYPE_BASE))
                (block
                  (var type_name (type_ptr (type_base u8)) (call (ident base_type_name) (ident var_type)))
                  (var type_name_len (type_base i64) (call (ident base_type_name_len) (ident var_type)))
                  (var enum_decl (type_ptr (type_base u8)) (call (ident find_enum) (ident type_name) (ident type_name_len)))
                  (if (binop != (ident enum_decl) (nil))
                    (block
                      (var enum_size (type_base i64) (call (ident get_enum_size) (ident enum_decl)))
                      (expr_stmt (call (ident emit_line) (string "    mov %rax, %rsi")))
                      (var copy_j (type_base i64) (number 0))
                      (while (binop < (ident copy_j) (ident enum_size))
                        (block
                          (expr_stmt (call (ident emit_str) (string "    mov ")))
                          (expr_stmt (call (ident emit_int) (ident copy_j)))
                          (expr_stmt (call (ident emit_line) (string "(%rsi), %rcx")))
                          (expr_stmt (call (ident emit_str) (string "    mov %rcx, ")))
                          (expr_stmt (call (ident emit_int) (binop + (ident offset) (ident copy_j))))
                          (expr_stmt (call (ident emit_line) (string "(%rbp)")))
                          (assign (ident copy_j) (binop + (ident copy_j) (number 8)))))
                      (return)))))
              (expr_stmt (call (ident emit_str) (string "    mov %rax, ")))
              (expr_stmt (call (ident emit_int) (ident offset)))
              (expr_stmt (call (ident emit_line) (string "(%rbp)")))))
          (return)))
      (if (binop == (ident k) (ident NODE_EXPR_STMT))
        (block
          (expr_stmt (call (ident gen_expr) (call (ident expr_stmt_expr) (ident stmt))))
          (return)))
      (if (binop == (ident k) (ident NODE_ASSIGN_STMT))
        (block
          (expr_stmt (call (ident gen_expr) (call (ident assign_stmt_value) (ident stmt))))
          (expr_stmt (call (ident gen_lvalue_store) (call (ident assign_stmt_target) (ident stmt))))
          (return)))
      (if (binop == (ident k) (ident NODE_RETURN_STMT))
        (block
          (var value (type_ptr (type_base u8)) (call (ident return_stmt_value) (ident stmt)))
          (if (binop != (ident value) (nil))
            (block
              (expr_stmt (call (ident gen_expr) (ident value))))
            (block
              (expr_stmt (call (ident emit_line) (string "    xor %rax, %rax")))))
          (expr_stmt (call (ident emit_line) (string "    leave")))
          (expr_stmt (call (ident emit_line) (string "    ret")))
          (return)))
      (if (binop == (ident k) (ident NODE_IF_STMT))
        (block
          (var else_label (type_base i64) (call (ident new_label)))
          (var end_label (type_base i64) (call (ident new_label)))
          (expr_stmt (call (ident gen_expr) (call (ident if_stmt_cond) (ident stmt))))
          (expr_stmt (call (ident emit_line) (string "    test %rax, %rax")))
          (if (binop != (call (ident if_stmt_else) (ident stmt)) (nil))
            (block
              (expr_stmt (call (ident emit_str) (string "    jz ")))
              (expr_stmt (call (ident emit_label) (ident else_label)))
              (expr_stmt (call (ident emit_char) (number 10))))
            (block
              (expr_stmt (call (ident emit_str) (string "    jz ")))
              (expr_stmt (call (ident emit_label) (ident end_label)))
              (expr_stmt (call (ident emit_char) (number 10)))))
          (expr_stmt (call (ident gen_block) (call (ident if_stmt_then) (ident stmt))))
          (if (binop != (call (ident if_stmt_else) (ident stmt)) (nil))
            (block
              (expr_stmt (call (ident emit_str) (string "    jmp ")))
              (expr_stmt (call (ident emit_label) (ident end_label)))
              (expr_stmt (call (ident emit_char) (number 10)))
              (expr_stmt (call (ident emit_label) (ident else_label)))
              (expr_stmt (call (ident emit_line) (string ":")))
              (var els (type_ptr (type_base u8)) (call (ident if_stmt_else) (ident stmt)))
              (if (binop == (call (ident node_kind) (ident els)) (ident NODE_BLOCK_STMT))
                (block
                  (expr_stmt (call (ident gen_block) (ident els))))
                (block
                  (expr_stmt (call (ident gen_stmt) (ident els)))))))
          (expr_stmt (call (ident emit_label) (ident end_label)))
          (expr_stmt (call (ident emit_line) (string ":")))
          (return)))
      (if (binop == (ident k) (ident NODE_WHILE_STMT))
        (block
          (var start_label (type_base i64) (call (ident new_label)))
          (var end_label (type_base i64) (call (ident new_label)))
          (var loop_name (type_ptr (type_base u8)) (call (ident while_stmt_label) (ident stmt)))
          (var loop_name_len (type_base i64) (call (ident while_stmt_label_len) (ident stmt)))
          (expr_stmt (call (ident loop_stack_push) (ident loop_name) (ident loop_name_len) (ident end_label) (ident start_label)))
          (expr_stmt (call (ident emit_label) (ident start_label)))
          (expr_stmt (call (ident emit_line) (string ":")))
          (expr_stmt (call (ident gen_expr) (call (ident while_stmt_cond) (ident stmt))))
          (expr_stmt (call (ident emit_line) (string "    test %rax, %rax")))
          (expr_stmt (call (ident emit_str) (string "    jz ")))
          (expr_stmt (call (ident emit_label) (ident end_label)))
          (expr_stmt (call (ident emit_char) (number 10)))
          (expr_stmt (call (ident gen_block) (call (ident while_stmt_body) (ident stmt))))
          (expr_stmt (call (ident emit_str) (string "    jmp ")))
          (expr_stmt (call (ident emit_label) (ident start_label)))
          (expr_stmt (call (ident emit_char) (number 10)))
          (expr_stmt (call (ident emit_label) (ident end_label)))
          (expr_stmt (call (ident emit_line) (string ":")))
          (expr_stmt (call (ident loop_stack_pop)))
          (return)))
      (if (binop == (ident k) (ident NODE_BLOCK_STMT))
        (block
          (expr_stmt (call (ident gen_block) (ident stmt)))
          (return)))
      (if (binop == (ident k) (ident NODE_BREAK_STMT))
        (block
          (var label (type_ptr (type_base u8)) (call (ident break_stmt_label) (ident stmt)))
          (var label_len (type_base i64) (call (ident break_stmt_label_len) (ident stmt)))
          (var entry (type_ptr (type_base u8)) (call (ident loop_stack_find) (ident label) (ident label_len)))
          (if (binop == (ident entry) (nil))
            (block
              (expr_stmt (call (ident print) (string "error: break outside of loop")))
              (if (binop != (ident label) (nil))
                (block
                  (expr_stmt (call (ident print) (string " (label not found)")))))
              (expr_stmt (call (ident print) (string "\n")))
              (expr_stmt (call (ident exit) (number 1)))))
          (expr_stmt (call (ident emit_str) (string "    jmp ")))
          (expr_stmt (call (ident emit_label) (call (ident loop_entry_break_label) (ident entry))))
          (expr_stmt (call (ident emit_char) (number 10)))
          (return)))
      (if (binop == (ident k) (ident NODE_CONTINUE_STMT))
        (block
          (var label (type_ptr (type_base u8)) (call (ident continue_stmt_label) (ident stmt)))
          (var label_len (type_base i64) (call (ident continue_stmt_label_len) (ident stmt)))
          (var entry (type_ptr (type_base u8)) (call (ident loop_stack_find) (ident label) (ident label_len)))
          (if (binop == (ident entry) (nil))
            (block
              (expr_stmt (call (ident print) (string "error: continue outside of loop")))
              (if (binop != (ident label) (nil))
                (block
                  (expr_stmt (call (ident print) (string " (label not found)")))))
              (expr_stmt (call (ident print) (string "\n")))
              (expr_stmt (call (ident exit) (number 1)))))
          (expr_stmt (call (ident emit_str) (string "    jmp ")))
          (expr_stmt (call (ident emit_label) (call (ident loop_entry_continue_label) (ident entry))))
          (expr_stmt (call (ident emit_char) (number 10)))
          (return)))))
  (func gen_block ((param block (type_ptr (type_base u8)))) (type_base void)
    (block
      (var stmts (type_ptr (type_base u8)) (call (ident block_stmt_stmts) (ident block)))
      (var count (type_base i64) (call (ident block_stmt_count) (ident block)))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident count))
        (block
          (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident stmts) (binop * (ident i) (number 8))))
          (expr_stmt (call (ident gen_stmt) (unop * (ident p))))
          (assign (ident i) (binop + (ident i) (number 1)))))))
  (func gen_func ((param func_node (type_ptr (type_base u8)))) (type_base void)
    (block
      (assign (ident cg_local_count) (number 0))
      (assign (ident cg_stack_size) (number 0))
      (var name (type_ptr (type_base u8)) (call (ident func_decl_name) (ident func_node)))
      (var name_len (type_base i64) (call (ident func_decl_name_len) (ident func_node)))
      (expr_stmt (call (ident emit_str) (string ".globl ")))
      (expr_stmt (call (ident emit_n) (ident name) (ident name_len)))
      (expr_stmt (call (ident emit_char) (number 10)))
      (expr_stmt (call (ident emit_n) (ident name) (ident name_len)))
      (expr_stmt (call (ident emit_line) (string ":")))
      (assign (ident cg_in_func_body) (number 1))
      (assign (ident cg_func_len) (number 0))
      (var params (type_ptr (type_base u8)) (call (ident func_decl_params) (ident func_node)))
      (var param_count (type_base i64) (call (ident func_decl_param_count) (ident func_node)))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident param_count))
        (block
          (assign (ident cg_stack_size) (binop + (ident cg_stack_size) (number 8)))
          (var offset (type_base i64) (binop - (number 0) (ident cg_stack_size)))
          (var p (type_ptr (type_base u8)) (binop + (ident params) (binop * (ident i) (number 24))))
          (expr_stmt (call (ident add_local) (call (ident param_name) (ident p)) (call (ident param_name_len) (ident p)) (ident offset) (call (ident param_type) (ident p))))
          (if (binop == (ident i) (number 0))
            (block
              (expr_stmt (call (ident emit_str) (string "    mov %rdi, ")))
              (expr_stmt (call (ident emit_int) (ident offset)))
              (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
            (if (binop == (ident i) (number 1))
              (block
                (expr_stmt (call (ident emit_str) (string "    mov %rsi, ")))
                (expr_stmt (call (ident emit_int) (ident offset)))
                (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
              (if (binop == (ident i) (number 2))
                (block
                  (expr_stmt (call (ident emit_str) (string "    mov %rdx, ")))
                  (expr_stmt (call (ident emit_int) (ident offset)))
                  (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
                (if (binop == (ident i) (number 3))
                  (block
                    (expr_stmt (call (ident emit_str) (string "    mov %rcx, ")))
                    (expr_stmt (call (ident emit_int) (ident offset)))
                    (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
                  (if (binop == (ident i) (number 4))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    mov %r8, ")))
                      (expr_stmt (call (ident emit_int) (ident offset)))
                      (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
                    (if (binop == (ident i) (number 5))
                      (block
                        (expr_stmt (call (ident emit_str) (string "    mov %r9, ")))
                        (expr_stmt (call (ident emit_int) (ident offset)))
                        (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
                      (block
                        (var stack_offset (type_base i64) (binop + (number 16) (binop * (binop - (ident i) (number 6)) (number 8))))
                        (expr_stmt (call (ident emit_str) (string "    mov ")))
                        (expr_stmt (call (ident emit_int) (ident stack_offset)))
                        (expr_stmt (call (ident emit_str) (string "(%rbp), %rax")))
                        (expr_stmt (call (ident emit_char) (number 10)))
                        (expr_stmt (call (ident emit_str) (string "    mov %rax, ")))
                        (expr_stmt (call (ident emit_int) (ident offset)))
                        (expr_stmt (call (ident emit_line) (string "(%rbp)"))))))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (expr_stmt (call (ident gen_block) (call (ident func_decl_body) (ident func_node))))
      (assign (ident cg_in_func_body) (number 0))
      (var aligned_size (type_base i64) (ident cg_stack_size))
      (if (binop < (ident aligned_size) (number 16))
        (block
          (assign (ident aligned_size) (number 16))))
      (assign (ident aligned_size) (binop * (binop / (binop + (ident aligned_size) (number 15)) (number 16)) (number 16)))
      (expr_stmt (call (ident emit_line) (string "    push %rbp")))
      (expr_stmt (call (ident emit_line) (string "    mov %rsp, %rbp")))
      (expr_stmt (call (ident emit_str) (string "    sub $")))
      (expr_stmt (call (ident emit_int) (ident aligned_size)))
      (expr_stmt (call (ident emit_line) (string ", %rsp")))
      (expr_stmt (call (ident flush_func_body)))
      (var ret_type (type_ptr (type_base u8)) (call (ident func_decl_ret_type) (ident func_node)))
      (if (call (ident is_void_type) (ident ret_type))
        (block
          (expr_stmt (call (ident emit_line) (string "    xor %rax, %rax")))
          (expr_stmt (call (ident emit_line) (string "    leave")))
          (expr_stmt (call (ident emit_line) (string "    ret")))))
      (expr_stmt (call (ident emit_char) (number 10)))))
  (func gen_lambda ((param lambda_node (type_ptr (type_base u8))) (param lambda_id (type_base i64)) (param captures (type_ptr (type_base u8))) (param capture_count (type_base i64))) (type_base void)
    (block
      (assign (ident cg_local_count) (number 0))
      (assign (ident cg_stack_size) (number 0))
      (expr_stmt (call (ident emit_str) (string "__lambda_")))
      (expr_stmt (call (ident emit_int) (ident lambda_id)))
      (expr_stmt (call (ident emit_line) (string ":")))
      (assign (ident cg_in_func_body) (number 1))
      (assign (ident cg_func_len) (number 0))
      (if (binop > (ident capture_count) (number 0))
        (block
          (assign (ident cg_in_closure) (number 1))
          (assign (ident cg_closure_captures) (ident captures))
          (assign (ident cg_closure_capture_count) (ident capture_count))
          (assign (ident cg_stack_size) (binop + (ident cg_stack_size) (number 8)))
          (assign (ident cg_closure_ptr_offset) (binop - (number 0) (ident cg_stack_size)))
          (expr_stmt (call (ident emit_str) (string "    mov %rdi, ")))
          (expr_stmt (call (ident emit_int) (ident cg_closure_ptr_offset)))
          (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
        (block
          (assign (ident cg_in_closure) (number 0))))
      (var params (type_ptr (type_base u8)) (call (ident lambda_expr_params) (ident lambda_node)))
      (var param_count (type_base i64) (call (ident lambda_expr_param_count) (ident lambda_node)))
      (var reg_offset (type_base i64) (number 0))
      (if (binop > (ident capture_count) (number 0))
        (block
          (assign (ident reg_offset) (number 1))))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident param_count))
        (block
          (assign (ident cg_stack_size) (binop + (ident cg_stack_size) (number 8)))
          (var offset (type_base i64) (binop - (number 0) (ident cg_stack_size)))
          (var p (type_ptr (type_base u8)) (binop + (ident params) (binop * (ident i) (number 24))))
          (expr_stmt (call (ident add_local) (call (ident param_name) (ident p)) (call (ident param_name_len) (ident p)) (ident offset) (call (ident param_type) (ident p))))
          (var reg_idx (type_base i64) (binop + (ident i) (ident reg_offset)))
          (if (binop == (ident reg_idx) (number 0))
            (block
              (expr_stmt (call (ident emit_str) (string "    mov %rdi, ")))
              (expr_stmt (call (ident emit_int) (ident offset)))
              (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
            (if (binop == (ident reg_idx) (number 1))
              (block
                (expr_stmt (call (ident emit_str) (string "    mov %rsi, ")))
                (expr_stmt (call (ident emit_int) (ident offset)))
                (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
              (if (binop == (ident reg_idx) (number 2))
                (block
                  (expr_stmt (call (ident emit_str) (string "    mov %rdx, ")))
                  (expr_stmt (call (ident emit_int) (ident offset)))
                  (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
                (if (binop == (ident reg_idx) (number 3))
                  (block
                    (expr_stmt (call (ident emit_str) (string "    mov %rcx, ")))
                    (expr_stmt (call (ident emit_int) (ident offset)))
                    (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
                  (if (binop == (ident reg_idx) (number 4))
                    (block
                      (expr_stmt (call (ident emit_str) (string "    mov %r8, ")))
                      (expr_stmt (call (ident emit_int) (ident offset)))
                      (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
                    (if (binop == (ident reg_idx) (number 5))
                      (block
                        (expr_stmt (call (ident emit_str) (string "    mov %r9, ")))
                        (expr_stmt (call (ident emit_int) (ident offset)))
                        (expr_stmt (call (ident emit_line) (string "(%rbp)"))))
                      (block
                        (var stack_offset (type_base i64) (binop + (number 16) (binop * (binop - (ident reg_idx) (number 6)) (number 8))))
                        (expr_stmt (call (ident emit_str) (string "    mov ")))
                        (expr_stmt (call (ident emit_int) (ident stack_offset)))
                        (expr_stmt (call (ident emit_str) (string "(%rbp), %rax")))
                        (expr_stmt (call (ident emit_char) (number 10)))
                        (expr_stmt (call (ident emit_str) (string "    mov %rax, ")))
                        (expr_stmt (call (ident emit_int) (ident offset)))
                        (expr_stmt (call (ident emit_line) (string "(%rbp)"))))))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (expr_stmt (call (ident gen_block) (call (ident lambda_expr_body) (ident lambda_node))))
      (assign (ident cg_in_func_body) (number 0))
      (assign (ident cg_in_closure) (number 0))
      (assign (ident cg_closure_captures) (nil))
      (assign (ident cg_closure_capture_count) (number 0))
      (var aligned_size (type_base i64) (ident cg_stack_size))
      (if (binop < (ident aligned_size) (number 16))
        (block
          (assign (ident aligned_size) (number 16))))
      (assign (ident aligned_size) (binop * (binop / (binop + (ident aligned_size) (number 15)) (number 16)) (number 16)))
      (expr_stmt (call (ident emit_line) (string "    push %rbp")))
      (expr_stmt (call (ident emit_line) (string "    mov %rsp, %rbp")))
      (expr_stmt (call (ident emit_str) (string "    sub $")))
      (expr_stmt (call (ident emit_int) (ident aligned_size)))
      (expr_stmt (call (ident emit_line) (string ", %rsp")))
      (expr_stmt (call (ident flush_func_body)))
      (var ret_type (type_ptr (type_base u8)) (call (ident lambda_expr_ret_type) (ident lambda_node)))
      (if (call (ident is_void_type) (ident ret_type))
        (block
          (expr_stmt (call (ident emit_line) (string "    xor %rax, %rax")))
          (expr_stmt (call (ident emit_line) (string "    leave")))
          (expr_stmt (call (ident emit_line) (string "    ret")))))
      (expr_stmt (call (ident emit_char) (number 10)))))
  (func gen_all_lambdas () (type_base void)
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident cg_lambda_count))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident cg_lambdas) (binop * (ident i) (number 32))))
          (var p_node (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var lambda_node (type_ptr (type_base u8)) (unop * (ident p_node)))
          (var p_id (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (var lambda_id (type_base i64) (unop * (ident p_id)))
          (var p_captures (type_ptr (type_ptr (type_base u8))) (binop + (ident entry) (number 16)))
          (var captures (type_ptr (type_base u8)) (unop * (ident p_captures)))
          (var p_cap_count (type_ptr (type_base i64)) (binop + (ident entry) (number 24)))
          (var capture_count (type_base i64) (unop * (ident p_cap_count)))
          (expr_stmt (call (ident gen_lambda) (ident lambda_node) (ident lambda_id) (ident captures) (ident capture_count)))
          (assign (ident i) (binop + (ident i) (number 1)))))))
  (func gen_reader_func ((param reader_node (type_ptr (type_base u8)))) (type_base void)
    (block
      (assign (ident cg_local_count) (number 0))
      (assign (ident cg_stack_size) (number 0))
      (var name (type_ptr (type_base u8)) (call (ident reader_decl_name) (ident reader_node)))
      (var name_len (type_base i64) (call (ident reader_decl_name_len) (ident reader_node)))
      (expr_stmt (call (ident emit_str) (string ".globl ")))
      (expr_stmt (call (ident emit_n) (ident name) (ident name_len)))
      (expr_stmt (call (ident emit_char) (number 10)))
      (expr_stmt (call (ident emit_n) (ident name) (ident name_len)))
      (expr_stmt (call (ident emit_line) (string ":")))
      (assign (ident cg_in_func_body) (number 1))
      (assign (ident cg_func_len) (number 0))
      (assign (ident cg_stack_size) (binop + (ident cg_stack_size) (number 8)))
      (var offset (type_base i64) (binop - (number 0) (ident cg_stack_size)))
      (var pname (type_ptr (type_base u8)) (call (ident reader_decl_param_name) (ident reader_node)))
      (var param_len (type_base i64) (call (ident reader_decl_param_len) (ident reader_node)))
      (var ptype (type_ptr (type_base u8)) (call (ident alloc) (number 16)))
      (assign (unop * (ident ptype)) (number 42))
      (assign (unop * (binop + (ident ptype) (number 1))) (number 117))
      (assign (unop * (binop + (ident ptype) (number 2))) (number 56))
      (assign (unop * (binop + (ident ptype) (number 3))) (number 0))
      (expr_stmt (call (ident add_local) (ident pname) (ident param_len) (ident offset) (ident ptype)))
      (expr_stmt (call (ident emit_str) (string "    mov %rdi, ")))
      (expr_stmt (call (ident emit_int) (ident offset)))
      (expr_stmt (call (ident emit_line) (string "(%rbp)")))
      (expr_stmt (call (ident gen_block) (call (ident reader_decl_body) (ident reader_node))))
      (assign (ident cg_in_func_body) (number 0))
      (var aligned_size (type_base i64) (ident cg_stack_size))
      (if (binop < (ident aligned_size) (number 16))
        (block
          (assign (ident aligned_size) (number 16))))
      (assign (ident aligned_size) (binop * (binop / (binop + (ident aligned_size) (number 15)) (number 16)) (number 16)))
      (expr_stmt (call (ident emit_line) (string "    push %rbp")))
      (expr_stmt (call (ident emit_line) (string "    mov %rsp, %rbp")))
      (expr_stmt (call (ident emit_str) (string "    sub $")))
      (expr_stmt (call (ident emit_int) (ident aligned_size)))
      (expr_stmt (call (ident emit_line) (string ", %rsp")))
      (expr_stmt (call (ident flush_func_body)))
      (expr_stmt (call (ident emit_char) (number 10)))))
  (func gen_decl ((param decl (type_ptr (type_base u8)))) (type_base void)
    (block
      (if (binop == (ident decl) (nil))
        (block
          (return)))
      (var k (type_base i64) (call (ident node_kind) (ident decl)))
      (if (binop == (ident k) (ident NODE_FUNC_DECL))
        (block
          (expr_stmt (call (ident gen_func) (ident decl)))
          (return)))
      (if (binop == (ident k) (ident NODE_VAR_DECL))
        (block
          (return)))
      (if (binop == (ident k) (ident NODE_IMPORT))
        (block
          (expr_stmt (call (ident eprint) (string "warning: import not yet implemented: ")))
          (expr_stmt (call (ident eprint_buf) (call (ident import_decl_path) (ident decl)) (call (ident import_decl_path_len) (ident decl))))
          (expr_stmt (call (ident eprintln) (string "")))
          (return)))
      (if (binop == (ident k) (ident NODE_READER_DECL))
        (block
          (expr_stmt (call (ident gen_reader_func) (ident decl)))
          (return)))
      (if (binop == (ident k) (ident NODE_INCLUDE_DECL))
        (block
          (var path (type_ptr (type_base u8)) (call (ident include_decl_path) (ident decl)))
          (var path_len (type_base i64) (call (ident include_decl_path_len) (ident decl)))
          (if (call (ident map_has) (ident cg_included_files) (call (ident str_dup_n) (ident path) (ident path_len)))
            (block
              (return)))
          (expr_stmt (call (ident map_set) (ident cg_included_files) (call (ident str_dup_n) (ident path) (ident path_len)) (number 1)))
          (if (call (ident include_stack_contains) (ident path) (ident path_len))
            (block
              (return)))
          (expr_stmt (call (ident include_stack_push) (ident path) (ident path_len)))
          (var buf (type_ptr (type_base u8)) (call (ident alloc) (number 1048576)))
          (var n (type_base i64) (call (ident read_file_contents) (ident path) (ident path_len) (ident buf) (number 1048576)))
          (if (binop < (ident n) (number 0))
            (block
              (expr_stmt (call (ident include_stack_pop)))
              (return)))
          (var prog (type_ptr (type_base u8)) (call (ident parse_program_from_string) (ident buf)))
          (if (binop == (ident prog) (nil))
            (block
              (expr_stmt (call (ident include_stack_pop)))
              (return)))
          (var inc_decls (type_ptr (type_base u8)) (call (ident program_decls) (ident prog)))
          (var inc_count (type_base i64) (call (ident program_decl_count) (ident prog)))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident inc_count))
            (block
              (expr_stmt (call (ident gen_decl) (call (ident get_decl) (ident inc_decls) (ident i))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident include_stack_pop)))
          (return)))
      (if (binop == (ident k) (ident NODE_READER_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident reader_expr_name) (ident decl)))
          (var name_len (type_base i64) (call (ident reader_expr_name_len) (ident decl)))
          (var content (type_ptr (type_base u8)) (call (ident reader_expr_content) (ident decl)))
          (var content_len (type_base i64) (call (ident reader_expr_content_len) (ident decl)))
          (var reader_decl (type_ptr (type_base u8)) (call (ident find_reader) (ident name) (ident name_len)))
          (if (binop == (ident reader_decl) (nil))
            (block
              (return)))
          (var exe_path (type_ptr (type_base u8)) (call (ident build_reader_cache_path) (ident name) (ident name_len)))
          (var output (type_ptr (type_base u8)) (call (ident alloc) (number 131072)))
          (var n (type_base i64) (call (ident exec_capture) (ident exe_path) (ident content) (ident content_len) (ident output) (number 131072)))
          (if (binop <= (ident n) (number 0))
            (block
              (return)))
          (var prog (type_ptr (type_base u8)) (call (ident parse_ast_from_string) (ident output)))
          (if (binop == (ident prog) (nil))
            (block
              (return)))
          (var gen_decls (type_ptr (type_base u8)) (call (ident program_decls) (ident prog)))
          (var gen_count (type_base i64) (call (ident program_decl_count) (ident prog)))
          (assign (ident i) (number 0))
          (while (binop < (ident i) (ident gen_count))
            (block
              (expr_stmt (call (ident gen_decl) (call (ident get_decl) (ident gen_decls) (ident i))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (return)))))
  (var interp_bindings (type_ptr (type_base u8)) (nil))
  (var interp_binding_count (type_base i64) (number 0))
  (var interp_return_value (type_base i64) (number 0))
  (var interp_has_returned (type_base i64) (number 0))
  (func interp_init () (type_base void)
    (block
      (if (binop == (ident interp_bindings) (nil))
        (block
          (assign (ident interp_bindings) (call (ident alloc) (number 384)))))
      (assign (ident interp_binding_count) (number 0))
      (assign (ident interp_return_value) (number 0))
      (assign (ident interp_has_returned) (number 0))))
  (func interp_add_binding ((param name (type_ptr (type_base u8))) (param name_len (type_base i64)) (param value (type_base i64))) (type_base void)
    (block
      (var entry (type_ptr (type_base u8)) (binop + (ident interp_bindings) (binop * (ident interp_binding_count) (number 24))))
      (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
      (assign (unop * (ident np)) (ident name))
      (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
      (assign (unop * (ident nl)) (ident name_len))
      (var vp (type_ptr (type_base i64)) (binop + (ident entry) (number 16)))
      (assign (unop * (ident vp)) (ident value))
      (assign (ident interp_binding_count) (binop + (ident interp_binding_count) (number 1)))))
  (func interp_find_binding ((param name (type_ptr (type_base u8))) (param name_len (type_base i64))) (type_base i64)
    (block
      (var i (type_base i64) (binop - (ident interp_binding_count) (number 1)))
      (while (binop >= (ident i) (number 0))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident interp_bindings) (binop * (ident i) (number 24))))
          (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var bname (type_ptr (type_base u8)) (unop * (ident np)))
          (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (var blen (type_base i64) (unop * (ident nl)))
          (if (binop == (ident blen) (ident name_len))
            (block
              (if (call (ident memcmp) (ident bname) (ident name) (ident name_len))
                (block
                  (var vp (type_ptr (type_base i64)) (binop + (ident entry) (number 16)))
                  (return (unop * (ident vp)))))))
          (assign (ident i) (binop - (ident i) (number 1)))))
      (return (number 0))))
  (func interp_set_binding ((param name (type_ptr (type_base u8))) (param name_len (type_base i64)) (param value (type_base i64))) (type_base void)
    (block
      (var i (type_base i64) (binop - (ident interp_binding_count) (number 1)))
      (while (binop >= (ident i) (number 0))
        (block
          (var entry (type_ptr (type_base u8)) (binop + (ident interp_bindings) (binop * (ident i) (number 24))))
          (var np (type_ptr (type_ptr (type_base u8))) (ident entry))
          (var bname (type_ptr (type_base u8)) (unop * (ident np)))
          (var nl (type_ptr (type_base i64)) (binop + (ident entry) (number 8)))
          (var blen (type_base i64) (unop * (ident nl)))
          (if (binop == (ident blen) (ident name_len))
            (block
              (if (call (ident memcmp) (ident bname) (ident name) (ident name_len))
                (block
                  (var vp (type_ptr (type_base i64)) (binop + (ident entry) (number 16)))
                  (assign (unop * (ident vp)) (ident value))
                  (return)))))
          (assign (ident i) (binop - (ident i) (number 1)))))))
  (func expand_quote ((param expr (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (if (binop == (ident expr) (nil))
        (block
          (return (nil))))
      (var k (type_base i64) (call (ident node_kind) (ident expr)))
      (if (binop == (ident k) (ident NODE_UNQUOTE_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident unquote_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident unquote_expr_name_len) (ident expr)))
          (return (call (ident interp_find_binding) (ident name) (ident name_len)))))
      (if (binop == (ident k) (ident NODE_UNQUOTE_STRING_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident unquote_string_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident unquote_string_expr_name_len) (ident expr)))
          (var str_ptr (type_ptr (type_base u8)) (call (ident interp_find_binding) (ident name) (ident name_len)))
          (var str_len (type_base i64) (call (ident strlen) (ident str_ptr)))
          (var quoted (type_ptr (type_base u8)) (call (ident alloc) (binop + (ident str_len) (number 3))))
          (assign (unop * (ident quoted)) (number 34))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident str_len))
            (block
              (assign (unop * (binop + (binop + (ident quoted) (number 1)) (ident i))) (unop * (binop + (ident str_ptr) (ident i))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (assign (unop * (binop + (binop + (ident quoted) (number 1)) (ident str_len))) (number 34))
          (assign (unop * (binop + (binop + (ident quoted) (number 2)) (ident str_len))) (number 0))
          (var new_node (type_ptr (type_base u8)) (call (ident string_expr_alloc)))
          (expr_stmt (call (ident string_expr_set_value) (ident new_node) (ident quoted)))
          (expr_stmt (call (ident string_expr_set_value_len) (ident new_node) (binop + (ident str_len) (number 2))))
          (return (ident new_node))))
      (if (binop == (ident k) (ident NODE_BINARY_EXPR))
        (block
          (var left (type_ptr (type_base u8)) (call (ident expand_quote) (call (ident binary_expr_left) (ident expr))))
          (var right (type_ptr (type_base u8)) (call (ident expand_quote) (call (ident binary_expr_right) (ident expr))))
          (var new_node (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (expr_stmt (call (ident binary_expr_set_op) (ident new_node) (call (ident binary_expr_op) (ident expr))))
          (expr_stmt (call (ident binary_expr_set_left) (ident new_node) (ident left)))
          (expr_stmt (call (ident binary_expr_set_right) (ident new_node) (ident right)))
          (return (ident new_node))))
      (if (binop == (ident k) (ident NODE_UNARY_EXPR))
        (block
          (var child (type_ptr (type_base u8)) (call (ident expand_quote) (call (ident unary_expr_expr) (ident expr))))
          (var new_node (type_ptr (type_base u8)) (call (ident unary_expr_alloc)))
          (expr_stmt (call (ident unary_expr_set_op) (ident new_node) (call (ident unary_expr_op) (ident expr))))
          (expr_stmt (call (ident unary_expr_set_expr) (ident new_node) (ident child)))
          (return (ident new_node))))
      (if (binop == (ident k) (ident NODE_GROUP_EXPR))
        (block
          (var child (type_ptr (type_base u8)) (call (ident expand_quote) (call (ident group_expr_expr) (ident expr))))
          (var new_node (type_ptr (type_base u8)) (call (ident group_expr_alloc)))
          (expr_stmt (call (ident group_expr_set_expr) (ident new_node) (ident child)))
          (return (ident new_node))))
      (if (binop == (ident k) (ident NODE_CALL_EXPR))
        (block
          (var func_node (type_ptr (type_base u8)) (call (ident expand_quote) (call (ident call_expr_func) (ident expr))))
          (var old_args (type_ptr (type_base u8)) (call (ident call_expr_args) (ident expr)))
          (var num_args (type_base i64) (call (ident call_expr_arg_count) (ident expr)))
          (var new_args (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident num_args) (number 8))))
          (var ai (type_base i64) (number 0))
          (while (binop < (ident ai) (ident num_args))
            (block
              (var old_arg_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident old_args) (binop * (ident ai) (number 8))))
              (var expanded_arg (type_ptr (type_base u8)) (call (ident expand_quote) (unop * (ident old_arg_ptr))))
              (var new_arg_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident new_args) (binop * (ident ai) (number 8))))
              (assign (unop * (ident new_arg_ptr)) (ident expanded_arg))
              (assign (ident ai) (binop + (ident ai) (number 1)))))
          (var new_node (type_ptr (type_base u8)) (call (ident call_expr_alloc)))
          (expr_stmt (call (ident call_expr_set_func) (ident new_node) (ident func_node)))
          (expr_stmt (call (ident call_expr_set_args) (ident new_node) (ident new_args)))
          (expr_stmt (call (ident call_expr_set_arg_count) (ident new_node) (ident num_args)))
          (return (ident new_node))))
      (return (ident expr))))
  (func interp_expr ((param expr (type_ptr (type_base u8)))) (type_base i64)
    (block
      (if (binop == (ident expr) (nil))
        (block
          (return (number 0))))
      (var k (type_base i64) (call (ident node_kind) (ident expr)))
      (if (binop == (ident k) (ident NODE_NUMBER_EXPR))
        (block
          (var ptr (type_ptr (type_base u8)) (call (ident number_expr_value) (ident expr)))
          (var len (type_base i64) (call (ident number_expr_value_len) (ident expr)))
          (var val (type_base i64) (number 0))
          (var ii (type_base i64) (number 0))
          (while (binop < (ident ii) (ident len))
            (block
              (assign (ident val) (binop + (binop * (ident val) (number 10)) (binop - (unop * (binop + (ident ptr) (ident ii))) (number 48))))
              (assign (ident ii) (binop + (ident ii) (number 1)))))
          (return (ident val))))
      (if (binop == (ident k) (ident NODE_BOOL_EXPR))
        (block
          (return (call (ident bool_expr_value) (ident expr)))))
      (if (binop == (ident k) (ident NODE_NIL_EXPR))
        (block
          (return (number 0))))
      (if (binop == (ident k) (ident NODE_STRING_EXPR))
        (block
          (return (call (ident string_expr_value) (ident expr)))))
      (if (binop == (ident k) (ident NODE_IDENT_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident expr)))
          (return (call (ident interp_find_binding) (ident name) (ident name_len)))))
      (if (binop == (ident k) (ident NODE_BINARY_EXPR))
        (block
          (var op (type_base i64) (call (ident binary_expr_op) (ident expr)))
          (var left (type_base i64) (call (ident interp_expr) (call (ident binary_expr_left) (ident expr))))
          (var right (type_base i64) (call (ident interp_expr) (call (ident binary_expr_right) (ident expr))))
          (if (binop == (ident op) (ident TOKEN_PLUS))
            (block
              (return (binop + (ident left) (ident right)))))
          (if (binop == (ident op) (ident TOKEN_MINUS))
            (block
              (return (binop - (ident left) (ident right)))))
          (if (binop == (ident op) (ident TOKEN_STAR))
            (block
              (return (binop * (ident left) (ident right)))))
          (if (binop == (ident op) (ident TOKEN_SLASH))
            (block
              (return (binop / (ident left) (ident right)))))
          (if (binop == (ident op) (ident TOKEN_PERCENT))
            (block
              (return (binop % (ident left) (ident right)))))
          (if (binop == (ident op) (ident TOKEN_EQEQ))
            (block
              (if (binop == (ident left) (ident right))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_BANGEQ))
            (block
              (if (binop != (ident left) (ident right))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_LT))
            (block
              (if (binop < (ident left) (ident right))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_GT))
            (block
              (if (binop > (ident left) (ident right))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_LTEQ))
            (block
              (if (binop <= (ident left) (ident right))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_GTEQ))
            (block
              (if (binop >= (ident left) (ident right))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_AMPAMP))
            (block
              (if (binop && (binop != (ident left) (number 0)) (binop != (ident right) (number 0)))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_PIPEPIPE))
            (block
              (if (binop || (binop != (ident left) (number 0)) (binop != (ident right) (number 0)))
                (block
                  (return (number 1))))
              (return (number 0))))
          (if (binop == (ident op) (ident TOKEN_EQ))
            (block
              (var left_node (type_ptr (type_base u8)) (call (ident binary_expr_left) (ident expr)))
              (if (binop == (call (ident node_kind) (ident left_node)) (ident NODE_IDENT_EXPR))
                (block
                  (expr_stmt (call (ident interp_set_binding) (call (ident ident_expr_name) (ident left_node)) (call (ident ident_expr_name_len) (ident left_node)) (ident right)))))
              (return (ident right))))
          (return (number 0))))
      (if (binop == (ident k) (ident NODE_UNARY_EXPR))
        (block
          (var op (type_base i64) (call (ident unary_expr_op) (ident expr)))
          (var val (type_base i64) (call (ident interp_expr) (call (ident unary_expr_expr) (ident expr))))
          (if (binop == (ident op) (ident TOKEN_MINUS))
            (block
              (return (binop - (number 0) (ident val)))))
          (if (binop == (ident op) (ident TOKEN_BANG))
            (block
              (if (binop == (ident val) (number 0))
                (block
                  (return (number 1))))
              (return (number 0))))
          (return (number 0))))
      (if (binop == (ident k) (ident NODE_GROUP_EXPR))
        (block
          (return (call (ident interp_expr) (call (ident group_expr_expr) (ident expr))))))
      (if (binop == (ident k) (ident NODE_QUOTE_EXPR))
        (block
          (var inner (type_ptr (type_base u8)) (call (ident quote_expr_expr) (ident expr)))
          (var expanded (type_ptr (type_base u8)) (call (ident expand_quote) (ident inner)))
          (return (ident expanded))))
      (if (binop == (ident k) (ident NODE_UNQUOTE_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident unquote_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident unquote_expr_name_len) (ident expr)))
          (return (call (ident interp_find_binding) (ident name) (ident name_len)))))
      (if (binop == (ident k) (ident NODE_CALL_EXPR))
        (block
          (var func_node (type_ptr (type_base u8)) (call (ident call_expr_func) (ident expr)))
          (if (binop == (call (ident node_kind) (ident func_node)) (ident NODE_IDENT_EXPR))
            (block
              (var fname (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident func_node)))
              (var fname_len (type_base i64) (call (ident ident_expr_name_len) (ident func_node)))
              (if (binop && (binop == (ident fname_len) (number 13)) (call (ident memcmp) (ident fname) (string "ast_to_string") (number 13)))
                (block
                  (var args (type_ptr (type_base u8)) (call (ident call_expr_args) (ident expr)))
                  (var arg_count (type_base i64) (call (ident call_expr_arg_count) (ident expr)))
                  (if (binop >= (ident arg_count) (number 1))
                    (block
                      (var arg_ptr (type_ptr (type_ptr (type_base u8))) (ident args))
                      (var arg_ast (type_ptr (type_base u8)) (call (ident interp_expr) (unop * (ident arg_ptr))))
                      (return (call (ident ast_to_string) (ident arg_ast)))))
                  (return (number 0))))))
          (return (number 0))))
      (if (binop == (ident k) (ident NODE_LET_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident let_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident let_expr_name_len) (ident expr)))
          (var init_val (type_base i64) (call (ident interp_expr) (call (ident let_expr_init) (ident expr))))
          (var saved_binding_count (type_base i64) (ident interp_binding_count))
          (expr_stmt (call (ident interp_add_binding) (ident name) (ident name_len) (ident init_val)))
          (var result (type_base i64) (call (ident interp_expr) (call (ident let_expr_body) (ident expr))))
          (assign (ident interp_binding_count) (ident saved_binding_count))
          (return (ident result))))
      (return (number 0))))
  (func interp_stmt ((param stmt (type_ptr (type_base u8)))) (type_base void)
    (block
      (if (binop == (ident stmt) (nil))
        (block
          (return)))
      (if (ident interp_has_returned)
        (block
          (return)))
      (var k (type_base i64) (call (ident node_kind) (ident stmt)))
      (if (binop == (ident k) (ident NODE_EXPR_STMT))
        (block
          (expr_stmt (call (ident interp_expr) (call (ident expr_stmt_expr) (ident stmt))))
          (return)))
      (if (binop == (ident k) (ident NODE_ASSIGN_STMT))
        (block
          (var target (type_ptr (type_base u8)) (call (ident assign_stmt_target) (ident stmt)))
          (var value (type_base i64) (call (ident interp_expr) (call (ident assign_stmt_value) (ident stmt))))
          (if (binop == (call (ident node_kind) (ident target)) (ident NODE_IDENT_EXPR))
            (block
              (expr_stmt (call (ident interp_set_binding) (call (ident ident_expr_name) (ident target)) (call (ident ident_expr_name_len) (ident target)) (ident value)))))
          (return)))
      (if (binop == (ident k) (ident NODE_VAR_DECL))
        (block
          (var name (type_ptr (type_base u8)) (call (ident var_decl_name) (ident stmt)))
          (var name_len (type_base i64) (call (ident var_decl_name_len) (ident stmt)))
          (var init (type_ptr (type_base u8)) (call (ident var_decl_init) (ident stmt)))
          (var value (type_base i64) (number 0))
          (if (binop != (ident init) (nil))
            (block
              (assign (ident value) (call (ident interp_expr) (ident init)))))
          (expr_stmt (call (ident interp_add_binding) (ident name) (ident name_len) (ident value)))
          (return)))
      (if (binop == (ident k) (ident NODE_RETURN_STMT))
        (block
          (var value (type_ptr (type_base u8)) (call (ident return_stmt_value) (ident stmt)))
          (if (binop != (ident value) (nil))
            (block
              (assign (ident interp_return_value) (call (ident interp_expr) (ident value)))))
          (assign (ident interp_has_returned) (number 1))
          (return)))
      (if (binop == (ident k) (ident NODE_IF_STMT))
        (block
          (var cond (type_base i64) (call (ident interp_expr) (call (ident if_stmt_cond) (ident stmt))))
          (if (binop != (ident cond) (number 0))
            (block
              (expr_stmt (call (ident interp_stmt) (call (ident if_stmt_then) (ident stmt)))))
            (block
              (var else_branch (type_ptr (type_base u8)) (call (ident if_stmt_else) (ident stmt)))
              (if (binop != (ident else_branch) (nil))
                (block
                  (expr_stmt (call (ident interp_stmt) (ident else_branch)))))))
          (return)))
      (if (binop == (ident k) (ident NODE_WHILE_STMT))
        (block
          (while (unop ! (ident interp_has_returned))
            (block
              (var cond (type_base i64) (call (ident interp_expr) (call (ident while_stmt_cond) (ident stmt))))
              (if (binop == (ident cond) (number 0))
                (block
                  (return)))
              (expr_stmt (call (ident interp_stmt) (call (ident while_stmt_body) (ident stmt))))))
          (return)))
      (if (binop == (ident k) (ident NODE_BLOCK_STMT))
        (block
          (var stmts (type_ptr (type_base u8)) (call (ident block_stmt_stmts) (ident stmt)))
          (var count (type_base i64) (call (ident block_stmt_count) (ident stmt)))
          (var saved_count (type_base i64) (ident interp_binding_count))
          (var i (type_base i64) (number 0))
          (while (binop && (binop < (ident i) (ident count)) (unop ! (ident interp_has_returned)))
            (block
              (var s (type_ptr (type_ptr (type_base u8))) (binop + (ident stmts) (binop * (ident i) (number 8))))
              (expr_stmt (call (ident interp_stmt) (unop * (ident s))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (assign (ident interp_binding_count) (ident saved_count))
          (return)))))
  (var ast_str_buf (type_ptr (type_base u8)) (nil))
  (var ast_str_pos (type_base i64) (number 0))
  (var ast_str_cap (type_base i64) (number 0))
  (func ast_str_init () (type_base void)
    (block
      (if (binop == (ident ast_str_buf) (nil))
        (block
          (assign (ident ast_str_cap) (number 65536))
          (assign (ident ast_str_buf) (call (ident alloc) (ident ast_str_cap)))))
      (assign (ident ast_str_pos) (number 0))))
  (func ast_str_append_char ((param c (type_base u8))) (type_base void)
    (block
      (if (binop < (ident ast_str_pos) (binop - (ident ast_str_cap) (number 1)))
        (block
          (assign (unop * (binop + (ident ast_str_buf) (ident ast_str_pos))) (ident c))
          (assign (ident ast_str_pos) (binop + (ident ast_str_pos) (number 1)))))))
  (func ast_str_append ((param s (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident len))
        (block
          (expr_stmt (call (ident ast_str_append_char) (unop * (binop + (ident s) (ident i)))))
          (assign (ident i) (binop + (ident i) (number 1)))))))
  (func ast_str_append_cstr ((param s (type_ptr (type_base u8)))) (type_base void)
    (block
      (while (binop != (unop * (ident s)) (number 0))
        (block
          (expr_stmt (call (ident ast_str_append_char) (unop * (ident s))))
          (assign (ident s) (binop + (ident s) (number 1)))))))
  (func ast_str_finish () (type_ptr (type_base u8))
    (block
      (assign (unop * (binop + (ident ast_str_buf) (ident ast_str_pos))) (number 0))
      (var result (type_ptr (type_base u8)) (call (ident str_dup) (ident ast_str_buf)))
      (return (ident result))))
  (func ast_to_string_expr ((param expr (type_ptr (type_base u8)))) (type_base void)
    (block
      (if (binop == (ident expr) (nil))
        (block
          (expr_stmt (call (ident ast_str_append_cstr) (string "nil")))
          (return)))
      (var kind (type_base i64) (call (ident node_kind) (ident expr)))
      (if (binop == (ident kind) (ident NODE_NUMBER_EXPR))
        (block
          (var ptr (type_ptr (type_base u8)) (call (ident number_expr_value) (ident expr)))
          (var len (type_base i64) (call (ident number_expr_value_len) (ident expr)))
          (expr_stmt (call (ident ast_str_append) (ident ptr) (ident len)))
          (return)))
      (if (binop == (ident kind) (ident NODE_IDENT_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident expr)))
          (expr_stmt (call (ident ast_str_append) (ident name) (ident name_len)))
          (return)))
      (if (binop == (ident kind) (ident NODE_STRING_EXPR))
        (block
          (var s (type_ptr (type_base u8)) (call (ident string_expr_value) (ident expr)))
          (var s_len (type_base i64) (call (ident string_expr_value_len) (ident expr)))
          (expr_stmt (call (ident ast_str_append) (ident s) (ident s_len)))
          (return)))
      (if (binop == (ident kind) (ident NODE_BOOL_EXPR))
        (block
          (if (binop != (call (ident bool_expr_value) (ident expr)) (number 0))
            (block
              (expr_stmt (call (ident ast_str_append_cstr) (string "true"))))
            (block
              (expr_stmt (call (ident ast_str_append_cstr) (string "false")))))
          (return)))
      (if (binop == (ident kind) (ident NODE_NIL_EXPR))
        (block
          (expr_stmt (call (ident ast_str_append_cstr) (string "nil")))
          (return)))
      (if (binop == (ident kind) (ident NODE_GROUP_EXPR))
        (block
          (expr_stmt (call (ident ast_str_append_char) (number 40)))
          (expr_stmt (call (ident ast_to_string_expr) (call (ident group_expr_expr) (ident expr))))
          (expr_stmt (call (ident ast_str_append_char) (number 41)))
          (return)))
      (if (binop == (ident kind) (ident NODE_BINARY_EXPR))
        (block
          (var op (type_base i64) (call (ident binary_expr_op) (ident expr)))
          (if (binop == (ident op) (ident TOKEN_EQ))
            (block
              (expr_stmt (call (ident ast_to_string_expr) (call (ident binary_expr_left) (ident expr))))
              (expr_stmt (call (ident ast_str_append_cstr) (string " = ")))
              (expr_stmt (call (ident ast_to_string_expr) (call (ident binary_expr_right) (ident expr))))
              (return)))
          (expr_stmt (call (ident ast_str_append_char) (number 40)))
          (expr_stmt (call (ident ast_to_string_expr) (call (ident binary_expr_left) (ident expr))))
          (expr_stmt (call (ident ast_str_append_char) (number 32)))
          (if (binop == (ident op) (ident TOKEN_PLUS))
            (block
              (expr_stmt (call (ident ast_str_append_cstr) (string "+"))))
            (if (binop == (ident op) (ident TOKEN_MINUS))
              (block
                (expr_stmt (call (ident ast_str_append_cstr) (string "-"))))
              (if (binop == (ident op) (ident TOKEN_STAR))
                (block
                  (expr_stmt (call (ident ast_str_append_cstr) (string "*"))))
                (if (binop == (ident op) (ident TOKEN_SLASH))
                  (block
                    (expr_stmt (call (ident ast_str_append_cstr) (string "/"))))
                  (if (binop == (ident op) (ident TOKEN_PERCENT))
                    (block
                      (expr_stmt (call (ident ast_str_append_cstr) (string "%"))))
                    (if (binop == (ident op) (ident TOKEN_EQEQ))
                      (block
                        (expr_stmt (call (ident ast_str_append_cstr) (string "=="))))
                      (if (binop == (ident op) (ident TOKEN_BANGEQ))
                        (block
                          (expr_stmt (call (ident ast_str_append_cstr) (string "!="))))
                        (if (binop == (ident op) (ident TOKEN_LT))
                          (block
                            (expr_stmt (call (ident ast_str_append_cstr) (string "<"))))
                          (if (binop == (ident op) (ident TOKEN_GT))
                            (block
                              (expr_stmt (call (ident ast_str_append_cstr) (string ">"))))
                            (if (binop == (ident op) (ident TOKEN_LTEQ))
                              (block
                                (expr_stmt (call (ident ast_str_append_cstr) (string "<="))))
                              (if (binop == (ident op) (ident TOKEN_GTEQ))
                                (block
                                  (expr_stmt (call (ident ast_str_append_cstr) (string ">="))))
                                (if (binop == (ident op) (ident TOKEN_AMPAMP))
                                  (block
                                    (expr_stmt (call (ident ast_str_append_cstr) (string "&&"))))
                                  (if (binop == (ident op) (ident TOKEN_PIPEPIPE))
                                    (block
                                      (expr_stmt (call (ident ast_str_append_cstr) (string "||"))))
                                    (if (binop == (ident op) (ident TOKEN_AMP))
                                      (block
                                        (expr_stmt (call (ident ast_str_append_cstr) (string "&"))))
                                      (if (binop == (ident op) (ident TOKEN_PIPE))
                                        (block
                                          (expr_stmt (call (ident ast_str_append_cstr) (string "|"))))
                                        (if (binop == (ident op) (ident TOKEN_CARET))
                                          (block
                                            (expr_stmt (call (ident ast_str_append_cstr) (string "^"))))
                                          (if (binop == (ident op) (ident TOKEN_LTLT))
                                            (block
                                              (expr_stmt (call (ident ast_str_append_cstr) (string "<<"))))
                                            (if (binop == (ident op) (ident TOKEN_GTGT))
                                              (block
                                                (expr_stmt (call (ident ast_str_append_cstr) (string ">>"))))
                                              (block
                                                (expr_stmt (call (ident ast_str_append_cstr) (string "?op?"))))))))))))))))))))))
          (expr_stmt (call (ident ast_str_append_char) (number 32)))
          (expr_stmt (call (ident ast_to_string_expr) (call (ident binary_expr_right) (ident expr))))
          (expr_stmt (call (ident ast_str_append_char) (number 41)))
          (return)))
      (if (binop == (ident kind) (ident NODE_UNARY_EXPR))
        (block
          (var op (type_base i64) (call (ident unary_expr_op) (ident expr)))
          (if (binop == (ident op) (ident TOKEN_MINUS))
            (block
              (expr_stmt (call (ident ast_str_append_cstr) (string "-"))))
            (if (binop == (ident op) (ident TOKEN_BANG))
              (block
                (expr_stmt (call (ident ast_str_append_cstr) (string "!"))))
              (if (binop == (ident op) (ident TOKEN_STAR))
                (block
                  (expr_stmt (call (ident ast_str_append_cstr) (string "*"))))
                (if (binop == (ident op) (ident TOKEN_AMP))
                  (block
                    (expr_stmt (call (ident ast_str_append_cstr) (string "&"))))))))
          (expr_stmt (call (ident ast_to_string_expr) (call (ident unary_expr_expr) (ident expr))))
          (return)))
      (if (binop == (ident kind) (ident NODE_CALL_EXPR))
        (block
          (expr_stmt (call (ident ast_to_string_expr) (call (ident call_expr_func) (ident expr))))
          (expr_stmt (call (ident ast_str_append_char) (number 40)))
          (var args (type_ptr (type_base u8)) (call (ident call_expr_args) (ident expr)))
          (var count (type_base i64) (call (ident call_expr_arg_count) (ident expr)))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident count))
            (block
              (if (binop > (ident i) (number 0))
                (block
                  (expr_stmt (call (ident ast_str_append_cstr) (string ", ")))))
              (var arg_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident args) (binop * (ident i) (number 8))))
              (expr_stmt (call (ident ast_to_string_expr) (unop * (ident arg_ptr))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident ast_str_append_char) (number 41)))
          (return)))
      (if (binop == (ident kind) (ident NODE_FIELD_EXPR))
        (block
          (expr_stmt (call (ident ast_to_string_expr) (call (ident field_expr_expr) (ident expr))))
          (expr_stmt (call (ident ast_str_append_char) (number 46)))
          (var fname (type_ptr (type_base u8)) (call (ident field_expr_field) (ident expr)))
          (var fname_len (type_base i64) (call (ident field_expr_field_len) (ident expr)))
          (expr_stmt (call (ident ast_str_append) (ident fname) (ident fname_len)))
          (return)))
      (expr_stmt (call (ident ast_str_append_cstr) (string "<expr>")))))
  (func ast_to_string_type ((param type_node (type_ptr (type_base u8)))) (type_base void)
    (block
      (if (binop == (ident type_node) (nil))
        (block
          (expr_stmt (call (ident ast_str_append_cstr) (string "void")))
          (return)))
      (var kind (type_base i64) (call (ident type_kind) (ident type_node)))
      (if (binop == (ident kind) (ident TYPE_PTR))
        (block
          (expr_stmt (call (ident ast_str_append_char) (number 42)))
          (expr_stmt (call (ident ast_to_string_type) (call (ident ptr_type_elem) (ident type_node))))
          (return)))
      (var name (type_ptr (type_base u8)) (call (ident base_type_name) (ident type_node)))
      (var name_len (type_base i64) (call (ident base_type_name_len) (ident type_node)))
      (expr_stmt (call (ident ast_str_append) (ident name) (ident name_len)))))
  (func ast_to_string_stmt ((param stmt (type_ptr (type_base u8)))) (type_base void)
    (block
      (if (binop == (ident stmt) (nil))
        (block
          (return)))
      (var kind (type_base i64) (call (ident node_kind) (ident stmt)))
      (if (binop == (ident kind) (ident NODE_BLOCK_STMT))
        (block
          (expr_stmt (call (ident ast_str_append_cstr) (string "{\n")))
          (var stmts (type_ptr (type_base u8)) (call (ident block_stmt_stmts) (ident stmt)))
          (var count (type_base i64) (call (ident block_stmt_count) (ident stmt)))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident count))
            (block
              (var s_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident stmts) (binop * (ident i) (number 8))))
              (expr_stmt (call (ident ast_str_append_cstr) (string "    ")))
              (expr_stmt (call (ident ast_to_string_stmt) (unop * (ident s_ptr))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident ast_str_append_cstr) (string "}\n")))
          (return)))
      (if (binop == (ident kind) (ident NODE_VAR_DECL))
        (block
          (expr_stmt (call (ident ast_str_append_cstr) (string "var ")))
          (var name (type_ptr (type_base u8)) (call (ident var_decl_name) (ident stmt)))
          (var name_len (type_base i64) (call (ident var_decl_name_len) (ident stmt)))
          (expr_stmt (call (ident ast_str_append) (ident name) (ident name_len)))
          (expr_stmt (call (ident ast_str_append_char) (number 32)))
          (expr_stmt (call (ident ast_to_string_type) (call (ident var_decl_type) (ident stmt))))
          (var init (type_ptr (type_base u8)) (call (ident var_decl_init) (ident stmt)))
          (if (binop != (ident init) (nil))
            (block
              (expr_stmt (call (ident ast_str_append_cstr) (string " = ")))
              (expr_stmt (call (ident ast_to_string_expr) (ident init)))))
          (expr_stmt (call (ident ast_str_append_cstr) (string ";\n")))
          (return)))
      (if (binop == (ident kind) (ident NODE_RETURN_STMT))
        (block
          (expr_stmt (call (ident ast_str_append_cstr) (string "return")))
          (var value (type_ptr (type_base u8)) (call (ident return_stmt_value) (ident stmt)))
          (if (binop != (ident value) (nil))
            (block
              (expr_stmt (call (ident ast_str_append_char) (number 32)))
              (expr_stmt (call (ident ast_to_string_expr) (ident value)))))
          (expr_stmt (call (ident ast_str_append_cstr) (string ";\n")))
          (return)))
      (if (binop == (ident kind) (ident NODE_EXPR_STMT))
        (block
          (expr_stmt (call (ident ast_to_string_expr) (call (ident expr_stmt_expr) (ident stmt))))
          (expr_stmt (call (ident ast_str_append_cstr) (string ";\n")))
          (return)))
      (if (binop == (ident kind) (ident NODE_ASSIGN_STMT))
        (block
          (expr_stmt (call (ident ast_to_string_expr) (call (ident assign_stmt_target) (ident stmt))))
          (expr_stmt (call (ident ast_str_append_cstr) (string " = ")))
          (expr_stmt (call (ident ast_to_string_expr) (call (ident assign_stmt_value) (ident stmt))))
          (expr_stmt (call (ident ast_str_append_cstr) (string ";\n")))
          (return)))
      (if (binop == (ident kind) (ident NODE_IF_STMT))
        (block
          (expr_stmt (call (ident ast_str_append_cstr) (string "if ")))
          (expr_stmt (call (ident ast_to_string_expr) (call (ident if_stmt_cond) (ident stmt))))
          (expr_stmt (call (ident ast_str_append_char) (number 32)))
          (expr_stmt (call (ident ast_to_string_stmt) (call (ident if_stmt_then) (ident stmt))))
          (var else_branch (type_ptr (type_base u8)) (call (ident if_stmt_else) (ident stmt)))
          (if (binop != (ident else_branch) (nil))
            (block
              (expr_stmt (call (ident ast_str_append_cstr) (string " else ")))
              (expr_stmt (call (ident ast_to_string_stmt) (ident else_branch)))))
          (return)))
      (if (binop == (ident kind) (ident NODE_WHILE_STMT))
        (block
          (expr_stmt (call (ident ast_str_append_cstr) (string "while ")))
          (expr_stmt (call (ident ast_to_string_expr) (call (ident while_stmt_cond) (ident stmt))))
          (expr_stmt (call (ident ast_str_append_char) (number 32)))
          (expr_stmt (call (ident ast_to_string_stmt) (call (ident while_stmt_body) (ident stmt))))
          (return)))
      (expr_stmt (call (ident ast_str_append_cstr) (string "/* unknown stmt */\n")))))
  (func ast_to_string_block ((param block (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (expr_stmt (call (ident ast_str_init)))
      (expr_stmt (call (ident ast_to_string_stmt) (ident block)))
      (return (call (ident ast_str_finish)))))
  (func ast_to_string ((param expr (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (expr_stmt (call (ident ast_str_init)))
      (expr_stmt (call (ident ast_to_string_expr) (ident expr)))
      (return (call (ident ast_str_finish)))))
  (func ast_to_string_func_decl ((param decl (type_ptr (type_base u8)))) (type_base void)
    (block
      (expr_stmt (call (ident ast_str_append_cstr) (string "func ")))
      (var name (type_ptr (type_base u8)) (call (ident func_decl_name) (ident decl)))
      (var name_len (type_base i64) (call (ident func_decl_name_len) (ident decl)))
      (expr_stmt (call (ident ast_str_append) (ident name) (ident name_len)))
      (expr_stmt (call (ident ast_str_append_char) (number 40)))
      (var params (type_ptr (type_base u8)) (call (ident func_decl_params) (ident decl)))
      (var param_count (type_base i64) (call (ident func_decl_param_count) (ident decl)))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident param_count))
        (block
          (if (binop > (ident i) (number 0))
            (block
              (expr_stmt (call (ident ast_str_append_cstr) (string ", ")))))
          (var p (type_ptr (type_base u8)) (binop + (ident params) (binop * (ident i) (number 24))))
          (expr_stmt (call (ident ast_str_append) (call (ident param_name) (ident p)) (call (ident param_name_len) (ident p))))
          (expr_stmt (call (ident ast_str_append_char) (number 32)))
          (expr_stmt (call (ident ast_to_string_type) (call (ident param_type) (ident p))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (expr_stmt (call (ident ast_str_append_cstr) (string ") ")))
      (expr_stmt (call (ident ast_to_string_type) (call (ident func_decl_ret_type) (ident decl))))
      (expr_stmt (call (ident ast_str_append_char) (number 32)))
      (expr_stmt (call (ident ast_to_string_stmt) (call (ident func_decl_body) (ident decl))))))
  (func ast_to_string_struct_decl ((param decl (type_ptr (type_base u8)))) (type_base void)
    (block
      (expr_stmt (call (ident ast_str_append_cstr) (string "struct ")))
      (expr_stmt (call (ident ast_str_append) (call (ident struct_decl_name) (ident decl)) (call (ident struct_decl_name_len) (ident decl))))
      (expr_stmt (call (ident ast_str_append_cstr) (string " {\n")))
      (var fields (type_ptr (type_base u8)) (call (ident struct_decl_fields) (ident decl)))
      (var field_count (type_base i64) (call (ident struct_decl_field_count) (ident decl)))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident field_count))
        (block
          (var f (type_ptr (type_base u8)) (binop + (ident fields) (binop * (ident i) (number 24))))
          (expr_stmt (call (ident ast_str_append_cstr) (string "    ")))
          (expr_stmt (call (ident ast_str_append) (call (ident param_name) (ident f)) (call (ident param_name_len) (ident f))))
          (expr_stmt (call (ident ast_str_append_char) (number 32)))
          (expr_stmt (call (ident ast_to_string_type) (call (ident param_type) (ident f))))
          (expr_stmt (call (ident ast_str_append_cstr) (string ";\n")))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (expr_stmt (call (ident ast_str_append_cstr) (string "}\n")))))
  (func ast_to_string_include_decl ((param decl (type_ptr (type_base u8)))) (type_base void)
    (block
      (expr_stmt (call (ident ast_str_append_cstr) (string "include \"")))
      (var path (type_ptr (type_base u8)) (call (ident include_decl_path) (ident decl)))
      (var path_len (type_base i64) (call (ident include_decl_path_len) (ident decl)))
      (expr_stmt (call (ident ast_str_append) (ident path) (ident path_len)))
      (expr_stmt (call (ident ast_str_append_cstr) (string "\"\n")))))
  (func print_expr_ast ((param expr (type_ptr (type_base u8)))) (type_base void)
    (block
      (if (binop == (ident expr) (nil))
        (block
          (expr_stmt (call (ident eprint) (string "nil")))
          (return)))
      (var kind (type_base i64) (call (ident node_kind) (ident expr)))
      (if (binop == (ident kind) (ident NODE_NUMBER_EXPR))
        (block
          (var ptr (type_ptr (type_base u8)) (call (ident number_expr_value) (ident expr)))
          (var len (type_base i64) (call (ident number_expr_value_len) (ident expr)))
          (expr_stmt (call (ident eprint_buf) (ident ptr) (ident len)))
          (return)))
      (if (binop == (ident kind) (ident NODE_IDENT_EXPR))
        (block
          (var name (type_ptr (type_base u8)) (call (ident ident_expr_name) (ident expr)))
          (var name_len (type_base i64) (call (ident ident_expr_name_len) (ident expr)))
          (expr_stmt (call (ident eprint_buf) (ident name) (ident name_len)))
          (return)))
      (if (binop == (ident kind) (ident NODE_STRING_EXPR))
        (block
          (expr_stmt (call (ident eprint) (string "\"")))
          (var s (type_ptr (type_base u8)) (call (ident string_expr_value) (ident expr)))
          (var s_len (type_base i64) (call (ident string_expr_value_len) (ident expr)))
          (expr_stmt (call (ident eprint_buf) (ident s) (ident s_len)))
          (expr_stmt (call (ident eprint) (string "\"")))
          (return)))
      (if (binop == (ident kind) (ident NODE_BOOL_EXPR))
        (block
          (if (binop != (call (ident bool_expr_value) (ident expr)) (number 0))
            (block
              (expr_stmt (call (ident eprint) (string "true"))))
            (block
              (expr_stmt (call (ident eprint) (string "false")))))
          (return)))
      (if (binop == (ident kind) (ident NODE_NIL_EXPR))
        (block
          (expr_stmt (call (ident eprint) (string "nil")))
          (return)))
      (if (binop == (ident kind) (ident NODE_GROUP_EXPR))
        (block
          (expr_stmt (call (ident eprint) (string "(")))
          (expr_stmt (call (ident print_expr_ast) (call (ident group_expr_expr) (ident expr))))
          (expr_stmt (call (ident eprint) (string ")")))
          (return)))
      (if (binop == (ident kind) (ident NODE_BINARY_EXPR))
        (block
          (expr_stmt (call (ident eprint) (string "(")))
          (expr_stmt (call (ident print_expr_ast) (call (ident binary_expr_left) (ident expr))))
          (expr_stmt (call (ident eprint) (string " ")))
          (var op (type_base i64) (call (ident binary_expr_op) (ident expr)))
          (if (binop == (ident op) (ident TOKEN_PLUS))
            (block
              (expr_stmt (call (ident eprint) (string "+"))))
            (if (binop == (ident op) (ident TOKEN_MINUS))
              (block
                (expr_stmt (call (ident eprint) (string "-"))))
              (if (binop == (ident op) (ident TOKEN_STAR))
                (block
                  (expr_stmt (call (ident eprint) (string "*"))))
                (if (binop == (ident op) (ident TOKEN_SLASH))
                  (block
                    (expr_stmt (call (ident eprint) (string "/"))))
                  (if (binop == (ident op) (ident TOKEN_PERCENT))
                    (block
                      (expr_stmt (call (ident eprint) (string "%"))))
                    (if (binop == (ident op) (ident TOKEN_EQEQ))
                      (block
                        (expr_stmt (call (ident eprint) (string "=="))))
                      (if (binop == (ident op) (ident TOKEN_BANGEQ))
                        (block
                          (expr_stmt (call (ident eprint) (string "!="))))
                        (if (binop == (ident op) (ident TOKEN_LT))
                          (block
                            (expr_stmt (call (ident eprint) (string "<"))))
                          (if (binop == (ident op) (ident TOKEN_GT))
                            (block
                              (expr_stmt (call (ident eprint) (string ">"))))
                            (if (binop == (ident op) (ident TOKEN_LTEQ))
                              (block
                                (expr_stmt (call (ident eprint) (string "<="))))
                              (if (binop == (ident op) (ident TOKEN_GTEQ))
                                (block
                                  (expr_stmt (call (ident eprint) (string ">="))))
                                (if (binop == (ident op) (ident TOKEN_AMPAMP))
                                  (block
                                    (expr_stmt (call (ident eprint) (string "&&"))))
                                  (if (binop == (ident op) (ident TOKEN_PIPEPIPE))
                                    (block
                                      (expr_stmt (call (ident eprint) (string "||"))))
                                    (if (binop == (ident op) (ident TOKEN_AMP))
                                      (block
                                        (expr_stmt (call (ident eprint) (string "&"))))
                                      (if (binop == (ident op) (ident TOKEN_PIPE))
                                        (block
                                          (expr_stmt (call (ident eprint) (string "|"))))
                                        (if (binop == (ident op) (ident TOKEN_CARET))
                                          (block
                                            (expr_stmt (call (ident eprint) (string "^"))))
                                          (if (binop == (ident op) (ident TOKEN_LTLT))
                                            (block
                                              (expr_stmt (call (ident eprint) (string "<<"))))
                                            (if (binop == (ident op) (ident TOKEN_GTGT))
                                              (block
                                                (expr_stmt (call (ident eprint) (string ">>"))))
                                              (block
                                                (expr_stmt (call (ident eprint) (string "?op?"))))))))))))))))))))))
          (expr_stmt (call (ident eprint) (string " ")))
          (expr_stmt (call (ident print_expr_ast) (call (ident binary_expr_right) (ident expr))))
          (expr_stmt (call (ident eprint) (string ")")))
          (return)))
      (if (binop == (ident kind) (ident NODE_UNARY_EXPR))
        (block
          (var op (type_base i64) (call (ident unary_expr_op) (ident expr)))
          (if (binop == (ident op) (ident TOKEN_MINUS))
            (block
              (expr_stmt (call (ident eprint) (string "-"))))
            (if (binop == (ident op) (ident TOKEN_BANG))
              (block
                (expr_stmt (call (ident eprint) (string "!"))))
              (if (binop == (ident op) (ident TOKEN_STAR))
                (block
                  (expr_stmt (call (ident eprint) (string "*"))))
                (if (binop == (ident op) (ident TOKEN_AMP))
                  (block
                    (expr_stmt (call (ident eprint) (string "&"))))))))
          (expr_stmt (call (ident print_expr_ast) (call (ident unary_expr_expr) (ident expr))))
          (return)))
      (if (binop == (ident kind) (ident NODE_CALL_EXPR))
        (block
          (expr_stmt (call (ident print_expr_ast) (call (ident call_expr_func) (ident expr))))
          (expr_stmt (call (ident eprint) (string "(")))
          (var args (type_ptr (type_base u8)) (call (ident call_expr_args) (ident expr)))
          (var count (type_base i64) (call (ident call_expr_arg_count) (ident expr)))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident count))
            (block
              (if (binop > (ident i) (number 0))
                (block
                  (expr_stmt (call (ident eprint) (string ", ")))))
              (var arg_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident args) (binop * (ident i) (number 8))))
              (expr_stmt (call (ident print_expr_ast) (unop * (ident arg_ptr))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident eprint) (string ")")))
          (return)))
      (if (binop == (ident kind) (ident NODE_INDEX_EXPR))
        (block
          (expr_stmt (call (ident eprint) (string "<index-expr>")))
          (return)))
      (if (binop == (ident kind) (ident NODE_FIELD_EXPR))
        (block
          (expr_stmt (call (ident print_expr_ast) (call (ident field_expr_expr) (ident expr))))
          (expr_stmt (call (ident eprint) (string ".")))
          (var fname (type_ptr (type_base u8)) (call (ident field_expr_field) (ident expr)))
          (var fname_len (type_base i64) (call (ident field_expr_field_len) (ident expr)))
          (expr_stmt (call (ident eprint_buf) (ident fname) (ident fname_len)))
          (return)))
      (expr_stmt (call (ident eprint) (string "<unknown-expr>")))))
  (func interp_call_macro ((param macro_decl (type_ptr (type_base u8))) (param args (type_ptr (type_base u8))) (param arg_count (type_base i64))) (type_ptr (type_base u8))
    (block
      (expr_stmt (call (ident interp_init)))
      (var macro_params (type_ptr (type_base u8)) (call (ident macro_decl_params) (ident macro_decl)))
      (var num_params (type_base i64) (call (ident macro_decl_param_count) (ident macro_decl)))
      (var i (type_base i64) (number 0))
      (while (binop && (binop < (ident i) (ident num_params)) (binop < (ident i) (ident arg_count)))
        (block
          (var p (type_ptr (type_base u8)) (binop + (ident macro_params) (binop * (ident i) (number 24))))
          (var pname (type_ptr (type_base u8)) (call (ident param_name) (ident p)))
          (var pname_len (type_base i64) (call (ident param_name_len) (ident p)))
          (var arg_ptr (type_ptr (type_ptr (type_base u8))) (binop + (ident args) (binop * (ident i) (number 8))))
          (var arg (type_ptr (type_base u8)) (unop * (ident arg_ptr)))
          (expr_stmt (call (ident interp_add_binding) (ident pname) (ident pname_len) (ident arg)))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (var macro_body (type_ptr (type_base u8)) (call (ident macro_decl_body) (ident macro_decl)))
      (expr_stmt (call (ident interp_stmt) (ident macro_body)))
      (return (ident interp_return_value))))
  (func exec_capture ((param program (type_ptr (type_base u8))) (param input (type_ptr (type_base u8))) (param input_len (type_base i64)) (param output (type_ptr (type_base u8))) (param output_cap (type_base i64))) (type_base i64)
    (block
      (var stdin_pipe (type_ptr (type_base u8)) (call (ident alloc) (number 8)))
      (var stdout_pipe (type_ptr (type_base u8)) (call (ident alloc) (number 8)))
      (if (binop < (call (ident syscall) (number 22) (ident stdin_pipe)) (number 0))
        (block
          (return (binop - (number 0) (number 1)))))
      (if (binop < (call (ident syscall) (number 22) (ident stdout_pipe)) (number 0))
        (block
          (return (binop - (number 0) (number 1)))))
      (var p1 (type_ptr (type_base i32)) (ident stdin_pipe))
      (var p2 (type_ptr (type_base i32)) (binop + (ident stdin_pipe) (number 4)))
      (var p3 (type_ptr (type_base i32)) (ident stdout_pipe))
      (var p4 (type_ptr (type_base i32)) (binop + (ident stdout_pipe) (number 4)))
      (var stdin_read (type_base i64) (unop * (ident p1)))
      (var stdin_write (type_base i64) (unop * (ident p2)))
      (var stdout_read (type_base i64) (unop * (ident p3)))
      (var stdout_write (type_base i64) (unop * (ident p4)))
      (var pid (type_base i64) (call (ident syscall) (number 57)))
      (if (binop < (ident pid) (number 0))
        (block
          (return (binop - (number 0) (number 1)))))
      (if (binop == (ident pid) (number 0))
        (block
          (expr_stmt (call (ident syscall) (number 33) (ident stdin_read) (number 0)))
          (expr_stmt (call (ident syscall) (number 33) (ident stdout_write) (number 1)))
          (expr_stmt (call (ident syscall) (number 3) (ident stdin_read)))
          (expr_stmt (call (ident syscall) (number 3) (ident stdin_write)))
          (expr_stmt (call (ident syscall) (number 3) (ident stdout_read)))
          (expr_stmt (call (ident syscall) (number 3) (ident stdout_write)))
          (var argv (type_ptr (type_base u8)) (call (ident alloc) (number 16)))
          (var ap (type_ptr (type_ptr (type_base u8))) (ident argv))
          (assign (unop * (ident ap)) (ident program))
          (var ap2 (type_ptr (type_ptr (type_base u8))) (binop + (ident argv) (number 8)))
          (assign (unop * (ident ap2)) (nil))
          (var envp (type_ptr (type_base u8)) (call (ident alloc) (number 8)))
          (var ep (type_ptr (type_ptr (type_base u8))) (ident envp))
          (assign (unop * (ident ep)) (nil))
          (expr_stmt (call (ident syscall) (number 59) (ident program) (ident argv) (ident envp)))
          (expr_stmt (call (ident syscall) (number 60) (number 127)))))
      (expr_stmt (call (ident syscall) (number 3) (ident stdin_read)))
      (expr_stmt (call (ident syscall) (number 3) (ident stdout_write)))
      (if (binop > (ident input_len) (number 0))
        (block
          (expr_stmt (call (ident syscall) (number 1) (ident stdin_write) (ident input) (ident input_len)))))
      (expr_stmt (call (ident syscall) (number 3) (ident stdin_write)))
      (var total (type_base i64) (number 0))
      (var n (type_base i64) (call (ident syscall) (number 0) (ident stdout_read) (ident output) (binop - (ident output_cap) (number 1))))
      (while (binop > (ident n) (number 0))
        (block
          (assign (ident total) (binop + (ident total) (ident n)))
          (if (binop >= (ident total) (binop - (ident output_cap) (number 1)))
            (block
              (assign (ident n) (number 0)))
            (block
              (assign (ident n) (call (ident syscall) (number 0) (ident stdout_read) (binop + (ident output) (ident total)) (binop - (binop - (ident output_cap) (number 1)) (ident total))))))))
      (expr_stmt (call (ident syscall) (number 3) (ident stdout_read)))
      (assign (unop * (binop + (ident output) (ident total))) (number 0))
      (var status (type_ptr (type_base i64)) (call (ident alloc) (number 8)))
      (expr_stmt (call (ident syscall) (number 61) (ident pid) (ident status) (number 0) (number 0)))
      (return (ident total))))
  (func interp_call_reader ((param reader_decl (type_ptr (type_base u8))) (param content (type_ptr (type_base u8))) (param content_len (type_base i64))) (type_ptr (type_base u8))
    (block
      (expr_stmt (call (ident interp_init)))
      (var param_name (type_ptr (type_base u8)) (call (ident reader_decl_param_name) (ident reader_decl)))
      (var param_len (type_base i64) (call (ident reader_decl_param_len) (ident reader_decl)))
      (expr_stmt (call (ident interp_add_binding) (ident param_name) (ident param_len) (ident content)))
      (var reader_body (type_ptr (type_base u8)) (call (ident reader_decl_body) (ident reader_decl)))
      (expr_stmt (call (ident interp_stmt) (ident reader_body)))
      (return (ident interp_return_value))))
  (func generate ((param prog (type_ptr (type_base u8))) (param out_path (type_ptr (type_base u8)))) (type_base void)
    (block
      (expr_stmt (call (ident codegen_init)))
      (var decls (type_ptr (type_base u8)) (call (ident program_decls) (ident prog)))
      (var decl_count (type_base i64) (call (ident program_decl_count) (ident prog)))
      (assign (ident cg_decls) (ident decls))
      (assign (ident cg_decl_count) (ident decl_count))
      (assign (ident cg_current_file_decls) (ident decls))
      (assign (ident cg_current_file_decl_count) (ident decl_count))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident decl_count))
        (block
          (expr_stmt (call (ident process_decl_first_pass) (call (ident get_decl) (ident decls) (ident i))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (assign (ident cg_included_files) (call (ident map_new)))
      (assign (ident i) (number 0))
      (while (binop < (ident i) (ident decl_count))
        (block
          (expr_stmt (call (ident gen_decl) (call (ident get_decl) (ident decls) (ident i))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (expr_stmt (call (ident gen_all_lambdas)))
      (assign (ident cg_out_fd) (call (ident syscall) (number 2) (ident out_path) (number 577) (number 420)))
      (if (binop < (ident cg_out_fd) (number 0))
        (block
          (expr_stmt (call (ident eprintln) (string "Error: cannot open output file")))
          (return)))
      (expr_stmt (call (ident out_line) (string ".section .data")))
      (assign (ident i) (number 0))
      (while (binop < (ident i) (ident cg_string_count))
        (block
          (expr_stmt (call (ident out_str) (string ".str")))
          (expr_stmt (call (ident out_int) (ident i)))
          (expr_stmt (call (ident out_line) (string ":")))
          (expr_stmt (call (ident out_str) (string "    .ascii ")))
          (expr_stmt (call (ident write_ascii_string) (call (ident string_get_ptr) (ident i)) (call (ident string_get_len) (ident i))))
          (expr_stmt (call (ident out_char) (number 10)))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (assign (ident i) (number 0))
      (while (binop < (ident i) (ident cg_global_count))
        (block
          (expr_stmt (call (ident out_n) (call (ident global_get_name) (ident i)) (call (ident global_get_name_len) (ident i))))
          (expr_stmt (call (ident out_line) (string ":")))
          (expr_stmt (call (ident out_str) (string "    .quad ")))
          (expr_stmt (call (ident out_int) (call (ident eval_constant) (call (ident global_get_init) (ident i)))))
          (expr_stmt (call (ident out_char) (number 10)))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (if (binop > (ident cg_effect_count) (number 0))
        (block
          (expr_stmt (call (ident out_line) (string "__handler_set:")))
          (expr_stmt (call (ident out_line) (string "    .quad 0")))
          (expr_stmt (call (ident out_line) (string "__handler_rbp:")))
          (expr_stmt (call (ident out_line) (string "    .quad 0")))
          (expr_stmt (call (ident out_line) (string "__handler_rsp:")))
          (expr_stmt (call (ident out_line) (string "    .quad 0")))
          (expr_stmt (call (ident out_line) (string "__handler_addr:")))
          (expr_stmt (call (ident out_line) (string "    .quad 0")))
          (expr_stmt (call (ident out_line) (string "__effect_value:")))
          (expr_stmt (call (ident out_line) (string "    .quad 0")))
          (expr_stmt (call (ident out_line) (string "__continuation_ptr:")))
          (expr_stmt (call (ident out_line) (string "    .quad 0")))
          (expr_stmt (call (ident out_line) (string "__effect_name_ptr:")))
          (expr_stmt (call (ident out_line) (string "    .quad 0")))
          (expr_stmt (call (ident out_line) (string "__effect_name_len:")))
          (expr_stmt (call (ident out_line) (string "    .quad 0")))))
      (expr_stmt (call (ident out_char) (number 10)))
      (expr_stmt (call (ident out_line) (string ".section .text")))
      (expr_stmt (call (ident out_line) (string ".globl _start")))
      (expr_stmt (call (ident out_line) (string "_start:")))
      (expr_stmt (call (ident out_line) (string "    mov (%rsp), %rdi")))
      (expr_stmt (call (ident out_line) (string "    lea 8(%rsp), %rsi")))
      (expr_stmt (call (ident out_line) (string "    call ___main")))
      (expr_stmt (call (ident out_line) (string "    mov %rax, %rdi")))
      (expr_stmt (call (ident out_line) (string "    mov $60, %rax")))
      (expr_stmt (call (ident out_line) (string "    syscall")))
      (expr_stmt (call (ident out_char) (number 10)))
      (expr_stmt (call (ident file_write) (ident cg_out_fd) (ident cg_code_buf) (ident cg_code_len)))
      (expr_stmt (call (ident file_close) (ident cg_out_fd)))))
  (func write_ascii_string ((param ptr (type_ptr (type_base u8))) (param len (type_base i64))) (type_base void)
    (block
      (var start (type_ptr (type_base u8)) (binop + (ident ptr) (number 1)))
      (var end (type_base i64) (binop - (ident len) (number 2)))
      (expr_stmt (call (ident out_char) (number 34)))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident end))
        (block
          (var c (type_base u8) (unop * (binop + (ident start) (ident i))))
          (if (binop && (binop == (ident c) (number 92)) (binop < (binop + (ident i) (number 1)) (ident end)))
            (block
              (assign (ident i) (binop + (ident i) (number 1)))
              (var next (type_base u8) (unop * (binop + (ident start) (ident i))))
              (if (binop == (ident next) (number 110))
                (block
                  (expr_stmt (call (ident out_str) (string "\\012"))))
                (if (binop == (ident next) (number 116))
                  (block
                    (expr_stmt (call (ident out_str) (string "\\011"))))
                  (if (binop == (ident next) (number 114))
                    (block
                      (expr_stmt (call (ident out_str) (string "\\015"))))
                    (if (binop == (ident next) (number 92))
                      (block
                        (expr_stmt (call (ident out_str) (string "\\\\"))))
                      (if (binop == (ident next) (number 34))
                        (block
                          (expr_stmt (call (ident out_str) (string "\\\""))))
                        (if (binop == (ident next) (number 48))
                          (block
                            (expr_stmt (call (ident out_str) (string "\\000"))))
                          (block
                            (expr_stmt (call (ident out_char) (ident next)))))))))))
            (if (binop && (binop && (binop && (binop >= (ident c) (number 32)) (binop < (ident c) (number 127))) (binop != (ident c) (number 34))) (binop != (ident c) (number 92)))
              (block
                (expr_stmt (call (ident out_char) (ident c))))
              (block
                (expr_stmt (call (ident out_char) (number 92)))
                (expr_stmt (call (ident out_char) (binop + (number 48) (binop / (ident c) (number 64)))))
                (expr_stmt (call (ident out_char) (binop + (number 48) (binop % (binop / (ident c) (number 8)) (number 8)))))
                (expr_stmt (call (ident out_char) (binop + (number 48) (binop % (ident c) (number 8))))))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (expr_stmt (call (ident out_str) (string "\\000")))
      (expr_stmt (call (ident out_char) (number 34)))))
  (var TOK_EOF (type_base i64) (number 0))
  (var TOK_NUMBER (type_base i64) (number 1))
  (var TOK_IDENT (type_base i64) (number 2))
  (var TOK_STRING (type_base i64) (number 3))
  (var TOK_LPAREN (type_base i64) (number 4))
  (var TOK_RPAREN (type_base i64) (number 5))
  (var TOK_LBRACKET (type_base i64) (number 6))
  (var TOK_RBRACKET (type_base i64) (number 7))
  (var TOK_LBRACE (type_base i64) (number 8))
  (var TOK_RBRACE (type_base i64) (number 9))
  (var TOK_PLUS (type_base i64) (number 10))
  (var TOK_MINUS (type_base i64) (number 11))
  (var TOK_STAR (type_base i64) (number 12))
  (var TOK_SLASH (type_base i64) (number 13))
  (var TOK_PERCENT (type_base i64) (number 14))
  (var TOK_COMMA (type_base i64) (number 15))
  (var TOK_COLON (type_base i64) (number 16))
  (var TOK_SEMI (type_base i64) (number 17))
  (var TOK_DOT (type_base i64) (number 18))
  (var TOK_EQ (type_base i64) (number 19))
  (var TOK_LT (type_base i64) (number 20))
  (var TOK_GT (type_base i64) (number 21))
  (var TOK_BANG (type_base i64) (number 22))
  (var TOK_AMP (type_base i64) (number 23))
  (var TOK_PIPE (type_base i64) (number 24))
  (var TOK_CARET (type_base i64) (number 25))
  (var TOK_UNKNOWN (type_base i64) (number 99))
  (struct Tokenizer ((field_decl input (type_ptr (type_base u8))) (field_decl pos (type_base i64)) (field_decl len (type_base i64)) (field_decl tok_start (type_base i64)) (field_decl tok_len (type_base i64)) (field_decl tok_kind (type_base i64))))
  (func tok_new ((param input (type_ptr (type_base u8)))) (type_ptr (type_base Tokenizer))
    (block
      (var t (type_ptr (type_base Tokenizer)) (call (ident alloc) (number 48)))
      (assign (field (ident t) input) (ident input))
      (assign (field (ident t) pos) (number 0))
      (assign (field (ident t) len) (call (ident strlen) (ident input)))
      (assign (field (ident t) tok_start) (number 0))
      (assign (field (ident t) tok_len) (number 0))
      (assign (field (ident t) tok_kind) (ident TOK_EOF))
      (expr_stmt (call (ident tok_next) (ident t)))
      (return (ident t))))
  (func tok_is_digit ((param c (type_base i64))) (type_base bool)
    (block
      (return (binop && (binop >= (ident c) (number 48)) (binop <= (ident c) (number 57))))))
  (func tok_is_alpha ((param c (type_base i64))) (type_base bool)
    (block
      (return (binop || (binop || (binop && (binop >= (ident c) (number 65)) (binop <= (ident c) (number 90))) (binop && (binop >= (ident c) (number 97)) (binop <= (ident c) (number 122)))) (binop == (ident c) (number 95))))))
  (func tok_is_alnum ((param c (type_base i64))) (type_base bool)
    (block
      (return (binop || (call (ident tok_is_digit) (ident c)) (call (ident tok_is_alpha) (ident c))))))
  (func tok_is_space ((param c (type_base i64))) (type_base bool)
    (block
      (return (binop || (binop || (binop || (binop == (ident c) (number 32)) (binop == (ident c) (number 9))) (binop == (ident c) (number 10))) (binop == (ident c) (number 13))))))
  (func tok_peek_char ((param t (type_ptr (type_base Tokenizer)))) (type_base i64)
    (block
      (if (binop >= (field (ident t) pos) (field (ident t) len))
        (block
          (return (number 0))))
      (return (unop * (binop + (field (ident t) input) (field (ident t) pos))))))
  (func tok_peek_char_at ((param t (type_ptr (type_base Tokenizer))) (param offset (type_base i64))) (type_base i64)
    (block
      (if (binop >= (binop + (field (ident t) pos) (ident offset)) (field (ident t) len))
        (block
          (return (number 0))))
      (return (unop * (binop + (binop + (field (ident t) input) (field (ident t) pos)) (ident offset))))))
  (func tok_advance_char ((param t (type_ptr (type_base Tokenizer)))) (type_base void)
    (block
      (if (binop < (field (ident t) pos) (field (ident t) len))
        (block
          (assign (field (ident t) pos) (binop + (field (ident t) pos) (number 1)))))))
  (func tok_skip_whitespace ((param t (type_ptr (type_base Tokenizer)))) (type_base void)
    (block
      (while (binop && (binop < (field (ident t) pos) (field (ident t) len)) (call (ident tok_is_space) (call (ident tok_peek_char) (ident t))))
        (block
          (expr_stmt (call (ident tok_advance_char) (ident t)))))))
  (func tok_next ((param t (type_ptr (type_base Tokenizer)))) (type_base void)
    (block
      (expr_stmt (call (ident tok_skip_whitespace) (ident t)))
      (assign (field (ident t) tok_start) (field (ident t) pos))
      (assign (field (ident t) tok_len) (number 0))
      (if (binop >= (field (ident t) pos) (field (ident t) len))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_EOF))
          (return)))
      (var c (type_base i64) (call (ident tok_peek_char) (ident t)))
      (if (binop == (ident c) (number 40))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_LPAREN))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 41))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_RPAREN))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 91))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_LBRACKET))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 93))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_RBRACKET))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 123))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_LBRACE))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 125))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_RBRACE))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 43))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_PLUS))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 42))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_STAR))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 47))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_SLASH))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 37))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_PERCENT))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 94))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_CARET))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 44))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_COMMA))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 58))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_COLON))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 59))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_SEMI))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 46))
        (block
          (assign (field (ident t) tok_kind) (ident TOK_DOT))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (binop == (ident c) (number 61))
        (block
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (if (binop == (call (ident tok_peek_char) (ident t)) (number 61))
            (block
              (expr_stmt (call (ident tok_advance_char) (ident t)))
              (assign (field (ident t) tok_len) (number 2)))
            (block
              (assign (field (ident t) tok_len) (number 1))))
          (assign (field (ident t) tok_kind) (ident TOK_EQ))
          (return)))
      (if (binop == (ident c) (number 60))
        (block
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (var next (type_base i64) (call (ident tok_peek_char) (ident t)))
          (if (binop || (binop == (ident next) (number 61)) (binop == (ident next) (number 60)))
            (block
              (expr_stmt (call (ident tok_advance_char) (ident t)))
              (assign (field (ident t) tok_len) (number 2)))
            (block
              (assign (field (ident t) tok_len) (number 1))))
          (assign (field (ident t) tok_kind) (ident TOK_LT))
          (return)))
      (if (binop == (ident c) (number 62))
        (block
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (var next (type_base i64) (call (ident tok_peek_char) (ident t)))
          (if (binop || (binop == (ident next) (number 61)) (binop == (ident next) (number 62)))
            (block
              (expr_stmt (call (ident tok_advance_char) (ident t)))
              (assign (field (ident t) tok_len) (number 2)))
            (block
              (assign (field (ident t) tok_len) (number 1))))
          (assign (field (ident t) tok_kind) (ident TOK_GT))
          (return)))
      (if (binop == (ident c) (number 33))
        (block
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (if (binop == (call (ident tok_peek_char) (ident t)) (number 61))
            (block
              (expr_stmt (call (ident tok_advance_char) (ident t)))
              (assign (field (ident t) tok_len) (number 2)))
            (block
              (assign (field (ident t) tok_len) (number 1))))
          (assign (field (ident t) tok_kind) (ident TOK_BANG))
          (return)))
      (if (binop == (ident c) (number 38))
        (block
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (if (binop == (call (ident tok_peek_char) (ident t)) (number 38))
            (block
              (expr_stmt (call (ident tok_advance_char) (ident t)))
              (assign (field (ident t) tok_len) (number 2)))
            (block
              (assign (field (ident t) tok_len) (number 1))))
          (assign (field (ident t) tok_kind) (ident TOK_AMP))
          (return)))
      (if (binop == (ident c) (number 124))
        (block
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (if (binop == (call (ident tok_peek_char) (ident t)) (number 124))
            (block
              (expr_stmt (call (ident tok_advance_char) (ident t)))
              (assign (field (ident t) tok_len) (number 2)))
            (block
              (assign (field (ident t) tok_len) (number 1))))
          (assign (field (ident t) tok_kind) (ident TOK_PIPE))
          (return)))
      (if (binop == (ident c) (number 45))
        (block
          (if (call (ident tok_is_digit) (call (ident tok_peek_char_at) (ident t) (number 1)))
            (block
              (expr_stmt (call (ident tok_advance_char) (ident t)))
              (while (call (ident tok_is_digit) (call (ident tok_peek_char) (ident t)))
                (block
                  (expr_stmt (call (ident tok_advance_char) (ident t)))))
              (assign (field (ident t) tok_len) (binop - (field (ident t) pos) (field (ident t) tok_start)))
              (assign (field (ident t) tok_kind) (ident TOK_NUMBER))
              (return)))
          (assign (field (ident t) tok_kind) (ident TOK_MINUS))
          (assign (field (ident t) tok_len) (number 1))
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (return)))
      (if (call (ident tok_is_digit) (ident c))
        (block
          (while (call (ident tok_is_digit) (call (ident tok_peek_char) (ident t)))
            (block
              (expr_stmt (call (ident tok_advance_char) (ident t)))))
          (assign (field (ident t) tok_len) (binop - (field (ident t) pos) (field (ident t) tok_start)))
          (assign (field (ident t) tok_kind) (ident TOK_NUMBER))
          (return)))
      (if (call (ident tok_is_alpha) (ident c))
        (block
          (while (call (ident tok_is_alnum) (call (ident tok_peek_char) (ident t)))
            (block
              (expr_stmt (call (ident tok_advance_char) (ident t)))))
          (assign (field (ident t) tok_len) (binop - (field (ident t) pos) (field (ident t) tok_start)))
          (assign (field (ident t) tok_kind) (ident TOK_IDENT))
          (return)))
      (if (binop == (ident c) (number 34))
        (block
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (while (binop && (binop != (call (ident tok_peek_char) (ident t)) (number 0)) (binop != (call (ident tok_peek_char) (ident t)) (number 34)))
            (block
              (if (binop == (call (ident tok_peek_char) (ident t)) (number 92))
                (block
                  (expr_stmt (call (ident tok_advance_char) (ident t)))))
              (expr_stmt (call (ident tok_advance_char) (ident t)))))
          (if (binop == (call (ident tok_peek_char) (ident t)) (number 34))
            (block
              (expr_stmt (call (ident tok_advance_char) (ident t)))))
          (assign (field (ident t) tok_len) (binop - (field (ident t) pos) (field (ident t) tok_start)))
          (assign (field (ident t) tok_kind) (ident TOK_STRING))
          (return)))
      (if (binop == (ident c) (number 39))
        (block
          (expr_stmt (call (ident tok_advance_char) (ident t)))
          (while (binop && (binop != (call (ident tok_peek_char) (ident t)) (number 0)) (binop != (call (ident tok_peek_char) (ident t)) (number 39)))
            (block
              (if (binop == (call (ident tok_peek_char) (ident t)) (number 92))
                (block
                  (expr_stmt (call (ident tok_advance_char) (ident t)))))
              (expr_stmt (call (ident tok_advance_char) (ident t)))))
          (if (binop == (call (ident tok_peek_char) (ident t)) (number 39))
            (block
              (expr_stmt (call (ident tok_advance_char) (ident t)))))
          (assign (field (ident t) tok_len) (binop - (field (ident t) pos) (field (ident t) tok_start)))
          (assign (field (ident t) tok_kind) (ident TOK_STRING))
          (return)))
      (assign (field (ident t) tok_kind) (ident TOK_UNKNOWN))
      (assign (field (ident t) tok_len) (number 1))
      (expr_stmt (call (ident tok_advance_char) (ident t)))))
  (func tok_kind ((param t (type_ptr (type_base Tokenizer)))) (type_base i64)
    (block
      (return (field (ident t) tok_kind))))
  (func tok_eof ((param t (type_ptr (type_base Tokenizer)))) (type_base bool)
    (block
      (return (binop == (field (ident t) tok_kind) (ident TOK_EOF)))))
  (func tok_text_ptr ((param t (type_ptr (type_base Tokenizer)))) (type_ptr (type_base u8))
    (block
      (return (binop + (field (ident t) input) (field (ident t) tok_start)))))
  (func tok_text_len ((param t (type_ptr (type_base Tokenizer)))) (type_base i64)
    (block
      (return (field (ident t) tok_len))))
  (func tok_text ((param t (type_ptr (type_base Tokenizer)))) (type_ptr (type_base u8))
    (block
      (var buf (type_ptr (type_base u8)) (call (ident alloc) (binop + (field (ident t) tok_len) (number 1))))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (field (ident t) tok_len))
        (block
          (assign (unop * (binop + (ident buf) (ident i))) (unop * (binop + (binop + (field (ident t) input) (field (ident t) tok_start)) (ident i))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (assign (unop * (binop + (ident buf) (field (ident t) tok_len))) (number 0))
      (return (ident buf))))
  (func tok_number ((param t (type_ptr (type_base Tokenizer)))) (type_base i64)
    (block
      (var ptr (type_ptr (type_base u8)) (binop + (field (ident t) input) (field (ident t) tok_start)))
      (var len (type_base i64) (field (ident t) tok_len))
      (var neg (type_base i64) (number 0))
      (var i (type_base i64) (number 0))
      (if (binop && (binop > (ident len) (number 0)) (binop == (unop * (ident ptr)) (number 45)))
        (block
          (assign (ident neg) (number 1))
          (assign (ident i) (number 1))))
      (var n (type_base i64) (number 0))
      (while (binop < (ident i) (ident len))
        (block
          (assign (ident n) (binop + (binop * (ident n) (number 10)) (binop - (unop * (binop + (ident ptr) (ident i))) (number 48))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (if (binop != (ident neg) (number 0))
        (block
          (return (binop - (number 0) (ident n)))))
      (return (ident n))))
  (func tok_string_value ((param t (type_ptr (type_base Tokenizer)))) (type_ptr (type_base u8))
    (block
      (var start (type_ptr (type_base u8)) (binop + (binop + (field (ident t) input) (field (ident t) tok_start)) (number 1)))
      (var len (type_base i64) (binop - (field (ident t) tok_len) (number 2)))
      (var buf (type_ptr (type_base u8)) (call (ident alloc) (binop + (ident len) (number 1))))
      (var i (type_base i64) (number 0))
      (var j (type_base i64) (number 0))
      (while (binop < (ident i) (ident len))
        (block
          (var c (type_base i64) (unop * (binop + (ident start) (ident i))))
          (if (binop && (binop == (ident c) (number 92)) (binop < (binop + (ident i) (number 1)) (ident len)))
            (block
              (assign (ident i) (binop + (ident i) (number 1)))
              (var next (type_base i64) (unop * (binop + (ident start) (ident i))))
              (if (binop == (ident next) (number 110))
                (block
                  (assign (ident c) (number 10)))
                (if (binop == (ident next) (number 114))
                  (block
                    (assign (ident c) (number 13)))
                  (if (binop == (ident next) (number 116))
                    (block
                      (assign (ident c) (number 9)))
                    (if (binop == (ident next) (number 34))
                      (block
                        (assign (ident c) (number 34)))
                      (if (binop == (ident next) (number 92))
                        (block
                          (assign (ident c) (number 92)))
                        (block
                          (assign (ident c) (ident next))))))))))
          (assign (unop * (binop + (ident buf) (ident j))) (ident c))
          (assign (ident i) (binop + (ident i) (number 1)))
          (assign (ident j) (binop + (ident j) (number 1)))))
      (assign (unop * (binop + (ident buf) (ident j))) (number 0))
      (return (ident buf))))
  (func tok_check ((param t (type_ptr (type_base Tokenizer))) (param kind (type_base i64))) (type_base bool)
    (block
      (return (binop == (field (ident t) tok_kind) (ident kind)))))
  (func tok_match ((param t (type_ptr (type_base Tokenizer))) (param kind (type_base i64))) (type_base bool)
    (block
      (if (binop == (field (ident t) tok_kind) (ident kind))
        (block
          (expr_stmt (call (ident tok_next) (ident t)))
          (return (bool true))))
      (return (bool false))))
  (func tok_expect ((param t (type_ptr (type_base Tokenizer))) (param kind (type_base i64))) (type_base bool)
    (block
      (if (binop != (field (ident t) tok_kind) (ident kind))
        (block
          (return (bool false))))
      (expr_stmt (call (ident tok_next) (ident t)))
      (return (bool true))))
  (struct PNode ((field_decl kind (type_base i64)) (field_decl text (type_ptr (type_base u8))) (field_decl children (type_ptr (type_base u8)))))
  (var PNODE_NUMBER (type_base i64) (number 1))
  (var PNODE_SYMBOL (type_base i64) (number 2))
  (var PNODE_STRING (type_base i64) (number 3))
  (var PNODE_LIST (type_base i64) (number 4))
  (var PNODE_OPERATOR (type_base i64) (number 5))
  (func pnode_new ((param kind (type_base i64))) (type_ptr (type_base PNode))
    (block
      (var n (type_ptr (type_base PNode)) (call (ident alloc) (number 24)))
      (assign (field (ident n) kind) (ident kind))
      (assign (field (ident n) text) (nil))
      (assign (field (ident n) children) (nil))
      (return (ident n))))
  (func pnode_atom ((param kind (type_base i64)) (param text (type_ptr (type_base u8)))) (type_ptr (type_base PNode))
    (block
      (var n (type_ptr (type_base PNode)) (call (ident pnode_new) (ident kind)))
      (assign (field (ident n) text) (ident text))
      (return (ident n))))
  (func pnode_list ((param children (type_ptr (type_base u8)))) (type_ptr (type_base PNode))
    (block
      (var n (type_ptr (type_base PNode)) (call (ident pnode_new) (ident PNODE_LIST)))
      (assign (field (ident n) children) (ident children))
      (return (ident n))))
  (func is_operator_token ((param kind (type_base i64))) (type_base bool)
    (block
      (return (binop || (binop || (binop || (binop || (binop || (binop || (binop || (binop || (binop || (binop || (binop || (binop == (ident kind) (ident TOK_PLUS)) (binop == (ident kind) (ident TOK_MINUS))) (binop == (ident kind) (ident TOK_STAR))) (binop == (ident kind) (ident TOK_SLASH))) (binop == (ident kind) (ident TOK_PERCENT))) (binop == (ident kind) (ident TOK_AMP))) (binop == (ident kind) (ident TOK_PIPE))) (binop == (ident kind) (ident TOK_CARET))) (binop == (ident kind) (ident TOK_LT))) (binop == (ident kind) (ident TOK_GT))) (binop == (ident kind) (ident TOK_BANG))) (binop == (ident kind) (ident TOK_EQ))))))
  (func parse_sexpr ((param t (type_ptr (type_base Tokenizer)))) (type_ptr (type_base PNode))
    (block
      (var kind (type_base i64) (call (ident tok_kind) (ident t)))
      (if (binop == (ident kind) (ident TOK_NUMBER))
        (block
          (var text (type_ptr (type_base u8)) (call (ident tok_text) (ident t)))
          (expr_stmt (call (ident tok_next) (ident t)))
          (return (call (ident pnode_atom) (ident PNODE_NUMBER) (ident text)))))
      (if (binop == (ident kind) (ident TOK_IDENT))
        (block
          (var text (type_ptr (type_base u8)) (call (ident tok_text) (ident t)))
          (expr_stmt (call (ident tok_next) (ident t)))
          (return (call (ident pnode_atom) (ident PNODE_SYMBOL) (ident text)))))
      (if (binop == (ident kind) (ident TOK_STRING))
        (block
          (var text (type_ptr (type_base u8)) (call (ident tok_text) (ident t)))
          (expr_stmt (call (ident tok_next) (ident t)))
          (return (call (ident pnode_atom) (ident PNODE_STRING) (ident text)))))
      (if (call (ident is_operator_token) (ident kind))
        (block
          (var text (type_ptr (type_base u8)) (call (ident tok_text) (ident t)))
          (expr_stmt (call (ident tok_next) (ident t)))
          (return (call (ident pnode_atom) (ident PNODE_OPERATOR) (ident text)))))
      (if (binop == (ident kind) (ident TOK_LPAREN))
        (block
          (expr_stmt (call (ident tok_next) (ident t)))
          (var children (type_ptr (type_base u8)) (call (ident vec_new) (number 8)))
          (while (binop && (binop != (call (ident tok_kind) (ident t)) (ident TOK_RPAREN)) (binop != (call (ident tok_kind) (ident t)) (ident TOK_EOF)))
            (block
              (var child (type_ptr (type_base PNode)) (call (ident parse_sexpr) (ident t)))
              (if (binop == (ident child) (nil))
                (block
                  (return (nil))))
              (expr_stmt (call (ident vec_push) (ident children) (ident child)))))
          (if (binop != (call (ident tok_kind) (ident t)) (ident TOK_RPAREN))
            (block
              (expr_stmt (call (ident eprintln) (string "Error: expected ')' in S-expression")))
              (return (nil))))
          (expr_stmt (call (ident tok_next) (ident t)))
          (return (call (ident pnode_list) (ident children)))))
      (expr_stmt (call (ident eprint) (string "Error: unexpected token in S-expression: ")))
      (expr_stmt (call (ident eprintln) (call (ident tok_text) (ident t))))
      (return (nil))))
  (func sexpr_get ((param node (type_ptr (type_base PNode))) (param i (type_base i64))) (type_ptr (type_base PNode))
    (block
      (return (call (ident vec_get) (field (ident node) children) (ident i)))))
  (func sexpr_len ((param node (type_ptr (type_base PNode)))) (type_base i64)
    (block
      (return (call (ident vec_len) (field (ident node) children)))))
  (func sexpr_inner ((param node (type_ptr (type_base PNode)))) (type_ptr (type_base PNode))
    (block
      (return (ident node))))
  (func sexpr_is ((param node (type_ptr (type_base PNode))) (param name (type_ptr (type_base u8)))) (type_base bool)
    (block
      (if (binop == (ident node) (nil))
        (block
          (return (bool false))))
      (if (binop != (field (ident node) kind) (ident PNODE_SYMBOL))
        (block
          (return (bool false))))
      (return (call (ident streq) (field (ident node) text) (ident name)))))
  (func sexpr_head ((param node (type_ptr (type_base PNode)))) (type_ptr (type_base u8))
    (block
      (if (binop == (ident node) (nil))
        (block
          (return (nil))))
      (if (binop != (field (ident node) kind) (ident PNODE_LIST))
        (block
          (return (nil))))
      (if (binop == (call (ident sexpr_len) (ident node)) (number 0))
        (block
          (return (nil))))
      (var first (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 0)))
      (if (binop != (field (ident first) kind) (ident PNODE_SYMBOL))
        (block
          (return (nil))))
      (return (field (ident first) text))))
  (func sexpr_strdup ((param s (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var len (type_base i64) (call (ident strlen) (ident s)))
      (var buf (type_ptr (type_base u8)) (call (ident alloc) (binop + (ident len) (number 1))))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident len))
        (block
          (assign (unop * (binop + (ident buf) (ident i))) (unop * (binop + (ident s) (ident i))))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (assign (unop * (binop + (ident buf) (ident len))) (number 0))
      (return (ident buf))))
  (func sexpr_parse_string ((param quoted (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var len (type_base i64) (call (ident strlen) (ident quoted)))
      (var buf (type_ptr (type_base u8)) (call (ident alloc) (binop + (ident len) (number 1))))
      (var out (type_base i64) (number 0))
      (var i (type_base i64) (number 1))
      (while (binop < (ident i) (binop - (ident len) (number 1)))
        (block
          (var c (type_base u8) (unop * (binop + (ident quoted) (ident i))))
          (if (binop && (binop == (ident c) (number 92)) (binop < (binop + (ident i) (number 1)) (binop - (ident len) (number 1))))
            (block
              (var next (type_base u8) (unop * (binop + (binop + (ident quoted) (ident i)) (number 1))))
              (if (binop == (ident next) (number 110))
                (block
                  (assign (unop * (binop + (ident buf) (ident out))) (number 10))
                  (assign (ident out) (binop + (ident out) (number 1)))
                  (assign (ident i) (binop + (ident i) (number 2))))
                (if (binop == (ident next) (number 116))
                  (block
                    (assign (unop * (binop + (ident buf) (ident out))) (number 9))
                    (assign (ident out) (binop + (ident out) (number 1)))
                    (assign (ident i) (binop + (ident i) (number 2))))
                  (if (binop == (ident next) (number 114))
                    (block
                      (assign (unop * (binop + (ident buf) (ident out))) (number 13))
                      (assign (ident out) (binop + (ident out) (number 1)))
                      (assign (ident i) (binop + (ident i) (number 2))))
                    (if (binop == (ident next) (number 48))
                      (block
                        (assign (unop * (binop + (ident buf) (ident out))) (number 0))
                        (assign (ident out) (binop + (ident out) (number 1)))
                        (assign (ident i) (binop + (ident i) (number 2))))
                      (if (binop == (ident next) (number 34))
                        (block
                          (assign (unop * (binop + (ident buf) (ident out))) (number 34))
                          (assign (ident out) (binop + (ident out) (number 1)))
                          (assign (ident i) (binop + (ident i) (number 2))))
                        (if (binop == (ident next) (number 92))
                          (block
                            (assign (unop * (binop + (ident buf) (ident out))) (number 92))
                            (assign (ident out) (binop + (ident out) (number 1)))
                            (assign (ident i) (binop + (ident i) (number 2))))
                          (block
                            (assign (unop * (binop + (ident buf) (ident out))) (ident c))
                            (assign (ident out) (binop + (ident out) (number 1)))
                            (assign (ident i) (binop + (ident i) (number 1)))))))))))
            (block
              (assign (unop * (binop + (ident buf) (ident out))) (ident c))
              (assign (ident out) (binop + (ident out) (number 1)))
              (assign (ident i) (binop + (ident i) (number 1)))))))
      (assign (unop * (binop + (ident buf) (ident out))) (number 0))
      (return (ident buf))))
  (func sexpr_op_to_token ((param op (type_ptr (type_base u8)))) (type_base i64)
    (block
      (if (call (ident streq) (ident op) (string "+"))
        (block
          (return (ident TOKEN_PLUS))))
      (if (call (ident streq) (ident op) (string "-"))
        (block
          (return (ident TOKEN_MINUS))))
      (if (call (ident streq) (ident op) (string "*"))
        (block
          (return (ident TOKEN_STAR))))
      (if (call (ident streq) (ident op) (string "/"))
        (block
          (return (ident TOKEN_SLASH))))
      (if (call (ident streq) (ident op) (string "%"))
        (block
          (return (ident TOKEN_PERCENT))))
      (if (call (ident streq) (ident op) (string "&"))
        (block
          (return (ident TOKEN_AMP))))
      (if (call (ident streq) (ident op) (string "|"))
        (block
          (return (ident TOKEN_PIPE))))
      (if (call (ident streq) (ident op) (string "^"))
        (block
          (return (ident TOKEN_CARET))))
      (if (call (ident streq) (ident op) (string "<<"))
        (block
          (return (ident TOKEN_LTLT))))
      (if (call (ident streq) (ident op) (string ">>"))
        (block
          (return (ident TOKEN_GTGT))))
      (if (call (ident streq) (ident op) (string "=="))
        (block
          (return (ident TOKEN_EQEQ))))
      (if (call (ident streq) (ident op) (string "!="))
        (block
          (return (ident TOKEN_BANGEQ))))
      (if (call (ident streq) (ident op) (string "<"))
        (block
          (return (ident TOKEN_LT))))
      (if (call (ident streq) (ident op) (string ">"))
        (block
          (return (ident TOKEN_GT))))
      (if (call (ident streq) (ident op) (string "<="))
        (block
          (return (ident TOKEN_LTEQ))))
      (if (call (ident streq) (ident op) (string ">="))
        (block
          (return (ident TOKEN_GTEQ))))
      (if (call (ident streq) (ident op) (string "&&"))
        (block
          (return (ident TOKEN_AMPAMP))))
      (if (call (ident streq) (ident op) (string "||"))
        (block
          (return (ident TOKEN_PIPEPIPE))))
      (if (call (ident streq) (ident op) (string "!"))
        (block
          (return (ident TOKEN_BANG))))
      (return (number 0))))
  (func sexpr_to_type ((param node (type_ptr (type_base PNode)))) (type_ptr (type_base u8))
    (block
      (if (binop == (ident node) (nil))
        (block
          (return (nil))))
      (if (binop && (binop == (field (ident node) kind) (ident PNODE_SYMBOL)) (call (ident streq) (field (ident node) text) (string "nil")))
        (block
          (return (nil))))
      (if (binop != (field (ident node) kind) (ident PNODE_LIST))
        (block
          (return (nil))))
      (var head (type_ptr (type_base u8)) (call (ident sexpr_head) (ident node)))
      (if (binop == (ident head) (nil))
        (block
          (return (nil))))
      (if (call (ident streq) (ident head) (string "type_base"))
        (block
          (var t (type_ptr (type_base u8)) (call (ident base_type_alloc)))
          (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident base_type_set_name) (ident t) (call (ident sexpr_strdup) (field (ident name_node) text))))
          (expr_stmt (call (ident base_type_set_name_len) (ident t) (call (ident strlen) (field (ident name_node) text))))
          (return (ident t))))
      (if (call (ident streq) (ident head) (string "type_ptr"))
        (block
          (var t (type_ptr (type_base u8)) (call (ident ptr_type_alloc)))
          (expr_stmt (call (ident ptr_type_set_elem) (ident t) (call (ident sexpr_to_type) (call (ident sexpr_get) (ident node) (number 1)))))
          (return (ident t))))
      (if (call (ident streq) (ident head) (string "type_func"))
        (block
          (var t (type_ptr (type_base u8)) (call (ident func_type_alloc)))
          (var params_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (var params_inner (type_ptr (type_base PNode)) (call (ident sexpr_inner) (ident params_node)))
          (var count (type_base i64) (call (ident vec_len) (field (ident params_inner) children)))
          (var params (type_ptr (type_base u8)) (call (ident vec_new) (ident count)))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident count))
            (block
              (var pt (type_ptr (type_base u8)) (call (ident sexpr_to_type) (call (ident vec_get) (field (ident params_inner) children) (ident i))))
              (expr_stmt (call (ident vec_push) (ident params) (ident pt)))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident func_type_set_params) (ident t) (ident params)))
          (expr_stmt (call (ident func_type_set_param_count) (ident t) (ident count)))
          (expr_stmt (call (ident func_type_set_ret) (ident t) (call (ident sexpr_to_type) (call (ident sexpr_get) (ident node) (number 2)))))
          (return (ident t))))
      (if (call (ident streq) (ident head) (string "type_closure"))
        (block
          (var t (type_ptr (type_base u8)) (call (ident closure_type_alloc)))
          (var params_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (var params_inner (type_ptr (type_base PNode)) (call (ident sexpr_inner) (ident params_node)))
          (var count (type_base i64) (call (ident vec_len) (field (ident params_inner) children)))
          (var params (type_ptr (type_base u8)) (call (ident vec_new) (ident count)))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident count))
            (block
              (var pt (type_ptr (type_base u8)) (call (ident sexpr_to_type) (call (ident vec_get) (field (ident params_inner) children) (ident i))))
              (expr_stmt (call (ident vec_push) (ident params) (ident pt)))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident closure_type_set_params) (ident t) (ident params)))
          (expr_stmt (call (ident closure_type_set_param_count) (ident t) (ident count)))
          (expr_stmt (call (ident closure_type_set_ret) (ident t) (call (ident sexpr_to_type) (call (ident sexpr_get) (ident node) (number 2)))))
          (return (ident t))))
      (return (nil))))
  (func sexpr_to_pattern ((param node (type_ptr (type_base PNode)))) (type_ptr (type_base u8))
    (block
      (if (binop == (ident node) (nil))
        (block
          (return (nil))))
      (if (binop != (field (ident node) kind) (ident PNODE_LIST))
        (block
          (return (nil))))
      (var head (type_ptr (type_base u8)) (call (ident sexpr_head) (ident node)))
      (if (binop == (ident head) (nil))
        (block
          (return (nil))))
      (if (call (ident streq) (ident head) (string "pattern_wildcard"))
        (block
          (return (call (ident pattern_wildcard_alloc)))))
      (if (call (ident streq) (ident head) (string "pattern_variant"))
        (block
          (var p (type_ptr (type_base u8)) (call (ident pattern_variant_alloc)))
          (var enum_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (var var_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 2)))
          (expr_stmt (call (ident pattern_variant_set_enum_name) (ident p) (call (ident sexpr_strdup) (field (ident enum_node) text))))
          (expr_stmt (call (ident pattern_variant_set_enum_len) (ident p) (call (ident strlen) (field (ident enum_node) text))))
          (expr_stmt (call (ident pattern_variant_set_name) (ident p) (call (ident sexpr_strdup) (field (ident var_node) text))))
          (expr_stmt (call (ident pattern_variant_set_name_len) (ident p) (call (ident strlen) (field (ident var_node) text))))
          (if (binop > (call (ident sexpr_len) (ident node)) (number 3))
            (block
              (var bind_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 3)))
              (expr_stmt (call (ident pattern_variant_set_binding) (ident p) (call (ident sexpr_strdup) (field (ident bind_node) text))))
              (expr_stmt (call (ident pattern_variant_set_binding_len) (ident p) (call (ident strlen) (field (ident bind_node) text)))))
            (block
              (expr_stmt (call (ident pattern_variant_set_binding) (ident p) (nil)))
              (expr_stmt (call (ident pattern_variant_set_binding_len) (ident p) (number 0)))))
          (return (ident p))))
      (return (nil))))
  (func sexpr_to_param ((param node (type_ptr (type_base PNode))) (param params_buf (type_ptr (type_base u8))) (param index (type_base i64))) (type_base void)
    (block
      (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
      (var type_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 2)))
      (var p (type_ptr (type_base u8)) (binop + (ident params_buf) (binop * (ident index) (number 24))))
      (expr_stmt (call (ident param_set_name) (ident p) (call (ident sexpr_strdup) (field (ident name_node) text))))
      (expr_stmt (call (ident param_set_name_len) (ident p) (call (ident strlen) (field (ident name_node) text))))
      (expr_stmt (call (ident param_set_type) (ident p) (call (ident sexpr_to_type) (ident type_node))))))
  (func sexpr_to_node ((param node (type_ptr (type_base PNode)))) (type_ptr (type_base u8))
    (block
      (if (binop == (ident node) (nil))
        (block
          (return (nil))))
      (if (binop && (binop == (field (ident node) kind) (ident PNODE_SYMBOL)) (call (ident streq) (field (ident node) text) (string "nil")))
        (block
          (return (nil))))
      (if (binop != (field (ident node) kind) (ident PNODE_LIST))
        (block
          (expr_stmt (call (ident eprintln) (string "Error: expected S-expression list")))
          (return (nil))))
      (var head (type_ptr (type_base u8)) (call (ident sexpr_head) (ident node)))
      (if (binop == (ident head) (nil))
        (block
          (expr_stmt (call (ident eprintln) (string "Error: empty S-expression")))
          (return (nil))))
      (if (call (ident streq) (ident head) (string "func"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident func_decl_alloc)))
          (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident func_decl_set_name) (ident n) (call (ident sexpr_strdup) (field (ident name_node) text))))
          (expr_stmt (call (ident func_decl_set_name_len) (ident n) (call (ident strlen) (field (ident name_node) text))))
          (var params_list (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 2)))
          (var params_inner (type_ptr (type_base PNode)) (call (ident sexpr_inner) (ident params_list)))
          (var param_count (type_base i64) (call (ident vec_len) (field (ident params_inner) children)))
          (var params (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident param_count) (number 24))))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident param_count))
            (block
              (expr_stmt (call (ident sexpr_to_param) (call (ident vec_get) (field (ident params_inner) children) (ident i)) (ident params) (ident i)))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident func_decl_set_params) (ident n) (ident params)))
          (expr_stmt (call (ident func_decl_set_param_count) (ident n) (ident param_count)))
          (expr_stmt (call (ident func_decl_set_ret_type) (ident n) (call (ident sexpr_to_type) (call (ident sexpr_get) (ident node) (number 3)))))
          (expr_stmt (call (ident func_decl_set_body) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 4)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "var"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident var_decl_alloc)))
          (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident var_decl_set_name) (ident n) (call (ident sexpr_strdup) (field (ident name_node) text))))
          (expr_stmt (call (ident var_decl_set_name_len) (ident n) (call (ident strlen) (field (ident name_node) text))))
          (expr_stmt (call (ident var_decl_set_type) (ident n) (call (ident sexpr_to_type) (call (ident sexpr_get) (ident node) (number 2)))))
          (if (binop > (call (ident sexpr_len) (ident node)) (number 3))
            (block
              (expr_stmt (call (ident var_decl_set_init) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 3))))))
            (block
              (expr_stmt (call (ident var_decl_set_init) (ident n) (nil)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "struct"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident struct_decl_alloc)))
          (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident struct_decl_set_name) (ident n) (call (ident sexpr_strdup) (field (ident name_node) text))))
          (expr_stmt (call (ident struct_decl_set_name_len) (ident n) (call (ident strlen) (field (ident name_node) text))))
          (var fields_list (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 2)))
          (var fields_inner (type_ptr (type_base PNode)) (call (ident sexpr_inner) (ident fields_list)))
          (var field_count (type_base i64) (call (ident vec_len) (field (ident fields_inner) children)))
          (var fields (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident field_count) (number 24))))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident field_count))
            (block
              (var f_node (type_ptr (type_base PNode)) (call (ident vec_get) (field (ident fields_inner) children) (ident i)))
              (var f (type_ptr (type_base u8)) (binop + (ident fields) (binop * (ident i) (number 24))))
              (var fname (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident f_node) (number 1)))
              (expr_stmt (call (ident struct_field_set_name) (ident f) (call (ident sexpr_strdup) (field (ident fname) text))))
              (expr_stmt (call (ident struct_field_set_name_len) (ident f) (call (ident strlen) (field (ident fname) text))))
              (expr_stmt (call (ident struct_field_set_type) (ident f) (call (ident sexpr_to_type) (call (ident sexpr_get) (ident f_node) (number 2)))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident struct_decl_set_fields) (ident n) (ident fields)))
          (expr_stmt (call (ident struct_decl_set_field_count) (ident n) (ident field_count)))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "enum"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident enum_decl_alloc)))
          (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident enum_decl_set_name) (ident n) (call (ident sexpr_strdup) (field (ident name_node) text))))
          (expr_stmt (call (ident enum_decl_set_name_len) (ident n) (call (ident strlen) (field (ident name_node) text))))
          (var variants_list (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 2)))
          (var variants_inner (type_ptr (type_base PNode)) (call (ident sexpr_inner) (ident variants_list)))
          (var variant_count (type_base i64) (call (ident vec_len) (field (ident variants_inner) children)))
          (var variants (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident variant_count) (number 32))))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident variant_count))
            (block
              (var v_node (type_ptr (type_base PNode)) (call (ident vec_get) (field (ident variants_inner) children) (ident i)))
              (var v (type_ptr (type_base u8)) (binop + (ident variants) (binop * (ident i) (number 32))))
              (var vname (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident v_node) (number 1)))
              (expr_stmt (call (ident enum_variant_set_name) (ident v) (call (ident sexpr_strdup) (field (ident vname) text))))
              (expr_stmt (call (ident enum_variant_set_name_len) (ident v) (call (ident strlen) (field (ident vname) text))))
              (if (binop > (call (ident sexpr_len) (ident v_node)) (number 2))
                (block
                  (expr_stmt (call (ident enum_variant_set_type) (ident v) (call (ident sexpr_to_type) (call (ident sexpr_get) (ident v_node) (number 2))))))
                (block
                  (expr_stmt (call (ident enum_variant_set_type) (ident v) (nil)))))
              (expr_stmt (call (ident enum_variant_set_tag) (ident v) (ident i)))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident enum_decl_set_variants) (ident n) (ident variants)))
          (expr_stmt (call (ident enum_decl_set_variant_count) (ident n) (ident variant_count)))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "effect"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident effect_decl_alloc)))
          (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident effect_decl_set_name) (ident n) (call (ident sexpr_strdup) (field (ident name_node) text))))
          (expr_stmt (call (ident effect_decl_set_name_len) (ident n) (call (ident strlen) (field (ident name_node) text))))
          (var params_list (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 2)))
          (var params_inner (type_ptr (type_base PNode)) (call (ident sexpr_inner) (ident params_list)))
          (var param_count (type_base i64) (call (ident vec_len) (field (ident params_inner) children)))
          (var params (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident param_count) (number 8))))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident param_count))
            (block
              (var pt (type_ptr (type_base u8)) (call (ident sexpr_to_type) (call (ident vec_get) (field (ident params_inner) children) (ident i))))
              (var pp (type_ptr (type_ptr (type_base u8))) (binop + (ident params) (binop * (ident i) (number 8))))
              (assign (unop * (ident pp)) (ident pt))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident effect_decl_set_param_types) (ident n) (ident params)))
          (expr_stmt (call (ident effect_decl_set_param_type_count) (ident n) (ident param_count)))
          (expr_stmt (call (ident effect_decl_set_return_type) (ident n) (call (ident sexpr_to_type) (call (ident sexpr_get) (ident node) (number 3)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "include"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident include_decl_alloc)))
          (var path_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (var path (type_ptr (type_base u8)) (call (ident sexpr_parse_string) (field (ident path_node) text)))
          (expr_stmt (call (ident include_decl_set_path) (ident n) (ident path)))
          (expr_stmt (call (ident include_decl_set_path_len) (ident n) (call (ident strlen) (ident path))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "reader"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident reader_decl_alloc)))
          (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident reader_decl_set_name) (ident n) (call (ident sexpr_strdup) (field (ident name_node) text))))
          (expr_stmt (call (ident reader_decl_set_name_len) (ident n) (call (ident strlen) (field (ident name_node) text))))
          (var param_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 2)))
          (expr_stmt (call (ident reader_decl_set_param_name) (ident n) (call (ident sexpr_strdup) (field (ident param_node) text))))
          (expr_stmt (call (ident reader_decl_set_param_len) (ident n) (call (ident strlen) (field (ident param_node) text))))
          (expr_stmt (call (ident reader_decl_set_body) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 3)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "block"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident block_stmt_alloc)))
          (var count (type_base i64) (binop - (call (ident sexpr_len) (ident node)) (number 1)))
          (var stmts (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident count) (number 8))))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident count))
            (block
              (var stmt (type_ptr (type_base u8)) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (binop + (ident i) (number 1)))))
              (var sp (type_ptr (type_ptr (type_base u8))) (binop + (ident stmts) (binop * (ident i) (number 8))))
              (assign (unop * (ident sp)) (ident stmt))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident block_stmt_set_stmts) (ident n) (ident stmts)))
          (expr_stmt (call (ident block_stmt_set_count) (ident n) (ident count)))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "block_expr"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident block_expr_alloc)))
          (var total (type_base i64) (binop - (call (ident sexpr_len) (ident node)) (number 1)))
          (var stmt_count (type_base i64) (binop - (ident total) (number 1)))
          (var stmts (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident stmt_count) (number 8))))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident stmt_count))
            (block
              (var stmt (type_ptr (type_base u8)) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (binop + (ident i) (number 1)))))
              (var sp (type_ptr (type_ptr (type_base u8))) (binop + (ident stmts) (binop * (ident i) (number 8))))
              (assign (unop * (ident sp)) (ident stmt))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident block_expr_set_stmts) (ident n) (ident stmts)))
          (expr_stmt (call (ident block_expr_set_count) (ident n) (ident stmt_count)))
          (expr_stmt (call (ident block_expr_set_tail) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (ident total)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "if"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident if_stmt_alloc)))
          (expr_stmt (call (ident if_stmt_set_cond) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 1)))))
          (expr_stmt (call (ident if_stmt_set_then) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 2)))))
          (if (binop > (call (ident sexpr_len) (ident node)) (number 3))
            (block
              (expr_stmt (call (ident if_stmt_set_else) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 3))))))
            (block
              (expr_stmt (call (ident if_stmt_set_else) (ident n) (nil)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "while"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident while_stmt_alloc)))
          (expr_stmt (call (ident while_stmt_set_cond) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 1)))))
          (expr_stmt (call (ident while_stmt_set_body) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 2)))))
          (if (binop > (call (ident sexpr_len) (ident node)) (number 3))
            (block
              (var label_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 3)))
              (expr_stmt (call (ident while_stmt_set_label) (ident n) (call (ident sexpr_strdup) (field (ident label_node) text))))
              (expr_stmt (call (ident while_stmt_set_label_len) (ident n) (call (ident strlen) (field (ident label_node) text)))))
            (block
              (expr_stmt (call (ident while_stmt_set_label) (ident n) (nil)))
              (expr_stmt (call (ident while_stmt_set_label_len) (ident n) (number 0)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "return"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident return_stmt_alloc)))
          (if (binop > (call (ident sexpr_len) (ident node)) (number 1))
            (block
              (expr_stmt (call (ident return_stmt_set_value) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 1))))))
            (block
              (expr_stmt (call (ident return_stmt_set_value) (ident n) (nil)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "break"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident break_stmt_alloc)))
          (if (binop > (call (ident sexpr_len) (ident node)) (number 1))
            (block
              (var label_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
              (expr_stmt (call (ident break_stmt_set_label) (ident n) (call (ident sexpr_strdup) (field (ident label_node) text))))
              (expr_stmt (call (ident break_stmt_set_label_len) (ident n) (call (ident strlen) (field (ident label_node) text)))))
            (block
              (expr_stmt (call (ident break_stmt_set_label) (ident n) (nil)))
              (expr_stmt (call (ident break_stmt_set_label_len) (ident n) (number 0)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "continue"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident continue_stmt_alloc)))
          (if (binop > (call (ident sexpr_len) (ident node)) (number 1))
            (block
              (var label_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
              (expr_stmt (call (ident continue_stmt_set_label) (ident n) (call (ident sexpr_strdup) (field (ident label_node) text))))
              (expr_stmt (call (ident continue_stmt_set_label_len) (ident n) (call (ident strlen) (field (ident label_node) text)))))
            (block
              (expr_stmt (call (ident continue_stmt_set_label) (ident n) (nil)))
              (expr_stmt (call (ident continue_stmt_set_label_len) (ident n) (number 0)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "expr_stmt"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident expr_stmt_alloc)))
          (expr_stmt (call (ident expr_stmt_set_expr) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 1)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "assign"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident assign_stmt_alloc)))
          (expr_stmt (call (ident assign_stmt_set_target) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 1)))))
          (expr_stmt (call (ident assign_stmt_set_value) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 2)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "ident"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident ident_expr_alloc)))
          (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident ident_expr_set_name) (ident n) (call (ident sexpr_strdup) (field (ident name_node) text))))
          (expr_stmt (call (ident ident_expr_set_name_len) (ident n) (call (ident strlen) (field (ident name_node) text))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "number"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident number_expr_alloc)))
          (var val_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident number_expr_set_value) (ident n) (call (ident sexpr_strdup) (field (ident val_node) text))))
          (expr_stmt (call (ident number_expr_set_value_len) (ident n) (call (ident strlen) (field (ident val_node) text))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "string"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident string_expr_alloc)))
          (var val_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident string_expr_set_value) (ident n) (field (ident val_node) text)))
          (expr_stmt (call (ident string_expr_set_value_len) (ident n) (call (ident strlen) (field (ident val_node) text))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "bool"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident bool_expr_alloc)))
          (var val_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (if (call (ident streq) (field (ident val_node) text) (string "true"))
            (block
              (expr_stmt (call (ident bool_expr_set_value) (ident n) (number 1))))
            (block
              (expr_stmt (call (ident bool_expr_set_value) (ident n) (number 0)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "nil"))
        (block
          (return (call (ident nil_expr_alloc)))))
      (if (call (ident streq) (ident head) (string "binop"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident binary_expr_alloc)))
          (var op_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident binary_expr_set_op) (ident n) (call (ident sexpr_op_to_token) (field (ident op_node) text))))
          (expr_stmt (call (ident binary_expr_set_left) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 2)))))
          (expr_stmt (call (ident binary_expr_set_right) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 3)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "unop"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident unary_expr_alloc)))
          (var op_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident unary_expr_set_op) (ident n) (call (ident sexpr_op_to_token) (field (ident op_node) text))))
          (expr_stmt (call (ident unary_expr_set_expr) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 2)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "call"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident call_expr_alloc)))
          (expr_stmt (call (ident call_expr_set_func) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 1)))))
          (var arg_count (type_base i64) (binop - (call (ident sexpr_len) (ident node)) (number 2)))
          (var args (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident arg_count) (number 8))))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident arg_count))
            (block
              (var arg (type_ptr (type_base u8)) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (binop + (ident i) (number 2)))))
              (var ap (type_ptr (type_ptr (type_base u8))) (binop + (ident args) (binop * (ident i) (number 8))))
              (assign (unop * (ident ap)) (ident arg))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident call_expr_set_args) (ident n) (ident args)))
          (expr_stmt (call (ident call_expr_set_arg_count) (ident n) (ident arg_count)))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "field"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident alloc) (number 32)))
          (expr_stmt (call (ident node_set_kind) (ident n) (ident NODE_FIELD_EXPR)))
          (var pe (type_ptr (type_ptr (type_base u8))) (binop + (ident n) (number 8)))
          (assign (unop * (ident pe)) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 1))))
          (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 2)))
          (var pf (type_ptr (type_ptr (type_base u8))) (binop + (ident n) (number 16)))
          (assign (unop * (ident pf)) (call (ident sexpr_strdup) (field (ident name_node) text)))
          (var pfl (type_ptr (type_base i64)) (binop + (ident n) (number 24)))
          (assign (unop * (ident pfl)) (call (ident strlen) (field (ident name_node) text)))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "index"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident alloc) (number 24)))
          (expr_stmt (call (ident node_set_kind) (ident n) (ident NODE_INDEX_EXPR)))
          (var pe (type_ptr (type_ptr (type_base u8))) (binop + (ident n) (number 8)))
          (assign (unop * (ident pe)) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 1))))
          (var pi (type_ptr (type_ptr (type_base u8))) (binop + (ident n) (number 16)))
          (assign (unop * (ident pi)) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 2))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "let"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident let_expr_alloc)))
          (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident let_expr_set_name) (ident n) (call (ident sexpr_strdup) (field (ident name_node) text))))
          (expr_stmt (call (ident let_expr_set_name_len) (ident n) (call (ident strlen) (field (ident name_node) text))))
          (var next (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 2)))
          (if (binop && (binop == (field (ident next) kind) (ident PNODE_LIST)) (call (ident streq) (call (ident sexpr_head) (ident next)) (string "type_base")))
            (block
              (expr_stmt (call (ident let_expr_set_type) (ident n) (call (ident sexpr_to_type) (ident next))))
              (expr_stmt (call (ident let_expr_set_init) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 3)))))
              (expr_stmt (call (ident let_expr_set_body) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 4))))))
            (if (binop && (binop == (field (ident next) kind) (ident PNODE_LIST)) (call (ident streq) (call (ident sexpr_head) (ident next)) (string "type_ptr")))
              (block
                (expr_stmt (call (ident let_expr_set_type) (ident n) (call (ident sexpr_to_type) (ident next))))
                (expr_stmt (call (ident let_expr_set_init) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 3)))))
                (expr_stmt (call (ident let_expr_set_body) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 4))))))
              (block
                (expr_stmt (call (ident let_expr_set_type) (ident n) (nil)))
                (expr_stmt (call (ident let_expr_set_init) (ident n) (call (ident sexpr_to_node) (ident next))))
                (expr_stmt (call (ident let_expr_set_body) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 3))))))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "lambda"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident lambda_expr_alloc)))
          (var params_list (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (var params_inner (type_ptr (type_base PNode)) (call (ident sexpr_inner) (ident params_list)))
          (var param_count (type_base i64) (call (ident vec_len) (field (ident params_inner) children)))
          (var params (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident param_count) (number 24))))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident param_count))
            (block
              (expr_stmt (call (ident sexpr_to_param) (call (ident vec_get) (field (ident params_inner) children) (ident i)) (ident params) (ident i)))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident lambda_expr_set_params) (ident n) (ident params)))
          (expr_stmt (call (ident lambda_expr_set_param_count) (ident n) (ident param_count)))
          (expr_stmt (call (ident lambda_expr_set_ret_type) (ident n) (call (ident sexpr_to_type) (call (ident sexpr_get) (ident node) (number 2)))))
          (expr_stmt (call (ident lambda_expr_set_body) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 3)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "match"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident match_expr_alloc)))
          (expr_stmt (call (ident match_expr_set_scrutinee) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 1)))))
          (var cases_list (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 2)))
          (var cases_inner (type_ptr (type_base PNode)) (call (ident sexpr_inner) (ident cases_list)))
          (var arm_count (type_base i64) (call (ident vec_len) (field (ident cases_inner) children)))
          (var arms (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident arm_count) (number 16))))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident arm_count))
            (block
              (var case_node (type_ptr (type_base PNode)) (call (ident vec_get) (field (ident cases_inner) children) (ident i)))
              (var arm (type_ptr (type_base u8)) (binop + (ident arms) (binop * (ident i) (number 16))))
              (expr_stmt (call (ident match_arm_set_pattern) (ident arm) (call (ident sexpr_to_pattern) (call (ident sexpr_get) (ident case_node) (number 1)))))
              (expr_stmt (call (ident match_arm_set_body) (ident arm) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident case_node) (number 2)))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident match_expr_set_arms) (ident n) (ident arms)))
          (expr_stmt (call (ident match_expr_set_arm_count) (ident n) (ident arm_count)))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "perform"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident perform_expr_alloc)))
          (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident perform_expr_set_name) (ident n) (call (ident sexpr_strdup) (field (ident name_node) text))))
          (expr_stmt (call (ident perform_expr_set_name_len) (ident n) (call (ident strlen) (field (ident name_node) text))))
          (var arg_count (type_base i64) (binop - (call (ident sexpr_len) (ident node)) (number 2)))
          (var args (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident arg_count) (number 8))))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident arg_count))
            (block
              (var arg (type_ptr (type_base u8)) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (binop + (ident i) (number 2)))))
              (var ap (type_ptr (type_ptr (type_base u8))) (binop + (ident args) (binop * (ident i) (number 8))))
              (assign (unop * (ident ap)) (ident arg))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident perform_expr_set_args) (ident n) (ident args)))
          (expr_stmt (call (ident perform_expr_set_arg_count) (ident n) (ident arg_count)))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "handle"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident handle_expr_alloc)))
          (expr_stmt (call (ident handle_expr_set_body) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 1)))))
          (var ret_handler (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 2)))
          (var ret_bind (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident ret_handler) (number 1)))
          (expr_stmt (call (ident handle_expr_set_ret_bind) (ident n) (call (ident sexpr_strdup) (field (ident ret_bind) text))))
          (expr_stmt (call (ident handle_expr_set_ret_bind_len) (ident n) (call (ident strlen) (field (ident ret_bind) text))))
          (expr_stmt (call (ident handle_expr_set_ret_body) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident ret_handler) (number 2)))))
          (var effect_count (type_base i64) (binop - (call (ident sexpr_len) (ident node)) (number 3)))
          (var cases (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident effect_count) (number 56))))
          (var i (type_base i64) (number 0))
          (while (binop < (ident i) (ident effect_count))
            (block
              (var eh (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (binop + (ident i) (number 3))))
              (var c (type_ptr (type_base u8)) (binop + (ident cases) (binop * (ident i) (number 56))))
              (var ename (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident eh) (number 1)))
              (var cp (type_ptr (type_ptr (type_base u8))) (ident c))
              (assign (unop * (ident cp)) (call (ident sexpr_strdup) (field (ident ename) text)))
              (var cl (type_ptr (type_base i64)) (binop + (ident c) (number 8)))
              (assign (unop * (ident cl)) (call (ident strlen) (field (ident ename) text)))
              (var ebind (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident eh) (number 2)))
              (var bp (type_ptr (type_ptr (type_base u8))) (binop + (ident c) (number 16)))
              (if (call (ident streq) (field (ident ebind) text) (string "_"))
                (block
                  (assign (unop * (ident bp)) (nil))
                  (var bl (type_ptr (type_base i64)) (binop + (ident c) (number 24)))
                  (assign (unop * (ident bl)) (number 0)))
                (block
                  (assign (unop * (ident bp)) (call (ident sexpr_strdup) (field (ident ebind) text)))
                  (var bl (type_ptr (type_base i64)) (binop + (ident c) (number 24)))
                  (assign (unop * (ident bl)) (call (ident strlen) (field (ident ebind) text)))))
              (var ek (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident eh) (number 3)))
              (var kp (type_ptr (type_ptr (type_base u8))) (binop + (ident c) (number 32)))
              (assign (unop * (ident kp)) (call (ident sexpr_strdup) (field (ident ek) text)))
              (var kl (type_ptr (type_base i64)) (binop + (ident c) (number 40)))
              (assign (unop * (ident kl)) (call (ident strlen) (field (ident ek) text)))
              (var bodyp (type_ptr (type_ptr (type_base u8))) (binop + (ident c) (number 48)))
              (assign (unop * (ident bodyp)) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident eh) (number 4))))
              (assign (ident i) (binop + (ident i) (number 1)))))
          (expr_stmt (call (ident handle_expr_set_cases) (ident n) (ident cases)))
          (expr_stmt (call (ident handle_expr_set_case_count) (ident n) (ident effect_count)))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "resume"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident resume_expr_alloc)))
          (expr_stmt (call (ident resume_expr_set_k) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 1)))))
          (if (binop > (call (ident sexpr_len) (ident node)) (number 2))
            (block
              (expr_stmt (call (ident resume_expr_set_value) (ident n) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (number 2))))))
            (block
              (expr_stmt (call (ident resume_expr_set_value) (ident n) (nil)))))
          (return (ident n))))
      (if (call (ident streq) (ident head) (string "reader_expr"))
        (block
          (var n (type_ptr (type_base u8)) (call (ident reader_expr_alloc)))
          (var name_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 1)))
          (expr_stmt (call (ident reader_expr_set_name) (ident n) (call (ident sexpr_strdup) (field (ident name_node) text))))
          (expr_stmt (call (ident reader_expr_set_name_len) (ident n) (call (ident strlen) (field (ident name_node) text))))
          (var content_node (type_ptr (type_base PNode)) (call (ident sexpr_get) (ident node) (number 2)))
          (var content (type_ptr (type_base u8)) (call (ident sexpr_parse_string) (field (ident content_node) text)))
          (expr_stmt (call (ident reader_expr_set_content) (ident n) (ident content)))
          (expr_stmt (call (ident reader_expr_set_content_len) (ident n) (call (ident strlen) (ident content))))
          (return (ident n))))
      (expr_stmt (call (ident eprint) (string "Error: unknown S-expression node type: ")))
      (expr_stmt (call (ident eprintln) (ident head)))
      (return (nil))))
  (func sexpr_to_program ((param node (type_ptr (type_base PNode)))) (type_ptr (type_base u8))
    (block
      (if (binop != (field (ident node) kind) (ident PNODE_LIST))
        (block
          (expr_stmt (call (ident eprintln) (string "Error: expected (program ...)")))
          (return (nil))))
      (var head (type_ptr (type_base u8)) (call (ident sexpr_head) (ident node)))
      (if (binop || (binop == (ident head) (nil)) (binop == (call (ident streq) (ident head) (string "program")) (bool false)))
        (block
          (expr_stmt (call (ident eprintln) (string "Error: expected (program ...)")))
          (return (nil))))
      (var decl_count (type_base i64) (binop - (call (ident sexpr_len) (ident node)) (number 1)))
      (var decls (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident decl_count) (number 8))))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident decl_count))
        (block
          (var decl (type_ptr (type_base u8)) (call (ident sexpr_to_node) (call (ident sexpr_get) (ident node) (binop + (ident i) (number 1)))))
          (var dp (type_ptr (type_ptr (type_base u8))) (binop + (ident decls) (binop * (ident i) (number 8))))
          (assign (unop * (ident dp)) (ident decl))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (var prog (type_ptr (type_base u8)) (call (ident alloc) (number 16)))
      (var pd (type_ptr (type_ptr (type_base u8))) (ident prog))
      (assign (unop * (ident pd)) (ident decls))
      (var pc (type_ptr (type_base i64)) (binop + (ident prog) (number 8)))
      (assign (unop * (ident pc)) (ident decl_count))
      (return (ident prog))))
  (func parse_ast_from_string ((param source (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var t (type_ptr (type_base Tokenizer)) (call (ident tok_new) (ident source)))
      (var node (type_ptr (type_base PNode)) (call (ident parse_sexpr) (ident t)))
      (if (binop == (ident node) (nil))
        (block
          (expr_stmt (call (ident eprintln) (string "Error: failed to parse S-expression")))
          (return (nil))))
      (return (call (ident sexpr_to_program) (ident node)))))
  (func parse_ast_expression_from_string ((param source (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var t (type_ptr (type_base Tokenizer)) (call (ident tok_new) (ident source)))
      (var node (type_ptr (type_base PNode)) (call (ident parse_sexpr) (ident t)))
      (if (binop == (ident node) (nil))
        (block
          (expr_stmt (call (ident eprintln) (string "Error: failed to parse S-expression")))
          (return (nil))))
      (return (call (ident sexpr_to_node) (ident node)))))
  (func get_arg ((param argv (type_ptr (type_ptr (type_base u8)))) (param i (type_base i64))) (type_ptr (type_base u8))
    (block
      (var base (type_ptr (type_base u8)) (ident argv))
      (var p (type_ptr (type_ptr (type_base u8))) (binop + (ident base) (binop * (ident i) (number 8))))
      (return (unop * (ident p)))))
  (func read_file ((param path (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var fd (type_base i64) (call (ident file_open) (ident path) (number 0)))
      (if (binop < (ident fd) (number 0))
        (block
          (expr_stmt (call (ident eprint) (string "Error: cannot open file: ")))
          (expr_stmt (call (ident eprintln) (ident path)))
          (return (nil))))
      (var buf (type_ptr (type_base u8)) (call (ident alloc) (number 4194304)))
      (var n (type_base i64) (call (ident file_read) (ident fd) (ident buf) (number 4194304)))
      (expr_stmt (call (ident file_close) (ident fd)))
      (if (binop < (ident n) (number 0))
        (block
          (expr_stmt (call (ident eprintln) (string "Error: cannot read file")))
          (return (nil))))
      (assign (unop * (binop + (ident buf) (ident n))) (number 0))
      (return (ident buf))))
  (func combine_programs ((param prog1 (type_ptr (type_base u8))) (param prog2 (type_ptr (type_base u8)))) (type_ptr (type_base u8))
    (block
      (var decls1 (type_ptr (type_base u8)) (call (ident program_decls) (ident prog1)))
      (var count1 (type_base i64) (call (ident program_decl_count) (ident prog1)))
      (var decls2 (type_ptr (type_base u8)) (call (ident program_decls) (ident prog2)))
      (var count2 (type_base i64) (call (ident program_decl_count) (ident prog2)))
      (var total (type_base i64) (binop + (ident count1) (ident count2)))
      (var combined_decls (type_ptr (type_base u8)) (call (ident alloc) (binop * (ident total) (number 8))))
      (var i (type_base i64) (number 0))
      (while (binop < (ident i) (ident count1))
        (block
          (var src (type_ptr (type_ptr (type_base u8))) (binop + (ident decls1) (binop * (ident i) (number 8))))
          (var dst (type_ptr (type_ptr (type_base u8))) (binop + (ident combined_decls) (binop * (ident i) (number 8))))
          (assign (unop * (ident dst)) (unop * (ident src)))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (assign (ident i) (number 0))
      (while (binop < (ident i) (ident count2))
        (block
          (var src (type_ptr (type_ptr (type_base u8))) (binop + (ident decls2) (binop * (ident i) (number 8))))
          (var dst (type_ptr (type_ptr (type_base u8))) (binop + (ident combined_decls) (binop * (binop + (ident count1) (ident i)) (number 8))))
          (assign (unop * (ident dst)) (unop * (ident src)))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (var prog (type_ptr (type_base u8)) (call (ident alloc) (number 16)))
      (var pd (type_ptr (type_ptr (type_base u8))) (ident prog))
      (assign (unop * (ident pd)) (ident combined_decls))
      (var pc (type_ptr (type_base i64)) (binop + (ident prog) (number 8)))
      (assign (unop * (ident pc)) (ident total))
      (return (ident prog))))
  (func main ((param argc (type_base i64)) (param argv (type_ptr (type_ptr (type_base u8))))) (type_base i64)
    (block
      (var input_file (type_ptr (type_base u8)) (nil))
      (var output_file (type_ptr (type_base u8)) (nil))
      (var compose_file (type_ptr (type_base u8)) (nil))
      (var kernel_ast_file (type_ptr (type_base u8)) (nil))
      (var compiler_ast_file (type_ptr (type_base u8)) (nil))
      (var i (type_base i64) (number 1))
      (while (binop < (ident i) (ident argc))
        (block
          (var arg (type_ptr (type_base u8)) (call (ident get_arg) (ident argv) (ident i)))
          (if (binop && (binop && (binop == (unop * (ident arg)) (number 45)) (binop == (unop * (binop + (ident arg) (number 1))) (number 111))) (binop == (unop * (binop + (ident arg) (number 2))) (number 0)))
            (block
              (assign (ident i) (binop + (ident i) (number 1)))
              (if (binop < (ident i) (ident argc))
                (block
                  (assign (ident output_file) (call (ident get_arg) (ident argv) (ident i)))))
              (assign (ident i) (binop + (ident i) (number 1)))
              (continue)))
          (if (binop && (binop && (binop == (unop * (ident arg)) (number 45)) (binop == (unop * (binop + (ident arg) (number 1))) (number 99))) (binop == (unop * (binop + (ident arg) (number 2))) (number 0)))
            (block
              (assign (ident i) (binop + (ident i) (number 1)))
              (if (binop < (ident i) (ident argc))
                (block
                  (assign (ident compose_file) (call (ident get_arg) (ident argv) (ident i)))))
              (assign (ident i) (binop + (ident i) (number 1)))
              (continue)))
          (if (binop && (binop == (unop * (ident arg)) (number 45)) (binop == (unop * (binop + (ident arg) (number 1))) (number 45)))
            (block
              (if (call (ident memcmp) (binop + (ident arg) (number 2)) (string "kernel-ast") (number 10))
                (block
                  (assign (ident i) (binop + (ident i) (number 1)))
                  (if (binop < (ident i) (ident argc))
                    (block
                      (assign (ident kernel_ast_file) (call (ident get_arg) (ident argv) (ident i)))))
                  (assign (ident i) (binop + (ident i) (number 1)))
                  (continue)))
              (if (call (ident memcmp) (binop + (ident arg) (number 2)) (string "compiler-ast") (number 12))
                (block
                  (assign (ident i) (binop + (ident i) (number 1)))
                  (if (binop < (ident i) (ident argc))
                    (block
                      (assign (ident compiler_ast_file) (call (ident get_arg) (ident argv) (ident i)))))
                  (assign (ident i) (binop + (ident i) (number 1)))
                  (continue)))))
          (assign (ident input_file) (ident arg))
          (assign (ident i) (binop + (ident i) (number 1)))))
      (if (binop == (ident output_file) (nil))
        (block
          (assign (ident output_file) (string "a.s"))))
      (if (binop != (ident compose_file) (nil))
        (block
          (if (binop == (ident kernel_ast_file) (nil))
            (block
              (assign (ident kernel_ast_file) (string "bootstrap/current/kernel/source.ast"))))
          (if (binop == (ident compiler_ast_file) (nil))
            (block
              (assign (ident compiler_ast_file) (string "bootstrap/current/compiler/source.ast"))))
          (var kernel_source (type_ptr (type_base u8)) (call (ident read_file) (ident kernel_ast_file)))
          (if (binop == (ident kernel_source) (nil))
            (block
              (expr_stmt (call (ident eprint) (string "Error: cannot read kernel AST from ")))
              (expr_stmt (call (ident eprintln) (ident kernel_ast_file)))
              (return (number 1))))
          (var kernel_prog (type_ptr (type_base u8)) (call (ident parse_ast_from_string) (ident kernel_source)))
          (if (binop == (ident kernel_prog) (nil))
            (block
              (expr_stmt (call (ident eprintln) (string "Error: failed to parse kernel AST")))
              (return (number 1))))
          (var reader_source (type_ptr (type_base u8)) (call (ident read_file) (ident compose_file)))
          (if (binop == (ident reader_source) (nil))
            (block
              (return (number 1))))
          (var reader_prog (type_ptr (type_base u8)) (call (ident parse_ast_from_string) (ident reader_source)))
          (if (binop == (ident reader_prog) (nil))
            (block
              (expr_stmt (call (ident eprintln) (string "Error: failed to parse reader AST")))
              (return (number 1))))
          (var compiler_source (type_ptr (type_base u8)) (call (ident read_file) (ident compiler_ast_file)))
          (if (binop == (ident compiler_source) (nil))
            (block
              (expr_stmt (call (ident eprint) (string "Error: cannot read compiler AST from ")))
              (expr_stmt (call (ident eprintln) (ident compiler_ast_file)))
              (return (number 1))))
          (var compiler_prog (type_ptr (type_base u8)) (call (ident parse_ast_from_string) (ident compiler_source)))
          (if (binop == (ident compiler_prog) (nil))
            (block
              (expr_stmt (call (ident eprintln) (string "Error: failed to parse compiler AST")))
              (return (number 1))))
          (var combined (type_ptr (type_base u8)) (call (ident combine_programs) (ident kernel_prog) (ident reader_prog)))
          (assign (ident combined) (call (ident combine_programs) (ident combined) (ident compiler_prog)))
          (expr_stmt (call (ident generate) (ident combined) (ident output_file)))
          (expr_stmt (call (ident print) (string "Wrote ")))
          (expr_stmt (call (ident println) (ident output_file)))
          (return (number 0))))
      (if (binop == (ident input_file) (nil))
        (block
          (expr_stmt (call (ident eprintln) (string "Usage: kernel <input.ast> -o output.s")))
          (expr_stmt (call (ident eprintln) (string "       kernel -c <reader.ast> -o compiler.s")))
          (return (number 1))))
      (var ast_source (type_ptr (type_base u8)) (call (ident read_file) (ident input_file)))
      (if (binop == (ident ast_source) (nil))
        (block
          (return (number 1))))
      (var prog (type_ptr (type_base u8)) (call (ident parse_ast_from_string) (ident ast_source)))
      (if (binop == (ident prog) (nil))
        (block
          (expr_stmt (call (ident eprintln) (string "Error: failed to parse AST")))
          (return (number 1))))
      (expr_stmt (call (ident generate) (ident prog) (ident output_file)))
      (expr_stmt (call (ident print) (string "Wrote ")))
      (expr_stmt (call (ident println) (ident output_file)))
      (return (number 0))))
  (func ___main ((param argc (type_base i64)) (param argv (type_ptr (type_ptr (type_base u8))))) (type_base i64)
    (block
      (return (call (ident main) (ident argc) (ident argv))))))
  